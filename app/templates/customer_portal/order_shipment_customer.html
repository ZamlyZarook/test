{% extends "partials/base.html" %}

{% block title %}{% if shipment %}Edit{% else %}New{% endif %} Shipment - {{entry.docserial}}{% endblock title %}

{% block content %}
<!-- Start right Content here -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
                        <h4 class="mb-sm-0">{% if shipment %}Edit{% else %}New{% endif %} Shipment - {{entry.docserial}}</h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">Operations</a></li>
                                <li class="breadcrumb-item"><a href="{{ url_for('customer_portal.sea_import') }}">Shipments</a></li>
                                <li class="breadcrumb-item active">{% if shipment %}Edit{% else %}Add{% endif %} Shipment</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" id="flash-message">
                <i class="ri-check-double-line"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <div class="row">
                <div class="col-12">
                    <!-- Tab Navigation -->
                    <div class="card shadow-none border mb-0">
                        <div class="card-body p-0">
                            <ul class="nav nav-tabs nav-tabs-custom nav-justified" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#tab-details" role="tab" aria-selected="true">
                                        <span class="d-block d-sm-none"><i class="ri-file-list-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-file-list-line"> </i>Details</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-actions" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-rocket-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-rocket-line"></i> Actions</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-attachments" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-attachment-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-attachment-line"></i> Attachments</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-items" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-item-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-archive-line"></i> Items</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-demurrage" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-timer-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-timer-line"></i> Demurrage</span>
                                    </a>
                                </li>
                     
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-expenses" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-money-dollar-circle-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-money-dollar-circle-line"> </i>Expenses</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-invoices" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-bill-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-file-paper-line"></i> Invoices</span>
                                    </a>
                                </li>
                                
                            </ul>
                        </div>
                    </div>

                    <!-- Tab Content -->
                    <div class="tab-content pt-3">
                        <!-- Details Tab -->
                        <div class="tab-pane active" id="tab-details" role="tabpanel">
                            <form method="POST">
                                {% if shipment %}
                                <input type="hidden" name="id" value="{{ shipment.id }}">
                                {% endif %}
                                {% if order %}
                                <input type="hidden" name="order_id" value="{{ order.id }}">
                                {% endif %}

                                <!-- Basic Information -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="branch_id" class="form-label">Branch</label>
                                                    <select class="form-select" id="branch_id" name="branch_id" readonly>
                                                        <option value="">Select Branch</option>
                                                        {% for branch in branches %}
                                                        <option value="{{ branch.id }}" {% if shipment and shipment.branch_id == branch.id %}selected{% endif %}>{{ branch.name }}</option>
                                                        {% endfor %}
                                                    </select>   
                                                </div>                                    
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="import_id" class="form-label">Import ID</label>
                                                    <input type="text" class="form-control" id="import_id" name="import_id" placeholder="Enter Import ID" value="{{ order.docserial if order else (shipment.import_id if shipment else '') }}" {% if order %}readonly{% endif %}>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="shipment_deadline" class="form-label">Shipment Deadline</label>
                                                    <input type="date" class="form-control" id="shipment_deadline" name="shipment_deadline" value="{{ order.dealineDate if order else (shipment.shipment_deadline if shipment else '') }}" {% if order %}readonly{% endif %}>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="bl_no" class="form-label">BL No</label>
                                                    <input type="text" class="form-control" id="bl_no" name="bl_no" placeholder="Enter BL number" value="{{ shipment.bl_no if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="license_number" class="form-label">License No</label>
                                                    <input type="text" class="form-control" id="license_number" name="license_number" placeholder="Enter license number" value="{{ shipment.license_number if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <div class="d-flex align-items-center">
                                                        <label for="primary_job" class="form-label me-2">Primary Job</label>
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="primary_job_yn" name="primary_job_yn" value="Y" {% if shipment and shipment.primary_job_yn == 'Y' %}checked{% endif %} readonly>
                                                        </div>
                                                    </div>
                                                    <input type="text" class="form-control" id="primary_job" name="primary_job" placeholder="Enter primary job" value="{{ shipment.primary_job if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="shipment_type_id" class="form-label">Shipment Type</label>
                                                    <select class="form-select" id="shipment_type_id" name="shipment_type_id" readonly>
                                                        <option value="">Select Shipment Type</option>
                                                        <option value="1" {% if shipment and shipment.shipment_type_id == 1 %}selected{% elif order and order.shipTypeid == 1 %}selected{% endif %}>Custom</option>
                                                        <option value="2" {% if shipment and shipment.shipment_type_id == 2 %}selected{% elif order and order.shipTypeid == 2 %}selected{% endif %}>BOI</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="sub_type" class="form-label">Sub Type</label>
                                                    <select class="form-select" id="sub_type" name="sub_type" readonly>
                                                        <option value="">Select Sub Type</option>
                                                        <option value="1" {% if shipment and shipment.sub_type_id == 1 %}selected{% endif %}>Tiep</option>
                                                        <option value="2" {% if shipment and shipment.sub_type_id == 2 %}selected{% endif %}>Infac</option>
                                                        <option value="3" {% if shipment and shipment.sub_type_id == 3 %}selected{% endif %}>Bond</option>
                                                        <option value="4" {% if shipment and shipment.sub_type_id == 4 %}selected{% endif %}>General</option>       
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="customer_category" class="form-label">Customer Category</label>
                                                    <select class="form-select" id="customer_category" name="customer_category" readonly>
                                                        <option value="">Select Customer Category</option>
                                                        <option value="1" {% if shipment and shipment.customer_category_id == 1 %}selected{% endif %}>Direct</option>
                                                    </select>
                                                </div>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="business_type" class="form-label">Business Type</label>
                                                    <select class="form-select" id="business_type" name="business_type" readonly>
                                                        <option value="">Select Business Type</option>
                                                        <option value="1" {% if shipment and shipment.business_type_id == 1 %}selected{% endif %}>Sales Nomination</option>
                                                        <option value="2" {% if shipment and shipment.business_type_id == 2 %}selected{% endif %}>Agent Nomination</option>
                                                        <option value="3" {% if shipment and shipment.business_type_id == 3 %}selected{% endif %}>Free hand</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Customer Information -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- First card in left column -->
                                        <div class="card shadow-none border mb-3">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="customer_id" class="form-label">Customer</label>
                                                            <select class="form-select" id="customer_id" name="customer_id" {% if order %}readonly{% endif %} readonly>
                                                                <option value="">Select Customer</option>
                                                                {% for customer in customers %}
                                                                <option value="{{ customer.id }}" {% if order and order.customer_id == customer.id %}selected{% elif shipment and shipment.customer_id == customer.id %}selected{% endif %}>{{ customer.customer_name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="billing_party_id" class="form-label">Billing Party</label>
                                                            <select class="form-select" id="billing_party_id" name="billing_party_id" readonly>
                                                                <option value="">Select Billing Party</option>
                                                                {% for party in billing_parties %}
                                                                <option value="{{ party.id }}" {% if shipment and shipment.billing_party_id == party.id %}selected{% endif %}>{{ party.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Second card in left column -->
                                        <div class="card shadow-none border mb-3">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="clearing_agent" class="form-label">Clearing Agent</label>
                                                            <input type="text" class="form-control" id="clearing_agent" name="clearing_agent" placeholder="Enter clearing agent" value="{{ shipment.clearing_agent if shipment else '' }}" readonly>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="contact_person" class="form-label">Contact Person</label>
                                                            <input type="text" class="form-control" id="contact_person" name="contact_person" placeholder="Enter contact person" value="{{ shipment.contact_person if shipment else '' }}" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Right column with single card -->
                                    <div class="col-md-6">
                                        <!-- Team Assignment -->
                                        <div class="card shadow-none border mb-3">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="sales_person_id" class="form-label">Sales Person</label>
                                                            <select class="form-select" id="sales_person_id" name="sales_person_id" readonly>
                                                                <option value="">Select Sales Person</option>
                                                                {% for person in sales_people %}
                                                                <option value="{{ person.id }}" {% if shipment and shipment.sales_person_id == person.id %}selected{% endif %}>{{ person.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="cs_executive_id" class="form-label">CS Executive</label>
                                                            <select class="form-select" id="cs_executive_id" name="cs_executive_id" readonly>
                                                                <option value="">Select CS Executive</option>
                                                                {% for exec in cs_executives %}
                                                                <option value="{{ exec.id }}" {% if shipment and shipment.cs_executive_id == exec.id %}selected{% endif %}>{{ exec.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-12">
                                                        <div class="mb-3">
                                                            <label for="wharf_clerk_id" class="form-label">Wharf Clerk</label>
                                                            <select class="form-select" id="wharf_clerk_id" name="wharf_clerk_id" readonly>
                                                                <option value="">Select Wharf Clerk</option>
                                                                {% for wharf in wharf_clerks %}
                                                                <option value="{{ wharf.id }}" {% if shipment and shipment.wharf_clerk_id == wharf.id %}selected{% endif %}>{{ wharf.first_name }} {{wharf.last_name}}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modified Import Container Section with Existing Container Loading -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="mb-0">Container Details</h5>
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <label class="form-label mb-0 me-2">20 ft:</label>
                                                    <input type="text" class="form-control form-control-sm d-inline-block" style="width: 60px;" id="importCount20ft" value="0" readonly>
                                                </div>
                                                <div class="me-3">
                                                    <label class="form-label mb-0 me-2">40 ft:</label>
                                                    <input type="text" class="form-control form-control-sm d-inline-block" style="width: 60px;" id="importCount40ft" value="0" readonly>
                                                </div>
                                                <!-- <button type="button" class="btn btn-sm btn-primary" id="addImportContainerRow">
                                                    <i class="ri-add-line"></i> Add Container
                                                </button> -->
                                            </div>
                                        </div>
                                        
                                        <div id="importContainerRows">
                                            {% if import_containers and import_containers|length > 0 %}
                                                {% for container in import_containers %}
                                                <div class="row mb-3 container-row">
                                                    <div class="col-md-3">
                                                        <label class="form-label">Container #</label>
                                                        <input type="text" class="form-control container-number" name="import_container_numbers[]" placeholder="Enter container number" value="{{ container.container_number }}" readonly>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Size</label>
                                                        <select class="form-select container-size" name="import_container_sizes[]" readonly>
                                                            <option value="">Select Size</option>
                                                            <option value="20" {% if container.container_size == '20' %}selected{% endif %}>20 ft</option>
                                                            <option value="40" {% if container.container_size == '40' %}selected{% endif %}>40 ft</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Type</label>
                                                        <select class="form-select container-type" name="import_container_types[]" readonly>
                                                            <option value="">Select Type</option>
                                                            <option value="GP" {% if container.container_type == 'GP' %}selected{% endif %}>GP (General Purpose)</option>
                                                            <option value="HC" {% if container.container_type == 'HC' %}selected{% endif %}>HC (High Cube)</option>
                                                            <option value="RF" {% if container.container_type == 'RF' %}selected{% endif %}>RF (Refrigerated)</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">Remarks</label>
                                                        <input type="text" class="form-control container-remarks" name="import_container_remarks[]" placeholder="Enter remarks" value="{{ container.remarks }}" readonly>
                                                    </div>
                                                    <!-- <div class="col-md-1">
                                                        <label class="form-label">&nbsp;</label>
                                                        <button type="button" class="btn btn-danger btn-sm d-block remove-container">
                                                            <i class="ri-delete-bin-line"></i>
                                                        </button>
                                                    </div> -->
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <!-- Default empty container row if no containers exist -->
                                                <div class="row mb-3 container-row">
                                                    <div class="col-md-3">
                                                        <label class="form-label">Container #</label>
                                                        <input type="text" class="form-control container-number" name="import_container_numbers[]" placeholder="Enter container number" readonly>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Size</label>
                                                        <select class="form-select container-size" name="import_container_sizes[]" readonly>
                                                            <option value="">Select Size</option>
                                                            <option value="20">20 ft</option>
                                                            <option value="40">40 ft</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Type</label>
                                                        <select class="form-select container-type" name="import_container_types[]" readonly>
                                                            <option value="">Select Type</option>
                                                            <option value="GP">GP (General Purpose)</option>
                                                            <option value="HC">HC (High Cube)</option>
                                                            <option value="RF">RF (Refrigerated)</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">Remarks</label>
                                                        <input type="text" class="form-control container-remarks" name="import_container_remarks[]" placeholder="Enter remarks" readonly>
                                                    </div>
                                                    <!-- <div class="col-md-1">
                                                        <label class="form-label">&nbsp;</label>
                                                        <button type="button" class="btn btn-danger btn-sm d-block remove-container" >
                                                            <i class="ri-delete-bin-line"></i>
                                                        </button>
                                                    </div> -->
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Reference Information -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="po_no" class="form-label">PO No</label>
                                                    <input type="text" class="form-control" id="po_no" name="po_no" placeholder="Enter PO number" value="{{ shipment.po_no if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="invoice_no" class="form-label">Invoice No</label>
                                                    <input type="text" class="form-control" id="invoice_no" name="invoice_no" placeholder="Enter invoice number" value="{{ shipment.invoice_no if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="customer_ref_no" class="form-label">Customer Ref No</label>
                                                    <input type="text" class="form-control" id="customer_ref_no" name="customer_ref_no" placeholder="Enter customer reference" value="{{ order.customer.customer_id if order else (shipment.customer_ref_no if shipment else '') }}" {% if order %}readonly{% endif %}>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="customs_dti_no" class="form-label">Customs DTI No</label>
                                                    <input type="text" class="form-control" id="customs_dti_no" name="customs_dti_no" placeholder="Enter customs DTI number" value="{{ shipment.customs_dti_no if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Shipping Information -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="mbl_number" class="form-label">MBL Number</label>
                                                    <input type="text" class="form-control" id="mbl_number" name="mbl_number" placeholder="Enter MBL number" value="{{ shipment.mbl_number if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="vessel" class="form-label">Vessel</label>
                                                    <input type="text" class="form-control" id="vessel" name="vessel" placeholder="Enter vessel name" value="{{ shipment.vessel if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="voyage" class="form-label">Voyage</label>
                                                    <input type="text" class="form-control" id="voyage" name="voyage" placeholder="Enter voyage" value="{{ shipment.voyage if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="eta" class="form-label">ETA</label>
                                                    <input type="datetime-local" class="form-control" id="eta" name="eta" value="{{ shipment.eta.strftime('%Y-%m-%dT%H:%M') if shipment and shipment.eta else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="shipper" class="form-label">Shipper</label>
                                                    <input type="text" class="form-control" id="shipper" name="shipper" placeholder="Enter shipper" value="{{ shipment.shipper if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="port_of_loading" class="form-label">Port of Loading</label>
                                                    <input type="text" class="form-control" id="port_of_loading" name="port_of_loading" placeholder="Enter port of loading" value="{{ shipment.port_of_loading if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="port_of_discharge" class="form-label">Port of Discharge</label>
                                                    <input type="text" class="form-control" id="port_of_discharge" name="port_of_discharge" placeholder="Enter port of discharge" value="{{ shipment.port_of_discharge if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="job_id" class="form-label">Job Type</label>
                                                    <select class="form-select" id="job_id" name="job_id" readonly>
                                                        <option value="">Select Job Type</option>
                                                        <option value="1" {% if shipment and shipment.job_type == "1" %}selected{% endif %}>FCL</option>
                                                        <option value="2" {% if shipment and shipment.job_type == "2" %}selected{% endif %}>LCL</option>                                                    
                                                    </select>   
                                                </div>                                    
                                            </div>
    
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="fcl_gate_out_date" class="form-label">FCL Gate Out Date</label>
                                                    <input type="date" class="form-control" id="fcl_gate_out_date" name="fcl_gate_out_date" value="{{ shipment.fcl_gate_out_date if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="pod_datetime" class="form-label">POD Date/Time</label>
                                                    <input type="datetime-local" class="form-control" id="pod_datetime" name="pod_datetime" value="{{ shipment.pod_datetime.strftime('%Y-%m-%dT%H:%M') if shipment and shipment.pod_datetime else '' }}" readonly>
                                                </div>
                                            </div>
                    
                                        </div>
                                    </div>
                                </div>

                                <!-- Cargo Details -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="no_of_packages" class="form-label">No of Packages</label>
                                                    <input type="number" class="form-control" id="no_of_packages" name="no_of_packages" placeholder="Enter number of packages" value="{{ shipment.no_of_packages if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="package_type" class="form-label">Package Type</label>
                                                    <input type="text" class="form-control" id="package_type" name="package_type" placeholder="Enter package type" value="{{ shipment.package_type if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="cbm" class="form-label">CBM</label>
                                                    <input type="number" step="0.01" class="form-control" id="cbm" name="cbm" placeholder="Enter CBM" value="{{ shipment.cbm if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="gross_weight" class="form-label">Gross Weight</label>
                                                    <input type="number" step="0.01" class="form-control" id="gross_weight" name="gross_weight" placeholder="Enter gross weight" value="{{ shipment.gross_weight if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="cargo_description" class="form-label">Cargo Description</label>
                                                    <input class="form-control" id="cargo_description" name="cargo_description" rows="3" placeholder="Enter cargo description" value="{{ shipment.cargo_description if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="liner" class="form-label">Liner</label>
                                                    <input type="text" class="form-control" id="liner" name="liner" placeholder="Enter Liner" value="{{ shipment.liner if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="entrepot" class="form-label">Entrepot</label>
                                                    <input type="text" class="form-control" id="entrepot" name="entrepot" placeholder="Enter entrepot" value="{{ shipment.entrepot if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Financial Information -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="job_currency" class="form-label">Job Currency</label>
                                                    <input type="text" class="form-control" id="job_currency" name="job_currency" placeholder="Enter currency code" value="{{ shipment.job_currency if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="mb-3">
                                                    <label for="ex_rating_buying" class="form-label">Exchange Rate (Buying)</label>
                                                    <input type="number" step="0.0001" class="form-control" id="ex_rating_buying" name="ex_rating_buying" placeholder="Enter buying rate" value="{{ shipment.ex_rating_buying if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="mb-3">
                                                    <label for="ex_rating_selling" class="form-label">Exchange Rate (Selling)</label>
                                                    <input type="number" step="0.0001" class="form-control" id="ex_rating_selling" name="ex_rating_selling" placeholder="Enter selling rate" value="{{ shipment.ex_rating_selling if shipment else '' }}" readonly>
                                                </div>
                                            </div>
                                            <div class="col-md-5">
                                                <div class="mb-3">
                                                    <label for="remarks" class="form-label">Remarks</label>
                                                    <input class="form-control" id="remarks" name="remarks" rows="3" placeholder="Enter remarks" value="{{ order.custComment if order else (shipment.remarks if shipment else '') }}" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Job Status Information -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <div class="form-check form-switch mt-2">
                                                        <input class="form-check-input" type="checkbox" id="onhold_yn" name="onhold_yn" value="Y" {% if shipment and shipment.onhold_yn == 'Y' %}checked{% endif %} readonly>
                                                        <label class="form-check-label" for="onhold_yn">On Hold</label>
                                                    </div>
                                                    <div id="onhold_reason_container" class="mt-3" style="display: none;">
                                                        <textarea class="form-control" id="onhold_reason" name="onhold_reason" rows="2" placeholder="Enter reason for on hold" readonly>{{ shipment.onhold_reason if shipment and shipment.onhold_yn == 'Y' else '' }}</textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="cleared_date" class="form-label">Cleared Date</label>
                                                            <input type="date" class="form-control" id="cleared_date" name="cleared_date" value="{{ shipment.cleared_date if shipment else '' }}" readonly>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="estimated_job_closing_date" class="form-label">Estimated Job Closing Date</label>
                                                            <input type="date" class="form-control" id="estimated_job_closing_date" name="estimated_job_closing_date" value="{{ shipment.estimated_job_closing_date if shipment else '' }}" readonly>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                        
                                <!-- <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="d-flex gap-2 float-end">
                                            <a href="{{ url_for('masters.orders') }}" class="btn btn-light">
                                                <i class="ri-close-line me-1"></i>Cancel
                                            </a>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="ri-save-line me-1"></i>Save Shipment
                                            </button>
                                        </div>
                                    </div>
                                </div>     -->
                            </form>
                        </div>

                        <!-- Actions Tab -->
                        <div class="tab-pane" id="tab-actions" role="tabpanel">
                            <div class="card shadow-none border">
                
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="card" id="tasksList">
                                                <div class="card-header border-0">
                                                    <div class="d-flex align-items-center">
                                                        <h5 class="card-title mb-0 flex-grow-1">All Tasks</h5>
                                                        <!-- <div class="flex-shrink-0">
                                                            <div class="d-flex flex-wrap gap-2">
                                                                <button class="btn btn-danger add-btn" data-bs-toggle="modal" data-bs-target="#showModal"><i class="ri-add-line align-bottom me-1"></i> Create Task</button>
                                                                <button class="btn btn-success" id="remove-actions" onClick="deleteMultiple()"><i class="ri-delete-bin-2-line"></i></button>
                                                           </div>
                                                        </div> -->
                                                    </div>
                                                </div>
                                                <div class="card-body border border-dashed border-end-0 border-start-0">
                                                    <form>
                                                        <div class="row g-3">
                                                            <div class="col-xxl-4 col-sm-4">
                                                                <div class="search-box">
                                                                    <input type="text" class="form-control search bg-light border-light" placeholder="Search for tasks or something...">
                                                                    <i class="ri-search-line search-icon"></i>
                                                                </div>
                                                            </div>
                                                            <!--end col-->
                
                                                                <div class="col-xxl-3 col-sm-3">
                                                                    <div class="input-light">
                                                                        <input type="text" class="form-control bg-light border-light" id="demo-datepicker" 
                                                                               data-provider="flatpickr" data-date-format="d M, Y" data-range-date="true" 
                                                                               data-clear-button="true"
                                                                               placeholder="Select due date range">
                                                                    </div>
                                                                </div>
                                                            <!--end col-->
                
                                                            <div class="col-xxl-2 col-sm-2">
                                                                <div class="input-light">
                                                                    <select class="form-control" data-choices data-choices-search-false name="choices-single-default" id="idStatus">
                                                                        <option value="">Status</option>
                                                                        <option value="all" selected>All</option>
                                                                        <!-- Task statuses will be loaded dynamically -->
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            <!--end col-->
                
                                                            <div class="col-xxl-2 col-sm-2">
                                                                <div class="input-light">
                                                                    <select class="form-control" data-choices data-choices-search-false name="taskView" id="idTaskView">
                                                                        <option value="my_tasks" selected>My Tasks</option>
                                                                        <option value="connected_tasks">My Connected Tasks</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                
                                                            <div class="col-xxl-1 col-sm-1">
                                                                <button type="button" class="btn btn-primary w-100" onclick="SearchData();"> <i class="ri-equalizer-fill me-1 align-bottom"></i>
                                                                    Filters
                                                                </button>
                                                            </div>
                                                            <!--end col-->
                                                        </div>
                                                        <!--end row-->
                                                    </form>
                                                </div>
                                                <!--end card-body-->
                                                <div class="card-body">
                                                    <div class="table-responsive table-card mb-4">
                                                        <table class="table align-middle table-nowrap mb-0" id="tasksTable">
                                                            <thead class="table-light text-muted">
                                                                <tr>
                                                                    <th scope="col" style="width: 40px;">
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" id="checkAll" value="option">
                                                                        </div>
                                                                    </th>
                                                                    <th class="sort" data-sort="id">Task Key</th>
                                                                    <th class="sort" data-sort="project_name">Project</th>
                                                                    <th class="sort" data-sort="tasks_name">Task</th>
                                                                    <th class="sort" data-sort="assignedto">Assigned To</th>
                                                                    <th class="sort" data-sort="due_date">Due Date</th>
                                                                    <th class="sort" data-sort="status">Status</th>
                                                                    <th class="sort" data-sort="priority">Priority</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="form-check-all">
                                                                {% for task in tasks %}
                                                                <tr class="task-row" 
                                                                    data-task-id="{{ task.id }}" >
                                                                    
                                                                    <th scope="row">
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" name="chk_child" value="option{{ task.id }}">
                                                                        </div>
                                                                    </th>
                                                                    <td class="id"><a href="{{ url_for('tasks.task_detail', project_id=task.project_id, task_id=task.id) }}?taskView={{ request.args.get('taskView', 'my_tasks') }}" class="fw-medium link-primary">
                                                                        {{ task.task_key }}</a></td>
                                                                    <td class="project_name">
                                                                        {% if task.project %}
                                                                        <a href="{{ url_for('tasks.task_detail', project_id=task.project_id, task_id=task.id) }}?taskView={{ request.args.get('taskView', 'my_tasks') }}" class="fw-medium link-primary">
                                                                            {{ task.project.name }}</a>
                                                                        {% else %}
                                                                        -
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        <div class="d-flex">
                                                                            <div class="flex-grow-1 tasks_name">{{ task.title }}</div>
                                                                            <div class="flex-shrink-0 ms-4">
                                                                                <ul class="list-inline tasks-list-menu mb-0">
                                                                                    <li class="list-inline-item">
                                                                                        <a href="{{ url_for('tasks.task_detail', project_id=task.project_id, task_id=task.id) }}?taskView={{ request.args.get('taskView', 'my_tasks') }}">
                                                                                            <i class="ri-eye-fill align-bottom me-2 text-muted"></i>
                                                                                        </a>
                                                                                    </li>
                                                                                    {% if current_user.role_id == 1 or current_user.id == task.creator_id %}
                                                                                    <li class="list-inline-item">
                                                                                            <a class="edit-item-btn" href="#showModal" data-bs-toggle="modal" onclick="editTask({{ task.id }})">
                                                                                                <i class="ri-pencil-fill align-bottom me-2 text-muted"></i>
                                                                                            </a>
                                                                                        </li>
                                                                                        <li class="list-inline-item">
                                                                                            <a class="remove-item-btn" onclick="deleteTask({{ task.id }})">
                                                                                                <i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i>
                                                                                            </a>
                                                                                        </li>
                                                                                    {% endif %}
                
                                                                                </ul>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td class="assignedto">
                                                                        {% if task.assignee %}
                                                                        <div class="avatar-group">
                                                                            <a href="javascript: void(0);" class="avatar-group-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="{{ task.assignee.name }}">
                                                                                {% if task.assignee.profile_picture %}
                                                                                <img src="data:image/jpeg;base64,{{ task.assignee.profile_picture_base64 }}" alt="" class="rounded-circle avatar-xxs">
                                                                                {% else %}
                                                                                <img src="{{ url_for('static', filename='images/users/user-dummy-img.jpg') }}" alt="" class="rounded-circle avatar-xxs">
                                                                                {% endif %}
                                                                            </a>
                                                                        </div>
                                                                        {% else %}
                                                                        -
                                                                        {% endif %}
                                                                    </td>
                                                                    <td class="due_date">{{ task.due_date.strftime('%d %b, %Y') if task.due_date else '-' }}</td>
                                                                    <td class="status">
                                                                        <span class="badge badge-soft-{{ task.status.color if task.status else 'secondary' }} text-uppercase">
                                                                            {{ task.status.name if task.status else 'Not Set' }}
                                                                        </span>
                                                                      
                                                                    </td>
                                                                    <td class="priority">
                                                                        {% if task.priority %}
                                                                            {% set color_map = {
                                                                                'red': 'danger',
                                                                                'blue': 'primary',
                                                                                'green': 'success',
                                                                                'yellow': 'warning',
                                                                                'gray': 'secondary'
                                                                            } %}
                                                                            <span class="badge badge-soft-{{ color_map[task.priority.color] if task.priority.color in color_map else 'secondary' }} text-uppercase">
                                                                                {{ task.priority.name }}
                                                                            </span>
                                                                        {% else %}
                                                                            <span class="badge badge-soft-secondary text-uppercase">Not Set</span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                        <!--end table-->
                                                        <div class="noresult" style="display: none">
                                                            <div class="text-center">
                                                                <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#121331,secondary:#08a88a" style="width:75px;height:75px"></lord-icon>
                                                                <h5 class="mt-2">Sorry! No Result Found</h5>
                                                                <p class="text-muted mb-0">We did not find any tasks for you search.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-end mt-2">
                                                        <div class="pagination-wrap hstack gap-2">
                                                            <a class="page-item pagination-prev disabled" href="#">
                                                                Previous
                                                            </a>
                                                            <ul class="pagination listjs-pagination mb-0"></ul>
                                                            <a class="page-item pagination-next" href="#">
                                                                Next
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--end card-body-->
                                            </div>
                                            <!--end card-->
                                        </div>
                                        <!--end col-->
                                    </div>
                                    <!--end row-->
                
                                    <div class="modal fade flip" id="deleteOrder" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content">
                                                <div class="modal-body p-5 text-center">
                                                    <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
                                                    <div class="mt-4 text-center">
                                                        <h4>You are about to delete a task ?</h4>
                                                        <p class="text-muted fs-14 mb-4">Deleting your task will remove all of
                                                            your information from our database.</p>
                                                        <div class="hstack gap-2 justify-content-center remove">
                                                            <button class="btn btn-link btn-ghost-success fw-medium text-decoration-none" id="deleteRecord-close" data-bs-dismiss="modal"><i class="ri-close-line me-1 align-middle"></i> Close</button>
                                                            <button class="btn btn-danger" id="delete-record">Yes, Delete It</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--end delete modal -->
                
                                    <div class="modal fade zoomIn" id="showModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered modal-lg">
                                            <div class="modal-content border-0">
                                                <div class="modal-header p-3 bg-soft-info">
                                                    <h5 class="modal-title" id="exampleModalLabel">Create Task</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="close-modal"></button>
                                                </div>
                                                    <!-- In the showModal div, update the form -->
                                                    <form id="createTaskForm" enctype="multipart/form-data" action="{{ url_for('tasks.create_project_task', project_id=0) }}" method="POST">
                                                        {% if shipment %}
                                                        <input type="hidden" name="id" value="{{ shipment.id }}">
                                                        {% endif %}
                                                        {% if order %}
                                                        <input type="hidden" name="order_id" id="order_id" value="{{ order.id }}">
                                                        {% endif %}
                                                        <div class="modal-body">
                                                            <!-- Tab Navigation -->
                                                            <ul class="nav nav-tabs nav-tabs-custom nav-justified" role="tablist">
                                                                <li class="nav-item">
                                                                    <a class="nav-link active" data-bs-toggle="tab" href="#task-details-tab" role="tab" aria-selected="true">
                                                                        <i class="ri-task-line me-1 align-bottom"></i> Task Details
                                                                    </a>
                                                                </li>
                                                                <li class="nav-item">
                                                                    <a class="nav-link" data-bs-toggle="tab" href="#task-attachments-tab" role="tab" aria-selected="false">
                                                                        <i class="ri-attachment-line me-1 align-bottom"></i> Attachments
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                            
                                                            <!-- Tab Content -->
                                                            <div class="tab-content">
                                                                <!-- Task Details Tab -->
                                                                <div class="tab-pane active" id="task-details-tab" role="tabpanel">
                                                                    <div class="row mt-4">
                                                                        <div class="col-md-6">
                                                                            <div class="mb-3">
                                                                                <label for="projects" class="form-label">Project</label>
                                                                                <select class="form-select" id="projects" required>
                                                                                    {% for project in projects %}
                                                                                    <option value="{{ project.id }}">{{ project.name }}</option>
                                                                                    {% endfor %}
                                                                                </select>
                                                                            </div>
                                                                        </div>
                                
                                                                    </div>
                                                                    <div class="mt-2 mb-3">
                                                                        <label for="taskTitle" class="form-label">Title</label>
                                                                        <input type="text" class="form-control" id="taskTitle" required>
                                                                    </div>
                                                                    <div class="mb-3">
                                                                        <label for="taskDescription" class="form-label">Description</label>
                                                                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                                                                    </div>
                                                                    
                                                                    <div class="row">
                                                                        <div class="col-md-6">
                                                                            <div class="mb-3">
                                                                                <label for="taskCategory" class="form-label">Category</label>
                                                                                <select class="form-select" id="taskCategory" required>
                                                                                    {% for category in categories %}
                                                                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                                                                    {% endfor %}
                                                                                </select>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6">
                                                                            <div class="mb-3">
                                                                                <label for="taskAssignee" class="form-label">Assignee</label>
                                                                                <select class="form-select" id="taskAssignee">
                                                                                    <option value="">Unassigned</option>
                                                                                    {% for member in project_members %}
                                                                                    <option value="{{ member.id }}">{{ member.name }}</option>
                                                                                    {% endfor %}
                                                                                </select>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="row">
                                                                        <div class="col-md-4">
                                                                            <div class="mb-3">
                                                                                <label for="taskStatus" class="form-label">Status</label>
                                                                                <select class="form-select" id="taskStatus" required>
                                                                                    {% for status in statuses %}
                                                                                    <option value="{{ status.id }}">{{ status.name }}</option>
                                                                                    {% endfor %}
                                                                                </select>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-4">
                                                                            <div class="mb-3">
                                                                                <label for="taskPriority" class="form-label">Priority</label>
                                                                                <select class="form-select" id="taskPriority" required>
                                                                                    {% for priority in priorities %}
                                                                                    <option value="{{ priority.id }}">{{ priority.name }}</option>
                                                                                    {% endfor %}
                                                                                </select>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-4">
                                                                            <div class="mb-3">
                                                                                <label for="taskDueDate" class="form-label">Due Date</label>
                                                                                <input type="date" class="form-control" id="taskDueDate" name="due_date">
                                                                                <small id="dueDateHelperText" class="text-muted">
                                                                                    <!-- This text will be updated dynamically based on project settings -->
                                                                                </small>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <!-- Attachments Tab -->
                                                                <div class="tab-pane" id="task-attachments-tab" role="tabpanel">
                                                                    <div class="mb-3 mt-3">
                                                                        <label for="taskAttachments" class="form-label">Attachments</label>
                                                                        <input type="file" class="form-control" id="taskAttachments" multiple>
                                                                        <div id="attachmentList" class="mt-3"></div>
                                                                    </div>
                                        
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                                                            <button type="submit" class="btn btn-success" id="createTaskBtn">Create Task</button>
                                                        </div>
                                                    </form>
                                            </div>
                                        </div>
                                    </div>
                                    <!--end modal-->

                            </div>
                        </div>

                        <!-- Attachments Tab -->
                        <div class="tab-pane" id="tab-attachments" role="tabpanel">
                            <div class="card shadow-none border">
                                <div class="card-body">
                                    <div class="d-flex align-items-center justify-content-between mb-4">
                                        <h5 class="card-title mb-0">Shipment Documents</h5>
                                        <!-- <div class="flex-shrink-0">
                                            {% if shipment %}
                                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#documentModal">
                                                <i class="ri-upload-2-line align-bottom me-1"></i> Upload Document
                                            </button>
                                            {% else %}
                                            <div class="alert alert-info mb-0 py-2">
                                                <i class="ri-information-line me-1"></i>
                                                Save shipment first to enable document uploads
                                            </div>
                                            {% endif %}
                                        </div> -->
                                    </div>
                                    
                                    <!-- Documents Table -->
                                    <div class="table-responsive">
                                        <table class="table align-middle table-nowrap mb-0" id="documentsTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document Name</th>
                                                    <th>Type</th>
                                                    <th>Description</th>
                                                    <th>Uploaded By</th>
                                                    <th>Upload Date</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if shipment and documents %}
                                                    {% for doc in documents %}
                                                        <tr>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <i class="ri-file-text-line fs-18 me-2 text-primary"></i>
                                                                    <div>{{ doc.document_name }}</div>
                                                                </div>
                                                            </td>
                                                            <td><span class="badge badge-soft-info">{{ doc.document_type }}</span></td>
                                                            <td>{{ doc.description }}</td>
                                                            <td>{{ doc.uploaded_by_user.name if doc.uploaded_by_user else 'Unknown' }}</td>
                                                            <td>{{ doc.created_at.strftime('%d %b, %Y') if doc.created_at else 'N/A' }}</td>
                                                            <td>
                                                                <div class="d-flex gap-2">
                                                                    <a href="{{ url_for('masters.view_ship_document', entry_id=shipment.id, document_id=doc.id) }}" 
                                                                    class="btn btn-sm btn-soft-primary" target="_blank">
                                                                        <i class="ri-eye-line"></i>
                                                                    </a>
                                                                    <button class="btn btn-sm btn-soft-info edit-document" data-id="{{ doc.id }}">
                                                                        <i class="ri-pencil-line"></i>
                                                                    </button>
                                                                    <button class="btn btn-sm btn-soft-danger delete-document" data-id="{{ doc.id }}">
                                                                        <i class="ri-delete-bin-line"></i>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="6" class="text-center py-4">
                                                            <div class="text-muted">
                                                                {% if not shipment %}
                                                                    <i class="ri-information-line fs-24 mb-2 d-block"></i>
                                                                    <p>Save this shipment first to start managing documents.</p>
                                                                {% else %}
                                                                    <i class="ri-folder-info-line fs-24 mb-2 d-block"></i>
                                                                    <p>No documents found. Upload documents using the button above.</p>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Document Modal -->
                            <div class="modal fade zoomIn" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content border-0">
                                        <div class="modal-header p-3 bg-soft-info">
                                            <h5 class="modal-title" id="documentModalLabel">Upload Document</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeDocumentModal"></button>
                                        </div>
                                        <form id="documentForm" enctype="multipart/form-data">
                                            <input type="hidden" id="documentId" name="document_id" value="">
                                            <input type="hidden" id="shipmentId" name="shipment_id" value="{{ shipment.ship_doc_entry_id if shipment else '' }}">
                                            
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <label for="documentType" class="form-label">Document Type</label>
                                                    <select class="form-select" id="documentType" name="document_type" required>
                                                        <option value="">Select Document Type</option>
                                                        <option value="invoice">Invoice</option>
                                                        <option value="bill-of-lading">Bill of Lading</option>
                                                        <option value="packing-list">Packing List</option>
                                                        <option value="customs">Customs Documents</option>
                                                        <option value="certificate">Certificates</option>
                                                        <option value="other">Other</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="documentFile" class="form-label">Document File</label>
                                                    <input type="file" class="form-control" id="documentFile" name="document" required>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="documentDescription" class="form-label">Description</label>
                                                    <textarea class="form-control" id="documentDescription" name="description" rows="3" placeholder="Enter document description"></textarea>
                                                </div>
                                                
                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox" id="isConfidential" name="is_confidential">
                                                    <label class="form-check-label" for="isConfidential">Mark as Confidential</label>
                                                </div>
                                                
                                                <div class="edit-only-fields d-none">
                                                    <div class="mb-3">
                                                        <label class="form-label">Uploaded By</label>
                                                        <input type="text" class="form-control" id="uploadedBy" readonly>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label class="form-label">Upload Date</label>
                                                        <input type="text" class="form-control" id="uploadDate" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="modal-footer">
                                                <div class="hstack gap-2 justify-content-end">
                                                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-success" id="saveDocument">Upload Document</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Delete Document Modal -->
                            <div class="modal fade flip" id="deleteDocumentModal" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-body p-5 text-center">
                                            <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
                                            <div class="mt-4 text-center">
                                                <h4>You are about to delete a document?</h4>
                                                <p class="text-muted fs-14 mb-4">Deleting your document will remove it permanently from the system.</p>
                                                <div class="hstack gap-2 justify-content-center remove">
                                                    <button class="btn btn-link btn-ghost-success fw-medium text-decoration-none" id="deleteDocumentCancel" data-bs-dismiss="modal">
                                                        <i class="ri-close-line me-1 align-middle"></i> Cancel
                                                    </button>
                                                    <button class="btn btn-danger" id="deleteDocument" data-document-id="">
                                                        Yes, Delete It
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Items Tab -->
                        <div class="tab-pane" id="tab-items" role="tabpanel">
                            <div class="card shadow-none border">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <h5 class="card-title mb-0">
                                            <i class="ri-shopping-cart-line me-1"></i>
                                            Items
                                        </h5>
                                        <div>
                                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addManualItemModal">
                                                <i class="ri-add-line me-1"></i>
                                                Add Item
                                            </button>
                                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#pullFromPOModal">
                                                <i class="ri-download-line me-1"></i>
                                                Pull from PO
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Items Summary Cards -->
                                    <div class="row mb-4">
                                        <div class="col-md-3">
                                            <div class="card card-animate card-hover shadow-sm bg-soft-primary">
                                                <div class="card-body p-3">
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0">
                                                            <i class="ri-shopping-bag-line fs-3 text-primary"></i>
                                                        </div>
                                                        <div class="flex-grow-1 overflow-hidden ms-3">
                                                            <h6 class="mb-0 text-muted">Total Items</h6>
                                                            <h4 class="mb-0">{{ shipment_items|length if shipment_items else 0 }}</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card card-animate card-hover shadow-sm bg-soft-success">
                                                <div class="card-body p-3">
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0">
                                                            <i class="ri-edit-line fs-3 text-success"></i>
                                                        </div>
                                                        <div class="flex-grow-1 overflow-hidden ms-3">
                                                            <h6 class="mb-0 text-muted">Manual Items</h6>
                                                            <h4 class="mb-0">{{ shipment_items|selectattr('source_type', 'equalto', 'manual')|list|length if shipment_items else 0 }}</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card card-animate card-hover shadow-sm bg-soft-info">
                                                <div class="card-body p-3">
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0">
                                                            <i class="ri-file-list-line fs-3 text-info"></i>
                                                        </div>
                                                        <div class="flex-grow-1 overflow-hidden ms-3">
                                                            <h6 class="mb-0 text-muted">PO Items</h6>
                                                            <h4 class="mb-0">{{ shipment_items|selectattr('source_type', 'equalto', 'po')|list|length if shipment_items else 0 }}</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card card-animate card-hover shadow-sm bg-soft-warning">
                                                <div class="card-body p-3">
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0 ">
                                                            <i class="ri-money-dollar-circle-line fs-3 text-warning"></i>
                                                        </div>
                                                        <div class="flex-grow-1 overflow-hidden ms-3">
                                                            <h6 class="mb-0 text-muted">Total Value</h6>
                                                            <h4 class="mb-0">LKR {{ '{:,.2f}'.format(shipment_items|sum(attribute='line_total') if shipment_items else 0) }}</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Items Table - Updated with HS Code and Documents columns -->
                                    <div class="table-responsive">
                                        {% if shipment_items and shipment_items|length > 0 %}
                                        <table class="table table-bordered table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th width="2%">#</th>
                                                    <th width="6%">Source</th>
                                                    <th width="8%">PO Number</th>
                                                    <th width="8%">Material Code</th>
                                                    <th width="25%">Material Name</th>
                                                    <th width="6%">Quantity</th>
                                                    <th width="4%">Unit</th>
                                                    <th width="8%">Price</th>
                                                    <th width="8%">Total</th>
                                                    <th width="8%">HS Code</th>
                                                    <th width="8%">Documents</th>
                                                    <th width="9%">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in shipment_items %}
                                                <tr>
                                                    <td>{{ loop.index }}</td>
                                                    <td>
                                                        {% if item.source_type == 'manual' %}
                                                            <span class="badge bg-success">Manual</span>
                                                        {% else %}
                                                            <span class="badge bg-info">PO</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if item.po_number %}
                                                            <small class="text-primary">{{ item.po_number }}</small>
                                                        {% else %}
                                                            <small class="text-muted">-</small>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <strong>{{ item.material_code }}</strong>
                                                    </td>
                                                    <td>
                                                        <div class="text-wrap">{{ item.material_name }}</div>
                                                        {% if item.supplier_name %}
                                                            <small class="text-muted">Supplier: {{ item.supplier_name }}</small>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-end">
                                                        {{ '%0.3f'|format(item.quantity) }}
                                                    </td>
                                                    <td>{{ item.order_unit }}</td>
                                                    <td class="text-end">
                                                        {% if item.net_price %}
                                                            {{ '{:,.2f}'.format(item.net_price) }}
                                                        {% else %}
                                                            <small class="text-muted">-</small>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-end">
                                                        {% if item.line_total %}
                                                            <strong>{{ item.po_currency }} {{ '{:,.2f}'.format(item.line_total) }}</strong>
                                                        {% else %}
                                                            <small class="text-muted">-</small>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if item.hs_code %}
                                                            <span class="badge badge-soft-success">{{ item.hs_code.code }}</span>
                                                        {% else %}
                                                            <span class="badge badge-soft-warning">Not Connected</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if item.hs_code %}
                                                            <div class="d-flex gap-1 flex-wrap">
                                                                <span class="badge badge-soft-warning" data-bs-toggle="tooltip" data-bs-placement="top" title="Required">
                                                                    <i class="ri-file-list-line me-1"></i>
                                                                    {{ item.required_docs_count }}
                                                                </span>
                                                                <span class="badge badge-soft-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Uploaded">
                                                                    <i class="ri-upload-line me-1"></i>
                                                                    {{ item.uploaded_docs_count }}
                                                                </span>
                                                                {% if item.po_material %}
                                                                <button class="btn btn-sm btn-outline-info" onclick="viewMaterialDocuments({{ item.po_material.id }})" data-bs-toggle="tooltip" data-bs-placement="top" title="View Documents">
                                                                    <i class="ri-eye-line"></i>
                                                                </button>
                                                                <span id="material-alert-{{ item.po_material.id }}" 
                                                                    class="material-alert-icon" 
                                                                    style="display: none;"
                                                                    data-bs-toggle="tooltip" 
                                                                    data-bs-placement="top" 
                                                                    title="Documents expiring before shipment date">
                                                                    <i class="ri-error-warning-line" style="color: #dc3545; font-size: 16px;"></i>
                                                                </span>
                                                                {% endif %}

                                                            </div>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-end">
                                                        <div class="d-flex gap-1 justify-content-end">
                                                            <button type="button" class="btn btn-primary btn-sm" 
                                                                    onclick="editItem({{ item.id }})" title="Edit">
                                                                <i class="ri-edit-line"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-danger btn-sm" 
                                                                    onclick="deleteItem({{ item.id }}, '{{ item.material_code }}')" title="Delete">
                                                                <i class="ri-delete-bin-line"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                            <tfoot class="table-light">
                                                <tr>
                                                    <td colspan="8" class="text-end"><strong>Grand Total:</strong></td>
                                                    <td class="text-end">
                                                        <strong>LKR {{ '{:,.2f}'.format(shipment_items|sum(attribute='line_total') if shipment_items else 0) }}</strong>
                                                    </td>
                                                    <td colspan="3"></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                        {% else %}
                                        <div class="text-center py-5">
                                            <i class="ri-shopping-cart-line fs-1 text-muted mb-3"></i>
                                            <h5 class="text-muted">No items added yet</h5>
                                            <p class="text-muted mb-4">Start by adding manual items or pulling from existing purchase orders.</p>
                                            <div>
                                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addManualItemModal">
                                                    <i class="ri-add-line me-1"></i>
                                                    Add Manual Item
                                                </button>
                                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#pullFromPOModal">
                                                    <i class="ri-download-line me-1"></i>
                                                    Pull from PO
                                                </button>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Add this modal at the bottom of your shipment page, before the closing body tag -->

                                <!-- Material Documents Modal -->
                                <div class="modal fade" id="materialDocumentsModal" tabindex="-1" aria-labelledby="materialDocumentsModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="materialDocumentsModalLabel">
                                                    <i class="ri-file-text-line me-2"></i>Material Documents
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div id="materialDocumentSection">
                                                    <!-- Document progress will be displayed here -->
                                                    <div id="materialDocumentProgress"></div>
                                                    
                                                    <div id="materialAlertSection" style="display: none;">
                                                        <div class="modal-alert-header">
                                                            <h6 class="text-danger mb-2">
                                                                <i class="ri-error-warning-line me-2"></i>
                                                                Document Expiry Alert
                                                            </h6>
                                                            <p class="mb-2 small" id="alertMessage">
                                                                Some documents expire before the shipment ETA/deadline date.
                                                            </p>
                                                        </div>
                                                    </div>


                                                    <!-- Material and HS Code info -->
                                                    <div class="row mb-3" id="materialHSInfo" style="display: none;">
                                                        <div class="col-12">
                                                            <div class="alert alert-info">
                                                                <h6 id="materialInfoTitle"></h6>
                                                                <p class="mb-0" id="materialInfoDetails"></p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Existing documents will be loaded here dynamically -->
                                                    <div class="card mb-3">
                                                        <div class="card-header">
                                                            <h6 class="card-title mb-0">Uploaded Documents</h6>
                                                        </div>
                                                        <div class="card-body" id="materialExistingDocuments">
                                                            <!-- Existing documents will be populated here -->
                                                        </div>
                                                    </div>

                                                    <!-- Required documents for view only -->
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h6 class="card-title mb-0">Required Documents</h6>
                                                        </div>
                                                        <div class="card-body" id="materialRequiredDocuments">
                                                            <!-- Required documents will be displayed here -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Add Manual Item Modal -->
                                <div class="modal fade" id="addManualItemModal" tabindex="-1" aria-labelledby="addManualItemModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <form id="manualItemForm" method="POST" action="{{ url_for('customer_portal.add_manual_item', entry_id=entry.id) }}">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="addManualItemModalLabel">
                                                        <i class="ri-add-line me-1"></i>
                                                        Add Manual Item
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="material_code" class="form-label">Material Code <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="material_code" name="material_code" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="material_name" class="form-label">Material Name <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="material_name" name="material_name" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                                                                <input type="number" class="form-control" id="quantity" name="quantity" step="0.001" min="0" required onchange="calculateLineTotal()">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="order_unit" class="form-label">Unit <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="order_unit" name="order_unit" placeholder="e.g., PCS, KG, LTR" required>
                                                                <small class="form-text text-muted">Enter unit (PCS, KG, LTR, M, etc.)</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="net_price" class="form-label">Unit Price</label>
                                                                <input type="number" class="form-control" id="net_price" name="net_price" step="0.01" min="0" onchange="calculateLineTotal()">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="supplier_name" class="form-label">Supplier Name</label>
                                                                <input type="text" class="form-control" id="supplier_name" name="supplier_name">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="po_number" class="form-label">PO Number</label>
                                                                <input type="text" class="form-control" id="po_number" name="po_number" placeholder="Enter PO number (if applicable)">
                                                                <small class="form-text text-muted">Optional - Link to purchase order</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="delivery_date" class="form-label">Delivery Date</label>
                                                                <input type="date" class="form-control" id="delivery_date" name="delivery_date">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="line_total_display" class="form-label">Line Total</label>
                                                                <input type="text" class="form-control bg-light" id="line_total_display" readonly>
                                                                <input type="hidden" id="line_total" name="line_total">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="mb-3">
                                                                <label for="remarks" class="form-label">Remarks</label>
                                                                <textarea class="form-control" id="remarks" name="remarks" rows="2" placeholder="Enter any additional notes"></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" name="submit_action" value="add_another" class="btn btn-info">
                                                        <i class="ri-add-line me-1"></i>
                                                        Add Another
                                                    </button>
                                                    <button type="submit" name="submit_action" value="save_close" class="btn btn-primary">
                                                        <i class="ri-save-line me-1"></i>
                                                        Save & Close
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pull from PO Modal -->
                                <div class="modal fade" id="pullFromPOModal" tabindex="-1" aria-labelledby="pullFromPOModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <form id="pullFromPOForm" method="POST" action="{{ url_for('customer_portal.add_po_items', entry_id=entry.id) }}">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="pullFromPOModalLabel">
                                                        <i class="ri-download-line me-1"></i>
                                                        Pull Items from Purchase Orders
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <!-- Search and Filter Controls -->
                                                    <div class="row mb-3">
                                                        <div class="col-md-4">
                                                            <label for="po_search" class="form-label">Search PO Number</label>
                                                            <input type="text" class="form-control" id="po_search" placeholder="Enter PO number..." onkeyup="filterPOItems()">
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label for="material_search" class="form-label">Search Material</label>
                                                            <input type="text" class="form-control" id="material_search" placeholder="Material code or name..." onkeyup="filterPOItems()">
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label for="supplier_filter" class="form-label">Filter by Supplier</label>
                                                            <select class="form-select" id="supplier_filter" onchange="filterPOItems()">
                                                                <option value="">All Suppliers</option>
                                                                {% for supplier in available_suppliers %}
                                                                <option value="{{ supplier }}">{{ supplier }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>

                                                    <!-- PO Items Table -->
                                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                        {% if available_po_items and available_po_items|length > 0 %}
                                                        <table class="table table-sm table-bordered">
                                                            <thead class="table-light sticky-top">
                                                                <tr>
                                                                    <th width="5%">
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" id="selectAllPO" onchange="toggleAllPOItems()">
                                                                            <label class="form-check-label" for="selectAllPO">All</label>
                                                                        </div>
                                                                    </th>
                                                                    <th width="12%">PO Number</th>
                                                                    <th width="12%">Material Code</th>
                                                                    <th width="25%">Material Name</th>
                                                                    <th width="8%">Pending Qty</th>
                                                                    <th width="6%">Unit</th>
                                                                    <th width="10%">Price</th>
                                                                    <th width="10%">Total</th>
                                                                    <th width="12%">Supplier</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="poItemsTableBody">
                                                                {% for po_item in available_po_items %}
                                                                <tr class="po-item-row" 
                                                                    data-po-number="{{ po_item.po_number }}"
                                                                    data-material="{{ (po_item.material_code + ' ' + po_item.material_name)|lower }}"
                                                                    data-supplier="{{ po_item.supplier_name }}">
                                                                    <td>
                                                                        <div class="form-check">
                                                                            <input class="form-check-input po-item-checkbox" type="checkbox" 
                                                                                name="selected_po_items" value="{{ po_item.id }}"
                                                                                id="po_item_{{ po_item.id }}" onchange="updateSelection()">
                                                                        </div>
                                                                    </td>
                                                                    <td><small class="text-primary">{{ po_item.po_number }}</small></td>
                                                                    <td><strong>{{ po_item.material_code }}</strong></td>
                                                                    <td>
                                                                        <div class="text-wrap">{{ po_item.material_name }}</div>
                                                                    </td>
                                                                    <td class="text-end">{{ '%0.3f'|format(po_item.quantity_pending) }}</td>
                                                                    <td>{{ po_item.order_unit }}</td>
                                                                                                                                        <td class="text-end">{{ '%0.2f'|format(po_item.net_price) }}</td>
                                                                    <td class="text-end">
                                                                        <strong>LKR {{ '%0.2f'|format(po_item.quantity_pending * po_item.net_price) }}</strong>
                                                                    </td>
                                                                    <td><small>{{ po_item.supplier_name }}</small></td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                        {% else %}
                                                        <div class="text-center py-4">
                                                            <i class="ri-file-list-line fs-1 text-muted mb-3"></i>
                                                            <h5 class="text-muted">No PO items available</h5>
                                                            <p class="text-muted">No purchase order items found for your company.</p>
                                                        </div>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Selection Summary -->
                                                    <div class="mt-3">
                                                        <div class="alert alert-info" id="selectionSummary" style="display: none;">
                                                            <i class="ri-information-line me-1"></i>
                                                            <span id="selectedCount">0</span> item(s) selected
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn btn-success" id="addSelectedItemsBtn" disabled>
                                                        <i class="ri-download-line me-1"></i>
                                                        Add Selected Items (<span id="selectedCountBtn">0</span>)
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Edit Item Modal (reuse manual item form structure) -->
                                <div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <form id="editItemForm" method="POST">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editItemModalLabel">
                                                        <i class="ri-edit-line me-1"></i>
                                                        Edit Item
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <!-- Same form fields as manual item modal but with edit_ prefix -->
                                                    <input type="hidden" id="edit_item_id" name="item_id">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="edit_material_code" class="form-label">Material Code <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="edit_material_code" name="material_code" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="edit_material_name" class="form-label">Material Name <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="edit_material_name" name="material_name" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="edit_quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                                                                <input type="number" class="form-control" id="edit_quantity" name="quantity" step="0.001" min="0" required onchange="calculateEditLineTotal()">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="edit_order_unit" class="form-label">Unit <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="edit_order_unit" name="order_unit" placeholder="e.g., PCS, KG, LTR" required>
                                                                <small class="form-text text-muted">Enter unit (PCS, KG, LTR, M, etc.)</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="edit_net_price" class="form-label">Unit Price</label>
                                                                <input type="number" class="form-control" id="edit_net_price" name="net_price" step="0.01" min="0" onchange="calculateEditLineTotal()">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="edit_supplier_name" class="form-label">Supplier Name</label>
                                                                <input type="text" class="form-control" id="edit_supplier_name" name="supplier_name">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="edit_po_number" class="form-label">PO Number</label>
                                                                <input type="text" class="form-control" id="edit_po_number" name="po_number" placeholder="Enter PO number (if applicable)">
                                                                <small class="form-text text-muted">Optional - Link to purchase order</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="edit_delivery_date" class="form-label">Delivery Date</label>
                                                                <input type="date" class="form-control" id="edit_delivery_date" name="delivery_date">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="edit_line_total_display" class="form-label">Line Total</label>
                                                                <input type="text" class="form-control bg-light" id="edit_line_total_display" readonly>
                                                                <input type="hidden" id="edit_line_total" name="line_total">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="mb-3">
                                                                <label for="edit_remarks" class="form-label">Remarks</label>
                                                                <textarea class="form-control" id="edit_remarks" name="remarks" rows="2" placeholder="Enter any additional notes"></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="ri-save-line me-1"></i>
                                                        Update Item
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                        <!-- Demurrage Tab (Customer View) -->
                        <div class="tab-pane" id="tab-demurrage" role="tabpanel">
                            <div class="card shadow-none border">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center mb-4">
                                                <h5 class="card-title mb-0">Demurrage Records</h5>
                                                <div class="badge bg-info fs-6" id="demurrageRecordCount">0 Records</div>
                                            </div>
                                            
                                            <!-- No Containers Message -->
                                            <div id="noContainersForDemurrage" class="alert alert-info text-center" style="display: none;">
                                                <i class="ri-container-line fs-2 mb-2"></i>
                                                <p class="mb-0">No containers found for this shipment.</p>
                                            </div>
                                            
                                            <!-- Demurrage Table -->
                                            <div class="table-responsive" id="demurrageTableContainer">
                                                <table class="table table-bordered table-striped" id="demurrageTable">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Container #</th>
                                                            <th>Date</th>
                                                            <th>Reason</th>
                                                            <th>Currency</th>
                                                            <th class="text-end">Amount</th>
                                                            <th>Documents</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- Demurrage records will be loaded here -->
                                                        <tr id="loadingRow">
                                                            <td colspan="6" class="text-center py-4">
                                                                <div class="spinner-border text-primary" role="status">
                                                                    <span class="visually-hidden">Loading...</span>
                                                                </div>
                                                                <p class="mt-2 mb-0 text-muted">Loading demurrage records...</p>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                    <tfoot>
                                                        <tr class="table-info">
                                                            <th colspan="4" class="text-end">Total:</th>
                                                            <th id="totalDemurrageAmount" class="text-end">0.00</th>
                                                            <th></th>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                            <!-- Demurrage Details Modal (Customer View) -->
                            <div class="modal fade" id="demurrageDetailsModal" tabindex="-1" aria-labelledby="demurrageDetailsModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="demurrageDetailsModalLabel">Demurrage Details</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <!-- Demurrage Details -->
                                            <div class="row mb-4">
                                                <div class="col-md-6">
                                                    <h6 class="text-muted mb-3">Demurrage Information</h6>
                                                    <div class="mb-2">
                                                        <strong>Container:</strong> 
                                                        <span id="modalContainerNumber">-</span>
                                                    </div>
                                                    <div class="mb-2">
                                                        <strong>Date:</strong> 
                                                        <span id="modalDemurrageDate">-</span>
                                                    </div>
                                                    <div class="mb-2">
                                                        <strong>Reason:</strong> 
                                                        <span id="modalDemurrageReason">-</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="text-muted mb-3">Financial Details</h6>
                                                    <div class="mb-2">
                                                        <strong>Currency:</strong> 
                                                        <span id="modalCurrency">-</span>
                                                    </div>
                                                    <div class="mb-2">
                                                        <strong>Amount:</strong> 
                                                        <span id="modalAmount" class="fw-bold text-primary">-</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Attachments Section -->
                                            <div class="border-top pt-4">
                                                <h6 class="text-muted mb-3">
                                                    <i class="ri-attachment-line me-2"></i>Documents & Attachments
                                                </h6>
                                                <div id="attachmentsContainer">
                                                    <div id="attachmentsLoading" class="text-center py-3">
                                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                            <span class="visually-hidden">Loading...</span>
                                                        </div>
                                                        <small class="text-muted ms-2">Loading attachments...</small>
                                                    </div>
                                                    
                                                    <div id="noAttachmentsMessage" class="text-center py-4 text-muted" style="display: none;">
                                                        <i class="ri-file-line fs-2 mb-2"></i>
                                                        <p class="mb-0">No documents attached</p>
                                                    </div>
                                                    
                                                    <div id="attachmentsList">
                                                        <!-- Attachments will be loaded here -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>      
       
                        <!-- Expenses Tab -->
                        <div class="tab-pane" id="tab-expenses" role="tabpanel">
                            <div class="card shadow-none border">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center mb-4">
                                                <h5 class="card-title mb-0">Shipment Expenses</h5>
                                            </div>
                                            
                                            <!-- Filter Controls -->
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-4">
                                                    <div class="search-box">
                                                        <input type="text" class="form-control search" id="expenseSearch" placeholder="Search expenses...">
                                                        <i class="ri-search-line search-icon"></i>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <select class="form-select" id="expenseTypeFilter">
                                                        <option value="all">All Expense Types</option>
                                                        {% for expense in income_expenses %}
                                                            {% if expense.type == 'expense' %}
                                                                <option value="{{ expense.id }}">{{ expense.description }}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="text" class="form-control" id="expenseDateFilter" 
                                                        placeholder="Select date range" data-provider="flatpickr" 
                                                        data-date-format="d M, Y" data-range-date="true">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-primary w-100" id="filterExpensesBtn">
                                                        <i class="ri-filter-line me-1"></i> Filter
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Expenses List Table -->
                                            <div class="table-responsive">
                                                <table class="table table-bordered table-striped align-middle" id="expensesTable">
                                                    <thead class="text-muted table-light">
                                                        <tr>
                                                            <th scope="col">Expense Type</th>
                                                            <th scope="col">Narration</th>
                                                            <th scope="col">Amount</th>
                                                            <th scope="col">Charged Amount</th>
                                                            <th scope="col">Balance Amount</th>
                                                            <th scope="col">Reference</th>
                                                            <th scope="col">Doc Date</th>
                                                            <th scope="col">Attachment</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% if shipment and customer_visible_expenses %}
                                                            {% for expense in customer_visible_expenses %}
                                                            <tr data-id="{{ expense.id }}"
                                                                data-type="{{ expense.expense_type_id }}"
                                                                data-date-from="{{ expense.doc_date }}">
                                                                <td>
                                                                    <span class="fw-medium">{{ expense.expense_description }}</span>
                                                                    <small class="d-block text-muted">{{ expense.expense_type.gl_code }}</small>
                                                                </td>
                                                                <td>{{ expense.narration }}</td>
                                                                <td class="text-end">
                                                                    <span class="fw-medium badge badge-soft-success fs-6 py-1 px-2">{{ expense.formatted_chargeable_amount }}</span>
                                                                </td>
                                                                <td class="text-end">
                                                                    <span class="fw-medium">{{ expense.formatted_charged_amount }}</span>
                                                                </td>
                                                                <td class="text-end">
                                                                    <span class="fw-medium">{{ expense.formatted_balance_amount }}</span>
                                                                </td>
                                                                <td>{{ expense.reference or '-' }}</td>
                                                                <td>
                                                                    {% if expense.doc_date %}
                                                                        {{ expense.doc_date.strftime('%d %b, %Y') }}
                                                                    {% else %}
                                                                        -
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% if expense.attachment_path and expense.attachment_visible_to_customer %}
                                                                        <a href="{{ url_for('customer_portal.view_expense_attachment', expense_id=expense.id) }}" target="_blank" class="btn btn-sm btn-soft-info">
                                                                            <i class="ri-file-text-line me-1"></i>View
                                                                        </a>
                                                                    {% else %}
                                                                        <span class="badge badge-soft-secondary">None</span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <tr>
                                                                <td colspan="8" class="text-center py-4">
                                                                    <div class="text-muted">
                                                                        <i class="ri-money-dollar-circle-line fs-24 mb-2 d-block"></i>
                                                                        <p>No expense information available for this shipment.</p>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            <!-- "No Results" message (initially hidden) -->
                                            <div class="noresult" style="display: none">
                                                <div class="text-center py-4">
                                                    <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#121331,secondary:#08a88a" style="width:75px;height:75px"></lord-icon>
                                                    <h5 class="mt-2">Sorry! No Result Found</h5>
                                                    <p class="text-muted mb-0">We couldn't find any expenses matching your search criteria.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>



                        <!-- Invoices Tab -->
                        <div class="tab-pane" id="tab-invoices" role="tabpanel">
                            <div class="card shadow-none border">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center mb-4">
                                                <h5 class="card-title mb-0">Shipment Invoices</h5>
                                            </div>
                                            
                                            <!-- Filter Controls -->
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-5">
                                                    <div class="search-box">
                                                        <input type="text" class="form-control search" id="invoiceSearch" placeholder="Search invoices...">
                                                        <i class="ri-search-line search-icon"></i>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <select class="form-select" id="invoiceStatusFilter">
                                                        <option value="all">All Statuses</option>
                                                        <option value="0">Pending</option>
                                                        <option value="1">Partially Paid</option>
                                                        <option value="2">Paid</option>
                                                        <option value="3">Cancelled</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <button type="button" class="btn btn-primary w-100" id="filterInvoicesBtn">
                                                        <i class="ri-filter-line me-1"></i> Filter
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Invoices List Table -->
                                            <div class="table-responsive">
                                                <table class="table table-bordered table-striped" id="invoicesTable">
                                                    <thead class="text-muted table-light">
                                                        <tr>
                                                            <th scope="col">Invoice #</th>
                                                            <th scope="col">Date</th>
                                                            <th scope="col">Amount</th>
                                                            <th scope="col">Status</th>
                                                            <th scope="col">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td colspan="5" class="text-center py-4">
                                                                <div class="spinner-border text-primary" role="status">
                                                                    <span class="visually-hidden">Loading...</span>
                                                                </div>
                                                                <p class="mt-2">Loading invoices...</p>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            <!-- "No Results" message (initially hidden) -->
                                            <div class="noresult" style="display: none">
                                                <div class="text-center py-4">
                                                    <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#121331,secondary:#08a88a" style="width:75px;height:75px"></lord-icon>
                                                    <h5 class="mt-2">No Invoices Found</h5>
                                                    <p class="text-muted mb-0">No invoices match your search criteria.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- View Invoice Modal -->
                        <div class="modal fade" id="viewInvoiceModal" tabindex="-1" aria-labelledby="viewInvoiceModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="viewInvoiceModalLabel">Invoice Details</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row mb-4">
                                            <div class="col-md-6">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6 class="card-title">Invoice Information</h6>
                                                        <table class="table table-sm table-borderless mb-0">
                                                            <tbody>
                                                                <tr>
                                                                    <td class="fw-medium">Invoice Number:</td>
                                                                    <td id="viewInvoiceNumber"></td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="fw-medium">Date:</td>
                                                                    <td id="viewInvoiceDate"></td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="fw-medium">Status:</td>
                                                                    <td id="viewInvoiceStatus"></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6 class="card-title">Customer Information</h6>
                                                        <table class="table table-sm table-borderless mb-0">
                                                            <tbody>
                                                                <tr>
                                                                    <td class="fw-medium">Customer:</td>
                                                                    <td id="viewInvoiceCustomer"></td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="fw-medium">Narration:</td>
                                                                    <td id="viewInvoiceNarration"></td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="fw-medium">Created By:</td>
                                                                    <td id="viewInvoiceCreatedBy"></td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-bordered" id="viewInvoiceItems">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Expense Type</th>
                                                        <th>Description</th>
                                                        <th>Amount</th>
                                                        <th>Charged Amount</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Items will be loaded via JavaScript -->
                                                </tbody>
                                                <tfoot>
                                                    <tr>
                                                        <td colspan="3" class="text-end fw-bold">Total:</td>
                                                        <td id="viewInvoiceTotal" class="fw-bold"></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-primary" id="printInvoiceBtn"><i class="ri-printer-line me-1"></i> Print</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->

    {% block footer %}
    {% include "partials/footer.html" %}
    {% endblock footer %}
</div>
{% endblock content %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-hide flash messages after 5 seconds
        const flashMessage = document.getElementById('flash-message');
        if (flashMessage) {
            setTimeout(() => {
                const closeBtn = flashMessage.querySelector('.btn-close');
                if (closeBtn) closeBtn.click();
            }, 5000);
        }
        
        // Toggle onhold_reason field based on onhold_yn checkbox
        const onholdCheckbox = document.getElementById('onhold_yn');
        const onholdReasonContainer = document.getElementById('onhold_reason_container');
        const onholdReasonField = document.getElementById('onhold_reason');
        
        function updateOnholdReason() {
            if (onholdCheckbox.checked) {
                onholdReasonContainer.style.display = 'block';
                onholdReasonField.setAttribute('required', 'required');
            } else {
                onholdReasonContainer.style.display = 'none';
                onholdReasonField.removeAttribute('required');
                onholdReasonField.value = ''; // Reset text area when unchecked
            }
        }
        
        if (onholdCheckbox && onholdReasonContainer) {
            updateOnholdReason(); // Initial state
            onholdCheckbox.addEventListener('change', updateOnholdReason);
        }
        
        // Make prefilled fields from order appear as read-only
        const customerSelect = document.getElementById('customer_id');
        if (customerSelect && customerSelect.hasAttribute('readonly')) {
            customerSelect.classList.add('bg-light');
            customerSelect.addEventListener('mousedown', function(event) {
                event.preventDefault();
                return false;
            });
        }
        
        // Additional read-only handling for other pre-filled fields
        const readOnlyFields = document.querySelectorAll('input[readonly], select[readonly]');
        readOnlyFields.forEach(field => {
            field.classList.add('bg-light');
            if (field.tagName === 'SELECT') {
                field.addEventListener('mousedown', function(event) {
                    event.preventDefault();
                    return false;
                });
            }
        });


        (function ensureActiveTab() {
            // Get all tab links and content panes
            const tabLinks = document.querySelectorAll('.nav-tabs .nav-link');
            const tabPanes = document.querySelectorAll('.tab-content .tab-pane');
            
            // Check if any tab is active
            const hasActiveTab = Array.from(tabLinks).some(link => link.classList.contains('active'));
            
            // If no tab is active, make the first tab active
            if (!hasActiveTab && tabLinks.length > 0 && tabPanes.length > 0) {
            // First clear any active classes that might exist
            tabLinks.forEach(link => link.classList.remove('active'));
            tabPanes.forEach(pane => pane.classList.remove('active'));
            
            // Now set the first tab and its content as active
            tabLinks[0].classList.add('active');
            tabLinks[0].setAttribute('aria-selected', 'true');
            tabPanes[0].classList.add('active');
            
            // Also save this to localStorage if you're using it
            localStorage.setItem('activeShipmentTab', tabLinks[0].getAttribute('href'));
            }
        })();

        // Handle tab navigation
        const tabLinks = document.querySelectorAll('.nav-tabs .nav-link');
        const tabContents = document.querySelectorAll('.tab-pane');
        
        // Save active tab to localStorage
        function saveActiveTab(tabId) {
            localStorage.setItem('activeShipmentTab', tabId);
        }
        
        // Restore active tab from localStorage
        const activeTab = localStorage.getItem('activeShipmentTab');
        let tabActivated = false;

        if (activeTab) {
            const tabToActivate = document.querySelector(`[href="${activeTab}"]`);
            if (tabToActivate) {
                // Remove active class from all tabs and content
                tabLinks.forEach(link => {
                    link.classList.remove('active');
                    link.setAttribute('aria-selected', 'false');
                });
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to selected tab and content
                tabToActivate.classList.add('active');
                tabToActivate.setAttribute('aria-selected', 'true');
                document.querySelector(activeTab).classList.add('active');
                tabActivated = true;
            }
        }

        if (!tabActivated && tabLinks.length > 0 && tabContents.length > 0) {
            tabLinks[0].classList.add('active');
            tabLinks[0].setAttribute('aria-selected', 'true');
            tabContents[0].classList.add('active');
            saveActiveTab(tabLinks[0].getAttribute('href'));
        }
        
        // Add click event listeners to tabs
        tabLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                // Set aria-selected for all tabs
                tabLinks.forEach(l => l.setAttribute('aria-selected', 'false'));
                this.setAttribute('aria-selected', 'true');
                
                saveActiveTab(this.getAttribute('href'));
            });
        });
    });
</script>

<script src="{{ url_for('static', filename='js/item_tab.js') }}"></script>

<!-- Sea Import Container Script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // ===== IMPORT CONTAINER HANDLING =====
    
    // Function to update container counts for Import
    function updateImportContainerCounts() {
        const sizeSelects = document.querySelectorAll('#importContainerRows .container-size');
        let count20ft = 0;
        let count40ft = 0;
        
        sizeSelects.forEach(select => {
            if (select.value === '20') {
                count20ft += 1;
            } else if (select.value === '40') {
                count40ft += 1;
            }
        });
        
        // Update the count displays
        const importCount20ft = document.getElementById('importCount20ft');
        const importCount40ft = document.getElementById('importCount40ft');
        
        if (importCount20ft) importCount20ft.value = count20ft;
        if (importCount40ft) importCount40ft.value = count40ft;
    }
    
    // Add new container row for Import
    const addImportContainerRowBtn = document.getElementById('addImportContainerRow');
    if (addImportContainerRowBtn) {
        addImportContainerRowBtn.addEventListener('click', function() {
            const containerRows = document.getElementById('importContainerRows');
            const newRow = containerRows.querySelector('.container-row').cloneNode(true);
            
            // Clear input values
            newRow.querySelectorAll('input').forEach(input => {
                input.value = '';
            });
            
            // Reset selects
            newRow.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Add event listeners to the new row
            addContainerRowEventListeners(newRow);
            
            // Append the new row
            containerRows.appendChild(newRow);
        });
    }
    
    // Add event listeners to container row
    function addContainerRowEventListeners(row) {
        // Add remove button event listener
        const removeBtn = row.querySelector('.remove-container');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                row.remove();
                // Update counts after removal
                updateImportContainerCounts();
            });
        }
        
        // Add container size change event listener
        const sizeSelect = row.querySelector('.container-size');
        if (sizeSelect) {
            sizeSelect.addEventListener('change', function() {
                // Update counts when size changes
                updateImportContainerCounts();
            });
        }
    }
    
    // Initialize event listeners for existing rows
    document.querySelectorAll('#importContainerRows .container-row').forEach(row => {
        addContainerRowEventListeners(row);
    });
    
    // Initial count update
    updateImportContainerCounts();
});
</script>

<!-- Actions Tab -->

<!-- list.js min js -->
<script src="{{url_for('static' ,filename='libs/list.js/dist/list.min.js')}}"></script>

<!--list pagination js-->
<script src="{{url_for('static' ,filename='libs/list.pagination.js/dist/list.pagination.min.js')}}"></script>

<!-- Sweet Alerts js -->
<script src="{{url_for('static' ,filename='libs/sweetalert2/dist/sweetalert2.min.js')}}"></script>

<!-- titcket init js -->
<script src="{{url_for('static' ,filename='js/pages/tasks-list.init.js')}}"></script>

<script>
    // This script enhances the edit task functionality in the tasks list view
// while preserving all other existing functionality

document.addEventListener('DOMContentLoaded', function() {
    const createTaskForm = document.getElementById('createTaskForm');
    const projectSelect = document.getElementById('projects');
    
    if (createTaskForm) {
        createTaskForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Get the selected project ID
            const projectId = document.getElementById('projects').value;
            if (!projectId) {
                alert('Please select a project');
                return;
            }
            
            // Create FormData
            const formData = new FormData();
            
            // Add form fields
            formData.append('title', document.getElementById('taskTitle').value);
            formData.append('description', document.getElementById('taskDescription').value);
            formData.append('category_id', document.getElementById('taskCategory').value);
            formData.append('assignee_id', document.getElementById('taskAssignee').value);
            formData.append('status_id', document.getElementById('taskStatus').value);
            formData.append('priority_id', document.getElementById('taskPriority').value);
            formData.append('due_date', document.getElementById('taskDueDate').value);
            formData.append('order_id', document.getElementById('order_id').value);

            // Add file attachments
            const attachments = document.getElementById('taskAttachments').files;
            for (let i = 0; i < attachments.length; i++) {
                formData.append('attachments', attachments[i]);
            }
            
            try {
                // Submit to the correct URL with the selected project ID
                const response = await fetch(`/tasks/api/projects/${projectId}/create-task`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message and close modal
                    Swal.fire({
                        title: 'Success',
                        text: 'Task created successfully',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    throw new Error(result.error || 'Failed to create task');
                }
            } catch (error) {
                console.error('Error creating task:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to create task',
                    icon: 'error'
                });
            }
        });
    }

    // Add event listener for project selection
    if (projectSelect) {
        projectSelect.addEventListener('change', function() {
            const selectedProjectId = this.value;
            if (selectedProjectId) {
                updateProjectFormData(selectedProjectId);
                
                // Load project settings if in edit mode
                const form = document.getElementById('createTaskForm');
                if (form && form.dataset.mode === 'edit') {
                    loadProjectSettings(selectedProjectId);
                }
            }
        });
    }

    // Add this to the existing DOMContentLoaded event handler
    // After the existing project select event listener

    // Trigger data loading when a project is selected
    if (projectSelect) {
        projectSelect.addEventListener('change', function() {
            const selectedProjectId = this.value;
            if (selectedProjectId) {
                // This function needs to fetch the project data and populate the dropdowns
                updateProjectFormData(selectedProjectId);
            }
        });
        
        // Also load data for the first project when the modal opens
        document.querySelector('.add-btn').addEventListener('click', function() {
            const initialProjectId = projectSelect.value;
            if (initialProjectId) {
                setTimeout(() => updateProjectFormData(initialProjectId), 300);
            }
        });
    }

    // Add event listener for category selection
    const categorySelect = document.getElementById('taskCategory');
    if (categorySelect) {
        categorySelect.addEventListener('change', function() {
            const selectedCategoryId = this.value;
            if (selectedCategoryId) {
                handleCategorySelection(selectedCategoryId);
            }
        });
    }

    // Reset form when modal is closed
    const closeButtons = document.querySelectorAll('[data-bs-dismiss="modal"]');
    closeButtons.forEach(button => {
        button.addEventListener('click', resetTaskForm);
    });

    // Also reset when modal is hidden
    const modal = document.getElementById('showModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', resetTaskForm);
    }

    // Initialize attachment handling
    const taskAttachments = document.getElementById('taskAttachments');
    if (taskAttachments) {
        taskAttachments.addEventListener('change', handleFileSelect);
    }

    // Format tasks for review
    formatTasksListForReview();
});


function formatTasksListForReview() {
    // Find all tasks in the list
    const taskRows = document.querySelectorAll('.task-row');
    
    taskRows.forEach(row => {
        const isDone = row.getAttribute('data-is-done') === '1';
        const isReviewed = row.getAttribute('data-is-reviewed') === '1';
        
        if (isDone && !isReviewed) {
            // Highlight tasks that need review
            row.classList.add('needs-review');
            
            // Add a badge
            const statusCell = row.querySelector('.task-status');
            if (statusCell) {
                const reviewBadge = document.createElement('span');
                reviewBadge.className = 'badge bg-warning ms-2';
                reviewBadge.textContent = 'Needs Review';
                statusCell.appendChild(reviewBadge);
            }
        } else if (isDone && isReviewed) {
            // Add reviewed badge
            const statusCell = row.querySelector('.task-status');
            if (statusCell) {
                const reviewedBadge = document.createElement('span');
                reviewedBadge.className = 'badge bg-success ms-2';
                reviewedBadge.textContent = 'Reviewed';
                statusCell.appendChild(reviewedBadge);
            }
        }
    });
}


// Enhanced helper functions for status and priority colors
function getStatusColor(status) {
    const colors = {
        'New': 'info',
        'In Progress': 'warning',
        'Completed': 'success',
        'Pending': 'danger'
    };
    return colors[status] || 'secondary';
}

function getPriorityColor(priority) {
    const colors = {
        'High': 'danger',
        'Medium': 'warning',
        'Low': 'success'
    };
    return colors[priority] || 'secondary';
}

// Function to create new task
function createTask(event) {
    event.preventDefault();
    const form = document.getElementById('createTaskForm');
    const formData = new FormData(form);
    
    const data = {
        title: formData.get('tasksTitle-field'),
        description: formData.get('description'),
        priority: formData.get('priority-field'),
        status: formData.get('ticket-status'),
        due_date: formData.get('duedate-field'),
        assigned_to: formData.get('assignedTo[]')
    };

    fetch('/tasks/api/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if(data.task_id) {
            // Close modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('showModal'));
            modal.hide();
            
            // Reload tasks
            loadTasks();
            
            // Show success message
            Swal.fire({
                title: 'Success!',
                text: 'Task created successfully',
                icon: 'success',
                confirmButtonClass: 'btn btn-primary w-xs mt-2',
                buttonsStyling: false
            });
        }
    })
    .catch(error => console.error('Error:', error));
}

// Function to delete task
function deleteTask(taskId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonClass: 'btn btn-primary w-xs me-2 mt-2',
        cancelButtonClass: 'btn btn-danger w-xs mt-2',
        confirmButtonText: 'Yes, delete it!',
        buttonsStyling: false,
        showCloseButton: true
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/tasks/api/tasks/${taskId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    // If server returns an error, throw it to be caught
                    return response.json().then(data => {
                        throw new Error(data.error || 'Unknown error occurred');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Instead of calling loadTasks(), reload the page
                Swal.fire({
                    title: 'Deleted!',
                    text: 'Task has been deleted.',
                    icon: 'success',
                    confirmButtonClass: 'btn btn-primary w-xs mt-2',
                    buttonsStyling: false
                }).then(() => {
                    // Reload page after confirmation
                    window.location.reload();
                });
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: `Failed to delete task: ${error.message}`,
                    icon: 'error',
                    confirmButtonClass: 'btn btn-primary w-xs mt-2',
                    buttonsStyling: false
                });
            });
        }
    });
}

// Enhanced edit task function
window.editTask = async function(taskId) {
    try {
        // Show loading state
        const modalTitle = document.querySelector('#showModal .modal-title');
        const submitButton = document.getElementById('createTaskBtn');
        
        if (modalTitle) modalTitle.textContent = 'Loading Task...';
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';
        }
        
        // Set the form in edit mode
        const form = document.getElementById('createTaskForm');
        form.dataset.mode = 'edit';
        form.dataset.taskId = taskId;
        
        // Show the modal first
        const modal = new bootstrap.Modal(document.getElementById('showModal'));
        modal.show();
        
        // Fetch task data
        const response = await fetch(`/tasks/api/tasks/${taskId}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch task: ${response.status}`);
        }
        
        const task = await response.json();
        console.log("Task data for editing:", task);
        
        // Update modal UI
        if (modalTitle) modalTitle.textContent = 'Edit Task';
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Update Task';
        }
        
        // Get project ID and load project data first
        if (task.project && task.project.id) {
            const projectSelect = document.getElementById('projects');
            if (projectSelect) {
                projectSelect.value = task.project.id;
                
                // Now load project data
                try {
                    await updateProjectFormData(task.project.id);
                    // Also load project settings
                    await loadProjectSettings(task.project.id);
                    
                    // After project data is loaded, populate all form fields
                    populateFormFields(task);
                } catch (error) {
                    console.error("Error updating project data:", error);
                    // Continue with populating basic fields even if project data loading fails
                    populateFormFields(task);
                }
            } else {
                // If no project select, just populate the fields directly
                populateFormFields(task);
            }
        } else {
            // No project data, populate what we can
            populateFormFields(task);
        }
    } catch (error) {
        console.error('Error in editTask:', error);
        Swal.fire({
            title: 'Error',
            text: 'Failed to load task data: ' + error.message,
            icon: 'error'
        });
        
        // Reset form and close modal on error
        resetTaskForm();
        const modal = bootstrap.Modal.getInstance(document.getElementById('showModal'));
        if (modal) {
            modal.hide();
            // After modal is hidden, ensure backdrop is removed
            document.querySelector('.modal-backdrop')?.remove();
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
        }
    }
};

// Function to populate form fields
function populateFormFields(task) {
    console.log("Populating form fields with:", task);
    
    // Basic fields that don't depend on drop-downs
    const titleField = document.getElementById('taskTitle');
    const descriptionField = document.getElementById('taskDescription');
    
    if (titleField) titleField.value = task.title || '';
    if (descriptionField) descriptionField.value = task.description || '';
    
    // Fields that depend on drop-downs being populated
    const categorySelect = document.getElementById('taskCategory');
    const statusSelect = document.getElementById('taskStatus');
    const prioritySelect = document.getElementById('taskPriority');
    const assigneeSelect = document.getElementById('taskAssignee');
    const dueDateField = document.getElementById('taskDueDate');
    
    if (categorySelect && task.category_id) {
        categorySelect.value = task.category_id;
    }
    
    if (statusSelect && task.status_id) {
        statusSelect.value = task.status_id;
    }
    
    if (prioritySelect && task.priority_id) {
        prioritySelect.value = task.priority_id;
    }
    
    if (assigneeSelect && task.assignee_id) {
        assigneeSelect.value = task.assignee_id;
    }
    
    // Handle due date
    if (dueDateField && task.due_date) {
        try {
            const dueDateObj = new Date(task.due_date);
            const formattedDate = dueDateObj.toISOString().split('T')[0]; // Format as YYYY-MM-DD
            dueDateField.value = formattedDate;
        } catch (error) {
            console.error("Error formatting due date:", error);
        }
    }
    
    // Setup due date field based on project settings
    setupTaskDueDateField(task);
    
    // Handle attachments if any
    const attachmentList = document.getElementById('attachmentList');
    if (attachmentList) {
        attachmentList.innerHTML = '';
        
        if (task.attachments && task.attachments.length > 0) {
            task.attachments.forEach(attachment => {
                const fileIcon = getFileIcon(attachment.file_name);
                
                attachmentList.innerHTML += `
                    <div class="d-flex align-items-center mt-2 border rounded p-2">
                        <i class="${fileIcon} fs-20 me-2"></i>
                        <div class="flex-grow-1">
                            <div class="fw-medium">${attachment.file_name}</div>
                            <small class="text-muted">Uploaded by ${attachment.uploaded_by || 'Unknown'}</small>
                        </div>
                        <a href="/tasks/download_attachment/${attachment.id}" class="btn btn-ghost-primary btn-icon btn-sm me-1">
                            <i class="ri-download-line"></i>
                        </a>
                        <button type="button" class="btn btn-ghost-danger btn-icon btn-sm" onclick="deleteAttachment(${attachment.id})">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>
                `;
            });
        }
    }
}

// Make sure this function properly loads and fills the dropdowns
async function updateProjectFormData(projectId) {
    try {
        // Fetch project form data from the API
        const response = await fetch(`/tasks/api/projects/${projectId}/form-data`);
        if (!response.ok) {
            throw new Error('Failed to load project data');
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to load project data');
        }
        
        // Update categories dropdown
        const categorySelect = document.getElementById('taskCategory');
        if (categorySelect) {
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            result.data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }
        
        // Update statuses dropdown
        // Update statuses dropdown
        const statusSelect = document.getElementById('taskStatus');
        if (statusSelect) {
            statusSelect.innerHTML = '<option value="">Select Status</option>';
            result.data.statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status.id;
                option.textContent = status.name;
                if (status.task_status_id == 1) {  // Note: use == not === for type flexibility
                    option.selected = true;
                }
                statusSelect.appendChild(option);
            });
        }
        
        // Update priorities dropdown
        const prioritySelect = document.getElementById('taskPriority');
        if (prioritySelect) {
            prioritySelect.innerHTML = '<option value="">Select Priority</option>';
            result.data.priorities.forEach(priority => {
                const option = document.createElement('option');
                option.value = priority.id;
                option.textContent = priority.name;
                prioritySelect.appendChild(option);
            });
        }
        
        // Update assignee dropdown
        const assigneeSelect = document.getElementById('taskAssignee');
        if (assigneeSelect) {
            assigneeSelect.innerHTML = '<option value="">Unassigned</option>';
            result.data.team_members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                assigneeSelect.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Error loading project form data:', error);
        // Show error to user
        alert('Failed to load project data: ' + error.message);
    }
}


// Function to load project settings (for due date handling)
async function loadProjectSettings(projectId) {
    try {
        const response = await fetch(`/tasks/api/projects/${projectId}`);
        const projectData = await response.json();
        
        window.projectSettings = {
            allowDueDateAssignment: projectData.allow_due_date_assignment,
            projectType: projectData.project_type
        };
        
        console.log("Loaded project settings:", window.projectSettings);
        return window.projectSettings;
    } catch (error) {
        console.error('Error loading project settings:', error);
        
        // Default settings
        window.projectSettings = {
            allowDueDateAssignment: true,
            projectType: 'general'
        };
        
        return window.projectSettings;
    }
}

// Function to setup due date field based on project settings
function setupTaskDueDateField(task) {
    const dueDateField = document.getElementById('taskDueDate');
    if (!dueDateField) return;
    
    const dueDateContainer = dueDateField.closest('.mb-3');
    if (!dueDateContainer) return;
    
    const dueDateHelperText = document.getElementById('dueDateHelperText');
    
    // Check if we have project settings
    if (!window.projectSettings) {
        console.log("No project settings, assuming manual due date allowed");
        return; // No special handling needed
    }
    
    if (window.projectSettings.allowDueDateAssignment) {
        // Enable manual due date editing
        dueDateField.removeAttribute('disabled');
        dueDateField.style.display = 'block';
        
        // Remove any read-only display
        const readOnlyDisplay = dueDateContainer.querySelector('.due-date-readonly');
        if (readOnlyDisplay) {
            readOnlyDisplay.style.display = 'none';
        }
        
        // Update helper text
        if (dueDateHelperText) {
            dueDateHelperText.textContent = 'You can modify the due date';
        }
    } else {
        // For automatic due date, show it as read-only
        dueDateField.style.display = 'none';
        dueDateField.setAttribute('disabled', 'disabled');
        
        // Create or update read-only display
        let readOnlyDisplay = dueDateContainer.querySelector('.due-date-readonly');
        if (!readOnlyDisplay) {
            readOnlyDisplay = document.createElement('div');
            readOnlyDisplay.className = 'due-date-readonly form-control-plaintext';
            readOnlyDisplay.style.marginTop = '8px';
            dueDateField.after(readOnlyDisplay);
        }
        
        // Show original due date
        if (task.due_date) {
            const dueDate = new Date(task.due_date);
            const displayDate = dueDate.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            });
            
            readOnlyDisplay.innerHTML = `<strong>${displayDate}</strong>`;
            
            // Update helper text
            if (dueDateHelperText) {
                dueDateHelperText.textContent = 'Due date calculated based on category SLA';
            }
        } else {
            readOnlyDisplay.textContent = 'No due date set';
            
            // Update helper text
            if (dueDateHelperText) {
                dueDateHelperText.textContent = 'Due date will be calculated when task is updated';
            }
        }
    }
}

// Handle category selection - update assignee and due date
function handleCategorySelection(categoryId) {
    if (!window.currentProjectData) return;
    
    // Find the selected category in our data
    const category = window.currentProjectData.categories.find(c => c.id == categoryId);
    if (!category) return;
    
    console.log("Selected category:", category);
    
    // Auto-assign to category lead if exists
    const assigneeSelect = document.getElementById('taskAssignee');
    if (category.category_lead && assigneeSelect) {
        assigneeSelect.value = category.category_lead.id;
        console.log(`Auto-assigned to category lead: ${category.category_lead.name}`);
    }
    
    // If manual due date assignment is disabled, calculate based on SLA
    if (window.projectSettings && !window.projectSettings.allowDueDateAssignment) {
        const dueDateField = document.getElementById('taskDueDate');
        if (!dueDateField) return;
        
        const slaHours = category.sla_hours || 24; // Default to 24 hours
        
        // Calculate due date
        const now = new Date();
        const dueDate = new Date(now.getTime() + (slaHours * 60 * 60 * 1000));
        
        // Format for storage (YYYY-MM-DD)
        const formattedDate = dueDate.toISOString().slice(0, 10);
        dueDateField.value = formattedDate;
        
        // Update display for read-only mode
        const dueDateContainer = dueDateField.closest('.mb-3');
        if (dueDateContainer) {
            let readOnlyDisplay = dueDateContainer.querySelector('.due-date-readonly');
            if (!readOnlyDisplay) {
                readOnlyDisplay = document.createElement('div');
                readOnlyDisplay.className = 'due-date-readonly form-control-plaintext';
                readOnlyDisplay.style.marginTop = '8px';
                dueDateField.after(readOnlyDisplay);
            }
            
            // Format for display
            const displayDate = dueDate.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            });
            
            readOnlyDisplay.innerHTML = `<strong>${displayDate}</strong>`;
            
            // Update helper text
            const dueDateHelperText = document.getElementById('dueDateHelperText');
            if (dueDateHelperText) {
                dueDateHelperText.innerHTML = `Due date calculated as <strong>${slaHours} hours</strong> from now (per category SLA)`;
            }
        }
    }
}

// Reset form function
function resetTaskForm() {
    const form = document.getElementById('createTaskForm');
    if (!form) return;
    
    form.reset();
    delete form.dataset.mode;
    delete form.dataset.taskId;
    
    // Reset modal title and button
    const modalTitle = document.querySelector('#showModal .modal-title');
    const submitButton = document.getElementById('createTaskBtn');
    
    if (modalTitle) modalTitle.textContent = 'Create Task';
    if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = 'Create Task';
    }
    
    // Clear attachment list
    const attachmentList = document.getElementById('attachmentList');
    if (attachmentList) {
        attachmentList.innerHTML = '';
    }
    
    // Reset due date field
    const dueDateField = document.getElementById('taskDueDate');
    if (dueDateField) {
        dueDateField.removeAttribute('disabled');
        dueDateField.style.display = 'block';
        
        // Remove read-only display if exists
        const dueDateContainer = dueDateField.closest('.mb-3');
        if (dueDateContainer) {
            const readOnlyDisplay = dueDateContainer.querySelector('.due-date-readonly');
            if (readOnlyDisplay) {
                readOnlyDisplay.remove();
            }
        }
    }
    
    // Clear helper text
    const dueDateHelperText = document.getElementById('dueDateHelperText');
    if (dueDateHelperText) {
        dueDateHelperText.textContent = '';
    }

    setTimeout(() => {
        if (!document.querySelector('.modal.show') && document.querySelector('.modal-backdrop')) {
            document.querySelector('.modal-backdrop').remove();
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
        }
    }, 200);
}

// Delete attachment function
function deleteAttachment(attachmentId) {
    const taskId = document.getElementById('createTaskForm').dataset.taskId;
    if (!taskId) return;
    
    Swal.fire({
        title: 'Delete Attachment',
        text: 'Are you sure you want to delete this attachment?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/tasks/api/tasks/${taskId}/attachments/${attachmentId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove attachment from list
                    const attachmentElement = document.querySelector(`button[onclick="deleteAttachment(${attachmentId})"]`).closest('.d-flex');
                    attachmentElement.remove();
                    
                    Swal.fire({
                        title: 'Deleted!',
                        text: 'Attachment has been deleted.',
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else {
                    throw new Error(data.error || 'Failed to delete attachment');
                }
            })
            .catch(error => {
                console.error('Error deleting attachment:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to delete attachment',
                    icon: 'error'
                });
            });
        }
    });
}

// Handle file selection for attachments
function handleFileSelect(event) {
    const files = event.target.files;
    const attachmentList = document.getElementById('attachmentList');
    
    if (!attachmentList) return;
    
    // Clear list if we're not in edit mode
    const form = document.getElementById('createTaskForm');
    if (!form || !form.dataset.mode) {
        attachmentList.innerHTML = '';
    }
    
    Array.from(files).forEach(file => {
        const fileSize = (file.size / 1024).toFixed(2);
        const fileExtension = file.name.split('.').pop().toLowerCase();
        let iconClass = getFileIcon(file.name);
        
        attachmentList.innerHTML += `
            <div class="d-flex align-items-center mt-2 border rounded p-2">
                <i class="${iconClass} fs-20 me-2"></i>
                <div class="flex-grow-1">
                    <div class="fw-medium">${file.name}</div>
                    <small class="text-muted">${fileSize} KB</small>
                </div>
                <button type="button" class="btn btn-ghost-danger btn-icon btn-sm" onclick="removeAttachment(this)">
                    <i class="ri-delete-bin-line"></i>
                </button>
            </div>
        `;
    });
}

// Remove attachment from form
function removeAttachment(button) {
    const attachmentDiv = button.closest('.d-flex');
    attachmentDiv.remove();
    
    // Clear the file input if all attachments are removed
    if (document.getElementById('attachmentList').children.length === 0) {
        document.getElementById('taskAttachments').value = '';
    }
}

// Get file icon based on extension
function getFileIcon(fileName) {
    if (!fileName) return 'ri-file-text-line';
    
    const ext = fileName.split('.').pop().toLowerCase();
    
    if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
        return 'ri-image-line';
    } else if (ext === 'pdf') {
        return 'ri-file-pdf-line';
    } else if (['doc', 'docx'].includes(ext)) {
        return 'ri-file-word-line';
    } else if (['xls', 'xlsx'].includes(ext)) {
        return 'ri-file-excel-line';
    } else if (['ppt', 'pptx'].includes(ext)) {
        return 'ri-file-ppt-line';
    } else if (['zip', 'rar', 'tar', 'gz'].includes(ext)) {
        return 'ri-file-zip-line';
    } else {
        return 'ri-file-text-line';
    }
}


</script>

<!-- filter -->
<script>
    /**
 * Comprehensive Task Filtering System
 * This script properly handles all filters including:
 * 1. "My Tasks" vs "My Connected Tasks" separation
 * 2. Text search
 * 3. Date range filter
 * 4. Status filter with dynamic status loading
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log("Starting comprehensive filter system setup...");
    
    // Get filter elements
    const viewFilter = document.getElementById('idTaskView');
    const searchInput = document.querySelector('.search');
    const dateRangePicker = document.getElementById('demo-datepicker');
    const statusFilter = document.getElementById('idStatus');
    
    if (!viewFilter) {
        console.error("View filter element not found");
        return;
    }
    
    // Store the current user ID for comparison
    const currentUserId = '{{ current_user.id }}';
    console.log(`Current user ID: ${currentUserId}`);

    // First, load status options into the status dropdown
    loadTaskStatuses();
    
    window.updateNoResultsMessage = function() {
        // Get all rows in the table
        const allRows = document.querySelectorAll('#tasksTable tbody tr');
        
        // Count visible rows (those not set to display:none)
        const visibleRows = Array.from(allRows).filter(row => row.style.display !== 'none');
        
        // Get the "no results" message element
        const noResultDiv = document.querySelector('.noresult');
        
        // Only show the "no results" message if there are no visible rows
        if (noResultDiv) {
            // If there are visible rows, hide the message; otherwise show it
            noResultDiv.style.display = visibleRows.length === 0 ? 'block' : 'none';
        }
    };


    const originalSearchData = window.SearchData;
    
    // Override the SearchData function to ensure the "no results" message is properly updated
    window.SearchData = function() {
        // Call the original function if it exists
        if (typeof originalSearchData === 'function') {
            originalSearchData();
        }
        
        // Make sure the "no results" message is properly updated
        window.updateNoResultsMessage();
    };
    
    // Call the function on page load to ensure the message is hidden initially
    window.updateNoResultsMessage();
    /**
     * Reset all rows to visible state
     * This is critical to ensure filters work correctly
     */
    function resetRowVisibility() {
        const allRows = document.querySelectorAll('#tasksTable tbody tr');
        allRows.forEach(row => {
            row.style.display = '';
        });
        return allRows;
    }
    
    /**
     * Load task statuses from the table into the status dropdown
     */
    function loadTaskStatuses() {
        // Keep only first two options (blank and "All")
        while (statusFilter && statusFilter.options.length > 2) {
            statusFilter.remove(2);
        }
        
        // Extract unique statuses from the table
        const statusSet = new Set();
        document.querySelectorAll('#tasksTable .status .badge').forEach(badge => {
            // Extract the status text (ignoring any badges for connected tasks)
            const statusText = badge.textContent.trim();
            if (statusText && statusText !== 'Not Set' && !badge.classList.contains('bg-info')) {
                statusSet.add(statusText);
            }
        });
        
        // Add unique statuses to dropdown
        if (statusFilter) {
            statusSet.forEach(status => {
                const option = document.createElement('option');
                option.value = status.toLowerCase();
                option.textContent = status;
                statusFilter.appendChild(option);
            });
            
            console.log(`Added ${statusSet.size} statuses to dropdown`);
        }
    }
    
    /**
     * Apply all filters in the correct sequence
     */
    function applyAllFilters(rows) {
        // Get filter values
        const viewMode = viewFilter.value;
        const searchText = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const dateRange = dateRangePicker ? dateRangePicker.value : '';
        const statusValue = statusFilter ? statusFilter.value.toLowerCase() : '';
        
        console.log(`Applying filters - View: ${viewMode}, Search: "${searchText}", Date Range: ${dateRange}, Status: ${statusValue}`);
        
        // Parse date range if provided
        let startDate = null;
        let endDate = null;
        
        if (dateRange) {
            const dateValues = parseDateRange(dateRange);
            startDate = dateValues.startDate;
            endDate = dateValues.endDate;
        }
        
        // Track statistics
        let hiddenCount = 0;
        let visibleCount = 0;
        let myTasksCount = 0;
        let connectedTasksCount = 0;
        
        // Apply all filters to each row
        // rows.forEach(row => {
        //     // Extract row data
        //     const taskId = row.getAttribute('data-task-id');
        //     const assignedTo = row.getAttribute('data-assigned-to');
        //     const hasVisibility = row.getAttribute('data-has-visibility') === 'true';
        //     const isDone = row.getAttribute('data-is-done') === '1';
        //     const isReviewed = row.getAttribute('data-is-reviewed') === '1';

        //     // Check if user is a reviewer for this task
        //     const isReviewer = row.hasAttribute('data-is-reviewer') && 
        //                     row.getAttribute('data-is-reviewer') === 'true';

        //     // View filter - My Tasks vs My Connected Tasks
        //     const isMyTask = assignedTo === currentUserId;
        //     const isConnectedTask = hasVisibility && assignedTo !== currentUserId; // Only count connected if NOT assigned
        //     let passesViewFilter = false;

        //     const createdBy = row.getAttribute('data-created-by');
        //     const isCreator = createdBy === currentUserId;
            
        //     // Change needed around line 731-742 where the view filter is applied
        //     if (viewMode === 'my_tasks') {
        //         // Previously only checking if assigned to user
        //         // Need to modify to include tasks pending review for reviewers
        //         passesViewFilter = isMyTask || isCreator || (isReviewer && isDone && !isReviewed);
        //         if (isMyTask) myTasksCount++;
        //         if (isReviewer && isDone && !isReviewed) myTasksCount++;
        //     } else if (viewMode === 'connected_tasks') {
        //         // For reviewers: only show tasks that have been reviewed in connected tasks
        //         // For non-reviewers: show all connected tasks
        //         if (isReviewer) {
        //             passesViewFilter = (isConnectedTask && !(isDone && !isReviewed)) || 
        //                             (isDone && isReviewed);
        //         } else {
        //             passesViewFilter = isConnectedTask;
        //         }
                
        //         if (passesViewFilter) connectedTasksCount++;
        //     }
            
        //     // Text search filter
        //     let passesSearchFilter = true;
        //     if (searchText) {
        //         const rowText = row.textContent.toLowerCase();
        //         passesSearchFilter = rowText.includes(searchText);
        //     }
            
        //     // Status filter
        //     let passesStatusFilter = true;
        //     if (statusValue && statusValue !== 'all') {
        //         const statusCell = row.querySelector('.status');
        //         const statusBadge = statusCell ? statusCell.querySelector('.badge:not(.bg-info)') : null;
        //         let statusText = '';
                
        //         if (statusBadge) {
        //             statusText = statusBadge.textContent.trim().toLowerCase();
        //         } else if (statusCell) {
        //             statusText = statusCell.textContent.trim().toLowerCase();
        //         }
                
        //         passesStatusFilter = statusText.includes(statusValue);
        //     }
            
        //     // Date filter
        //     let passesDateFilter = true;
        //     if (startDate && endDate) {
        //         const dueDateCell = row.querySelector('.due_date');
        //         if (dueDateCell) {
        //             const dueDateText = dueDateCell.textContent.trim();
        //             if (dueDateText && dueDateText !== '-') {
        //                 const dueDate = parseDate(dueDateText);
        //                 passesDateFilter = dueDate && dueDate >= startDate && dueDate <= endDate;
        //             } else {
        //                 // No due date, doesn't pass date filter
        //                 passesDateFilter = false;
        //             }
        //         }
        //     }
            
        //     // Combine all filters (AND logic)
        //     const isVisible = passesViewFilter && passesSearchFilter && 
        //                       passesStatusFilter && passesDateFilter;
            
        //     // Apply visibility
        //     row.style.display = isVisible ? '' : 'none';
            
        //     // Count for statistics
        //     if (isVisible) {
        //         visibleCount++;
        //     } else {
        //         hiddenCount++;
        //     }
        // });
        
        console.log(`Filter results: ${visibleCount} shown, ${hiddenCount} hidden`);
        console.log(`My tasks: ${myTasksCount}, Connected tasks: ${connectedTasksCount}`);
        
        // Update stats and handle no results
        updateTaskCounters(rows);
        toggleNoResultsMessage(visibleCount === 0);
    }
    
    /**
     * Helper function to update task counters in UI
     */
    function updateTaskCounters(allRows) {
        const visibleRows = Array.from(allRows).filter(row => row.style.display !== 'none');
        
        // Count total, pending and completed
        const totalCount = visibleRows.length;
        const pendingCount = visibleRows.filter(row => row.getAttribute('data-is-done') !== '1').length;
        const completedCount = visibleRows.filter(row => row.getAttribute('data-is-done') === '1').length;
        
        // Update counter elements
        const counterElements = document.querySelectorAll('.counter-value');
        if (counterElements.length >= 3) {
            counterElements[0].setAttribute('data-target', totalCount);
            counterElements[0].textContent = totalCount;
            
            counterElements[1].setAttribute('data-target', pendingCount);
            counterElements[1].textContent = pendingCount;
            
            counterElements[2].setAttribute('data-target', completedCount);
            counterElements[2].textContent = completedCount;
        }
    }
    
    /**
     * Helper function to toggle no results message
     */
    function toggleNoResultsMessage(show) {
        const noResultDiv = document.querySelector('.noresult');
        if (noResultDiv) {
            noResultDiv.style.display = show ? 'block' : 'none';
        }
    }
    
    /**
     * Helper function to parse date strings from the table
     */
    function parseDate(dateStr) {
        if (!dateStr || dateStr === '-') return null;
        
        try {
            // Format: "15 Feb, 2023"
            const formatRegex = /(\d+)\s+([A-Za-z]+),?\s+(\d{4})/;
            const match = dateStr.match(formatRegex);
            
            if (match) {
                const day = match[1].padStart(2, '0');
                const month = getMonthNumber(match[2]);
                const year = match[3];
                return new Date(`${year}-${month}-${day}`);
            }
            
            // Try direct parsing as fallback
            const directDate = new Date(dateStr);
            if (!isNaN(directDate.getTime())) {
                return directDate;
            }
        } catch (error) {
            console.error(`Error parsing date: ${dateStr}`, error);
        }
        
        return null;
    }
    
    /**
     * Helper function to parse a date range string
     */
    function parseDateRange(dateRange) {
        let startDate = null;
        let endDate = null;
        
        if (dateRange.includes('to')) {
            // Format: "15 Feb, 2023 to 20 Feb, 2023"
            const dates = dateRange.split('to').map(d => d.trim());
            if (dates.length === 2) {
                startDate = parseDate(dates[0]);
                endDate = parseDate(dates[1]);
                
                // Set end date to end of day for inclusive comparison
                if (endDate) {
                    endDate = new Date(endDate);
                    endDate.setHours(23, 59, 59, 999);
                }
            }
        } else {
            // Single date
            startDate = parseDate(dateRange);
            endDate = parseDate(dateRange);
            
            // Set end date to end of day for inclusive comparison
            if (endDate) {
                endDate = new Date(endDate);
                endDate.setHours(23, 59, 59, 999);
            }
        }
        
        return { startDate, endDate };
    }
    
    /**
     * Helper function to convert month name to number
     */
    function getMonthNumber(monthName) {
        const months = {
            'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04', 
            'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
            'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
        };
        return months[monthName.substring(0, 3)] || '01';
    }
    
    // Set up event listeners for all filter controls
    // Update URL when view filter changes
    if (viewFilter) {
        viewFilter.addEventListener('change', function() {
            console.log(`View filter changed to: ${this.value}`);
            
            // Update URL with the new filter value without reloading the page
            const url = new URL(window.location.href);
            url.searchParams.set('taskView', this.value);
            
            // Replace current history state without reloading
            window.history.replaceState({}, '', url.toString());
            console.log(`Updated URL to: ${url.toString()}`);
            
            // Then apply filters
            window.SearchData();
        });
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            window.SearchData();
        });
    }
    
    if (dateRangePicker) {
        // Initialize the flatpickr date picker if it isn't already
        if (typeof flatpickr === 'function' && !dateRangePicker._flatpickr) {
            flatpickr(dateRangePicker, {
                mode: "range",
                dateFormat: "d M, Y",
                clear: true,
                onChange: function() {
                    window.SearchData();
                }
            });
        }

        dateRangePicker.addEventListener('change', function() {
            window.SearchData();
        });
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            window.SearchData();
        });
    }
    
    // Apply initial filtering after a short delay to ensure the page is fully loaded
    setTimeout(window.SearchData, 500);
});

// Simple filter parameter handler
document.addEventListener('DOMContentLoaded', function() {
  // Check URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const taskViewParam = urlParams.get('taskView');
  
  if (taskViewParam) {
    // If there's a taskView parameter in the URL, update the filter dropdown
    const taskViewSelect = document.getElementById('idTaskView');
    if (taskViewSelect && (taskViewParam === 'my_tasks' || taskViewParam === 'connected_tasks')) {
      taskViewSelect.value = taskViewParam;
      
      // Apply filter (using the existing SearchData function)
      if (typeof SearchData === 'function') {
        SearchData();
      }
    }
  }
});

</script>
    
<!-- 4. Add a small CSS to highlight connected tasks (optional) -->
<style>
/* Connected task styling */
tr[data-has-visibility="true"]:not([data-assigned-to="{{ current_user.id }}"]) {
    background-color: rgba(0, 149, 255, 0.01); /* Light blue background */
}

/* Badge for connected tasks */
.connected-badge {
    font-size: 10px;
    padding: 2px 5px;
    margin-left: 5px;
    background-color: #0d6efd;
    color: white;
}
</style>



<!-- Document Management Script -->
<script>
    // Document Management JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // ===== Document Management Functions =====
    
    // Initialize variables
    let currentShipmentId = null;
    
    // Get shipment ID from the form or URL
    const shipmentIdInput = document.getElementById('shipmentId');
    if (shipmentIdInput && shipmentIdInput.value) {
        currentShipmentId = shipmentIdInput.value;
        initializeDocumentManagement(currentShipmentId);
    }
    
    // Initialize Document Management
    function initializeDocumentManagement(shipmentId) {
        if (!shipmentId) return;
        
        // Load documents
        loadDocuments(shipmentId);
        
        // Set up event listeners
        setupDocumentEventListeners(shipmentId);
    }
    
    // Load documents for a shipment
    function loadDocuments(shipmentId) {
    const documentsTable = document.getElementById('documentsTable');
    if (!documentsTable) {
        console.error('Documents table not found');
        return;
    }

    const tableBody = documentsTable.querySelector('tbody');
    if (!tableBody) {
        console.error('Table body not found');
        return;
    }

    // Show loading state
    tableBody.innerHTML = `
        <tr>
            <td colspan="6" class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </td>
        </tr>
    `;

    fetch(`/masters/entries/${shipmentId}/documents`)
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        // Clear loading state
        tableBody.innerHTML = '';

        if (data.success) {
            if (data.documents.length > 0) {
                data.documents.forEach(doc => {
                    // Create row using innerHTML instead of createElement
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="${getFileIconClass(doc.document_name)} fs-18 me-2 text-primary"></i>
                                <div>${doc.document_name}</div>
                            </div>
                        </td>
                        <td><span class="badge badge-soft-info">${doc.document_type}</span></td>
                        <td>${doc.description || ''}</td>
                        <td>${doc.uploaded_by_name || 'Unknown'}</td>
                        <td>${formatDate(doc.created_at)}</td>
                        <td>
                            <div class="d-flex gap-2">
                                <a href="/masters/entries/${shipmentId}/document/${doc.id}/view" 
                                   class="btn btn-sm btn-soft-primary" target="_blank">
                                    <i class="ri-eye-line"></i>
                                </a>

                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                // Show no documents message
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="text-muted">
                                <i class="ri-folder-info-line fs-24 mb-2 d-block"></i>
                                <p>No documents found. Upload documents using the button above.</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
        } else {
            // Show error message
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger">
                        ${data.message || 'Failed to load documents'}
                    </td>
                </tr>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading documents:', error);
        
        // Show error in table body
        const tableBody = document.querySelector('#documentsTable tbody');
        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-danger">
                        An unexpected error occurred while loading documents
                    </td>
                </tr>
            `;
        }
    });
}

    // Create document table row
    function createDocumentRow(document, shipmentId) {
        const row = document.createElement('tr');
        
        // Format date
        const uploadDate = new Date(document.created_at);
        const formattedDate = uploadDate.toLocaleDateString('en-US', {
            day: '2-digit',
            month: 'short',
            year: 'numeric'
        });
        
        row.innerHTML = `
            <th scope="row">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="document_check" value="${document.id}">
                </div>
            </th>
            <td class="document_name">
                <div class="d-flex align-items-center">
                    <i class="${getFileIconClass(document.document_name)} fs-20 me-2"></i>
                    <div>${document.document_name}</div>
                </div>
            </td>
            <td class="document_type"><span class="badge badge-soft-${getTypeBadgeColor(document.document_type)}">${document.document_type}</span></td>
            <td class="document_size">${formatFileSize(document.file_size)}</td>
            <td class="uploaded_by">${document.uploaded_by_name || 'System'}</td>
            <td class="upload_date">${formattedDate}</td>
            <td class="actions">
                <div class="d-flex gap-2">
                    <a href="/masters/entries/${shipmentId}/documents/${document.id}/view" class="btn btn-sm btn-soft-primary view-document" data-id="${document.id}" title="View" target="_blank">
                        <i class="ri-eye-line"></i>
                    </a>
                    <button class="btn btn-sm btn-soft-info edit-document" data-id="${document.id}" title="Edit">
                        <i class="ri-pencil-line"></i>
                    </button>
                    <button class="btn btn-sm btn-soft-danger delete-document" data-id="${document.id}" title="Delete">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </div>
            </td>
        `;
        
        return row;
    }
    
    // Set up document event listeners
    function setupDocumentEventListeners(shipmentId) {
        // Document form submission
        const documentForm = document.getElementById('documentForm');
        if (documentForm) {
            documentForm.addEventListener('submit', function(event) {
                event.preventDefault();
                handleDocumentFormSubmit(shipmentId);
            });
        }
        
        // Document file input change
        const documentFileInput = document.getElementById('documentFile');
        if (documentFileInput) {
            documentFileInput.addEventListener('change', handleDocumentFileSelect);
        }
        
        // Check all documents checkbox
        const checkAllDocuments = document.getElementById('checkAllDocuments');
        if (checkAllDocuments) {
            checkAllDocuments.addEventListener('change', toggleAllDocumentCheckboxes);
        }
        
        // Document upload button
        const uploadDocumentBtn = document.querySelector('[data-bs-target="#documentModal"]');
        if (uploadDocumentBtn) {
            uploadDocumentBtn.addEventListener('click', function() {
                resetDocumentForm();
                
                // Set modal title and button text
                const modalTitle = document.getElementById('documentModalLabel');
                const submitButton = document.getElementById('saveDocument');
                
                if (modalTitle) modalTitle.textContent = 'Upload Document';
                if (submitButton) submitButton.textContent = 'Upload Document';
                
                // Hide edit-only fields
                const editOnlyFields = document.querySelectorAll('.edit-only-fields');
                editOnlyFields.forEach(field => field.classList.add('d-none'));
                
                // Make file input required in add mode
                documentFileInput.setAttribute('required', 'required');
            });
        }
        
        // Delete document button in modal
        const deleteDocumentBtn = document.getElementById('deleteDocument');
        if (deleteDocumentBtn) {
            deleteDocumentBtn.addEventListener('click', function() {
                const documentId = this.getAttribute('data-document-id');
                deleteDocument(shipmentId, documentId);
            });
        }
        
        // Document filter button
        const filterBtn = document.querySelector('button[onclick="filterDocuments()"]');
        if (filterBtn) {
            filterBtn.addEventListener('click', function() {
                applyDocumentFilters();
            });
        }
        
        // Add event delegation for document actions
        const documentsTable = document.getElementById('documentsTable');
        if (documentsTable) {
            documentsTable.addEventListener('click', function(event) {
                // View document
                if (event.target.closest('.view-document')) {
                    // Let the browser handle the click since it's a link
                    return;
                }
                
                // Edit document
                if (event.target.closest('.edit-document')) {
                    event.preventDefault();
                    const btn = event.target.closest('.edit-document');
                    const documentId = btn.getAttribute('data-id');
                    editDocument(shipmentId, documentId);
                }
                
                // Delete document
                if (event.target.closest('.delete-document')) {
                    event.preventDefault();
                    const btn = event.target.closest('.delete-document');
                    const documentId = btn.getAttribute('data-id');
                    confirmDeleteDocument(documentId);
                }
            });
        }
    }
    
    // Handle document form submission
    function handleDocumentFormSubmit(shipmentId) {
    const form = document.getElementById('documentForm');
    const formData = new FormData(form);
    
    // Get document ID to determine if this is an add or update
    const documentId = document.getElementById('documentId').value;
    
    const saveButton = document.getElementById('saveDocument');
    const originalText = saveButton.textContent;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Saving...';
    saveButton.disabled = true;
    
    // Determine method and URL based on whether it's a new document or update
    const method = documentId ? 'PUT' : 'POST';
    const url = documentId 
        ? `/masters/entries/${shipmentId}/documents/${documentId}` 
        : `/masters/entries/${shipmentId}/documents`;
    
    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('documentModal'));
            modal.hide();
            
            // Show success message
            Swal.fire({
                title: 'Success',
                text: data.message,
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
            
            // Reload documents
            loadDocuments(shipmentId);
        } else {
            // Show error message
            Swal.fire({
                title: 'Error',
                text: data.message,
                icon: 'error'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            title: 'Error',
            text: 'An unexpected error occurred',
            icon: 'error'
        });
    })
    .finally(() => {
        // Reset button state
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
    });
}
        
    // Handle document file selection
    function handleDocumentFileSelect(event) {
        const file = event.target.files[0];
        const filePreview = document.getElementById('filePreview');
        
        if (!file || !filePreview) {
            if (filePreview) filePreview.classList.add('d-none');
            return;
        }
        
        // Show file preview
        filePreview.classList.remove('d-none');
        
        // Get file icon based on type
        const fileIcon = document.getElementById('fileIcon');
        if (fileIcon) {
            fileIcon.className = getFileIconClass(file.name) + ' fs-20 me-2';
        }
        
        // Set file details
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        
        if (fileName) fileName.textContent = file.name;
        if (fileSize) fileSize.textContent = formatFileSize(file.size);
    }
    
    // Edit document
    function editDocument(shipmentId, documentId) {
    // Reset form
    resetDocumentForm();
    
    // Set document ID in form
    document.getElementById('documentId').value = documentId;
    
    // Fetch document details
    fetch(`/masters/entries/${shipmentId}/documents/${documentId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.document) {
                const doc = data.document;
                
                // Fill form fields
                document.getElementById('documentType').value = doc.document_type;
                document.getElementById('documentDescription').value = doc.description || '';
                document.getElementById('isConfidential').checked = doc.is_confidential;
                
                // Set upload info for edit-only fields
                document.getElementById('uploadedBy').value = doc.uploaded_by_name || 'System';
                
                // Format date
                const uploadDate = new Date(doc.created_at);
                document.getElementById('uploadDate').value = uploadDate.toLocaleDateString('en-US', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Set modal title and button text
                const modalTitle = document.getElementById('documentModalLabel');
                const submitButton = document.getElementById('saveDocument');
                
                if (modalTitle) modalTitle.textContent = 'Edit Document';
                if (submitButton) submitButton.textContent = 'Update Document';
                
                // Show edit-only fields
                const editOnlyFields = document.querySelectorAll('.edit-only-fields');
                editOnlyFields.forEach(field => field.classList.remove('d-none'));
                
                // Make file input optional in edit mode
                const fileInput = document.getElementById('documentFile');
                if (fileInput) fileInput.removeAttribute('required');
                
                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('documentModal'));
                modal.show();
            } else {
                // Show error message
                Swal.fire({
                    title: 'Error',
                    text: data.message || 'Failed to load document details',
                    icon: 'error'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: 'Error loading document details',
                icon: 'error'
            });
        });
}


    // Confirm document deletion
    function confirmDeleteDocument(documentId) {
        // Set document ID in delete button
        const deleteButton = document.getElementById('deleteDocument');
        if (deleteButton) {
            deleteButton.setAttribute('data-document-id', documentId);
            
            // Show delete confirmation modal
            const modal = new bootstrap.Modal(document.getElementById('deleteDocumentModal'));
            modal.show();
        }
    }
    
    // Delete document
    function deleteDocument(shipmentId, documentId) {
        // Show loading state in delete button
        const deleteButton = document.getElementById('deleteDocument');
        const originalText = deleteButton.textContent;
        deleteButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Deleting...';
        deleteButton.disabled = true;
        
        // Send delete request
        fetch(`/masters/entries/${shipmentId}/documents/${documentId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteDocumentModal'));
                modal.hide();
                
                // Show success message
                showToast('success', 'Document deleted successfully');
                
                // Reload documents
                loadDocuments(shipmentId);
            } else {
                throw new Error(data.message || 'Error deleting document');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', error.message || 'An error occurred while deleting the document');
        })
        .finally(() => {
            // Reset button state
            deleteButton.innerHTML = originalText;
            deleteButton.disabled = false;
        });
    }
    
    // Toggle all checkboxes
    function toggleAllDocumentCheckboxes() {
        const checkAllBox = document.getElementById('checkAllDocuments');
        if (!checkAllBox) return;
        
        const isChecked = checkAllBox.checked;
        
        document.querySelectorAll('input[name="document_check"]').forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    }
    
    // Apply filter for documents
    function applyDocumentFilters() {
        const searchText = document.querySelector('.search').value.toLowerCase();
        const typeFilter = document.getElementById('documentTypeFilter').value;
        const dateFilter = document.getElementById('documentDateFilter').value;
        
        let startDate = null;
        let endDate = null;
        
        if (dateFilter) {
            const dateRange = dateFilter.split(' to ');
            startDate = dateRange[0] ? new Date(dateRange[0]) : null;
            endDate = dateRange[1] ? new Date(dateRange[1]) : startDate;
            
            // Set end date to end of day
            if (endDate) {
                endDate.setHours(23, 59, 59, 999);
            }
        }
        
        const rows = document.querySelectorAll('#documentsTable tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const nameCell = row.querySelector('.document_name');
            const typeCell = row.querySelector('.document_type');
            const dateCell = row.querySelector('.upload_date');
            
            if (!nameCell || !typeCell || !dateCell) return;
            
            const documentName = nameCell.textContent.toLowerCase();
            const documentType = typeCell.textContent.toLowerCase();
            const uploadDateText = dateCell.textContent.trim();
            
            // Parse date for comparison
            const uploadDate = uploadDateText ? parseDate(uploadDateText) : null;
            
            const matchesSearch = !searchText || documentName.includes(searchText);
            const matchesType = typeFilter === 'all' || documentType.includes(typeFilter.toLowerCase());
            const matchesDate = !startDate || !endDate || !uploadDate || 
                                (uploadDate >= startDate && uploadDate <= endDate);
            
            // Apply visibility
            const isVisible = matchesSearch && matchesType && matchesDate;
            row.style.display = isVisible ? '' : 'none';
            
            if (isVisible) {
                visibleCount++;
            }
        });
        
        // Show/hide no results message
        document.querySelector('.noresult').style.display = visibleCount === 0 ? 'block' : 'none';
    }
    
    // Reset document form
    function resetDocumentForm() {
        const form = document.getElementById('documentForm');
        if (!form) return;
        
        form.reset();
        document.getElementById('documentId').value = '';
        
        const filePreview = document.getElementById('filePreview');
        if (filePreview) filePreview.classList.add('d-none');
        
        // Reset edit-only fields
        const editOnlyFields = document.querySelectorAll('.edit-only-fields');
        editOnlyFields.forEach(field => field.classList.add('d-none'));
        
        // Reset file input
        const documentFileInput = document.getElementById('documentFile');
        if (documentFileInput) documentFileInput.value = '';
        
        // Reset validation states
        const invalidFields = form.querySelectorAll('.is-invalid');
        invalidFields.forEach(field => field.classList.remove('is-invalid'));
    }
    
    // Helper function to get file icon class based on file extension
    function getFileIconClass(filename) {
        if (!filename) return 'ri-file-text-line';
        
        const ext = filename.split('.').pop().toLowerCase();
        
        if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
            return 'ri-image-line text-success';
        } else if (ext === 'pdf') {
            return 'ri-file-pdf-line text-danger';
        } else if (['doc', 'docx'].includes(ext)) {
            return 'ri-file-word-line text-info';
        } else if (['xls', 'xlsx', 'csv'].includes(ext)) {
            return 'ri-file-excel-line text-success';
        } else if (['ppt', 'pptx'].includes(ext)) {
            return 'ri-file-ppt-line text-warning';
        } else if (['zip', 'rar', 'tar', 'gz', '7z'].includes(ext)) {
            return 'ri-file-zip-line text-primary';
        } else if (['txt', 'log'].includes(ext)) {
            return 'ri-file-text-line text-secondary';
        } else {
            return 'ri-file-line text-muted';
        }
    }
    
    // Helper function to get badge color for document type
    function getTypeBadgeColor(type) {
        const colors = {
            'invoice': 'info',
            'bill-of-lading': 'danger',
            'packing-list': 'success',
            'customs': 'warning',
            'certificate': 'primary',
            'other': 'secondary'
        };
        
        return colors[type] || 'secondary';
    }
    
    // Helper function to format file size
    function formatFileSize(bytes) {
        if (!bytes || isNaN(bytes)) return '0 Bytes';
        
        const units = ['Bytes', 'KB', 'MB', 'GB'];
        let i = 0;
        
        while (bytes >= 1024 && i < units.length - 1) {
            bytes /= 1024;
            i++;
        }
        
        return bytes.toFixed(2) + ' ' + units[i];
    }
    
    // Helper function to format date
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        
        const date = new Date(dateString);
        
        if (isNaN(date.getTime())) return dateString;
        
        const day = date.getDate();
        const month = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][date.getMonth()];
        const year = date.getFullYear();
        
        return `${day} ${month}, ${year}`;
    }
    
    // Helper function to parse date string
    function parseDate(dateStr) {
        if (!dateStr || dateStr === 'N/A') return null;
        
        try {
            // Handle format like "25 Apr, 2025"
            const parts = dateStr.replace(',', '').split(' ');
            
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].indexOf(parts[1]);
                const year = parseInt(parts[2], 10);
                
                if (!isNaN(day) && month !== -1 && !isNaN(year)) {
                    return new Date(year, month, day);
                }
            }
            
            // Try direct parsing as fallback
            return new Date(dateStr);
        } catch (e) {
            console.error('Error parsing date:', e);
            return null;
        }
    }
    
    // Show toast notification
    function showToast(type, message) {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: type === 'success' ? "#0ab39c" : type === 'error' ? "#f06548" : "#405189",
            stopOnFocus: true,
            close: true
        }).showToast();
    }
    
    // Initialize document management if shipment ID is available
    if (currentShipmentId) {
        loadDocuments(currentShipmentId);
    }


});


</script>


<!-- Expense Management Script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Expense filtering functionality
        const filterExpensesBtn = document.getElementById('filterExpensesBtn');
        const expenseSearch = document.getElementById('expenseSearch');
        const expenseTypeFilter = document.getElementById('expenseTypeFilter');
        const expenseDateFilter = document.getElementById('expenseDateFilter');
        
        if (filterExpensesBtn) {
            filterExpensesBtn.addEventListener('click', filterExpenses);
        }
        
        if (expenseSearch) {
            expenseSearch.addEventListener('input', filterExpenses);
        }
        
        if (expenseTypeFilter) {
            expenseTypeFilter.addEventListener('change', filterExpenses);
        }
        
        // Initialize flatpickr date picker if it exists
        if (typeof flatpickr === 'function' && expenseDateFilter) {
            flatpickr(expenseDateFilter, {
                mode: "range",
                dateFormat: "d M, Y",
                onChange: filterExpenses
            });
        }
        
        function filterExpenses() {
            const searchText = expenseSearch ? expenseSearch.value.toLowerCase() : '';
            const typeFilter = expenseTypeFilter ? expenseTypeFilter.value : 'all';
            const dateRange = expenseDateFilter ? expenseDateFilter.value : '';
            
            // Parse date range
            let startDate = null;
            let endDate = null;
            
            if (dateRange) {
                const parts = dateRange.split(' to ');
                if (parts.length > 0) {
                    startDate = parseDate(parts[0]);
                    endDate = parts.length > 1 ? parseDate(parts[1]) : startDate;
                    
                    // Set end date to end of day for inclusive comparison
                    if (endDate) {
                        endDate.setHours(23, 59, 59, 999);
                    }
                }
            }
            
            // Get all rows
            const rows = document.querySelectorAll('#expensesTable tbody tr');
            let visibleCount = 0;
            
            // Apply filters to each row
            rows.forEach(row => {
                // Skip if this is the "no expenses" row with colspan
                if (row.querySelector('td[colspan]')) return;
                
                const rowText = row.textContent.toLowerCase();
                const rowTypeId = row.getAttribute('data-type');
                const rowDateStr = row.getAttribute('data-date-from');
                
                // Match by text
                const matchesSearch = searchText === '' || rowText.includes(searchText);
                
                // Match by expense type
                const matchesType = typeFilter === 'all' || typeFilter === rowTypeId;
                
                // Match by date range
                let matchesDate = true;
                if (startDate && endDate && rowDateStr) {
                    const rowDate = parseDate(rowDateStr);
                    matchesDate = rowDate && rowDate >= startDate && rowDate <= endDate;
                }
                
                // Show/hide row based on all criteria
                const visible = matchesSearch && matchesType && matchesDate;
                row.style.display = visible ? '' : 'none';
                
                if (visible) visibleCount++;
            });
            
            // Show/hide "no results" message
            const noResult = document.querySelector('.noresult');
            if (noResult) {
                noResult.style.display = visibleCount === 0 ? 'block' : 'none';
            }
        }
        
        // Helper function to parse date strings
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            try {
                // Handle format like "15 Jan, 2023"
                const match = dateStr.match(/(\d+)\s+([A-Za-z]{3})[,]?\s+(\d{4})/);
                if (match) {
                    const day = parseInt(match[1]);
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const month = monthNames.indexOf(match[2]);
                    const year = parseInt(match[3]);
                    
                    if (month !== -1) {
                        return new Date(year, month, day);
                    }
                }
                
                // Handle ISO dates and other formats
                return new Date(dateStr);
            } catch (e) {
                console.error('Error parsing date:', e);
                return null;
            }
        }
    });
    </script>

<!-- Invoice Management Script for Customer View -->
<script>
    // Wait for both DOM and all resources to be loaded
    window.addEventListener('load', function() {
        // Add a small delay to ensure all scripts are initialized
        setTimeout(function() {
            initCustomerInvoiceManagement();
        }, 100);
    });
    
    // Also try to initialize when DOM is ready (fallback)
    document.addEventListener('DOMContentLoaded', function() {
        // Only initialize if not already done
        if (!window.invoiceManagementInitialized) {
            setTimeout(function() {
                initCustomerInvoiceManagement();
            }, 500);
        }
    });
    
    /**
     * Initialize invoice management functionality for customer view
     */
    function initCustomerInvoiceManagement() {
        // Prevent multiple initializations
        if (window.invoiceManagementInitialized) {
            return;
        }
        
        console.log(' Initializing customer invoice management...');
        
        // Try multiple ways to get shipment ID
        let shipmentId = null;
        
        // Method 1: From hidden input
        const idInput = document.querySelector('input[name="id"]');
        if (idInput && idInput.value) {
            shipmentId = idInput.value;
            console.log(' Found shipment ID from input:', shipmentId);
        }
        
        // Method 2: From URL if not found
        if (!shipmentId) {
            const urlParts = window.location.pathname.split('/');
            const shipmentIndex = urlParts.indexOf('shipment');
            if (shipmentIndex !== -1 && urlParts[shipmentIndex + 1]) {
                shipmentId = urlParts[shipmentIndex + 1];
                console.log(' Found shipment ID from URL:', shipmentId);
            }
        }
        
        // Method 3: From order_id in URL
        if (!shipmentId) {
            const urlParts = window.location.pathname.split('/');
            const orderIndex = urlParts.indexOf('order_shipment');
            if (orderIndex !== -1 && urlParts[orderIndex + 1]) {
                shipmentId = urlParts[orderIndex + 1];
                console.log(' Found shipment ID from order_shipment URL:', shipmentId);
            }
        }
        
        if (shipmentId) {
            console.log(' Starting invoice loading for shipment:', shipmentId);
            
            // Wait for table to be available
            waitForElement('#invoicesTable tbody', function(tableBody) {
                if (tableBody) {
                    loadCustomerInvoices(shipmentId);
                    setupCustomerInvoiceEventListeners(shipmentId);
                    window.invoiceManagementInitialized = true;
                    console.log(' Invoice management initialized successfully');
                } else {
                    console.error(' Invoice table not found after waiting');
                }
            });
        } else {
            console.error(' Could not determine shipment ID');
        }
    }
    
    /**
     * Wait for an element to be available in the DOM
     */
    function waitForElement(selector, callback, maxAttempts = 10) {
        let attempts = 0;
        
        function checkElement() {
            attempts++;
            const element = document.querySelector(selector);
            
            if (element) {
                callback(element);
            } else if (attempts < maxAttempts) {
                console.log(` Waiting for element ${selector} (attempt ${attempts}/${maxAttempts})`);
                setTimeout(checkElement, 500);
            } else {
                console.error(` Element ${selector} not found after ${maxAttempts} attempts`);
                callback(null);
            }
        }
        
        checkElement();
    }
    
    /**
     * Setup event listeners for customer invoice view
     */
    function setupCustomerInvoiceEventListeners(shipmentId) {
        console.log(' Setting up invoice event listeners...');
        
        // Wait for elements to be available
        waitForElement('#filterInvoicesBtn', function(filterInvoicesBtn) {
            if (filterInvoicesBtn) {
                filterInvoicesBtn.addEventListener('click', filterInvoices);
                console.log(' Filter button listener added');
            }
        });
        
        waitForElement('#invoiceSearch', function(invoiceSearch) {
            if (invoiceSearch) {
                invoiceSearch.addEventListener('input', filterInvoices);
                console.log(' Search input listener added');
            }
        });
        
        waitForElement('#invoiceStatusFilter', function(invoiceStatusFilter) {
            if (invoiceStatusFilter) {
                invoiceStatusFilter.addEventListener('change', filterInvoices);
                console.log(' Status filter listener added');
            }
        });
        
        waitForElement('#invoicesTable', function(invoicesTable) {
            if (invoicesTable) {
                invoicesTable.addEventListener('click', function(event) {
                    const viewButton = event.target.closest('.view-invoice');
                    if (viewButton) {
                        const invoiceId = viewButton.getAttribute('data-id');
                        viewInvoice(shipmentId, invoiceId);
                    }
                });
                console.log(' Table click listener added');
            }
        });
    }
    
    /**
     * Load all invoices for a customer shipment
     */
    function loadCustomerInvoices(shipmentId) {
        console.log(' Loading invoices for shipment:', shipmentId);
        
        const tableBody = document.querySelector('#invoicesTable tbody');
        if (!tableBody) {
            console.error(' Invoice table body not found');
            return;
        }
        
        // Show loading state
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading invoices...</p>
                </td>
            </tr>
        `;
        
        // Add error handling and timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
        
        // Fetch invoices from the server
        fetch(`/customer_portal/shipments/${shipmentId}/invoices`, {
            signal: controller.signal,
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            clearTimeout(timeoutId);
            console.log(' Invoice API response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log(' Invoice data received:', data);
            
            if (data.success) {
                renderCustomerInvoicesList(data.invoices, tableBody);
                console.log(' Invoices rendered successfully');
            } else {
                throw new Error(data.message || 'Failed to load invoices');
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error(' Error loading invoices:', error);
            
            // Show error in the table
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4 text-danger">
                        <i class="ri-error-warning-line fs-24 mb-2 d-block"></i>
                        <p>Error loading invoices: ${error.message}</p>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadCustomerInvoices('${shipmentId}')">
                            <i class="ri-refresh-line me-1"></i>Retry
                        </button>
                    </td>
                </tr>
            `;
        });
    }
    
    /**
     * Render invoices list in the table for customer view
     */
    function renderCustomerInvoicesList(invoices, tableBody) {
        // Clear table body
        tableBody.innerHTML = '';
        
        if (invoices && invoices.length > 0) {
            // Create rows for each invoice
            invoices.forEach(invoice => {
                const row = document.createElement('tr');
                row.setAttribute('data-id', invoice.id);
                row.setAttribute('data-status', invoice.payment_status);
                
                // Set the invoice date attribute for filtering
                if (invoice.invoice_date) {
                    row.setAttribute('data-date', invoice.invoice_date);
                }
                
                // Get status badge class
                let statusBadgeClass;
                let statusText;
                
                switch (parseInt(invoice.payment_status)) {
                    case 0:
                        statusBadgeClass = 'badge-soft-warning';
                        statusText = 'Pending';
                        break;
                    case 1:
                        statusBadgeClass = 'badge-soft-info';
                        statusText = 'Partially Paid';
                        break;
                    case 2:
                        statusBadgeClass = 'badge-soft-success';
                        statusText = 'Paid';
                        break;
                    case 3:
                        statusBadgeClass = 'badge-soft-danger';
                        statusText = 'Cancelled';
                        break;
                    default:
                        statusBadgeClass = 'badge-soft-secondary';
                        statusText = 'Unknown';
                }
                
                // Format invoice date
                const invoiceDate = formatDate(invoice.invoice_date);
                const shipmentIdElement = document.querySelector('input[name="id"]');
                const shipmentId = shipmentIdElement ? shipmentIdElement.value : null;
                
                row.innerHTML = `
                    <td>
                        <span class="fw-medium">${invoice.invoice_number}</span>
                    </td>
                    <td>${invoiceDate}</td>
                    <td class="text-end">
                        <span class="fw-medium">${invoice.formatted_total || formatCurrency(invoice.total)}</span>
                    </td>
                    <td>
                        <span class="badge ${statusBadgeClass}">${statusText}</span>
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-soft-primary view-invoice" 
                                    data-id="${invoice.id}" title="View">
                                <i class="ri-eye-line"></i> View
                            </button>
                            <button type="button" class="btn btn-sm btn-soft-info" 
                                    onclick="window.open('/customer_portal/shipments/${shipmentId}/invoice-pdf', '_blank')" title="Download PDF">
                                <i class="ri-download-line"></i> Download
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        } else {
            // No invoices found
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <div class="text-muted">
                            <i class="ri-bill-line fs-24 mb-2 d-block"></i>
                            <p>No invoices have been created for this shipment yet.</p>
                        </div>
                    </td>
                </tr>
            `;
        }
    }
    
    /**
     * View invoice details
     */
    function viewInvoice(shipmentId, invoiceId) {
        // Fetch invoice details from customer endpoint
        fetch(`/customer_portal/shipments/${shipmentId}/invoices/${invoiceId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    populateViewInvoiceModal(data.invoice);
                    
                    // Show the modal
                    const modalElement = document.getElementById('viewInvoiceModal');
                    if (modalElement) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    } else {
                        console.error('View invoice modal element not found');
                    }
                } else {
                    throw new Error(data.message || 'Failed to load invoice details');
                }
            })
            .catch(error => {
                console.error('Error viewing invoice:', error);
                
                // Show error message
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'An error occurred while loading the invoice details',
                    icon: 'error'
                });
            });
    }
    
    /**
     * Populate view invoice modal
     */
    function populateViewInvoiceModal(invoice) {
        // Set invoice header info
        document.getElementById('viewInvoiceNumber').textContent = invoice.invoice_number;
        document.getElementById('viewInvoiceDate').textContent = formatDate(invoice.invoice_date);
        
        // Set status badge
        let statusBadgeClass;
        let statusText;
        
        switch (parseInt(invoice.payment_status)) {
            case 0:
                statusBadgeClass = 'badge-soft-warning';
                statusText = 'Pending';
                break;
            case 1:
                statusBadgeClass = 'badge-soft-info';
                statusText = 'Partially Paid';
                break;
            case 2:
                statusBadgeClass = 'badge-soft-success';
                statusText = 'Paid';
                break;
            case 3:
                statusBadgeClass = 'badge-soft-danger';
                statusText = 'Cancelled';
                break;
            default:
                statusBadgeClass = 'badge-soft-secondary';
                statusText = 'Unknown';
        }
        
        document.getElementById('viewInvoiceStatus').innerHTML = `<span class="badge ${statusBadgeClass}">${statusText}</span>`;
        
        // Set customer info
        document.getElementById('viewInvoiceCustomer').textContent = invoice.customer_name;
        document.getElementById('viewInvoiceNarration').textContent = invoice.narration || '-';
        document.getElementById('viewInvoiceCreatedBy').textContent = invoice.created_by || '-';
        
        // Set invoice items
        const tbody = document.querySelector('#viewInvoiceItems tbody');
        if (!tbody) {
            console.error('View invoice items table body not found');
            return;
        }
        
        tbody.innerHTML = '';
        
        if (invoice.details && invoice.details.length > 0) {
            invoice.details.forEach(item => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.expense_type}</td>
                    <td>${item.description || '-'}</td>
                    <td>${formatCurrency(item.original_chargeable_amount)}</td>
                    <td>${formatCurrency(item.final_amount)}</td>
                `;
                
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center">No items found</td>
                </tr>
            `;
        }
        
        // Set total
        document.getElementById('viewInvoiceTotal').textContent = formatCurrency(invoice.total);
    }
    
    /**
     * Filter invoices based on search and status
     */
    function filterInvoices() {
        const searchText = document.getElementById('invoiceSearch')?.value.toLowerCase() || '';
        const statusFilter = document.getElementById('invoiceStatusFilter')?.value || 'all';
        
        // Get all rows
        const rows = document.querySelectorAll('#invoicesTable tbody tr');
        
        // Skip filtering if there's only one row with a colspan (no results or loading)
        if (rows.length === 1 && rows[0].querySelector('td[colspan="5"]')) {
            return;
        }
        
        // Variable to track if any rows match the filter
        let matchFound = false;
        
        // Apply filters to each row
        rows.forEach(row => {
            // Skip the "no results" row if it exists
            if (row.querySelector('td[colspan="5"]')) {
                return;
            }
            
            // Get row data
            const rowText = row.textContent.toLowerCase();
            const rowStatus = row.getAttribute('data-status');
            
            // Text search match
            const matchesSearch = !searchText || rowText.includes(searchText);
            
            // Status match
            const matchesStatus = statusFilter === 'all' || statusFilter === rowStatus;
            
            // Set row visibility based on combined filters
            const isVisible = matchesSearch && matchesStatus;
            row.style.display = isVisible ? '' : 'none';
            
            if (isVisible) {
                matchFound = true;
            }
        });
        
        // Show/hide "no results" message
        const noResultElement = document.querySelector('.noresult');
        if (noResultElement) {
            noResultElement.style.display = matchFound ? 'none' : 'block';
        }
    }
    
    /**
     * Print invoice
     */
    function printInvoice() {
        // Prepare print window
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
            Swal.fire({
                title: 'Error',
                text: 'Unable to open print window. Please check your browser settings.',
                icon: 'error'
            });
            return;
        }
        
        // Get invoice data from modal
        const invoiceNumber = document.getElementById('viewInvoiceNumber')?.textContent || '';
        const invoiceDate = document.getElementById('viewInvoiceDate')?.textContent || '';
        const invoiceStatus = document.getElementById('viewInvoiceStatus')?.innerHTML || '';
        const invoiceCustomer = document.getElementById('viewInvoiceCustomer')?.textContent || '';
        const invoiceNarration = document.getElementById('viewInvoiceNarration')?.textContent || '';
        
        // Get invoice items
        const itemsTable = document.getElementById('viewInvoiceItems');
        const tableHTML = itemsTable ? itemsTable.outerHTML : '<table><tr><td>No items found</td></tr></table>';
        
        // Get invoice total
        const invoiceTotal = document.getElementById('viewInvoiceTotal')?.textContent || 'LKR 0.00';
        
        // Get dynamic company information from template variables - safely escaped
        const companyName = {{ (company_info.company_name if company_info and company_info.company_name else 'Company Name')|tojson }};
        const companyAddress = {{ (company_info.address if company_info and company_info.address else 'Address not available')|tojson }};
        const companyEmail = {{ (company_info.email if company_info and company_info.email else 'Email not available')|tojson }};
        const companyPhone = {{ (company_info.contact_num if company_info and company_info.contact_num else 'Phone not available')|tojson }};
        const companyWebsite = {{ (company_info.website if company_info and company_info.website else '')|tojson }};
        const companyVat = {{ (company_info.vat_identification_number if company_info and company_info.vat_identification_number else '')|tojson }};
        
        // Create print content with dynamic company information
        const printContent = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Invoice ${invoiceNumber}</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        margin: 0;
                        padding: 20px;
                        color: #333;
                    }
                    .invoice-header {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 30px;
                        padding-bottom: 20px;
                        border-bottom: 1px solid #ddd;
                    }
                    .company-info h1 {
                        margin: 0;
                        color: #007bff;
                    }
                    .invoice-info {
                        text-align: right;
                    }
                    .invoice-info h2 {
                        margin: 0 0 10px 0;
                    }
                    .customer-info {
                        display: flex;
                        justify-content: space-between;
                        margin-bottom: 30px;
                    }
                    .info-box {
                        width: 48%;
                        padding: 15px;
                        background-color: #f9f9f9;
                        border-radius: 5px;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 30px;
                    }
                    th, td {
                        padding: 10px;
                        text-align: left;
                        border-bottom: 1px solid #ddd;
                    }
                    th {
                        background-color: #f3f3f3;
                    }
                    .total-row td {
                        font-weight: bold;
                    }
                    .text-right {
                        text-align: right;
                    }
                    .footer {
                        margin-top: 50px;
                        text-align: center;
                        color: #777;
                        font-size: 14px;
                    }
                    @media print {
                        body {
                            padding: 0;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="invoice-header">
                    <div class="company-info">
                        <h1>${companyName}</h1>
                        <p>
                            ${companyAddress}<br>
                            ${companyPhone ? `Phone: ${companyPhone}<br>` : ''}
                            ${companyEmail ? `Email: ${companyEmail}<br>` : ''}
                            ${companyWebsite ? `Website: ${companyWebsite}<br>` : ''}
                            ${companyVat ? `VAT: ${companyVat}` : ''}
                        </p>
                    </div>
                    <div class="invoice-info">
                        <h2>INVOICE</h2>
                        <p>
                            <strong>Invoice #:</strong> ${invoiceNumber}<br>
                            <strong>Date:</strong> ${invoiceDate}<br>
                            <strong>Status:</strong> ${invoiceStatus.replace(/<[^>]*>/g, '')}<br>
                        </p>
                    </div>
                </div>
                
                <div class="customer-info">
                    <div class="info-box">
                        <h3>Bill To:</h3>
                        <p>
                            ${invoiceCustomer}<br>
                            <!-- Customer address would go here -->
                        </p>
                    </div>
                    <div class="info-box">
                        <h3>Invoice Details:</h3>
                        <p>
                            <strong>Narration:</strong> ${invoiceNarration}<br>
                        </p>
                    </div>
                </div>
                
                ${tableHTML}
                
                <div class="footer">
                    <p>Thank you for your business!</p>
                    <p>This invoice was printed on ${new Date().toLocaleDateString()}</p>
                </div>
            </body>
            </html>
        `;
        
        // Write to print window
        printWindow.document.write(printContent);
        printWindow.document.close();
        
        // Trigger print when content is loaded
        printWindow.onload = function() {
            printWindow.print();
        };
    }
    
    /**
     * Format date for display
     */
    function formatDate(dateStr) {
        if (!dateStr) return '-';
        
        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        } catch (error) {
            console.error('Error formatting date:', error);
            return dateStr;
        }
    }
    
    /**
     * Format currency value
     */
    function formatCurrency(value) {
        if (value === undefined || value === null) return 'LKR 0.00';
        
        const numValue = parseFloat(value);
        if (isNaN(numValue)) return 'LKR 0.00';
        
        return `LKR ${numValue.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
    }
</script>

<style>
    /* Add these styles to your page or CSS file */
.badge.badge-soft-success {
    background-color: #d1e7dd;
    color: #0f5132;
}

.badge.badge-soft-danger {
    background-color: #f8d7da;
    color: #721c24;
}

.badge.badge-soft-warning {
    background-color: #fff3cd;
    color: #856404;
}

.badge.badge-soft-info {
    background-color: #d1ecf1;
    color: #0c5460;
}

.badge.badge-soft-primary {
    background-color: #cff4fc;
    color: #055160;
}

/* Progress bar styling */
.progress {
    height: 20px;
    background-color: #e9ecef;
    border-radius: 10px;
}

.progress-bar {
    border-radius: 10px;
    font-size: 12px;
    line-height: 20px;
}
</style>


<!-- Add this CSS to the head section of order_shipment_customer.html -->
<style>
    .material-alert-icon {
        animation: pulse 1.5s infinite;
        cursor: pointer;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .expiring-document-alert {
        background-color: rgba(220, 53, 69, 0.1) !important;
        border-left: 3px solid #dc3545;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 15px;
    }
    
    .expiry-warning {
        color: #dc3545;
        font-weight: bold;
    }
    
    .document-card.expiring {
        background-color: rgba(220, 53, 69, 0.05) !important;
        border-left: 3px solid #dc3545 !important;
    }
</style>


<script>
// Customer Demurrage Tab JavaScript
document.addEventListener('DOMContentLoaded', function() {
    initializeCustomerDemurrageTab();
});

function initializeCustomerDemurrageTab() {
    // Load data when demurrage tab is activated
    const demurrageTab = document.querySelector('a[href="#tab-demurrage"]');
    if (demurrageTab) {
        demurrageTab.addEventListener('shown.bs.tab', function() {
            loadCustomerDemurrageData();
        });
    }

    // Check if demurrage tab is already active on page load
    const demurrageTabPane = document.getElementById('tab-demurrage');
    if (demurrageTabPane && demurrageTabPane.classList.contains('active')) {
        console.log('Demurrage tab is already active, loading data...');
        setTimeout(() => {
            loadCustomerDemurrageData();
        }, 100);
    }
}

function loadCustomerDemurrageData() {
    const shipmentId = getShipmentId();
    if (!shipmentId) {
        console.error('Shipment ID not found');
        return;
    }

    console.log('Loading customer demurrage data for shipment:', shipmentId);

    // Show loading state
    showLoadingState();

    // Load demurrage records
    fetch(`/customer_portal/api/demurrage/shipment/${shipmentId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Demurrage data loaded:', data);
            if (data.success) {
                renderCustomerDemurrageTable(data.data || []);
                updateTotalAmount(data.total_amount || 0);
                updateRecordCount(data.data ? data.data.length : 0);
            } else {
                console.warn('No demurrage records found:', data.message);
                renderCustomerDemurrageTable([]);
                updateTotalAmount(0);
                updateRecordCount(0);
            }
        })
        .catch(error => {
            console.error('Error loading demurrage data:', error);
            showErrorState();
        });
}

function getShipmentId() {
    // Try to get shipment ID from hidden input or URL
    const shipmentIdInput = document.getElementById('shipmentId');
    if (shipmentIdInput) {
        return shipmentIdInput.value;
    }
    
    // Alternative: extract from URL if available
    const urlParts = window.location.pathname.split('/');
    const shipmentIndex = urlParts.indexOf('shipment');
    if (shipmentIndex !== -1 && urlParts[shipmentIndex + 1]) {
        return urlParts[shipmentIndex + 1];
    }
    
    return null;
}

function showLoadingState() {
    const tableBody = document.querySelector('#demurrageTable tbody');
    const noContainersDiv = document.getElementById('noContainersForDemurrage');
    const tableContainer = document.getElementById('demurrageTableContainer');
    
    noContainersDiv.style.display = 'none';
    tableContainer.style.display = 'block';
    
    tableBody.innerHTML = `
        <tr id="loadingRow">
            <td colspan="6" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0 text-muted">Loading demurrage records...</p>
            </td>
        </tr>
    `;
}

function showErrorState() {
    const tableBody = document.querySelector('#demurrageTable tbody');
    tableBody.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-4 text-danger">
                <i class="ri-error-warning-line fs-2 mb-2"></i>
                <p class="mb-0">Failed to load demurrage records</p>
            </td>
        </tr>
    `;
    updateTotalAmount(0);
    updateRecordCount(0);
}

function renderCustomerDemurrageTable(demurrageRecords) {
    const tableBody = document.querySelector('#demurrageTable tbody');
    const noContainersDiv = document.getElementById('noContainersForDemurrage');
    const tableContainer = document.getElementById('demurrageTableContainer');

    if (!tableBody) return;

    // Show table container
    noContainersDiv.style.display = 'none';
    tableContainer.style.display = 'block';

    tableBody.innerHTML = '';

    if (demurrageRecords.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="ri-inbox-line fs-2 mb-2"></i>
                    <p class="mb-0">No demurrage records found</p>
                </td>
            </tr>
        `;
        return;
    }

    demurrageRecords.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="fw-medium">${record.container_number}</div>
                <small class="text-muted">${record.container_size || ''}</small>
            </td>
            <td>${formatDate(record.demurrage_date)}</td>
            <td>
                <span>${record.reason_name}</span>
            </td>
            <td>${record.currency_code}</td>
            <td class="text-end fw-bold">${formatAmount(record.amount)}</td>
            <td>
                <button class="btn btn-outline-primary btn-sm" onclick="viewDemurrageDetails(${record.id})" title="View Details">
                    <i class="ri-eye-line me-1"></i>Details
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

function updateTotalAmount(totalAmount) {
    const totalElement = document.getElementById('totalDemurrageAmount');
    if (totalElement) {
        totalElement.textContent = formatAmount(totalAmount || 0);
    }
}

function updateRecordCount(count) {
    const countElement = document.getElementById('demurrageRecordCount');
    if (countElement) {
        countElement.textContent = `${count} Record${count !== 1 ? 's' : ''}`;
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB'); // DD/MM/YYYY format
}

function formatAmount(amount) {
    return parseFloat(amount || 0).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// View demurrage details in modal
window.viewDemurrageDetails = function(demurrageId) {
    console.log('Viewing demurrage details for ID:', demurrageId);
    
    const modal = new bootstrap.Modal(document.getElementById('demurrageDetailsModal'));
    
    // Show modal with loading state
    resetModal();
    modal.show();
    
    // Load demurrage details
    fetch(`/customer_portal/api/demurrage/${demurrageId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                populateModalWithDetails(data.data);
                loadDemurrageAttachments(demurrageId);
            } else {
                throw new Error(data.message || 'Failed to load details');
            }
        })
        .catch(error => {
            console.error('Error loading demurrage details:', error);
            showModalError('Failed to load demurrage details');
        });
};

function resetModal() {
    // Reset all modal fields
    document.getElementById('modalContainerNumber').textContent = '-';
    document.getElementById('modalDemurrageDate').textContent = '-';
    document.getElementById('modalDemurrageReason').textContent = '-';
    document.getElementById('modalCurrency').textContent = '-';
    document.getElementById('modalAmount').textContent = '-';
    
    // Reset attachments section
    document.getElementById('attachmentsLoading').style.display = 'block';
    document.getElementById('noAttachmentsMessage').style.display = 'none';
    document.getElementById('attachmentsList').innerHTML = '';
}

function populateModalWithDetails(demurrage) {
    document.getElementById('modalContainerNumber').textContent = demurrage.container_number || '-';
    document.getElementById('modalDemurrageDate').textContent = formatDate(demurrage.demurrage_date);
    document.getElementById('modalDemurrageReason').textContent = demurrage.reason_name || '-';
    document.getElementById('modalCurrency').textContent = demurrage.currency_code || '-';
    document.getElementById('modalAmount').textContent = formatAmount(demurrage.amount);
}


function loadDemurrageAttachments(demurrageId) {
    fetch(`/customer_portal/api/demurrage/${demurrageId}/attachments`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('attachmentsLoading').style.display = 'none';
            
            if (data.success && data.data && data.data.length > 0) {
                renderAttachmentsList(data.data);
            } else {
                document.getElementById('noAttachmentsMessage').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading attachments:', error);
            document.getElementById('attachmentsLoading').style.display = 'none';
            document.getElementById('attachmentsList').innerHTML = `
                <div class="alert alert-warning">
                    <i class="ri-error-warning-line me-2"></i>
                    Failed to load attachments
                </div>
            `;
        });
}

function renderAttachmentsList(attachments) {
    const attachmentsList = document.getElementById('attachmentsList');
    
    attachmentsList.innerHTML = attachments.map(att => `
        <div class="card mb-2">
            <div class="card-body py-2">
                <div class="row align-items-center">
                    <div class="col">
                        <div class="d-flex align-items-center">
                            <i class="ri-file-text-line fs-18 me-2 text-primary"></i>
                            <div>
                                <div class="fw-medium">${att.file_name}</div>
                                <small class="text-muted">
                                    Date: ${formatDate(att.date)} 
                                    ${att.comment ? ` ${att.comment}` : ''}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewCustomerDocument(${att.id})" title="View Document">
                            <i class="ri-eye-line me-1"></i>View
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function showModalError(message) {
    const modal = document.getElementById('demurrageDetailsModal');
    const modalBody = modal.querySelector('.modal-body');
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <i class="ri-error-warning-line fs-2 text-danger mb-3"></i>
            <p class="text-danger">${message}</p>
        </div>
    `;
}

// View document function
window.viewCustomerDocument = function(attachmentId) {
    console.log('Viewing customer document ID:', attachmentId);
    window.open(`/customer_portal/view-demurrage-document/${attachmentId}`, '_blank');
};
</script>

{% endblock extra_js %}