{% extends "partials/base.html" %}

{% block title %}Non-Working Days Management{% endblock title %}

{% block content %}
<!-- Start right Content here -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
                        <h4 class="mb-sm-0">Non-Working Days Management</h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">Admin</a></li>
                                <li class="breadcrumb-item active">Non-Working Days Management</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" id="flash-message">
                <i class="ri-check-double-line"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <div class="row">
                <div class="col-12">
                    <!-- Action buttons -->
                    <div class="d-flex justify-content-between mb-3">
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="showWeekendGenerator()">
                                <i class="ri-calendar-line me-1"></i> Generate Weekends
                            </button>
                        </div>
                        <a href="{{ url_for('demurrage.new_non_working_day') }}" class="btn btn-primary">
                            <i class="ri-add-line me-1"></i> Add Non-Working Day
                        </a>
                    </div>

                    <!-- Filters Card -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Filters</h5>
                        </div>
                        <div class="card-body">
                            <form method="GET" class="row g-3">
                                <div class="col-md-2">
                                    <label for="entriesPerPage" class="form-label">Show Entries</label>
                                    <select class="form-select" id="entriesPerPage" name="per_page" onchange="this.form.submit()">
                                        <option value="10" {% if request.args.get('per_page')=='10' %}selected{% endif %}>10</option>
                                        <option value="25" {% if request.args.get('per_page')=='25' %}selected{% endif %}>25</option>
                                        <option value="50" {% if request.args.get('per_page')=='50' %}selected{% endif %}>50</option>
                                        <option value="100" {% if request.args.get('per_page')=='100' %}selected{% endif %}>100</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="countryFilter" class="form-label">Country</label>
                                    <select class="form-select" id="countryFilter" name="country_id" onchange="this.form.submit()">
                                        <option value="">All Countries</option>
                                        {% for country in countries %}
                                        <option value="{{ country.countryID }}" {% if request.args.get('country_id')==country.countryID|string %}selected{% endif %}>
                                            {{ country.countryName }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="typeFilter" class="form-label">Type</label>
                                    <select class="form-select" id="typeFilter" name="type" onchange="this.form.submit()">
                                        <option value="">All Types</option>
                                        <option value="WEEKEND" {% if request.args.get('type')=='WEEKEND' %}selected{% endif %}>Weekend</option>
                                        <option value="PUBLIC_HOLIDAY" {% if request.args.get('type')=='PUBLIC_HOLIDAY' %}selected{% endif %}>Public Holiday</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="searchInput" class="form-label">Search</label>
                                    <input type="text" class="form-control" id="searchInput" name="search"
                                        value="{{ request.args.get('search', '') }}" placeholder="Search descriptions...">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label d-none d-md-block">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="ri-filter-3-line me-1"></i> Filter
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Non-Working Days Table Card -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Non-Working Days List</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-nowrap align-middle table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Country</th>
                                            <th>Description</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if non_working_days %}
                                        {% for nwd in non_working_days %}
                                        <tr>
                                            <td>{{ loop.index }}</td>
                                            <td>{{ nwd.date.strftime('%Y-%m-%d') }}</td>
                                            <td>
                                                <span class="badge badge-soft-{{ 'info' if nwd.type == 'WEEKEND' else 'warning' }}">
                                                    {{ nwd.type.replace('_', ' ').title() }}
                                                </span>
                                            </td>
                                            <td>{{ nwd.country.countryName }}</td>
                                            <td>{{ nwd.description }}</td>
                                            <td>
                                                <span class="badge badge-soft-{{ 'success' if nwd.is_active else 'danger' }}">
                                                    {{ 'Active' if nwd.is_active else 'Inactive' }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="d-flex gap-2">
                                                    <a href="{{ url_for('demurrage.edit_non_working_day', nwd_id=nwd.id) }}" class="btn btn-sm btn-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
                                                        <i class="ri-pencil-line"></i>
                                                    </a>
                                                    <button class="btn btn-sm btn-danger" onclick="confirmDelete('{{ nwd.id }}')" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete">
                                                        <i class="ri-delete-bin-line"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <div class="d-flex flex-column align-items-center">
                                                    <i class="ri-calendar-line fs-1 text-muted mb-2"></i>
                                                    <p class="text-muted mb-0">No non-working days found</p>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->

    <!-- Weekend Generator Modal -->
    <!-- Updated Weekend Generator Modal -->
<div class="modal fade" id="weekendModal" tabindex="-1" aria-labelledby="weekendModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="weekendModalLabel">Generate Weekend Days</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="weekendForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="modalCountry" class="form-label">Country <span class="text-danger">*</span></label>
                            <select class="form-select" id="modalCountry" required>
                                <option value="">Select Country</option>
                                {% for country in countries %}
                                <option value="{{ country.countryID }}" {% if country.countryName == 'Sri Lanka' %}selected{% endif %}>
                                    {{ country.countryName }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="modalYear" class="form-label">Year <span class="text-danger">*</span></label>
                            <select class="form-select" id="modalYear" required>
                                <option value="">Select Year</option>
                                {% for year in range(2024, 2031) %}
                                <option value="{{ year }}" {% if year == 2025 %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Select Weekend Days <span class="text-danger">*</span></label>
                        <div class="alert alert-info mb-3">
                            <i class="ri-information-line me-2"></i>
                            Select which days of the week are considered weekends in the selected country.
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-3" id="weekendDaysContainer">
                                    <div class="form-check">
                                        <input class="form-check-input weekend-day" type="checkbox" value="0" id="monday">
                                        <label class="form-check-label fw-medium" for="monday">
                                            Monday
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input weekend-day" type="checkbox" value="1" id="tuesday">
                                        <label class="form-check-label fw-medium" for="tuesday">
                                            Tuesday
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input weekend-day" type="checkbox" value="2" id="wednesday">
                                        <label class="form-check-label fw-medium" for="wednesday">
                                            Wednesday
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input weekend-day" type="checkbox" value="3" id="thursday">
                                        <label class="form-check-label fw-medium" for="thursday">
                                            Thursday
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input weekend-day" type="checkbox" value="4" id="friday">
                                        <label class="form-check-label fw-medium" for="friday">
                                            Friday
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input weekend-day" type="checkbox" value="5" id="saturday" checked>
                                        <label class="form-check-label fw-medium" for="saturday">
                                            Saturday
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input weekend-day" type="checkbox" value="6" id="sunday" checked>
                                        <label class="form-check-label fw-medium" for="sunday">
                                            Sunday
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted">
                            <i class="ri-lightbulb-line me-1"></i>
                            <strong>Common patterns:</strong> 
                            Saturday-Sunday (Most countries), 
                            Friday-Saturday (UAE, Saudi Arabia), 
                            Friday-Sunday (Iran), 
                            Thursday-Friday (Afghanistan)
                        </small>
                    </div>
                    
                    <!-- Quick Select Buttons -->
                    <div class="mb-3">
                        <label class="form-label">Quick Select:</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectWeekendPattern([5, 6])">
                                Sat-Sun
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectWeekendPattern([4, 5])">
                                Fri-Sat
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectWeekendPattern([4, 6])">
                                Fri-Sun
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectWeekendPattern([3, 4])">
                                Thu-Fri
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearWeekendSelection()">
                                Clear All
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="ri-alert-line me-2"></i>
                        This will generate weekend entries for all selected days throughout the year. Existing entries for the same dates will be skipped.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="generateWeekends()">
                    <i class="ri-calendar-line me-1"></i>Generate Weekends
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="ri-alert-line fs-1 text-warning"></i>
                        <h5 class="mt-2">Are you sure you want to delete this non-working day?</h5>
                        <p class="text-muted">This action cannot be undone.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteForm" method="POST">
                        <button type="submit" class="btn btn-danger">
                            <i class="ri-delete-bin-line me-1"></i>Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% block footer %}
    {% include "partials/footer.html" %}
    {% endblock footer %}
</div>
{% endblock content %}

{% block extra_js %}
<script>
// Updated JavaScript functions for weekend generation

function confirmDelete(id) {
    const deleteForm = document.getElementById('deleteForm');
    deleteForm.action = "{{ url_for('demurrage.delete_non_working_day', nwd_id=0) }}".replace('0', id);
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function showWeekendGenerator() {
    // Reset form when opening
    resetWeekendForm();
    new bootstrap.Modal(document.getElementById('weekendModal')).show();
}

function resetWeekendForm() {
    // Clear all checkboxes first
    document.querySelectorAll('.weekend-day').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Set default Saturday-Sunday pattern
    document.getElementById('saturday').checked = true;
    document.getElementById('sunday').checked = true;
}

function selectWeekendPattern(dayNumbers) {
    // Clear all checkboxes first
    document.querySelectorAll('.weekend-day').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // Select the specified days
    dayNumbers.forEach(dayNum => {
        const checkbox = document.querySelector(`.weekend-day[value="${dayNum}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
}

function clearWeekendSelection() {
    document.querySelectorAll('.weekend-day').forEach(checkbox => {
        checkbox.checked = false;
    });
}

function getSelectedWeekendDays() {
    const selectedDays = [];
    document.querySelectorAll('.weekend-day:checked').forEach(checkbox => {
        selectedDays.push(parseInt(checkbox.value));
    });
    return selectedDays;
}

function generateWeekends() {
    const country = document.getElementById('modalCountry').value;
    const year = document.getElementById('modalYear').value;
    const selectedDays = getSelectedWeekendDays();
    
    // Validation
    if (!country || !year) {
        Swal.fire({
            icon: 'warning',
            title: 'Missing Information',
            text: 'Please select both country and year'
        });
        return;
    }
    
    if (selectedDays.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'No Weekend Days Selected',
            text: 'Please select at least one day as weekend'
        });
        return;
    }
    
    // Get country name for confirmation
    const countrySelect = document.getElementById('modalCountry');
    const countryName = countrySelect.options[countrySelect.selectedIndex].text;
    
    // Get day names for confirmation
    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const selectedDayNames = selectedDays.map(dayNum => dayNames[dayNum]).join(', ');
    
    // Show confirmation dialog
    Swal.fire({
        title: 'Confirm Weekend Generation',
        html: `
            <div class="text-start">
                <p><strong>Country:</strong> ${countryName}</p>
                <p><strong>Year:</strong> ${year}</p>
                <p><strong>Weekend Days:</strong> ${selectedDayNames}</p>
                <hr>
                <p class="text-muted small">This will create weekend entries for all ${selectedDayNames} in ${year}. Existing entries will be skipped.</p>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#198754',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, Generate Weekends',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            performWeekendGeneration(country, year, selectedDays);
        }
    });
}

function performWeekendGeneration(country, year, selectedDays) {
    // Show loading state
    Swal.fire({
        title: 'Generating Weekends...',
        html: 'Please wait while we generate the weekend entries.',
        allowOutsideClick: false,
        allowEscapeKey: false,
        showConfirmButton: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
    
    fetch("{{ url_for('demurrage.generate_weekends') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            country_id: country,
            year: year,
            weekend_days: selectedDays
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Close the weekend modal
            const weekendModal = bootstrap.Modal.getInstance(document.getElementById('weekendModal'));
            if (weekendModal) {
                weekendModal.hide();
            }
            
            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: data.message,
                confirmButtonColor: '#198754'
            }).then(() => {
                // Reload the page to show new entries
                location.reload();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Generation Failed',
                text: data.message || 'An error occurred while generating weekends'
            });
        }
    })
    .catch(error => {
        console.error('Error generating weekends:', error);
        Swal.fire({
            icon: 'error',
            title: 'Network Error',
            text: 'Failed to connect to the server. Please try again.'
        });
    });
}

// Initialize tooltips and other functionality when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Add change event listeners to weekend day checkboxes for better UX
    document.querySelectorAll('.weekend-day').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedDaysDisplay();
        });
    });
});

function updateSelectedDaysDisplay() {
    const selectedDays = getSelectedWeekendDays();
    const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    
    // You can add visual feedback here if needed
    console.log('Selected weekend days:', selectedDays.map(dayNum => dayNames[dayNum]).join(', '));
}
</script>
{% endblock extra_js %}