{% extends "partials/base.html" %}

{% block title %}Purchase Order Details - {{ po_header.po_number }}{% endblock title %}

{% block content %}
<!-- Start right Content here -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
                        <h4 class="mb-sm-0">Purchase Order Details</h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item">
                                    <a href="{{ url_for('po.purchase_orders', 
                                        page=request.args.get('return_page', 1),
                                        per_page=request.args.get('return_per_page', 10),
                                        search=request.args.get('return_search', ''),
                                        status=request.args.get('return_status', '')) }}">
                                        Purchase Orders
                                    </a>
                                </li>
                                <li class="breadcrumb-item active">{{ po_header.po_number }}</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <div class="row">
                <div class="col-12">
                    <!-- Back button -->
                    <div class="d-flex justify-content-end mb-3">
                        <a href="{{ url_for('po.purchase_orders', 
                            page=request.args.get('return_page', 1),
                            per_page=request.args.get('return_per_page', 10),
                            search=request.args.get('return_search', ''),
                            status=request.args.get('return_status', '')) }}" 
                            class="btn btn-secondary">
                            <i class="ri-arrow-left-line me-1"></i> Back to List
                        </a>
                    </div>

                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs nav-tabs-custom nav-success mb-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#po-details" role="tab">
                                <i class="ri-file-list-3-line me-1"></i> PO Details
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#shipment-documents" role="tab">
                                <i class="ri-folder-line me-1"></i> Shipment Documents
                                {% if shipment_documents %}
                                <span class="badge badge-soft-primary ms-1">{{ shipment_documents|length }}</span>
                                {% else %}
                                <span class="badge badge-soft-secondary ms-1">0</span>
                                {% endif %}
                            </a>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content">
                        <!-- PO Details Tab -->
                        <div class="tab-pane active" id="po-details" role="tabpanel">
                            <!-- PO Header Card -->
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Purchase Order Information</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <table class="table table-borderless">
                                                <tr>
                                                    <td class="fw-medium" width="40%">System Document No:</td>
                                                    <td>
                                                        <span class="badge badge-soft-primary fs-6">{{ po_header.sysdocnum }}</span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-medium">PO Number:</td>
                                                    <td><span class="badge badge-soft-warning fs-6">{{ po_header.po_number }}</span></td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-medium">PO Date:</td>
                                                    <td>{{ po_header.po_date.strftime('%Y-%m-%d') }}</td>
                                                </tr>

                                                <tr>
                                                    <td class="fw-medium">Currency:</td>
                                                    <td>{{ po_header.currency }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-medium">License Number{{ 's' if shipment_info and shipment_info.shipment_count > 1 else '' }}:</td>
                                                    <td>
                                                        {% if shipment_info and shipment_info.license_numbers %}
                                                            {% for license in shipment_info.license_numbers %}
                                                                <span class="badge badge-soft-info me-1">{{ license }}</span>
                                                                {% if not loop.last %}<br>{% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            <span class="text-muted">N/A</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-medium">Shipment Deadline{{ 's' if shipment_info and shipment_info.shipment_count > 1 else '' }}:</td>
                                                    <td>
                                                        {% if shipment_info and shipment_info.shipment_deadlines %}
                                                            {% for deadline in shipment_info.shipment_deadlines %}
                                                                <span class="fw-medium text-danger">{{ deadline }}</span>
                                                                {% if not loop.last %}<br>{% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            <span class="text-muted">N/A</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <table class="table table-borderless">
                                                <tr>
                                                    <td class="fw-medium">Job No{{ 's' if shipment_info and shipment_info.shipment_count > 1 else '' }}:</td>
                                                    <td>
                                                        {% if shipment_info and shipment_info.import_ids %}
                                                            {% for import_id in shipment_info.import_ids %}
                                                                <span class="badge badge-soft-info fs-6">{{ import_id }}</span>
                                                                {% if not loop.last %}<br>{% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            <span class="text-muted">N/A</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-medium" width="40%">Supplier Code:</td>
                                                    <td><span class="badge badge-soft-success fs-6">{{ po_header.supplier.supplier_code }}</span></td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-medium">Supplier Name:</td>
                                                    <td>{{ po_header.supplier.supplier_name }}</td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-medium">Total Value:</td>
                                                    <td>
                                                        {{ po_header.currency }} {{ "{:,.2f}".format(po_header.total_value) }}
                                                    </td>
                                                </tr>
                                        
                                                <tr>
                                                    <td class="fw-medium" width="40%">Port{{ 's' if shipment_info and shipment_info.shipment_count > 1 else '' }} of Loading:</td>
                                                    <td>
                                                        {% if shipment_info and shipment_info.ports_of_loading %}
                                                            {% for port in shipment_info.ports_of_loading %}
                                                                <i class="ri-upload-line me-1 text-primary"></i> {{ port }}
                                                                {% if not loop.last %}<br>{% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            <span class="text-muted">N/A</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="fw-medium">Port{{ 's' if shipment_info and shipment_info.shipment_count > 1 else '' }} of Discharge:</td>
                                                    <td>
                                                        {% if shipment_info and shipment_info.ports_of_discharge %}
                                                            {% for port in shipment_info.ports_of_discharge %}
                                                                <i class="ri-download-line me-1 text-primary"></i> {{ port }}
                                                                {% if not loop.last %}<br>{% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            <span class="text-muted">N/A</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <hr>
                                            <div class="row align-items-center">
                                                
                                                <div class="col-md-12">
                                                    <div class="d-flex align-items-center">
                                                        <strong class="me-2">PO Term:</strong>
                                                        <span id="payment-term-display" class="me-2">
                                                            {% if po_header.payment_term %}
                                                                <span class="badge badge-soft-info fs-6">{{ po_header.payment_term }}</span>
                                                            {% else %}
                                                                <span class="text-muted">Not set</span>
                                                            {% endif %}
                                                        </span>
                                                        <button type="button" 
                                                                class="btn btn-sm btn-outline-primary" 
                                                                onclick="editPaymentTerm({{ po_header.id }}, '{{ po_header.payment_term|default('') }}')">
                                                            <i class="ri-edit-line me-1"></i>Edit
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PO Details Card -->
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Line Items ({{ po_details|length }} items)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-nowrap align-middle table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Item #</th>
                                                    <th>Material Code</th>
                                                    <th>Material Description</th>
                                                    <th>Order Qty</th>
                                                    <th>Qty Received</th>
                                                    <th>Qty Pending</th>
                                                    <th>Unit</th>
                                                    <th>Net Price</th>
                                                    <th>Line Total</th>
                                                    <th>Delivery Date</th>
                                                    <th>Delivered Date</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for detail in po_details %}
                                                <tr>
                                                    <td>
                                                        <span class="badge badge-soft-info">{{ detail.item_number }}</span>
                                                    </td>
                                                    <td>
                                                        <span class="fw-medium">{{ detail.material_code }}</span>
                                                    </td>
                                                    <td>
                                                        <div class="text-wrap" style="max-width: 300px;">
                                                            {{ detail.material_name }}
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <span class="fw-medium">{{ "{:,.3f}".format(detail.order_quantity) }}</span>
                                                    </td>
                                                    <td>
                                                        <span class="fw-medium">{{ "{:,.3f}".format(detail.quantity_received) }}</span>
                                                    </td>
                                                    <td>
                                                        <span class="fw-medium">{{ "{:,.3f}".format(detail.quantity_pending) }}</span>
                                                    </td>
                                                    <td>{{ detail.order_unit }}</td>
                                                    <td>{{ po_header.currency }} {{ "{:,.2f}".format(detail.net_price) }}</td>
                                                    <td>
                                                        <span class="fw-bold text-success">{{ po_header.currency }} {{ "{:,.2f}".format(detail.line_total) }}</span>
                                                    </td>
                                                    <td>
                                                        {% if detail.delivery_date %}
                                                            {{ detail.delivery_date.strftime('%Y-%m-%d') }}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <input type="date" 
                                                                   id="delivered_date_{{ detail.id }}" 
                                                                   value="{{ detail.date_delivered.strftime('%Y-%m-%d') if detail.date_delivered else '' }}" 
                                                                   class="form-control form-control-sm me-2" 
                                                                   style="width: 140px;">
                                                            <button type="button" 
                                                                    class="btn btn-sm btn-primary update-delivered-btn" 
                                                                    data-detail-id="{{ detail.id }}">
                                                                <i class="ri-save-line me-1"></i>Save
                                                            </button>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        {% if detail.is_completed %}
                                                            <span class="badge badge-soft-success">Completed</span>
                                                        {% elif detail.quantity_received >= detail.order_quantity %}
                                                            <span class="badge badge-soft-success">Completed</span>
                                                        {% elif detail.quantity_received > 0 %}
                                                            <span class="badge badge-soft-warning">Partial</span>
                                                        {% else %}
                                                            <span class="badge badge-soft-info">Pending</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                            <tfoot class="table-light">
                                                <tr>
                                                    <th colspan="8" class="text-end">Total:</th>
                                                    <th>
                                                        <span class="fw-bold text-primary fs-5">{{ po_header.currency }} {{ "{:,.2f}".format(po_header.total_value) }}</span>
                                                    </th>
                                                    <th colspan="3"></th>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Summary Cards -->
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body text-center">
                                            <i class="ri-file-list-3-line fs-1 text-primary mb-2"></i>
                                            <h5 class="mb-1">{{ po_details|length }}</h5>
                                            <p class="text-muted mb-0">Total Items</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body text-center">
                                            <i class="ri-shopping-cart-line fs-1 text-success mb-2"></i>
                                            <h5 class="mb-1">{{ "{:,.0f}".format(po_details|sum(attribute='order_quantity')) }}</h5>
                                            <p class="text-muted mb-0">Total Quantity</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body text-center">
                                            <i class="ri-truck-line fs-1 text-warning mb-2"></i>
                                            <h5 class="mb-1">{{ "{:,.0f}".format(po_details|sum(attribute='quantity_received')) }}</h5>
                                            <p class="text-muted mb-0">Received</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body text-center">
                                            <i class="ri-time-line fs-1 text-info mb-2"></i>
                                            <h5 class="mb-1">{{ "{:,.0f}".format(po_details|sum(attribute='quantity_pending')) }}</h5>
                                            <p class="text-muted mb-0">Pending</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Shipment Documents Tab -->
                        <div class="tab-pane" id="shipment-documents" role="tabpanel">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">
                                        <i class="ri-folder-line me-2"></i>Shipment Documents 
                                        {% if shipment_documents %}
                                        <span class="badge badge-soft-primary ms-2">{{ shipment_documents|length }} documents</span>
                                        {% else %}
                                        <span class="badge badge-soft-secondary ms-2">0 documents</span>
                                        {% endif %}
                                    </h5>
                                    <p class="text-muted mb-0 mt-1">
                                    {% if shipment_info and shipment_info.import_ids %}
                                        <small>Related to shipment{{ 's' if shipment_info.shipment_count > 1 else '' }}: 
                                            {% for import_id in shipment_info.import_ids %}
                                                <strong>{{ import_id }}</strong>{% if not loop.last %}, {% endif %}
                                            {% endfor %}
                                        </small>
                                    {% endif %}
                                </p>
                                </div>
                                <div class="card-body">
                                    {% if shipment_documents %}
                                    <div class="row">
                                        {% for document in shipment_documents %}
                                        <div class="col-md-6 col-lg-4 mb-3">
                                            <div class="card border">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-start">
                                                        <div class="flex-shrink-0">
                                                            {% if document.document_type == 'invoice' %}
                                                                <i class="ri-file-text-line fs-2 text-success"></i>
                                                            {% elif document.document_type == 'bill-of-lading' %}
                                                                <i class="ri-ship-line fs-2 text-primary"></i>
                                                            {% elif document.document_type == 'packing-list' %}
                                                                <i class="ri-list-check fs-2 text-warning"></i>
                                                            {% elif document.document_type == 'customs' %}
                                                                <i class="ri-government-line fs-2 text-danger"></i>
                                                            {% elif document.document_type == 'certificate' %}
                                                                <i class="ri-award-line fs-2 text-info"></i>
                                                            {% else %}
                                                                <i class="ri-file-line fs-2 text-secondary"></i>
                                                            {% endif %}
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <div class="d-flex justify-content-between">
                                                                <h6 class="mb-1">{{ document.document_name }}</h6>
                                                                <h6 class="mb-1 bag"><span class="badge badge-soft-primary fs-6">{{ document.ship_doc_entry.docserial }}</span></h6>
                                                            </div>

                                                            <p class="text-muted mb-2 small">
                                                                <span class="badge badge-soft-{{ 
                                                                    'success' if document.document_type == 'invoice' else
                                                                    'primary' if document.document_type == 'bill-of-lading' else
                                                                    'warning' if document.document_type == 'packing-list' else
                                                                    'danger' if document.document_type == 'customs' else
                                                                    'info' if document.document_type == 'certificate' else
                                                                    'secondary'
                                                                }}">{{ document.document_type|title }}</span>
                                                                {% if document.is_confidential %}
                                                                <span class="badge badge-soft-danger ms-1">
                                                                    <i class="ri-lock-line"></i> Confidential
                                                                </span>
                                                                {% endif %}
                                                            </p>
                                                            {% if document.description %}
                                                            <p class="text-muted small mb-2">{{ document.description }}</p>
                                                            {% endif %}
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <small class="text-muted">
                                                                    {{ document.created_at.strftime('%Y-%m-%d') }}
                                                                </small>
                                                                <a href="{{ url_for('po.view_po_document', po_id=po_header.id, document_id=document.id) }}" 
                                                                   class="btn btn-sm btn-outline-primary" 
                                                                   target="_blank">
                                                                    <i class="ri-eye-line me-1"></i>View
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <i class="ri-folder-open-line fs-1 text-muted mb-3"></i>
                                        <h5 class="text-muted mb-2">No Documents Available</h5>
                                        <p class="text-muted">No documents have been uploaded for this shipment yet.</p>
                                    </div>
                                    {% endif %}
                                </div>
            </div>
        </div>
    </div>
</div>
</div>
<!-- container-fluid -->
</div>
<!-- End Page-content -->

{% block footer %}
{% include "partials/footer.html" %}
{% endblock footer %}
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle delivered date update
    document.querySelectorAll('.update-delivered-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            
            const detailId = this.getAttribute('data-detail-id');
            const dateInput = document.getElementById(`delivered_date_${detailId}`);
            const deliveredDate = dateInput.value;
            
            if (!deliveredDate) {
                Swal.fire('Warning', 'Please select a delivery date first.', 'warning');
                return;
            }
            
            // Show loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="ri-loader-4-line me-1"></i>Saving...';
            this.disabled = true;
            
            // Prepare form data
            const formData = new FormData();
            formData.append('delivered_date', deliveredDate);
            
            // Get CSRF token if available
            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            if (csrfToken) {
                formData.append('csrf_token', csrfToken.getAttribute('content'));
            }
            
            // Send AJAX request
            fetch(`{{ url_for('po.update_delivered_date', po_detail_id=0) }}`.replace('0', detailId), {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                this.innerHTML = originalText;
                this.disabled = false;
                
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Updated!',
                        text: data.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Update the status badge if needed
                    const row = this.closest('tr');
                    const statusBadge = row.querySelector('td:last-child span');
                    if (statusBadge && deliveredDate) {
                        // You can add logic here to update status based on delivery
                    }
                } else {
                    Swal.fire('Error', data.message || 'Failed to update delivered date', 'error');
                }
            })
            .catch(error => {
                this.innerHTML = originalText;
                this.disabled = false;
                console.error('Error:', error);
                Swal.fire('Error', 'An error occurred while updating the delivered date.', 'error');
            });
        });
    });
});
</script>

<script>
function editPaymentTerm(poId, currentTerm) {
    Swal.fire({
        title: 'Update PO Term',
        input: 'text',
        inputValue: currentTerm,
        inputPlaceholder: 'Enter payment term (e.g., NET 30, COD, etc.)',
        showCancelButton: true,
        confirmButtonText: 'Update',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#6c757d',
        inputValidator: (value) => {
            if (!value || value.trim() === '') {
                return 'PO term cannot be empty!';
            }
            if (value.length > 100) {
                return 'PO term cannot exceed 500 characters!';
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            updatePaymentTerm(poId, result.value.trim());
        }
    });
}

function updatePaymentTerm(poId, paymentTerm) {
    // Show loading
    Swal.fire({
        title: 'Updating...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    // Prepare form data
    const formData = new FormData();
    formData.append('payment_term', paymentTerm);
    
    // Get CSRF token if available
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    if (csrfToken) {
        formData.append('csrf_token', csrfToken.getAttribute('content'));
    }

    // Send AJAX request
    fetch(`/purchase_orders/${poId}/update-payment-term`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Update the display
            const displayElement = document.getElementById('payment-term-display');
            displayElement.innerHTML = `<span class="badge badge-soft-info fs-6">${paymentTerm}</span>`;
            
            Swal.fire({
                icon: 'success',
                title: 'Updated!',
                text: data.message,
                timer: 2000,
                showConfirmButton: false
            });
        } else {
            Swal.fire('Error', data.message || 'Failed to update PO term', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'An error occurred while updating the PO term.', 'error');
    });
}
</script>

{% endblock extra_js %}