{% extends "partials/base.html" %}

{% block title %}PO Dashboard{% endblock title %}

{% block extra_css %}
<!-- Include FullCalendar CSS -->
<link href="{{url_for('static' ,filename='libs/fullcalendar/main.min.css')}}" rel="stylesheet" type="text/css" />
<style>
    /* PO Calendar styling */
    .po-calendar {
        display: flex;
        flex-direction: column;
    }
    
    .po-calendar-card {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .po-calendar-card .card-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 0;
    }
    
    #po-calendar {
        flex: 1;
        min-height: 400px;
    }
    
    /* Style for PO events */
    .po-event {
        font-weight: 500;
        padding: 3px 6px;
        border-radius: 4px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.85rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* Style for PO Detail events - reverted to original styling */
    .po-detail-event {
        font-weight: 500;
        padding: 2px 5px;
        border-radius: 3px;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.8rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        border-left: 3px solid #0dcaf0;
        margin-bottom: 2px;
    }
    
    /* Improved Show more indicator */
    .po-show-more {
        font-weight: 600;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        color: #495057;
        text-align: center;
        margin-bottom: 2px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }
    
    .po-show-more:hover {
        background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        border-color: #adb5bd;
        color: #212529;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .po-show-more i {
        font-size: 0.9em;
        animation: bounce 1.5s infinite;
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }
        40% {
            transform: translateY(-3px);
        }
        60% {
            transform: translateY(-2px);
        }
    }
    
    /* Override FullCalendar event styles */
    .po-calendar .fc-event {
        border: none !important;
        background-color: transparent !important;
    }
    
    .po-calendar .fc-event-main {
        background-color: transparent !important;
    }
    
    /* Loading indicator */
    .po-calendar-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
    }
    
    /* PO calendar list view time styling */
    .po-calendar .fc-list-event-time {
        color: #000000 !important;
    }
    
    /* Responsive adjustments */
    @media (max-width: 991.98px) {
        #po-calendar {
            min-height: 300px;
        }
    }

    /* Modal fixes */
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.5) !important;
    }
    
    .modal-backdrop.show {
        opacity: 0.5 !important;
    }

    /* PO Item styling in modal */
    .po-item {
        border-left: 3px solid #007bff;
        background-color: #f8f9fa;
        margin-bottom: 10px;
        border-radius: 6px;
    }

    .po-item.partial {
        border-left-color: #ffc107;
    }

    .po-item.pending {
        border-left-color: #dc3545;
    }

    .po-item.completed {
        border-left-color: #28a745;
    }

    /* Progress bar styling */
    .progress-custom {
        height: 8px;
        border-radius: 4px;
    }

    /* Status badge styling */
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    /* PO Table styling with proper padding */
    .po-table {
        font-size: 0.9rem;
    }
    
    .po-table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
        padding: 15px 12px;
        border-bottom: 2px solid #dee2e6;
    }
    
    .po-table td {
        padding: 12px;
        vertical-align: middle;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .po-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .po-table .progress {
        height: 6px;
        margin-bottom: 0;
    }

    /* Modal content padding fixes */
    .modal-body-padded {
        padding: 1.5rem !important;
    }

    .table-container {
        margin: -1rem -1.5rem;
    }

    .modal-footer-custom {
        padding: 1rem 1.5rem;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        margin: 1.5rem -1.5rem -1.5rem -1.5rem;
    }

    /* Enhanced modal header */
    .modal-header-custom {
        background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%);
        border-bottom: 1px solid #dee2e6;
    }

    /* Summary section styling */
    .summary-section {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    /* Larger modal for table data */
    @media (min-width: 992px) {
        .modal-xl {
            max-width: 90% !important;
        }
    }

    @media (min-width: 1200px) {
        .modal-xl {
            max-width: 85% !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Start right Content here -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                        <h4 class="mb-sm-0">PO Dashboard</h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">Home</a></li>
                                <li class="breadcrumb-item active">PO Dashboard</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            <!-- Statistics Cards -->
            <div class="row">
                <div class="col-xl-3 col-md-3">
                    <div class="card card-animate card-hover shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 avatar-sm rounded-circle bg-light p-2 me-3">
                                    <span class="avatar-title bg-soft-primary text-primary rounded-circle fs-3">
                                        <i class="ri-file-list-3-line"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1 overflow-hidden">
                                    <h5 class="text-muted text-uppercase fs-13 mb-1">Total Purchase Orders</h5>
                                    <h2 class="mb-0 ff-secondary fw-semibold">
                                        <span class="counter-value" data-target="{{ statistics.total_pos }}">{{ statistics.total_pos }}</span>
                                    </h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-3">
                    <div class="card card-animate card-hover shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 avatar-sm rounded-circle bg-light p-2 me-3">
                                    <span class="avatar-title bg-soft-danger text-danger rounded-circle fs-3">
                                        <i class="ri-time-line"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1 overflow-hidden">
                                    <h5 class="text-muted text-uppercase fs-13 mb-1">Pending Purchase Orders</h5>
                                    <h2 class="mb-0 ff-secondary fw-semibold">
                                        <span class="counter-value" data-target="{{ statistics.pending_pos }}">{{ statistics.pending_pos }}</span>
                                    </h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-md-3">
                    <div class="card card-animate card-hover shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 avatar-sm rounded-circle bg-light p-2 me-3">
                                    <span class="avatar-title bg-soft-warning text-warning rounded-circle fs-3">
                                        <i class="ri-truck-line"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1 overflow-hidden">
                                    <h5 class="text-muted text-uppercase fs-13 mb-1">Partial Purchase Orders</h5>
                                    <h2 class="mb-0 ff-secondary fw-semibold">
                                        <span class="counter-value" data-target="{{ statistics.partial_pos }}">{{ statistics.partial_pos }}</span>
                                    </h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Add this new card after the existing 3 cards -->
                <div class="col-xl-3 col-md-3">
                    <div class="card card-animate card-hover shadow-sm cursor-pointer" onclick="showOverduePODetails()">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0 avatar-sm rounded-circle bg-light p-2 me-3">
                                    <span class="avatar-title bg-soft-danger text-danger rounded-circle fs-3">
                                        <i class="ri-alarm-warning-line"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1 overflow-hidden">
                                    <h5 class="text-muted text-uppercase fs-13 mb-1">Overdue Purchase Orders</h5>
                                    <h2 class="mb-0 ff-secondary fw-semibold">
                                        <span class="counter-value" data-target="{{ statistics.overdue_pos }}">{{ statistics.overdue_pos }}</span>
                                    </h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <!-- PO Calendar -->
                <div class="col-12">
                    <div class="po-calendar">
                        <div class="card po-calendar-card shadow-sm">
                            <div class="card-header py-2">
                                <div class="d-flex align-items-center">
                                    <h5 class="card-title mb-0 flex-grow-1">
                                        <i class="ri-calendar-event-line text-primary me-2"></i>PO Shipment & Delivery Calendar
                                    </h5>
                                    <div class="flex-shrink-0">
                                        <div class="d-flex gap-2">
                                            <div class="btn-group">
                                                <button class="btn btn-soft-primary btn-sm" id="po-btn-month">Month</button>
                                                <button class="btn btn-soft-secondary btn-sm" id="po-btn-list">List</button>
                                            </div>
                                            <button class="btn btn-soft-info btn-sm" id="po-btn-refresh">
                                                <i class="ri-refresh-line"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- Legend -->
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="ri-ship-line text-primary me-1"></i>Shipments
                                        <span class="ms-3"><i class="ri-truck-line text-info me-1"></i>Item Deliveries</span>
                                    </small>
                                </div>
                            </div>
                            <div class="card-body position-relative">
                                <!-- Loading indicator -->
                                <div class="po-calendar-loading d-none" id="po-calendar-loader">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                                <!-- Calendar container -->
                                <div id="po-calendar"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PO Shipment Details Modal -->
            <div class="modal fade" id="po-details-modal" tabindex="-1" data-bs-backdrop="true" data-bs-keyboard="true">
                <div class="modal-dialog modal-dialog-centered modal-xl">
                    <div class="modal-content border-0">
                        <div class="modal-header modal-header-custom p-3">
                            <h5 class="modal-title">
                                <i class="ri-ship-line text-primary me-2"></i>PO Shipment Details
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body modal-body-padded">
                            <!-- Shipment Info -->
                            <div class="summary-section">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0 me-3">
                                                <i class="ri-ship-line text-primary fs-24"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">Job No</h6>
                                                <p class="text-muted mb-0" id="modal-job-no"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0 me-3">
                                                <i class="ri-calendar-event-line text-success fs-24"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">Date</h6>
                                                <p class="text-muted mb-0" id="modal-date"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0 me-3">
                                                <i class="ri-map-pin-line text-info fs-24"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">Port of Loading</h6>
                                                <p class="text-muted mb-0" id="modal-pol"></p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="d-flex align-items-center">
                                            <div class="flex-shrink-0 me-3">
                                                <i class="ri-map-pin-5-line text-warning fs-24"></i>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1">Port of Discharge</h6>
                                                <p class="text-muted mb-0" id="modal-pod"></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- PO Details -->
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="mb-3">
                                        <i class="ri-file-list-3-line text-primary me-2"></i>Purchase Orders in this Shipment
                                    </h6>
                                    <div id="po-details-container">
                                        <!-- PO details will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer modal-footer-custom">
                       
                        </div>
                    </div>
                </div>
            </div>

            <!-- PO Details for Date Modal -->
            <div class="modal fade" id="po-date-details-modal" tabindex="-1" data-bs-backdrop="true" data-bs-keyboard="true">
                <div class="modal-dialog modal-dialog-centered modal-fullscreen-lg-down modal-xl">
                    <div class="modal-content border-0">
                        <div class="modal-header modal-header-custom p-3">
                            <h5 class="modal-title">
                                <i class="ri-calendar-event-line text-info me-2"></i>Purchase Orders for <span id="modal-delivery-date"></span>
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-3">
                            <!-- Loading indicator for modal -->
                            <div class="text-center p-4 d-none" id="po-date-loading">
                                <div class="spinner-border text-info" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading PO details...</p>
                            </div>

                            <!-- PO Details Table -->
                            <div id="po-date-content">
                                <div class="table-responsive">
                                    <table class="table table-hover po-table mb-0">
                                        <thead>
                                            <tr>
                                                <th>PO Number</th>
                                                <th>Item #</th>
                                                <th>Material Code</th>
                                                <th>Material Name</th>
                                                <th>Supplier</th>
                                                <th>Order Qty</th>
                                                <th>Received</th>
                                                <th>Pending</th>
                                                <th>Progress</th>
                                                <th class="text-center">Documents</th>
                                                <th>Status</th>
                                                <th>Value</th>
                                            </tr>
                                        </thead>
                                        <tbody id="po-date-table-body">
                                            <!-- PO item rows will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer bg-light border-top">
                            <div class="row align-items-center w-100">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="ri-file-list-3-line text-muted me-2"></i>
                                        <span class="text-muted">Total Items: <strong id="modal-total-pos">0</strong></span>
                                    </div>
                                </div>
                          
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PO Document Management Modal for Dashboard -->
            <div class="modal fade" id="poDocumentModalDashboard" tabindex="-1" aria-labelledby="poDocumentModalDashboardLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="poDocumentModalDashboardLabel">
                                <i class="ri-file-text-line me-2"></i>Shipment Documents for Purchase Order
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="poDocumentSectionDashboard">
                                <!-- Document info will be displayed here -->
                                <div class="alert alert-info mb-3" id="poDocumentInfoDashboard">
                                    <i class="ri-information-line me-2"></i>
                                    <span id="poDocumentInfoTextDashboard">Loading document information...</span>
                                </div>
                                
                                <!-- Document status and progress will be displayed here -->
                                <div id="poDocumentProgressDashboard"></div>
                                
                                <!-- Existing documents will be loaded here dynamically -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Uploaded Documents</h6>
                                    </div>
                                    <div class="card-body" id="poExistingDocumentsDashboard">
                                        <!-- Existing documents will be populated here -->
                                    </div>
                                </div>

                                <!-- Required Documents Section -->
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="card-title mb-0">Required Documents</h6>
                                    </div>
                                    <div class="card-body" id="poRequiredDocumentsDashboard">
                                        <!-- Required documents will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="ri-close-line me-1"></i>Close
                            </button>
                            <button type="button" class="btn btn-primary" id="goToShipmentBtnDashboard" style="display: none;">
                                <i class="ri-ship-line me-1"></i>Go to Shipment
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->


    <!-- Overdue PO Details Modal -->
    <div class="modal fade" id="overdue-po-modal" tabindex="-1" data-bs-backdrop="true" data-bs-keyboard="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content border-0">
                <div class="modal-header bg-danger-subtle p-3">
                    <h5 class="modal-title">
                        <i class="ri-alarm-warning-line text-danger me-2"></i>Overdue Purchase Orders
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-3">
                    <!-- Loading indicator -->
                    <div class="text-center p-4 d-none" id="overdue-loading">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading overdue PO details...</p>
                    </div>

                    <!-- Overdue PO Content -->
                    <div id="overdue-content">
                        <div id="overdue-summary" class="alert alert-danger d-none">
                            <i class="ri-information-line me-2"></i>
                            <span id="overdue-summary-text">Loading...</span>
                        </div>
                        
                        <div id="overdue-pos-container">
                            <!-- Overdue PO details will be populated here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="ri-close-line me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>


    {% block footer %}
    {% include "partials/footer.html" %}
    {% endblock footer %}
</div>
{% endblock content %}

{% block extra_js %}
<script src="{{url_for('static' ,filename='libs/fullcalendar/main.min.js')}}"></script>

<script>
    let currentPOIdDashboard = null;
    let currentShipmentIdDashboard = null;
    let currentShipCatIdDashboard = null;
    let currentShipTypeIdDashboard = null;
    let poDocumentModalDashboard = null;


    document.addEventListener('DOMContentLoaded', function () {
        console.log("PO Calendar initialization started");
        
        // Show loading indicator
        const poCalendarLoader = document.getElementById('po-calendar-loader');
        let poCalendar;
        
        try {
            // Initialize PO calendar
            var poCalendarEl = document.getElementById('po-calendar');
            
            if (!poCalendarEl) {
                console.error("Error: PO calendar element not found!");
                return;
            }
            
            // Check if FullCalendar is loaded
            if (typeof FullCalendar === 'undefined') {
                console.error("Error: FullCalendar library not loaded!");
                return;
            }
            
            // Create PO calendar
            poCalendar = new FullCalendar.Calendar(poCalendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: false // Hide default view buttons, we have custom ones
                },
                height: 'auto',
                contentHeight: 'auto',
                aspectRatio: 1.5,
                selectable: false,
                dayMaxEvents: true,
                events: [],
                eventClick: function(info) {
                    console.log("Event clicked:", info.event);
                    if (info.event.extendedProps && info.event.extendedProps.isPODetail) {
                        showPODetailsForDate(info.event);
                    } else if (info.event.extendedProps && info.event.extendedProps.isPO) {
                        showPODetails(info.event);
                    }
                },
                eventContent: function(arg) {
                    var eventHtml = '';
                    if (arg.event.extendedProps && arg.event.extendedProps.isPO) {
                        // Shipment events (keep unchanged)
                        var colorClass = arg.event.extendedProps.colorClass || 'primary';
                        var poCount = arg.event.extendedProps.po_count || 0;
                        eventHtml = `
                            <div class="po-event bg-${colorClass}-subtle text-${colorClass}">
                                <i class="ri-ship-line me-1"></i> ${arg.event.title} - ${poCount} PO${poCount > 1 ? 's' : ''}
                            </div>
                        `;
                        return { html: eventHtml };
                    } else if (arg.event.extendedProps && arg.event.extendedProps.isPODetail) {
                        // PO Detail events (updated for max 3 display)
                        var statusIcon = getStatusIcon(arg.event.extendedProps.status);
                        var showMore = arg.event.extendedProps.has_more_pos;
                        var totalPosForDate = arg.event.extendedProps.total_pos_for_date;
                        
                        eventHtml = `
                            <div class="po-detail-event bg-info-subtle text-info" 
                                 data-delivery-date="${arg.event.extendedProps.delivery_date}">
                                <i class="${statusIcon} me-1"></i> ${arg.event.title}
                            </div>
                        `;
                        
                        // Add "Show More" indicator if this is the last visible PO and there are more
                        if (showMore) {
                            var moreCount = totalPosForDate - 3;
                            eventHtml += `
                                <div class="po-show-more" 
                                     data-delivery-date="${arg.event.extendedProps.delivery_date}">
                                    <i class="ri-arrow-down-line"></i>
                                    <span>+${moreCount} more</span>
                                </div>
                            `;
                        }
                        
                        return { html: eventHtml };
                    }
                    return;
                },

                views: {
                    dayGridMonth: {
                        titleFormat: { year: 'numeric', month: 'long' },
                        dayHeaderFormat: { weekday: 'short' }
                    },
                    listMonth: {
                        listDayFormat: { weekday: 'long', day: 'numeric', month: 'long' },
                        listDaySideFormat: { year: 'numeric' }
                    }
                },
                datesSet: function(dateInfo) {
                    // Update active button based on current view
                    const monthBtn = document.getElementById('po-btn-month');
                    const listBtn = document.getElementById('po-btn-list');
                    
                    if (monthBtn && listBtn) {
                        if (dateInfo.view.type === 'dayGridMonth') {
                            monthBtn.classList.remove('btn-soft-secondary');
                            monthBtn.classList.add('btn-soft-primary');
                            listBtn.classList.remove('btn-soft-primary');
                            listBtn.classList.add('btn-soft-secondary');
                        } else {
                            listBtn.classList.remove('btn-soft-secondary');
                            listBtn.classList.add('btn-soft-primary');
                            monthBtn.classList.remove('btn-soft-primary');
                            monthBtn.classList.add('btn-soft-secondary');
                        }
                    }
                }
            });
            
            // Render the calendar
            poCalendar.render();
            console.log("PO calendar rendering complete");
            
            // Handle view buttons
            const monthBtn = document.getElementById('po-btn-month');
            const listBtn = document.getElementById('po-btn-list');
            const refreshBtn = document.getElementById('po-btn-refresh');
            
            if (monthBtn) {
                monthBtn.addEventListener('click', function() {
                    poCalendar.changeView('dayGridMonth');
                });
            }
            
            if (listBtn) {
                listBtn.addEventListener('click', function() {
                    poCalendar.changeView('listMonth');
                });
            }
            
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    fetchAllCalendarData(poCalendar);
                });
            }
            
            // Fetch all calendar data (shipments + PO details)
            fetchAllCalendarData(poCalendar);
            
        } catch (error) {
            console.error("Error initializing PO calendar:", error.message);
            if (poCalendarLoader) poCalendarLoader.classList.add('d-none');
        }
        
        // Function to fetch all calendar data
        function fetchAllCalendarData(calendar) {
            if (poCalendarLoader) poCalendarLoader.classList.remove('d-none');
            
            // Fetch both shipment data and PO detail data
            Promise.all([
                fetch('/purchase_orders/api/po_calendar_data').then(response => response.json()),
                fetch('/purchase_orders/api/po_detail_calendar_data').then(response => response.json())
            ])
            .then(([shipmentData, poDetailData]) => {
                console.log("Received shipment data:", shipmentData);
                console.log("Received PO detail data:", poDetailData);
                
                // Transform both data sets into FullCalendar event format
                var shipmentEvents = transformPODataToEvents(shipmentData);
                var poDetailEvents = transformPODetailDataToEvents(poDetailData);
                
                // Combine all events
                var allEvents = [...shipmentEvents, ...poDetailEvents];
                
                // Remove all existing events
                if (calendar) {
                    calendar.getEvents().forEach(function(event) {
                        event.remove();
                    });
                    
                    // Add new events
                    allEvents.forEach(function(event) {
                        calendar.addEvent(event);
                    });
                }
                
                console.log("Calendar updated with", shipmentEvents.length, "shipment events and", poDetailEvents.length, "PO detail events");
            })
            .catch(error => {
                console.error('Error fetching calendar data:', error);
            })
            .finally(() => {
                if (poCalendarLoader) poCalendarLoader.classList.add('d-none');
            });
        }

        // Add this line after other modal initializations
        poDocumentModalDashboard = new bootstrap.Modal(document.getElementById('poDocumentModalDashboard'));
    });

    // Transform PO API data to calendar events (existing function - unchanged)
    function transformPODataToEvents(data) {
        return data.map(function(shipment) {
            var colorClass = getPOColorClass(shipment);
            
            return {
                id: 'shipment_' + shipment.ship_doc_entry_id,
                title: shipment.import_id || 'Job #' + shipment.ship_doc_entry_id,
                start: shipment.display_date,
                extendedProps: {
                    isPO: true,
                    ship_doc_entry_id: shipment.ship_doc_entry_id,
                    import_id: shipment.import_id,
                    vessel: shipment.vessel,
                    voyage: shipment.voyage,
                    port_of_loading: shipment.port_of_loading,
                    port_of_discharge: shipment.port_of_discharge,
                    po_count: shipment.po_count,
                    pos: shipment.pos,
                    colorClass: colorClass
                },
                className: 'bg-' + colorClass + '-subtle',
                display: 'block'
            };
        });
    }


    // Copy all the PO document functions from purchase_orders.html but rename them with "Dashboard" suffix
    function openPODocumentModalDashboard(poId, shipmentId, shipCatId, shipTypeId) {
        console.log('Opening PO document modal (Dashboard) with:', { poId, shipmentId, shipCatId, shipTypeId });
        
        if (!poId || !shipmentId || !shipCatId || !shipTypeId) {
            showToast('danger', 'Invalid parameters for document management');
            return;
        }
        
        // Store current IDs for later use
        currentPOIdDashboard = poId;
        currentShipmentIdDashboard = shipmentId;
        currentShipCatIdDashboard = shipCatId;
        currentShipTypeIdDashboard = shipTypeId;
        
        // Show loading state
        const existingDocuments = document.getElementById('poExistingDocumentsDashboard');
        const requiredDocuments = document.getElementById('poRequiredDocumentsDashboard');
        const documentInfo = document.getElementById('poDocumentInfoTextDashboard');
        
        if (!existingDocuments || !requiredDocuments) {
            console.error('PO Document modal container elements not found');
            return;
        }
        
        // Show loading indicators
        documentInfo.textContent = `Loading document information for PO and Shipment...`;
        existingDocuments.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading existing documents...</p></div>';
        requiredDocuments.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Loading required documents...</p></div>';
        
        // Hide "Go to Shipment" button initially
        document.getElementById('goToShipmentBtnDashboard').style.display = 'none';
        
        // Show the modal
        poDocumentModalDashboard.show();
        
        // Load PO and shipment information
        loadPODocumentInfoDashboard();
    }

    // Function to load PO document information for dashboard
    async function loadPODocumentInfoDashboard() {
        try {
            // First get PO information
            const poResponse = await fetch(`/purchase_orders/get-po-info/${currentPOIdDashboard}`);
            if (!poResponse.ok) {
                throw new Error(`Failed to get PO details: ${poResponse.status}`);
            }
            const poData = await poResponse.json();
            
            if (!poData.success) {
                throw new Error(poData.message || 'Failed to get PO data');
            }
            
            // Then get shipment documents using the customer portal endpoint
            const docsResponse = await fetch(`/customer_portal/get-required-documents/${currentShipCatIdDashboard}/${currentShipTypeIdDashboard}/${currentShipmentIdDashboard}`);
            if (!docsResponse.ok) {
                throw new Error(`Failed to get document requirements: ${docsResponse.status}`);
            }
            const documentData = await docsResponse.json();
            
            // Update document info header
            document.getElementById('poDocumentInfoTextDashboard').innerHTML = `
                <strong>PO:</strong> ${poData.po_number} | <strong>System Doc:</strong> ${poData.sysdocnum} | 
                <strong>Shipment Job:</strong> ${poData.shipment_job_no || 'N/A'} | 
                <strong>Supplier:</strong> ${poData.supplier_name}
            `;
            
            // Show "Go to Shipment" button
            const goToShipmentBtn = document.getElementById('goToShipmentBtnDashboard');
            goToShipmentBtn.style.display = 'inline-block';
            goToShipmentBtn.onclick = () => {
                window.open(`/customer_portal/sea-import/${currentShipmentIdDashboard}`, '_blank');
            };
            
            // Process and display documents
            displayPODocumentsDashboard(documentData);
            
        } catch (error) {
            console.error('Error loading PO document info (Dashboard):', error);
            document.getElementById('poDocumentInfoTextDashboard').textContent = 'Error loading document information';
            document.getElementById('poExistingDocumentsDashboard').innerHTML = `
                <div class="alert alert-danger">
                    <i class="ri-error-warning-line me-2"></i>Failed to load documents: ${error.message}
                </div>`;
            document.getElementById('poRequiredDocumentsDashboard').innerHTML = '';
        }
    }


    // Transform PO Detail API data to calendar events (updated function)
    function transformPODetailDataToEvents(data) {
        return data.map(function(poDetail) {
            return {
                id: 'po_detail_' + poDetail.delivery_date + '_' + poDetail.po_number,
                title: poDetail.po_number + ' - ' + poDetail.supplier_name,
                start: poDetail.delivery_date,
                extendedProps: {
                    isPODetail: true,
                    po_number: poDetail.po_number,
                    supplier_name: poDetail.supplier_name,
                    status: poDetail.status,
                    completion_percentage: poDetail.completion_percentage,
                    item_count: poDetail.item_count,
                    total_quantity: poDetail.total_quantity,
                    total_received: poDetail.total_received,
                    total_pending: poDetail.total_pending,
                    total_value: poDetail.total_value,
                    delivery_date: poDetail.delivery_date,
                    position_in_date: poDetail.position_in_date,
                    has_more_pos: poDetail.has_more_pos,
                    total_pos_for_date: poDetail.total_pos_for_date
                },
                className: 'bg-info-subtle',
                display: 'block'
            };
        });
    }

    function getPOColorClass(shipment) {
        // Use different colors based on shipment ID or other criteria
        var colors = ['primary', 'success', 'warning', 'danger'];
        return colors[shipment.ship_doc_entry_id % colors.length];
    }

    function getStatusIcon(status) {
        switch(status) {
            case 'pending': return 'ri-time-line';
            case 'partial': return 'ri-truck-line';
            case 'completed': return 'ri-check-double-line';
            default: return 'ri-question-line';
        }
    }

    // Function to show PO shipment details in modal (existing function - unchanged)
    function showPODetails(event) {
        if (!event || !event.extendedProps || !event.extendedProps.isPO) {
            return;
        }
        
        // Populate modal with shipment details
        document.getElementById('modal-job-no').textContent = event.extendedProps.import_id || 'N/A';
        document.getElementById('modal-date').textContent = formatDateTime(event.start);
        document.getElementById('modal-pol').textContent = event.extendedProps.port_of_loading || 'N/A';
        document.getElementById('modal-pod').textContent = event.extendedProps.port_of_discharge || 'N/A';
        
        // Populate PO details
        var poDetailsContainer = document.getElementById('po-details-container');
        poDetailsContainer.innerHTML = '';
        
        if (event.extendedProps.pos && event.extendedProps.pos.length > 0) {
            event.extendedProps.pos.forEach(function(po) {
                var statusClass = getStatusClass(po.status);
                var poHtml = `
                    <div class="po-item ${po.status} p-3 mb-3">
                        <div class="row">
                            <div class="col-md-3">
                                <h6 class="mb-1">PO Number</h6>
                                <p class="mb-2">${po.po_number}</p>
                            </div>
                            <div class="col-md-3">
                                <h6 class="mb-1">Supplier</h6>
                                <p class="mb-2">${po.supplier_name}</p>
                            </div>
                            <div class="col-md-3">
                                <h6 class="mb-1">Total Items</h6>
                                <p class="mb-2">${po.item_count}</p>
                            </div>
                            <div class="col-md-3">
                                <h6 class="mb-1">Status</h6>
                                <span class="badge bg-${statusClass}-subtle text-${statusClass}">${po.status.charAt(0).toUpperCase() + po.status.slice(1)}</span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <h6 class="mb-2">Items:</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Material Code</th>
                                                <th>Material Name</th>
                                                <th>Order Qty</th>
                                                <th>Received</th>
                                                <th>Pending</th>
                                                <th>Unit</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${po.items.map(function(item) {
                                                return `
                                                    <tr>
                                                        <td>${item.material_code}</td>
                                                        <td>${item.material_name}</td>
                                                        <td>${item.order_quantity}</td>
                                                        <td>${item.quantity_received}</td>
                                                        <td>${item.quantity_pending}</td>
                                                        <td>${item.order_unit}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                poDetailsContainer.innerHTML += poHtml;
            });
        } else {
            poDetailsContainer.innerHTML = '<p class="text-muted">No PO details available.</p>';
        }
        
        // Show the modal with proper backdrop handling
        var poModal = new bootstrap.Modal(document.getElementById('po-details-modal'), {
            backdrop: true,
            keyboard: true
        });
        poModal.show();
    }

    // Function to show PO details for a specific date (updated with proper modal handling)
    function showPODetailsForDate(event) {
        if (!event || !event.extendedProps || !event.extendedProps.isPODetail) {
            return;
        }

        var deliveryDate = event.extendedProps.delivery_date;
        
        // Show the modal with proper backdrop handling
        var poDateModal = new bootstrap.Modal(document.getElementById('po-date-details-modal'), {
            backdrop: true,
            keyboard: true
        });
        poDateModal.show();

        // Set modal title with formatted date
        document.getElementById('modal-delivery-date').textContent = formatDate(deliveryDate);

        // Show loading indicator
        document.getElementById('po-date-loading').classList.remove('d-none');
        document.getElementById('po-date-content').style.display = 'none';

        // Fetch detailed PO information for the date
        fetch('/purchase_orders/api/po_details_for_date/' + deliveryDate)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch PO details for date');
                }
                return response.json();
            })
            .then(data => {
                console.log("Received PO details for date:", data);
                populatePODateModal(data);
            })
            .catch(error => {
                console.error('Error fetching PO details for date:', error);
                document.getElementById('po-date-content').innerHTML = 
                    '<div class="alert alert-danger m-3">Error loading PO details. Please try again.</div>';
            })
            .finally(() => {
                document.getElementById('po-date-loading').classList.add('d-none');
                document.getElementById('po-date-content').style.display = 'block';
            });
    }

    // Function to populate PO date modal with individual item data
    function populatePODateModal(data) {
        var tableBody = document.getElementById('po-date-table-body');
        var totalItemsSpan = document.getElementById('modal-total-pos');
        
        // Clear existing content
        tableBody.innerHTML = '';
        
        // Set total count
        totalItemsSpan.textContent = data.item_count || 0;
        
        // Populate table with individual PO item data
        if (data.items && data.items.length > 0) {
            data.items.forEach(function(item) {
                var statusClass = getStatusClass(item.status);
                var progressBarClass = getProgressBarClass(item.status);
                
                var row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${item.po_number}</strong>
                        <br><small class="text-muted">${item.sysdocnum}</small>
                    </td>
                    <td>
                        <span class="badge bg-secondary">#${item.item_number}</span>
                    </td>
                    <td>
                        <strong>${item.material_code}</strong>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 200px;" title="${item.material_name}">
                            ${item.material_name}
                        </div>
                    </td>
                    <td>
                        <div class="text-truncate" style="max-width: 150px;" title="${item.supplier_name}">
                            ${item.supplier_name}
                        </div>
                    </td>
                    <td>
                        <strong>${item.order_quantity.toLocaleString()}</strong>
                        <br><small class="text-muted">${item.order_unit}</small>
                    </td>
                    <td>
                        <span class="text-success"><strong>${item.quantity_received.toLocaleString()}</strong></span>
                    </td>
                    <td>
                        <span class="text-danger"><strong>${item.quantity_pending.toLocaleString()}</strong></span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                <div class="progress-bar ${progressBarClass}" 
                                     style="width: ${item.completion_percentage}%"></div>
                            </div>
                            <small class="text-muted">${item.completion_percentage.toFixed(1)}%</small>
                        </div>
                    </td>
                    <td>
                            <div class="text-center">
                                ${item.shipment_info && item.shipment_info.has_shipment ? `
                                    <div class="d-flex gap-1 flex-wrap justify-content-center">
                                        <span class="badge badge-soft-warning" data-bs-toggle="tooltip" title="Required Documents">
                                            <i class="ri-file-list-line me-1"></i>
                                            ${item.shipment_info.total_required}
                                        </span>
                                        <span class="badge badge-soft-primary" data-bs-toggle="tooltip" title="Uploaded Documents">
                                            <i class="ri-send-plane-line me-1"></i>
                                            ${item.shipment_info.total_uploaded}
                                        </span>
                                        <span class="badge badge-soft-success" data-bs-toggle="tooltip" title="Approved Documents">
                                            <i class="ri-thumb-up-line me-1"></i>
                                            ${item.shipment_info.approved_docs}
                                        </span>
                                        <span class="badge badge-soft-danger" data-bs-toggle="tooltip" title="Rejected Documents">
                                            <i class="ri-thumb-down-line me-1"></i>
                                            ${item.shipment_info.rejected_docs}
                                        </span>
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="openPODocumentModalDashboard('${item.po_header_id}', '${item.shipment_info.shipment_id}', '${item.shipment_info.ship_category_id}', '${item.shipment_info.shipment_type_id}')"
                                                data-bs-toggle="tooltip" title="View Documents">
                                            <i class="ri-eye-line"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted d-block mt-1">Job: ${item.shipment_info.shipment_job_no}</small>
                                ` : `
                                    <div class="text-center">
                                        <span class="badge badge-soft-secondary">
                                            <i class="ri-close-line me-1"></i>Not Assigned
                                        </span>
                                    </div>
                                `}
                            </div>
                        </td>
                    <td>
                        <span class="badge bg-${statusClass}-subtle text-${statusClass}">
                            <i class="${getStatusIcon(item.status)} me-1"></i>
                            ${item.status.charAt(0).toUpperCase() + item.status.slice(1)}
                        </span>
                    </td>
                    <td>
                        <div class="text-end">
                            <small class="text-muted">${item.currency}</small><br>
                            <strong>${item.line_total.toLocaleString()}</strong>
                            <br><small class="text-muted">@${item.net_price.toLocaleString()}</small>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        } else {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="11" class="text-center text-muted py-4">
                        <i class="ri-file-list-3-line fs-48 text-muted mb-2 d-block"></i>
                        No purchase order items found for this date.
                    </td>
                </tr>
            `;
        }
    }

    // Add event delegation for "Show More" clicks with improved handling
    document.addEventListener('click', function(e) {
        if (e.target.closest('.po-show-more')) {
            e.preventDefault();
            e.stopPropagation();
            
            var showMoreElement = e.target.closest('.po-show-more');
            var deliveryDate = showMoreElement.getAttribute('data-delivery-date');
            
            // Create a mock event object to pass to showPODetailsForDate
            var mockEvent = {
                extendedProps: {
                    isPODetail: true,
                    delivery_date: deliveryDate
                }
            };
            
            showPODetailsForDate(mockEvent);
        }
    });

    // Ensure modal backdrop is properly removed on modal hide
    document.getElementById('po-details-modal').addEventListener('hidden.bs.modal', function () {
        // Remove any lingering backdrop
        var backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(function(backdrop) {
            backdrop.remove();
        });
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
    });

    document.getElementById('po-date-details-modal').addEventListener('hidden.bs.modal', function () {
        // Remove any lingering backdrop
        var backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(function(backdrop) {
            backdrop.remove();
        });
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
    });

    function getStatusClass(status) {
        switch(status) {
            case 'pending': return 'danger';
            case 'partial': return 'warning';
            case 'completed': return 'success';
            default: return 'secondary';
        }
    }

    function getProgressBarClass(status) {
        switch(status) {
            case 'pending': return 'bg-danger';
            case 'partial': return 'bg-warning';
            case 'completed': return 'bg-success';
            default: return 'bg-secondary';
        }
    }

    // Global helper function to format date and time
    function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
        
        var options = { 
            weekday: 'long',
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        
        return new Date(dateString).toLocaleDateString('en-US', options);
    }

    // Global helper function to format date only
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        
        var options = { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric'
        };
        
        return new Date(dateString).toLocaleDateString('en-US', options);
    }

    function displayPODocumentsDashboard(documentData) {
        const existingDocuments = document.getElementById('poExistingDocumentsDashboard');
        const requiredDocuments = document.getElementById('poRequiredDocumentsDashboard');
        
        // Group existing attachments by description
        const attachmentsByDescription = {};
        if (documentData.existing_attachments) {
            documentData.existing_attachments.forEach(doc => {
                if (!attachmentsByDescription[doc.description]) {
                    attachmentsByDescription[doc.description] = [];
                }
                attachmentsByDescription[doc.description].push(doc);
            });
        }
        
        // Create a map of ALL required documents for easy lookup
        const allRequiredDocsMap = {};
        if (documentData.all_required_documents) {
            documentData.all_required_documents.forEach(reqDoc => {
                allRequiredDocsMap[reqDoc.description] = reqDoc;
            });
        }
        
        // Display existing attachments
        if (documentData.existing_attachments && documentData.existing_attachments.length > 0) {
            let existingHtml = '';
            
            Object.keys(attachmentsByDescription).forEach(description => {
                const docs = attachmentsByDescription[description];
                
                existingHtml += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title d-flex justify-content-between align-items-center">
                                <span>
                                    <i class="ri-file-text-line me-2"></i>
                                    ${description}
                                    ${docs[0].isMandatory ? '<span class="badge badge-soft-danger ms-2">Required</span>' : '<span class="badge badge-soft-success ms-2">Optional</span>'}
                                    <span class="badge badge-soft-success ms-2">Uploaded (${docs.length})</span>
                                </span>
                            </h6>
                            
                            ${docs.map((doc, index) => {
                                const originalDoc = allRequiredDocsMap[doc.description];
                                
                                let statusBadge = '';
                                let aiValidationBadge = '';
                                let aiValidationMessage = '';
                                
                                if (doc.docAccepted === 'accepted') {
                                    statusBadge = '<span class="badge badge-soft-success ms-2">Accepted by Company</span>';
                                } else if (doc.docAccepted === 'rejected') {
                                    statusBadge = '<span class="badge badge-soft-danger ms-2 blink-badge">Rejected by Company</span>';
                                } else {
                                    statusBadge = '<span class="badge badge-soft-secondary ms-2">Company Review Pending</span>';
                                }

                                // AI validation logic (simplified for PO view - read-only)
                                if (originalDoc && originalDoc.ai_validate === 1) {
                                    if (doc.ai_validated === 0) {
                                        aiValidationBadge = '<span class="badge badge-soft-info ms-2 blink-badge">AI Validation in Progress</span>';
                                        aiValidationMessage = `
                                        <div class="alert alert-info mt-2 mb-2 py-2">
                                            <i class="ri-information-line me-1"></i>
                                            <small><strong>AI Validation in Progress:</strong> Our AI agent is currently validating this document.</small>
                                        </div>`;
                                    } else if (doc.ai_validated === 1) {
                                        aiValidationBadge = '<span class="badge badge-soft-success ms-2">AI Validation Successful</span>';
                                        aiValidationMessage = `
                                        <div class="alert alert-success mt-2 mb-2 py-2">
                                            <i class="ri-check-double-line me-1"></i>
                                            <small><strong>AI Validation Successful:</strong> The document has been successfully validated by our AI system.</small>
                                        </div>`;
                                    } else if (doc.ai_validated === 2) {
                                        aiValidationBadge = '<span class="badge badge-soft-danger ms-2 blink-badge">AI Validation Failed</span>';
                                        aiValidationMessage = `
                                        <div class="alert alert-danger mt-2 mb-2 py-2">
                                            <i class="ri-close-circle-line me-1"></i>
                                            <small><strong>AI Validation Failed:</strong> The document has been rejected by our AI system.</small>
                                        </div>`;
                                    } else if (doc.ai_validated === 8) {
                                        aiValidationBadge = '<span class="badge badge-soft-danger ms-2 blink-badge">Document Type Mismatch</span>';
                                        aiValidationMessage = `
                                        <div class="alert alert-danger mt-2 mb-2 py-2">
                                            <i class="ri-file-forbid-line me-1"></i>
                                            <small><strong>Document Type Mismatch:</strong> The submitted document doesn't match the required document type.</small>
                                        </div>`;
                                    }
                                } else {
                                    aiValidationBadge = '<span class="badge badge-soft-secondary ms-2">AI Validation Not Required</span>';
                                }
                                
                                return `
                                    <div class="border rounded p-3 mb-3 bg-light">
                                        <h6 class="mb-2">
                                            Document ${index + 1}
                                            ${aiValidationBadge}
                                            ${statusBadge}
                                        </h6>
                                        ${aiValidationMessage}
                                        
                                        <p class="card-text">
                                            <small class="text-muted">Note: ${doc.note || 'No notes added'}</small>
                                        </p>
                                        ${doc.docAccepteComments ? `
                                        <div class="alert alert-${doc.docAccepted === 'rejected' ? 'danger' : 'info'} mt-2 mb-2 py-2">
                                            <small><strong>Company Feedback:</strong> ${doc.docAccepteComments}</small>
                                        </div>` : ''}
                                        ${doc.docAccepteDate ? `
                                        <p class="card-text">
                                            <small class="text-muted">Reviewed on: ${new Date(doc.docAccepteDate).toLocaleDateString()}</small>
                                        </p>` : ''}
                                        ${doc.expiry_date ? `
                                        <p class="card-text">
                                            <small class="text-muted">Expires on: ${new Date(doc.expiry_date).toLocaleDateString()}</small>
                                        </p>` : ''}
                                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                                            <div class="d-flex flex-wrap gap-2">
                                                <button class="btn btn-sm btn-info" onclick="viewDocument('${doc.attachement_path}')">
                                                    <i class="ri-eye-line me-1"></i>View
                                                </button>
                                                ${doc.sample_file_path ? `
                                                <button class="btn btn-sm btn-secondary" onclick="viewSampleDocument('${doc.sample_file_path}')">
                                                    <i class="ri-file-text-line me-1"></i>View Sample
                                                </button>` : ''}
                                                <button class="btn btn-sm btn-primary" onclick="downloadDocument('${doc.attachement_path}')">
                                                    <i class="ri-download-line me-1"></i>Download
                                                </button>
                                            </div>
                                            <div class="d-flex flex-wrap gap-2">
                                                ${(doc.ai_validated === 1 || doc.ai_validated === 2) && originalDoc && originalDoc.ai_validate === 1 ? `
                                                <button class="btn btn-sm btn-secondary" onclick="viewAIValidationResults('${doc.id}')">
                                                    <i class="ri-ai-generate me-1"></i>AI Validation Results
                                                </button>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            existingDocuments.innerHTML = existingHtml;
        } else {
            existingDocuments.innerHTML = '<div class="alert alert-info">No documents have been uploaded yet.</div>';
        }
        
        // Display required documents info
        if (documentData.new_required_documents && documentData.new_required_documents.length > 0) {
            let requiredHtml = '<div class="alert alert-info"><i class="ri-information-line me-2"></i>The following documents are required for this shipment:</div>';
            
            requiredHtml += '<div class="row g-3">';
            documentData.new_required_documents.forEach(doc => {
                const hasAttachments = attachmentsByDescription[doc.description] && attachmentsByDescription[doc.description].length > 0;
                
                requiredHtml += `
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 ${doc.isMandatory ? 'border-danger' : ''}">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    ${doc.description}
                                    ${doc.isMandatory 
                                        ? '<span class="badge badge-soft-danger ms-2">Required</span>' 
                                        : '<span class="badge badge-soft-success ms-2">Optional</span>'}
                                    ${hasAttachments 
                                        ? `<span class="badge badge-soft-success ms-2">Uploaded (${attachmentsByDescription[doc.description].length})</span>` 
                                        : '<span class="badge badge-soft-warning ms-2">Missing</span>'}
                                </h6>
                                ${doc.sample_file_path ? `
                                <div class="mb-3">
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="viewSampleDocument('${doc.sample_file_path}')">
                                        <i class="ri-file-text-line me-1"></i>View Sample
                                    </button>
                                </div>` : ''}
                                <small class="text-muted">This document needs to be uploaded through the shipment management page.</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            requiredHtml += '</div>';
            
            requiredDocuments.innerHTML = requiredHtml;
        } else {
            requiredDocuments.innerHTML = '<div class="alert alert-success"><i class="ri-check-double-line me-2"></i>All required documents have been uploaded.</div>';
        }
    }

    function viewSampleDocument(path) {
    if (!path) {
        showToast('warning', 'No sample file available');
        return;
    }
    
    const encodedPath = encodeURIComponent(path);
    window.open(`/customer_portal/view-sample-document/${encodedPath}`, '_blank');
}

// Function to view document (reuse from sea_import)
function viewDocument(path) {
    if (!path) {
        showToast('warning', 'No file path provided');
        return;
    }
    
    const encodedPath = encodeURIComponent(path);
    window.open(`/customer_portal/view-document/${encodedPath}`, '_blank');
}

// Function to download document
function downloadDocument(path) {
    if (!path) {
        showToast('warning', 'No file path provided');
        return;
    }

    const encodedPath = encodeURIComponent(path);
    window.open(`/customer_portal/download-document/${encodedPath}`, '_blank');
}

// Function to view AI validation results (reuse from sea_import)
function viewAIValidationResults(docId) {
    // First, close the PO document modal if it's open
    const poDocModal = bootstrap.Modal.getInstance(document.getElementById('poDocumentModal'));
    if (poDocModal) {
        poDocModal.hide();
    }
    
    // Add a small delay to ensure the modal is fully closed before showing the SweetAlert
    setTimeout(() => {
        // Show loading state
        Swal.fire({
            title: 'Loading validation results...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Fetch validation results
        fetch(`/customer_portal/get-document-validation/${docId}`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'Failed to load validation results'
                    });
                    return;
                }

                // Extract validation data
                const results = data.results;
                const validationResults = results.validation_results || {};
                const matchPercentage = results.match_percentage || 0;
                
                // Use document_similarity from backend
                let documentSimilarity = 0;
                
                if (results.document_similarity !== undefined) {
                    // Convert to percentage if it's in decimal form (0-1)
                    documentSimilarity = results.document_similarity <= 1 ? 
                        results.document_similarity * 100 : results.document_similarity;
                }
                
                // Ensure documentSimilarity is a number between 0-100
                documentSimilarity = Math.max(0, Math.min(100, parseFloat(documentSimilarity)));
                
                // Determine colors for progress bars
                const docSimilarityColor = documentSimilarity >= 70 ? 'success' : 
                                         documentSimilarity >= 50 ? 'warning' : 'danger';
                const matchPercentageColor = matchPercentage >= 80 ? 'success' : 
                                           matchPercentage >= 50 ? 'warning' : 'danger';

                // Build the HTML content for detailed field validation
                let fieldValidationHtml = '';
                
                if (Object.keys(validationResults).length > 0) {
                    fieldValidationHtml = `
                    <div class="table-responsive mt-3">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Field Name</th>
                                    <th>Status</th>
                                    <th>Similarity Score</th>
                                    <th>Matched With</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    for (const [fieldName, field] of Object.entries(validationResults)) {
                        // Skip if not a valid field object or if it's the document_type field
                        if (!field || typeof field !== 'object' || field.matched === undefined || fieldName === 'document_type') continue;
                        
                        const matched = field.matched || false;
                        const similarity = (field.similarity || 0) * 100;
                        const matchedWith = field.matched_with || 'N/A';
                        
                        fieldValidationHtml += `
                            <tr>
                                <td>${fieldName}</td>
                                <td>
                                    ${matched ? 
                                    '<span class="badge bg-success">Matched</span>' : 
                                    '<span class="badge bg-danger">Not Matched</span>'}
                                </td>
                                <td>${similarity.toFixed(2)}%</td>
                                <td>${matchedWith}</td>
                            </tr>
                        `;
                    }
                    
                    fieldValidationHtml += `
                            </tbody>
                        </table>
                    </div>`;
                } else {
                    fieldValidationHtml = `
                    <div class="alert alert-info mt-3">
                        <i class="ri-information-line me-2"></i>
                        No detailed field validation results available.
                    </div>`;
                }

                // Build the HTML content for the modal
                let swalContent = `
                <div class="validation-results">
                    <h5>Document Type Similarity</h5>
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar bg-${docSimilarityColor}" 
                             role="progressbar" 
                             style="width: ${documentSimilarity.toFixed(2)}%;" 
                             aria-valuenow="${documentSimilarity.toFixed(2)}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            ${documentSimilarity.toFixed(2)}%
                        </div>
                    </div>
                    
                    <h5 class="mt-4">Field Match Percentage</h5>
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar bg-${matchPercentageColor}" 
                             role="progressbar" 
                             style="width: ${matchPercentage.toFixed(2)}%;" 
                             aria-valuenow="${matchPercentage.toFixed(2)}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            ${matchPercentage.toFixed(2)}%
                        </div>
                    </div>
                    
                    <h5 class="mt-4">Field Validation Details</h5>
                    ${fieldValidationHtml}
                </div>
                `;

                // Show the validation results
                Swal.fire({
                    title: 'AI Validation Results',
                    html: swalContent,
                    icon: 'info',
                    width: '800px',
                    heightAuto: true,
                    scrollbarPadding: true,
                    confirmButtonText: 'Close',
                    confirmButtonColor: '#3085d6',
                    allowOutsideClick: true,
                    didClose: () => {
                        // Optionally reopen the PO document modal when this is closed
                        setTimeout(() => {
                            openPODocumentModalDashboard(currentPOId, currentShipmentId, currentShipCatId, currentShipTypeId);
                        }, 100);
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching validation results:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load validation results: ' + error.message
                });
            });
    }, 300); // Short delay to ensure modal is closed
}



// Function to show overdue PO details modal
function showOverduePODetails() {
    // Show the modal
    var overdueModal = new bootstrap.Modal(document.getElementById('overdue-po-modal'), {
        backdrop: true,
        keyboard: true
    });
    overdueModal.show();

    // Show loading indicator
    document.getElementById('overdue-loading').classList.remove('d-none');
    document.getElementById('overdue-content').style.display = 'none';

    // Fetch overdue PO details
    fetch('/purchase_orders/api/overdue_po_details')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch overdue PO details');
            }
            return response.json();
        })
        .then(data => {
            console.log("Received overdue PO details:", data);
            populateOverduePOModal(data);
        })
        .catch(error => {
            console.error('Error fetching overdue PO details:', error);
            document.getElementById('overdue-content').innerHTML = 
                '<div class="alert alert-danger m-3">Error loading overdue PO details. Please try again.</div>';
        })
        .finally(() => {
            document.getElementById('overdue-loading').classList.add('d-none');
            document.getElementById('overdue-content').style.display = 'block';
        });
}

// Function to populate overdue PO modal
function populateOverduePOModal(data) {
    const summaryElement = document.getElementById('overdue-summary');
    const summaryText = document.getElementById('overdue-summary-text');
    const container = document.getElementById('overdue-pos-container');
    
    // Show summary
    summaryElement.classList.remove('d-none');
    summaryText.textContent = `Found ${data.total_overdue_pos} overdue purchase orders with ${data.total_overdue_items} overdue items.`;
    
    // Clear existing content
    container.innerHTML = '';
    
    if (data.data && data.data.length > 0) {
        data.data.forEach(function(poData) {
            const poHeader = poData.po_header;
            const overdueItems = poData.overdue_items;
            
            // Calculate most overdue days for this PO
            const maxDaysOverdue = Math.max(...overdueItems.map(item => item.days_overdue));
            
            const poHtml = `
                <div class="card mb-4 border-danger">
                    <div class="card-header bg-danger-subtle">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-0">
                                    <i class="ri-file-list-3-line me-2"></i>
                                    PO: ${poHeader.po_number}
                                    <span class="badge bg-danger ms-2">${maxDaysOverdue} days overdue</span>
                                </h6>
                                <small class="text-muted">System Doc: ${poHeader.sysdocnum}</small>
                            </div>
                            <div class="col-md-6">
                                <div class="text-md-end">
                                    <strong>Supplier:</strong> ${poHeader.supplier_name}<br>
                                    <small class="text-muted">Total Value: ${poHeader.currency} ${poHeader.total_value.toLocaleString()}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Item #</th>
                                        <th>Material Code</th>
                                        <th>Material Name</th>
                                        <th>Delivery Date</th>
                                        <th>Delivered Date</th>
                                        <th>Days Overdue</th>
                                        <th>Order Qty</th>
                                        <th>Received</th>
                                        <th>Pending</th>
                                        <th>Progress</th>
                                        <th>Status</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${overdueItems.map(item => {
                                        const statusClass = getStatusClass(item.status);
                                        const progressBarClass = getProgressBarClass(item.status);
                                        const overdueClass = item.days_overdue > 30 ? 'text-danger fw-bold' : 
                                                           item.days_overdue > 14 ? 'text-warning fw-bold' : 'text-danger';
                                        
                                        return `
                                            <tr>
                                                <td><span class="badge bg-secondary">#${item.item_number}</span></td>
                                                <td><strong>${item.material_code}</strong></td>
                                                <td>
                                                    <div class="text-truncate" style="max-width: 200px;" title="${item.material_name}">
                                                        ${item.material_name}
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="text-muted">${formatDate(item.delivery_date)}</span>
                                                </td>
                                                <td>
                                                    <span class="text-muted">${formatDate(item.date_delivered)}</span>
                                                <td>
                                                    <span class="${overdueClass}">
                                                        <i class="ri-alarm-warning-line me-1"></i>${item.days_overdue} days
                                                    </span>
                                                </td>
                                                <td>
                                                    <strong>${item.order_quantity.toLocaleString()}</strong>
                                                    <br><small class="text-muted">${item.order_unit}</small>
                                                </td>
                                                <td>
                                                    <span class="text-success"><strong>${item.quantity_received.toLocaleString()}</strong></span>
                                                </td>
                                                <td>
                                                    <span class="text-danger"><strong>${item.quantity_pending.toLocaleString()}</strong></span>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                                            <div class="progress-bar ${progressBarClass}" 
                                                                 style="width: ${item.completion_percentage}%"></div>
                                                        </div>
                                                        <small class="text-muted">${item.completion_percentage.toFixed(1)}%</small>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-${statusClass}-subtle text-${statusClass}">
                                                        <i class="${getStatusIcon(item.status)} me-1"></i>
                                                        ${item.status.charAt(0).toUpperCase() + item.status.slice(1)}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="text-end">
                                                        <strong>${item.line_total.toLocaleString()}</strong>
                                                        <br><small class="text-muted">@${item.net_price.toLocaleString()}</small>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML += poHtml;
        });
    } else {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="ri-check-double-line fs-48 text-success mb-3 d-block"></i>
                <h5 class="text-success">No Overdue Purchase Orders</h5>
                <p class="text-muted">All purchase orders are on schedule or completed.</p>
            </div>
        `;
    }
}

// Add CSS for cursor pointer
const style = document.createElement('style');
style.textContent = `
    .cursor-pointer {
        cursor: pointer;
    }
    .cursor-pointer:hover {
        transform: translateY(-2px);
        transition: transform 0.2s ease;
    }
`;
document.head.appendChild(style);

</script>
{% endblock %}