{% extends "partials/base.html" %}

{% block title %}{% if customer %}Edit{% else %}New{% endif %} Customer{% endblock title %}

{% block content %}
<!-- Start right Content here -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
                        <h4 class="mb-sm-0">{% if customer %}Edit{% else %}New{% endif %} Customer</h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">Admin</a></li>
                                <li class="breadcrumb-item"><a href="{{ url_for('masters.customers') }}">Customers</a></li>
                                <li class="breadcrumb-item active">{% if customer %}Edit{% else %}Add{% endif %} Customer</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" id="flash-message">
                <i class="ri-check-double-line"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <div class="row">
                <div class="col-12">
                    <!-- Customer Form Card -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="ri-{% if customer %}edit-line{% else %}add-line{% endif %} me-1 align-bottom"></i>
                                Customer Details
                            </h5>
                            {% if customer and not customer.user_id %}
                            <button type="button" class="btn btn-soft-success" onclick="createLogin({{ customer.id }})">
                                <i class="ri-user-add-line me-1"></i>
                                Create Login
                            </button>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <form method="POST">
                                {{ form.hidden_tag() }}

                                <!-- Tab Navigation -->
                                <ul class="nav nav-tabs mb-3" id="customerTab" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="customer-info-tab" data-bs-toggle="tab" data-bs-target="#customer-info" type="button" role="tab" aria-controls="customer-info" aria-selected="true">
                                            <i class="ri-user-line me-1"></i> Customer Info
                                        </button>
                                    </li>

                                    <li class="nav-item" role="presentation" id="rate-card-tab-nav">
                                        <button class="nav-link" id="rate-card-tab" data-bs-toggle="tab" data-bs-target="#rate-card" type="button" role="tab" aria-controls="rate-card" aria-selected="false">
                                            <i class="ri-money-dollar-circle-line me-1"></i> Rate Card
                                        </button>
                                    </li>

                                    {% if customer %}
                                    <li class="nav-item" role="presentation" id="attachments-tab-nav">
                                        <button class="nav-link" id="attachments-tab" data-bs-toggle="tab" data-bs-target="#attachments" type="button" role="tab" aria-controls="attachments" aria-selected="false">
                                            <i class="ri-attachment-line me-1"></i> Attachments
                                        </button>
                                    </li>
                                    {% endif %}
                                </ul>

                                <!-- Tab Content -->
                                <div class="tab-content" id="customerTabContent">
                                    <!-- Customer Information Tab (keeping existing content) -->
                                    <div class="tab-pane fade show active" id="customer-info" role="tabpanel" aria-labelledby="customer-info-tab">
                                        <!-- Existing customer info content remains the same -->
                                        <!-- Customer Type Selection -->
                                        <!-- <div class="row mb-4">
                                            <div class="col-lg-6">
                                                <div class="card shadow-none border">
                                                    <div class="card-header bg-soft-info">
                                                        <h6 class="card-title mb-0">Customer Type</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="mb-3">
                                                            {{ form.customer_type.label(class="form-label") }}
                                                            {{ form.customer_type(class="form-select" + (" is-invalid" if form.customer_type.errors else ""), id="customer_type_select") }}
                                                            {% if form.customer_type.errors %}
                                                            <div class="invalid-feedback">
                                                                {% for error in form.customer_type.errors %}
                                                                {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div> -->

                                        <div class="row mb-4">
                                            <div class="col-lg-6">
                                                <div class="card shadow-none border">
                                                    <div class="card-header bg-soft-primary">
                                                        <h6 class="card-title mb-0">Customer Information</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="mb-3">
                                                            {{ form.customer_id.label(class="form-label") }}
                                                            {{ form.customer_id(class="form-control" + (" is-invalid" if
                                                            form.customer_id.errors else ""), readonly=true, style="background-color: #f8f9fa;") }}
                                                            {% if form.customer_id.errors %}
                                                            <div class="invalid-feedback">
                                                                {% for error in form.customer_id.errors %}
                                                                {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                            {% endif %}
                                                        </div>

                                                        <div class="mb-3">
                                                            {{ form.customer_name.label(class="form-label") }}
                                                            {{ form.customer_name(class="form-control" + (" is-invalid" if
                                                            form.customer_name.errors else "")) }}
                                                            {% if form.customer_name.errors %}
                                                            <div class="invalid-feedback">
                                                                {% for error in form.customer_name.errors %}
                                                                {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                            {% endif %}
                                                        </div>

                                                        <div class="mb-3">
                                                            {{ form.short_name.label(class="form-label") }}
                                                            {{ form.short_name(class="form-control" + (" is-invalid" if form.short_name.errors else "")) }}
                                                            {% if form.short_name.errors %}
                                                            <div class="invalid-feedback">
                                                                {% for error in form.short_name.errors %}
                                                                {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                            {% endif %}
                                                        </div>

                                                        <div class="mb-3">
                                                            {{ form.address.label(class="form-label") }}
                                                            {{ form.address(class="form-control" + (" is-invalid" if form.address.errors
                                                            else ""), rows=3) }}
                                                            {% if form.address.errors %}
                                                            <div class="invalid-feedback">
                                                                {% for error in form.address.errors %}
                                                                {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                            {% endif %}
                                                        </div>

                                                        <div class="mb-3">
                                                            {{ form.email.label(class="form-label") }}
                                                            {{ form.email(class="form-control" + (" is-invalid" if form.email.errors else
                                                            "")) }}
                                                            {% if form.email.errors %}
                                                            <div class="invalid-feedback">
                                                                {% for error in form.email.errors %}
                                                                {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                            {% endif %}
                                                        </div>

                                                        <div class="mb-3">
                                                            {{ form.telephone.label(class="form-label") }}
                                                            {{ form.telephone(class="form-control" + (" is-invalid" if form.telephone.errors
                                                            else "")) }}
                                                            {% if form.telephone.errors %}
                                                            <div class="invalid-feedback">
                                                                {% for error in form.telephone.errors %}
                                                                {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                            {% endif %}
                                                        </div>

                                                        <div class="row" id="credit-fields">
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    {{ form.credit_facility.label(class="form-label") }}
                                                                    {{ form.credit_facility(class="form-select" + (" is-invalid" if
                                                                    form.credit_facility.errors else "")) }}
                                                                    {% if form.credit_facility.errors %}
                                                                    <div class="invalid-feedback">
                                                                        {% for error in form.credit_facility.errors %}
                                                                        {{ error }}
                                                                        {% endfor %}
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="mb-3">
                                                                    {{ form.credit_period.label(class="form-label") }}
                                                                    {{ form.credit_period(class="form-control" + (" is-invalid" if
                                                                    form.credit_period.errors else "")) }}
                                                                    {% if form.credit_period.errors %}
                                                                    <div class="invalid-feedback">
                                                                        {% for error in form.credit_period.errors %}
                                                                        {{ error }}
                                                                        {% endfor %}
                                                                    </div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Additional Information - Only for companies -->
                                            <!-- <div class="col-lg-6" id="additional-info-card">
                                                <div class="card shadow-none border">
                                                    <div class="card-header bg-soft-success">
                                                        <h6 class="card-title mb-0">Additional Information</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="mb-3">
                                                            {{ form.dsr_format.label(class="form-label") }}
                                                            {{ form.dsr_format(class="form-select" + (" is-invalid" if
                                                            form.dsr_format.errors else "")) }}
                                                            {% if form.dsr_format.errors %}
                                                            <div class="invalid-feedback">
                                                                {% for error in form.dsr_format.errors %}
                                                                {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                            {% endif %}
                                                        </div>

                                                        <div class="mb-3">
                                                            {{ form.icl_report_format.label(class="form-label") }}
                                                            {{ form.icl_report_format(class="form-select" + (" is-invalid" if
                                                            form.icl_report_format.errors else "")) }}
                                                            {% if form.icl_report_format.errors %}
                                                            <div class="invalid-feedback">
                                                                {% for error in form.icl_report_format.errors %}
                                                                {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                            {% endif %}
                                                        </div>

                                                        <div class="mb-3">
                                                            {{ form.new_storage_report_format.label(class="form-label") }}
                                                            {{ form.new_storage_report_format(class="form-select" + (" is-invalid" if
                                                            form.new_storage_report_format.errors else "")) }}
                                                            {% if form.new_storage_report_format.errors %}
                                                            <div class="invalid-feedback">
                                                                {% for error in form.new_storage_report_format.errors %}
                                                                {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                            {% endif %}
                                                        </div>

                                                        <div class="mb-3">
                                                            {{ form.sales_person.label(class="form-label") }}
                                                            {{ form.sales_person(class="form-select" + (" is-invalid" if
                                                            form.sales_person.errors else "")) }}
                                                            {% if form.sales_person.errors %}
                                                            <div class="invalid-feedback">
                                                                {% for error in form.sales_person.errors %}
                                                                {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                            {% endif %}
                                                        </div>

                                                        <div class="mb-3">
                                                            {{ form.cs_executive.label(class="form-label") }}
                                                            {{ form.cs_executive(class="form-select" + (" is-invalid" if
                                                            form.cs_executive.errors else "")) }}
                                                            {% if form.cs_executive.errors %}
                                                            <div class="invalid-feedback">
                                                                {% for error in form.cs_executive.errors %}
                                                                {{ error }}
                                                                {% endfor %}
                                                            </div>
                                                            {% endif %}
                                                        </div>

                                                        <div class="mb-3">
                                                            <div class="form-check form-switch">
                                                                {{ form.status(class="form-check-input") }}
                                                                {{ form.status.label(class="form-check-label") }}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div> -->
                                        </div>
                                        <!-- <div class="row mb-4">
                                            <div class="col-lg-12">
                                                <div class="card shadow-none border mb-4">
                                            <div class="card-header bg-soft-warning">
                                                <h6 class="card-title mb-0">Billing Party Information</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-4">
                                                    <div class="form-check">
                                                        {{ form.billing_party_same(class="form-check-input") }}
                                                        {{ form.billing_party_same.label(class="form-check-label") }}
                                                    </div>
                                                </div>

                                                <div id="billingPartyFields">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                {{ form.billing_party_name.label(class="form-label") }}
                                                                {{ form.billing_party_name(class="form-control" + (" is-invalid" if
                                                                form.billing_party_name.errors else "")) }}
                                                                {% if form.billing_party_name.errors %}
                                                                <div class="invalid-feedback">
                                                                    {% for error in form.billing_party_name.errors %}
                                                                    {{ error }}
                                                                    {% endfor %}
                                                                </div>
                                                                {% endif %}
                                                            </div>

                                                            <div class="mb-3">
                                                                {{ form.billing_party_address.label(class="form-label") }}
                                                                {{ form.billing_party_address(class="form-control" + (" is-invalid"
                                                                if form.billing_party_address.errors else ""), rows=3) }}
                                                                {% if form.billing_party_address.errors %}
                                                                <div class="invalid-feedback">
                                                                    {% for error in form.billing_party_address.errors %}
                                                                    {{ error }}
                                                                    {% endfor %}
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>

                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                {{ form.billing_party_email.label(class="form-label") }}
                                                                {{ form.billing_party_email(class="form-control" + (" is-invalid" if
                                                                form.billing_party_email.errors else "")) }}
                                                                {% if form.billing_party_email.errors %}
                                                                <div class="invalid-feedback">
                                                                    {% for error in form.billing_party_email.errors %}
                                                                    {{ error }}
                                                                    {% endfor %}
                                                                </div>
                                                                {% endif %}
                                                            </div>

                                                            <div class="mb-3">
                                                                {{ form.billing_party_contact_person.label(class="form-label") }}
                                                                {{ form.billing_party_contact_person(class="form-control" + ("
                                                                is-invalid" if form.billing_party_contact_person.errors else "")) }}
                                                                {% if form.billing_party_contact_person.errors %}
                                                                <div class="invalid-feedback">
                                                                    {% for error in form.billing_party_contact_person.errors %}
                                                                    {{ error }}
                                                                    {% endfor %}
                                                                </div>
                                                                {% endif %}
                                                            </div>

                                                            <div class="mb-3">
                                                                {{ form.billing_party_telephone.label(class="form-label") }}
                                                                {{ form.billing_party_telephone(class="form-control" + ("
                                                                is-invalid" if form.billing_party_telephone.errors else "")) }}
                                                                {% if form.billing_party_telephone.errors %}
                                                                <div class="invalid-feedback">
                                                                    {% for error in form.billing_party_telephone.errors %}
                                                                    {{ error }}
                                                                    {% endfor %}
                                                                </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                            </div>
                                        </div> -->
                                    </div>

                                    <!-- Rate Card Tab -->
                                    <div class="tab-pane fade" id="rate-card" role="tabpanel" aria-labelledby="rate-card-tab">
                                        <div class="card shadow-none border mb-4">
                                            <div class="card-header bg-soft-info">
                                                <h6 class="card-title mb-0">Rate Card Configuration</h6>
                                            </div>
                                            <div class="card-body">
                                                <!-- Currency Selection -->
                                                <div class="mb-4">
                                                    <label for="currency_id" class="form-label">Currency</label>
                                                    <select id="currency_id" name="currency_id" class="form-select">
                                                        {% for currency in currencies %}
                                                        <option value="{{ currency.currencyID }}" {% if selected_currency_id == currency.currencyID %}selected{% endif %}>
                                                            {{ currency.CurrencyCode }} - {{ currency.CurrencyName }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <!-- Rate Card Table -->
                                                <div class="table-responsive">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                            <tr>
                                                                <th style="width: 5%">#</th>
                                                                <th style="width: 10%">GL Code</th>
                                                                <th style="width: 65%">Income Description</th>
                                                                <th style="width: 20%">Rate Amount</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for income in incomes %}
                                                            <tr>
                                                                <td>{{ loop.index }}</td>
                                                                <td>{{ income.gl_code }}</td>
                                                                <td>{{ income.description }}</td>
                                                                <td>
                                                                    <input type="hidden" name="rate_card_income_ids[]" value="{{ income.id }}">
                                                                    <input type="number" step="0.01" min="0" class="form-control" name="rate_card_amounts[]" value="{{ rate_cards.get(income.id, 0.00) }}">
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Attachments Tab -->
                                    {% if customer %}
                                    <div class="tab-pane fade" id="attachments" role="tabpanel" aria-labelledby="attachments-tab">
                                        <div class="card shadow-none border mb-4">
                                            <div class="card-header bg-soft-primary d-flex justify-content-between align-items-center">
                                                <h6 class="card-title mb-0">Document Attachments</h6>
                                                <button type="button" class="btn btn-soft-primary btn-sm" onclick="showUploadModal()">
                                                    <i class="ri-upload-2-line me-1"></i>Upload Document
                                                </button>
                                            </div>
                                            <div class="card-body">
                                                <!-- Required Documents Section -->
                                                <div class="mb-4">
                                                    <h6 class="mb-3">Required Documents</h6>
                                                    <div class="row" id="requiredDocumentsContainer">
                                                        <!-- Will be populated via JavaScript -->
                                                    </div>
                                                </div>

                                                <!-- Uploaded Documents List -->
                                                <div class="table-responsive">
                                                    <table class="table table-bordered table-hover" id="uploadedDocumentsTable">
                                                        <thead>
                                                            <tr>
                                                                <th>Document Type</th>
                                                                <th>Description</th>
                                                                <th>File Name</th>
                                                                <th>Expiry Date</th>
                                                                <th>Uploaded By</th>
                                                                <th>Uploaded On</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="uploadedDocumentsBody">
                                                            <!-- Will be populated via JavaScript -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>

                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('masters.customers') }}" class="btn btn-light">
                                        <i class="ri-close-line me-1"></i>Cancel
                                    </a>
                                    {{ form.submit(class="btn btn-primary") }}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->

    {% block footer %}
    {% include "partials/footer.html" %}
    {% endblock footer %}
</div>


<!-- Upload Document Modal -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadDocumentModalLabel">Upload Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="uploadDocumentForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="documentType" class="form-label">Document Type <span class="text-danger">*</span></label>
                        <select class="form-select" id="documentType" name="documentType" required onchange="updateDocumentOptions()">
                            <option value="">Select Document Type</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="document" class="form-label">Document <span class="text-danger">*</span></label>
                        <select class="form-select" id="document" name="document" required disabled>
                            <option value="">Select Document</option>
                        </select>
                        <div class="mt-2" id="documentInfo">
                            <!-- Document info will be displayed here -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="documentFile" class="form-label">File <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="documentFile" name="documentFile" required>
                    </div>

                    <div class="mb-3">
                        <label for="expiryDate" class="form-label">Expiry Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="expiryDate" name="expiryDate" required>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Document Modal -->
<div class="modal fade" id="editDocumentModal" tabindex="-1" aria-labelledby="editDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDocumentModalLabel">Edit Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editDocumentForm" enctype="multipart/form-data">
                <input type="hidden" id="editDocumentId" name="documentId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Document Type</label>
                        <input type="text" class="form-control" id="editDocumentType" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Document</label>
                        <input type="text" class="form-control" id="editDocumentName" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="editDocumentFile" class="form-label">Replace File (Optional)</label>
                        <input type="file" class="form-control" id="editDocumentFile" name="documentFile">
                        <small class="text-muted">Leave empty to keep existing file</small>
                    </div>

                    <div class="mb-3">
                        <label for="editExpiryDate" class="form-label">Expiry Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="editExpiryDate" name="expiryDate" required>
                    </div>

                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Global variables for attachments
    let attachmentTypes = [];
    let attachmentDocuments = {};
    let uploadedDocuments = [];
    let customerId = {% if customer %}{{ customer.id }}{% else %}null{% endif %};
    let customerType = {% if customer %}{{ customer.customer_type }}{% else %}null{% endif %};

    // Define functions outside DOMContentLoaded so they can be called from onclick handlers
    function showUploadModal() {
        document.getElementById('uploadDocumentForm').reset();
        document.getElementById('document').disabled = true;
        document.getElementById('documentInfo').innerHTML = '';
        new bootstrap.Modal(document.getElementById('uploadDocumentModal')).show();
    }

    function updateDocumentOptions() {
        const typeId = document.getElementById('documentType').value;
        const documentSelect = document.getElementById('document');
        const documentInfo = document.getElementById('documentInfo');
        
        documentSelect.innerHTML = '<option value="">Select Document</option>';
        documentSelect.disabled = !typeId;
        documentInfo.innerHTML = '';
        
        if (typeId && attachmentDocuments[typeId]) {
            attachmentDocuments[typeId].forEach(doc => {
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = doc.description;
                option.dataset.mandatory = doc.is_mandatory;
                option.dataset.multiple = doc.allow_multiple;
                option.dataset.samplePath = doc.sample_file_path || '';
                documentSelect.appendChild(option);
            });
        }
    }

    function viewDocument(id) {
        const doc = uploadedDocuments.find(d => d.id === id);
        if (doc && doc.file_url) {
            window.open(doc.file_url, '_blank');
        }
    }

    function viewSampleDocument(url) {
        window.open(url, '_blank');
    }

    function editDocument(id) {
        const doc = uploadedDocuments.find(d => d.id === id);
        if (!doc) return;
        
        document.getElementById('editDocumentId').value = doc.id;
        document.getElementById('editDocumentType').value = doc.document_type;
        document.getElementById('editDocumentName').value = doc.document_description;
        document.getElementById('editExpiryDate').value = doc.expiry_date;
        document.getElementById('editDescription').value = doc.description || '';
        
        new bootstrap.Modal(document.getElementById('editDocumentModal')).show();
    }

    function deleteDocument(id) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/masters/customer/${customerId}/attachment/${id}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Deleted!', 'Document has been deleted.', 'success');
                        loadUploadedDocuments();
                    } else {
                        Swal.fire('Error', data.message || 'Failed to delete document', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error', 'Failed to delete document', 'error');
                });
            }
        });
    }

    // Attachment-related functions
    function loadAttachmentData() {
        // Load attachment types and documents
        fetch(`/masters/customer/${customerId}/attachment-types`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    attachmentTypes = data.attachment_types;
                    attachmentDocuments = data.attachment_documents;
                    populateDocumentTypeSelect();
                    displayRequiredDocuments();
                }
            })
            .catch(error => console.error('Error loading attachment types:', error));

        // Load uploaded documents
        loadUploadedDocuments();
    }

    function loadUploadedDocuments() {
        fetch(`/masters/customer/${customerId}/attachments`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    uploadedDocuments = data.attachments;
                    displayUploadedDocuments();
                }
            })
            .catch(error => console.error('Error loading attachments:', error));
    }

    function populateDocumentTypeSelect() {
        const select = document.getElementById('documentType');
        if (!select) return;
        
        select.innerHTML = '<option value="">Select Document Type</option>';
        
        attachmentTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.name;
            select.appendChild(option);
        });
    }

    function displayRequiredDocuments() {
        const container = document.getElementById('requiredDocumentsContainer');
        if (!container) return;
        
        container.innerHTML = '';
        
        attachmentTypes.forEach(type => {
            if (attachmentDocuments[type.id]) {
                attachmentDocuments[type.id].forEach(doc => {
                    if (doc.is_mandatory) {
                        const col = document.createElement('div');
                        col.className = 'col-md-6 mb-3';
                        
                        const card = document.createElement('div');
                        card.className = 'card shadow-none border';
                        
                        let badges = '';
                        if (doc.is_mandatory) badges += '<span class="badge bg-danger me-1">Mandatory</span>';
                        if (doc.allow_multiple) badges += '<span class="badge bg-info">Multiple</span>';
                        
                        let sampleBtn = '';
                        if (doc.sample_file_url) {
                            sampleBtn = `<button type="button" class="btn btn-soft-secondary btn-sm" onclick="viewSampleDocument('${doc.sample_file_url}')">
                                <i class="ri-eye-line me-1"></i>View Sample
                            </button>`;
                        }
                        
                        card.innerHTML = `
                            <div class="card-body">
                                <h6 class="card-title">${doc.description}</h6>
                                <p class="text-muted mb-2">${type.name}</p>
                                <div class="mb-2">${badges}</div>
                                ${sampleBtn}
                            </div>
                        `;
                        
                        col.appendChild(card);
                        container.appendChild(col);
                    }
                });
            }
        });
    }

    function displayUploadedDocuments() {
        const tbody = document.getElementById('uploadedDocumentsBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (uploadedDocuments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No documents uploaded yet</td></tr>';
            return;
        }
        
        uploadedDocuments.forEach(doc => {
            const row = document.createElement('tr');
            
            const expiryDate = new Date(doc.expiry_date);
            const today = new Date();
            const isExpired = expiryDate < today;
            const isExpiringSoon = !isExpired && (expiryDate - today) / (1000 * 60 * 60 * 24) <= 30;
            
            let expiryClass = '';
            let expiryBadge = '';
            if (isExpired) {
                expiryClass = 'text-danger';
                expiryBadge = '<span class="badge bg-danger ms-1">Expired</span>';
            } else if (isExpiringSoon) {
                expiryClass = 'text-warning';
                expiryBadge = '<span class="badge bg-warning ms-1">Expiring Soon</span>';
            }
            
            row.innerHTML = `
                <td>${doc.document_type}</td>
                <td>${doc.document_description}</td>
                <td>${doc.file_name}</td>
                <td class="${expiryClass}">${formatDate(doc.expiry_date)}${expiryBadge}</td>
                <td>${doc.uploaded_by_name}</td>
                <td>${formatDateTime(doc.uploaded_at)}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-soft-info" onclick="viewDocument(${doc.id})" title="View">
                            <i class="ri-eye-line"></i>
                        </button>
                        <button type="button" class="btn btn-soft-primary" onclick="editDocument(${doc.id})" title="Edit">
                            <i class="ri-pencil-line"></i>
                        </button>
                        <button type="button" class="btn btn-soft-danger" onclick="deleteDocument(${doc.id})" title="Delete">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    function handleUploadDocument(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('attachment_type_id', document.getElementById('documentType').value);
        formData.append('attachment_document_id', document.getElementById('document').value);
        formData.append('expiry_date', document.getElementById('expiryDate').value);
        formData.append('description', document.getElementById('description').value);
        formData.append('file', document.getElementById('documentFile').files[0]);
        
        fetch(`/masters/customer/${customerId}/upload-attachment`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('uploadDocumentModal')).hide();
                Swal.fire('Success', 'Document uploaded successfully', 'success');
                loadUploadedDocuments();
            } else {
                Swal.fire('Error', data.message || 'Failed to upload document', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'Failed to upload document', 'error');
        });
    }

    function handleEditDocument(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('expiry_date', document.getElementById('editExpiryDate').value);
        formData.append('description', document.getElementById('editDescription').value);
        
        const fileInput = document.getElementById('editDocumentFile');
        if (fileInput.files.length > 0) {
            formData.append('file', fileInput.files[0]);
        }
        
        const documentId = document.getElementById('editDocumentId').value;
        
        fetch(`/masters/customer/${customerId}/attachment/${documentId}/update`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('editDocumentModal')).hide();
                Swal.fire('Success', 'Document updated successfully', 'success');
                loadUploadedDocuments();
            } else {
                Swal.fire('Error', data.message || 'Failed to update document', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error', 'Failed to update document', 'error');
        });
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Add event listener for document selection
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'document') {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const documentInfo = document.getElementById('documentInfo');
            
            if (selectedOption.value) {
                let infoHtml = '<div class="d-flex gap-2 align-items-center">';
                
                if (selectedOption.dataset.mandatory === 'true') {
                    infoHtml += '<span class="badge bg-danger">Mandatory</span>';
                }
                
                if (selectedOption.dataset.multiple === 'true') {
                    infoHtml += '<span class="badge bg-info">Multiple Allowed</span>';
                }
                
                if (selectedOption.dataset.samplePath) {
                    const typeId = document.getElementById('documentType').value;
                    const docData = attachmentDocuments[typeId].find(d => d.id == selectedOption.value);
                    if (docData && docData.sample_file_url) {
                        infoHtml += `<button type="button" class="btn btn-soft-secondary btn-sm" onclick="viewSampleDocument('${docData.sample_file_url}')">
                            <i class="ri-eye-line me-1"></i>View Sample
                        </button>`;
                    }
                }
                
                infoHtml += '</div>';
                documentInfo.innerHTML = infoHtml;
            } else {
                documentInfo.innerHTML = '';
            }
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Auto-hide flash messages after 5 seconds
        const flashMessage = document.getElementById('flash-message');
        if (flashMessage) {
            setTimeout(() => {
                const closeBtn = flashMessage.querySelector('.btn-close');
                if (closeBtn) closeBtn.click();
            }, 5000);
        }

        // Handle billing party fields visibility
        const billingPartySameCheckbox = document.getElementById('billing_party_same');
        const billingPartyFields = document.getElementById('billingPartyFields');

        function toggleBillingPartyFields() {
            billingPartyFields.style.display = billingPartySameCheckbox.checked ? 'none' : 'block';
        }

        billingPartySameCheckbox.addEventListener('change', toggleBillingPartyFields);
        toggleBillingPartyFields(); // Initial state

        // Handle customer type changes
        const customerTypeSelect = document.getElementById('customer_type_select');
        const additionalInfoCard = document.getElementById('additional-info-card');
        const rateCardTabNav = document.getElementById('rate-card-tab-nav');

        function toggleFieldsByCustomerType() {
            const customerType = customerTypeSelect.value;
            
            if (customerType === '2' || customerType === '3') { // Clearing Agent
                // Hide additional information card
                additionalInfoCard.style.display = 'none';
                // Hide rate card tab
                rateCardTabNav.style.display = 'none';
                
                // If currently on rate card tab, switch to customer info tab
                const rateCardTab = document.getElementById('rate-card-tab');
                const customerInfoTab = document.getElementById('customer-info-tab');
                if (rateCardTab.classList.contains('active')) {
                    rateCardTab.classList.remove('active');
                    customerInfoTab.classList.add('active');
                    document.getElementById('rate-card').classList.remove('show', 'active');
                    document.getElementById('customer-info').classList.add('show', 'active');
                }
            } else { // Company
                // Show additional information card
                additionalInfoCard.style.display = 'block';
                // Show rate card tab
                rateCardTabNav.style.display = 'block';
            }
        }

        customerTypeSelect.addEventListener('change', toggleFieldsByCustomerType);
        toggleFieldsByCustomerType(); // Initial state

        // If we have a customer (edit mode), load attachments data
        if (customerId) {
            loadAttachmentData();
            
            // Upload form submission
            const uploadForm = document.getElementById('uploadDocumentForm');
            if (uploadForm) {
                uploadForm.addEventListener('submit', handleUploadDocument);
            }
            
            // Edit form submission
            const editForm = document.getElementById('editDocumentForm');
            if (editForm) {
                editForm.addEventListener('submit', handleEditDocument);
            }
        }
    });

    function createLogin(customerId) {
        Swal.fire({
            title: 'Create Login',
            text: 'Are you sure you want to create a login for this customer?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, create login',
            cancelButtonText: 'No, cancel',
            confirmButtonColor: '#0ab39c',
            cancelButtonColor: '#f06548'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/masters/customer/${customerId}/create-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'Success!',
                            text: data.message,
                            icon: 'success',
                            confirmButtonColor: '#0ab39c'
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: 'Error!',
                            text: data.message || 'Error creating login',
                            icon: 'error',
                            confirmButtonColor: '#f06548'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        title: 'Error!',
                        text: error.message || 'Error creating login',
                        icon: 'error',
                        confirmButtonColor: '#f06548'
                    });
                });
            }
        });
    }
</script>
{% endblock extra_js %}