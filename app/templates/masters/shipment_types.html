{% extends "partials/base.html" %}

{% block title %}Shipment Type Management{% endblock title %}

{% block content %}
<!-- Start right Content here -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
                        <h4 class="mb-sm-0">Shipment Type Management</h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">Admin</a></li>
                                <li class="breadcrumb-item active">Shipment Types</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" id="flash-message">
                <i class="ri-check-double-line"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <div class="row">
                <div class="col-12">
                    <!-- Action buttons -->
                    <div class="d-flex justify-content-end mb-3">
                        <a href="{{ url_for('masters.add_shipment_type') }}" class="btn btn-primary">
                            <i class="ri-add-line me-1"></i> Add Shipment Type
                        </a>
                    </div>

                    <!-- Shipment Types Card -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Shipment Types List</h5>
                        </div>
                        <div class="card-body">
                            <div class="shipment-tree">
                                {% for shipment_type in shipment_types %}
                                <div class="card shadow-sm mt-3">
                                    <div class="card-header bg-light d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <i class="ri-ship-line me-2 text-muted"></i>
                                            <span class="fw-bold">{{ shipment_type.shipment_name }}</span>
                                            <span class="text-muted ms-2">({{ shipment_type.shipment_code }})</span>
                                            {% if shipment_type.base_type %}
                                            <span class="badge badge-soft-info ms-2">
                                                <i class="ri-price-tag-line me-1"></i>{{ shipment_type.base_type.base_code }}
                                            </span>
                                            {% endif %}
                                            {% if shipment_type.docCode %}
                                            <span class="badge badge-soft-secondary ms-2">
                                                <i class="ri-file-code-line me-1"></i>{{ shipment_type.docCode }}
                                            </span>
                                            {% endif %}
                                            {% if shipment_type.is_active %}
                                            <span class="badge badge-soft-success ms-2">Active</span>
                                            {% else %}
                                            <span class="badge badge-soft-danger ms-2">Inactive</span>
                                            {% endif %}
                                        </div>
                                        <div class="hstack gap-2">
                                            <a href="{{ url_for('masters.edit_shipment_type', shipment_type_id=shipment_type.id) }}" 
                                               class="btn btn-sm btn-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit">
                                                <i class="ri-pencil-line"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-info" data-bs-toggle="tooltip" 
                                                data-bs-placement="top" title="Categories" onclick="toggleCategories('{{ shipment_type.id }}')">
                                                <i class="ri-price-tag-3-line"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="tooltip" 
                                                data-bs-placement="top" title="Delete" onclick="confirmDelete('{{ shipment_type.id }}')">
                                                <i class="ri-delete-bin-line"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div id="categories{{ shipment_type.id }}" class="card-body pt-0" style="display: none;">
                                        <div class="border-bottom pb-3 pt-3">
                                            <h6 class="mb-3 text-uppercase fs-12 fw-semibold text-muted">Categories</h6>
                                            <!-- Add Category Form -->
                                            <form id="categoryForm{{ shipment_type.id }}" class="row g-3 align-items-end">
                                                <div class="col-md-4">
                                                    <label for="catCode{{ shipment_type.id }}" class="form-label">Category Code</label>
                                                    <input type="text" class="form-control" id="catCode{{ shipment_type.id }}"
                                                        name="catCode" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="catname{{ shipment_type.id }}" class="form-label">Category Name</label>
                                                    <input type="text" class="form-control" id="catname{{ shipment_type.id }}"
                                                        name="catname" required>
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="submit" class="btn btn-primary w-100">
                                                        <i class="ri-add-line me-1"></i> Add
                                                    </button>
                                                </div>
                                            </form>
                                        </div>

                                        <!-- Categories List -->
                                        <div class="pt-3">
                                            {% for category in shipment_type.ship_categories %}
                                            <div class="card shadow-none border mb-3">
                                                <div class="card-header bg-light d-flex align-items-center">
                                                    <div class="flex-grow-1">
                                                        <i class="ri-price-tag-3-line me-2 text-muted"></i>
                                                        <span class="fw-medium">{{ category.catname }}</span>
                                                        <span class="text-muted ms-2">({{ category.catCode }})</span>
                                                        {% if category.isActive == 1 %}
                                                        <span class="badge badge-soft-success ms-2">Active</span>
                                                        {% else %}
                                                        <span class="badge badge-soft-danger ms-2">Inactive</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="hstack gap-2">
                                                        <button type="button" class="btn btn-sm btn-primary edit-category-btn" data-bs-toggle="tooltip" 
                                                            data-bs-placement="top" title="Edit Category" data-category-id="{{ category.id }}" 
                                                            data-category-code="{{ category.catCode }}" data-category-name="{{ category.catname }}">
                                                            <i class="ri-pencil-line"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-info" data-bs-toggle="tooltip" 
                                                            data-bs-placement="top" title="Documents" onclick="toggleDocuments('{{ category.id }}')">
                                                            <i class="ri-file-list-line"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="tooltip" 
                                                            data-bs-placement="top" title="Delete Category" data-category-id="{{ category.id }}">
                                                            <i class="ri-delete-bin-line"></i>
                                                        </button>
                                                    </div>
                                                </div>

                                                <div id="documents{{ category.id }}" class="card-body" style="display: none;">
                                                    <div class="border-bottom pb-3 mb-3">
                                                        <h6 class="mb-3 text-uppercase fs-12 fw-semibold text-muted">Documents</h6>
                                                        <!-- Add Document Form -->
                                                        <form class="document-form row g-3 align-items-end"
                                                            data-category-id="{{ category.id }}"
                                                            data-shipment-type-id="{{ shipment_type.id }}">
                                                            <div class="col-md-4">
                                                                <label for="description{{ category.id }}" class="form-label">Document Description</label>
                                                                <input type="text" class="form-control"
                                                                    id="description{{ category.id }}" name="description" required>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label for="sampleFile{{ category.id }}" class="form-label">Sample Document (Optional)</label>
                                                                <input type="file" class="form-control" id="sampleFile{{ category.id }}" name="sampleFile">
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label for="confidenceLevel{{ category.id }}" class="form-label">Confidence Level (%)</label>
                                                                <input type="number" class="form-control" 
                                                                    id="confidenceLevel{{ category.id }}" 
                                                                    name="confidence_level" 
                                                                    step="0.1" 
                                                                    min="0" 
                                                                    max="100" 
                                                                    value="0.0"
                                                                    placeholder="0-100">
                                                            </div>
                                                            <div class="col-md-2">
                                                                <label for="contentSimilarity{{ category.id }}" class="form-label">Content Similarity (%)</label>
                                                                <input type="number" class="form-control" 
                                                                    id="contentSimilarity{{ category.id }}" 
                                                                    name="content_similarity" 
                                                                    step="0.1" 
                                                                    min="0" 
                                                                    max="100" 
                                                                    value="0.0"
                                                                    placeholder="0-100">
                                                            </div>
                                                            
                                                            <div class="col-md-9">
                                                                <div class="d-flex gap-5">
                                                                    <div class="form-check form-switch">
                                                                        <input class="form-check-input" type="checkbox"
                                                                            id="isMandatory{{ category.id }}" name="isMandatory">
                                                                        <label class="form-check-label" for="isMandatory{{ category.id }}">
                                                                            Document Mandatory
                                                                        </label>
                                                                    </div>
                                                                    <div class="form-check form-switch">
                                                                        <input class="form-check-input" type="checkbox"
                                                                            id="aiValidate{{ category.id }}" name="ai_validate">
                                                                        <label class="form-check-label" for="aiValidate{{ category.id }}">
                                                                            Allow AI Validation
                                                                        </label>
                                                                    </div>
                                                                    <div class="form-check form-switch">
                                                                        <input class="form-check-input" type="checkbox"
                                                                            id="multipleDocument{{ category.id }}" name="multiple_document">
                                                                        <label class="form-check-label" for="multipleDocument{{ category.id }}">
                                                                            Attach Multiple Documents
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <button type="submit" class="btn btn-primary w-100">
                                                                    <i class="ri-add-line me-1"></i> Add
                                                                </button>
                                                            </div>
                                                        </form>
                                                    </div>

                                                    <!-- Documents List -->
                                                    <div class="documents-list" id="documentsList{{ category.id }}">
                                                        <!-- Documents will be loaded here -->
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- container-fluid -->
    </div>
    <!-- End Page-content -->

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="ri-alert-line fs-1 text-warning"></i>
                        <h5 class="mt-2">Are you sure you want to delete this shipment type?</h5>
                        <p class="text-muted">This action cannot be undone.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteForm" method="POST">
                        <button type="submit" class="btn btn-danger">
                            <i class="ri-delete-bin-line me-1"></i>Delete
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Check Fields Modal -->
    <div class="modal fade" id="aiCheckFieldsModal" tabindex="-1" aria-labelledby="aiCheckFieldsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aiCheckFieldsModalLabel">Fields to be Checked by AI</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="aiCheckShipmentTypeId">
                    <input type="hidden" id="aiCheckCategoryId">
                    <input type="hidden" id="aiCheckDocumentId">
                    <input type="hidden" id="aiCheckDocumentDescription">
                    
                    <div class="alert alert-info">
                        <i class="ri-information-line me-2"></i>
                        Define key fields to extract from this document and specify their section location.
                    </div>
                    
                    <div id="aiCheckFieldsContainer">
                        <div class="ai-check-field-row mb-3 row g-2 align-items-center">
                            <div class="col-md-5">
                                <input type="text" class="form-control field-name" placeholder="Field Name">
                            </div>
                            <div class="col-md-5">
                                <!-- Changed from text input to dropdown -->
                                <select class="form-select field-condition">
                                    <option value="">Select Section</option>
                                    <option value="header">Header</option>
                                    <option value="body">Body</option>
                                    <option value="footer">Footer</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-danger remove-ai-check-field d-none">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-end mt-3">
                        <button type="button" id="addAICheckFieldBtn" class="btn btn-success me-2">
                            <i class="ri-add-line me-1"></i> Add Field
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="saveAICheckFieldsBtn" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editCategoryForm" class="row g-3">
                        <input type="hidden" id="editCategoryId">
                        <div class="col-md-6">
                            <label for="editCatCode" class="form-label">Category Code</label>
                            <input type="text" class="form-control" id="editCatCode" name="catCode" required>
                        </div>
                        <div class="col-md-6">
                            <label for="editCatName" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="editCatName" name="catname" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="saveCategoryBtn" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Document Modal -->
    <div class="modal fade" id="editDocumentModal" tabindex="-1" aria-labelledby="editDocumentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editDocumentModalLabel">Edit Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editDocumentForm" class="row g-3">
                        <input type="hidden" id="editDocumentId">
                        <input type="hidden" id="editCategoryId">
                        <div class="col-md-12 mb-3">
                            <label for="editDescription" class="form-label">Document Description</label>
                            <input type="text" class="form-control" id="editDescription" name="description" required>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label for="editSampleFile" class="form-label">Sample Document</label>
                            <input type="file" class="form-control" id="editSampleFile" name="sampleFile">
                            <div id="currentFileInfo" class="form-text mt-1"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editConfidenceLevel" class="form-label">Confidence Level (%)</label>
                            <div class="input-group">
                                <input type="number" 
                                    class="form-control" 
                                    id="editConfidenceLevel" 
                                    name="confidence_level" 
                                    step="0.1" 
                                    min="0" 
                                    max="100" 
                                    required>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editContentSimilarity" class="form-label">Content Similarity (%)</label>
                            <div class="input-group">
                                <input type="number" 
                                    class="form-control" 
                                    id="editContentSimilarity" 
                                    name="content_similarity" 
                                    step="0.1" 
                                    min="0" 
                                    max="100" 
                                    required>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <div class="d-flex gap-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editIsMandatory" name="isMandatory">
                                    <label class="form-check-label" for="editIsMandatory">Mandatory</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editAiValidate" name="ai_validate">
                                    <label class="form-check-label" for="editAiValidate">Allow AI Validation</label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="editMultipleDocument" name="multiple_document">
                                    <label class="form-check-label" for="editMultipleDocument">Multiple Documents</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="saveDocumentBtn" class="btn btn-primary">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    {% block footer %}
    {% include "partials/footer.html" %}
    {% endblock footer %}
</div>
{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    document.addEventListener('click', function(e) {
        const editCategoryBtn = e.target.closest('.edit-category-btn');
        if (editCategoryBtn) {
            const categoryId = editCategoryBtn.dataset.categoryId;
            const categoryCode = editCategoryBtn.dataset.categoryCode;
            const categoryName = editCategoryBtn.dataset.categoryName;
            
            // Populate the edit modal fields
            document.getElementById('editCategoryId').value = categoryId;
            document.getElementById('editCatCode').value = categoryCode;
            document.getElementById('editCatName').value = categoryName;
            
            // Show the edit modal
            const editCategoryModal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
            editCategoryModal.show();
        }
    });


    document.getElementById('saveCategoryBtn').addEventListener('click', function() {
        const categoryId = document.getElementById('editCategoryId').value;
        const categoryCode = document.getElementById('editCatCode').value;
        const categoryName = document.getElementById('editCatName').value;
        
        // Create form data for the request
        const formData = new FormData();
        formData.append('catCode', categoryCode);
        formData.append('catname', categoryName);
        
        // Send update request
        fetch(`/masters/ship-category/${categoryId}/update`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
                
                // Show success alert
                Swal.fire({
                    title: 'Success!',
                    text: 'Category updated successfully',
                    icon: 'success',
                    confirmButtonColor: '#0ab39c'
                }).then(() => {
                    // Reload page to reflect changes
                    location.reload();
                });
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: data.message || 'Failed to update category',
                    icon: 'error',
                    confirmButtonColor: '#f06548'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error!',
                text: 'An unexpected error occurred',
                icon: 'error',
                confirmButtonColor: '#f06548'
            });
        });
    });
    
    // Edit Document Button Handler
    document.addEventListener('click', function(e) {
        const editDocumentBtn = e.target.closest('.edit-document-btn');
        if (editDocumentBtn) {
            const documentId = editDocumentBtn.dataset.documentId;
            const categoryId = editDocumentBtn.dataset.categoryId;
            const description = editDocumentBtn.dataset.description;
            const isMandatory = editDocumentBtn.dataset.isMandatory === 'true';
            const hasSample = editDocumentBtn.dataset.hasSample === 'true';
            const confidenceLevel = editDocumentBtn.dataset.confidenceLevel || '0.0';
            
            // Add new fields
            const contentSimilarity = editDocumentBtn.dataset.contentSimilarity || '0.0';
            const aiValidate = editDocumentBtn.dataset.aiValidate === 'true';
            const multipleDocument = editDocumentBtn.dataset.multipleDocument === 'true';

            // Populate the edit modal fields
            document.getElementById('editDocumentId').value = documentId;
            document.getElementById('editCategoryId').value = categoryId;
            document.getElementById('editDescription').value = description;
            document.getElementById('editIsMandatory').checked = isMandatory;
            document.getElementById('editConfidenceLevel').value = confidenceLevel;
            
            // Set new fields
            document.getElementById('editContentSimilarity').value = contentSimilarity;
            document.getElementById('editAiValidate').checked = aiValidate;
            document.getElementById('editMultipleDocument').checked = multipleDocument;

            // Show sample file information if exists
            const currentFileInfo = document.getElementById('currentFileInfo');
            if (hasSample) {
                currentFileInfo.innerHTML = '<span class="text-success"><i class="ri-file-text-line me-1"></i>Current sample file exists. Upload a new file to replace it.</span>';
            } else {
                currentFileInfo.innerHTML = '<span class="text-muted">No sample file uploaded</span>';
            }
            
            // Show the edit modal
            const editDocumentModal = new bootstrap.Modal(document.getElementById('editDocumentModal'));
            editDocumentModal.show();
        }
    });

    
    // Save Document Changes Button Handler
    document.getElementById('saveDocumentBtn').addEventListener('click', function() {
        const documentId = document.getElementById('editDocumentId').value;
        const categoryId = document.getElementById('editCategoryId').value;
        const description = document.getElementById('editDescription').value;
        const isMandatory = document.getElementById('editIsMandatory').checked;
        const sampleFile = document.getElementById('editSampleFile').files[0];
        const confidenceLevel = document.getElementById('editConfidenceLevel').value;
        
        // Add new fields
        const contentSimilarity = document.getElementById('editContentSimilarity').value;
        const aiValidate = document.getElementById('editAiValidate').checked;
        const multipleDocument = document.getElementById('editMultipleDocument').checked;

        // Create form data for the request
        const formData = new FormData();
        formData.append('description', description);
        formData.append('isMandatory', isMandatory ? 1 : 0);
        formData.append('confidence_level', confidenceLevel);
        
        // Append new fields
        formData.append('content_similarity', contentSimilarity);
        formData.append('ai_validate', aiValidate ? 1 : 0);
        formData.append('multiple_document', multipleDocument ? 1 : 0);

        // Only append file if a new one is selected
        if (sampleFile) {
            formData.append('sampleFile', sampleFile);
        }
        
        // Send update request
        fetch(`/masters/ship-cat-document/${documentId}/update`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('editDocumentModal')).hide();
                
                // Show success alert
                Swal.fire({
                    title: 'Success!',
                    text: 'Document updated successfully',
                    icon: 'success',
                    confirmButtonColor: '#0ab39c'
                }).then(() => {
                    // Reload the documents section
                    loadDocuments(categoryId);
                });
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: data.message || 'Failed to update document',
                    icon: 'error',
                    confirmButtonColor: '#f06548'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error!',
                text: 'An unexpected error occurred',
                icon: 'error',
                confirmButtonColor: '#f06548'
            });
        });
    });
        
});

document.addEventListener('DOMContentLoaded', function() {
    // Function to validate and correct confidence level inputs
    function validateConfidenceLevel(input) {
        let value = parseFloat(input.value);
        
        // Check if value exceeds maximum
        if (value > 100) {
            input.value = 100;
            value = 100;
        }
        
        // Check if value is below minimum
        if (value < 0) {
            input.value = 0;
            value = 0;
        }
        
        // Check for decimal places (optional - limit to 1 decimal place)
        if (value !== Math.round(value * 10) / 10) {
            input.value = Math.round(value * 10) / 10;
        }
    }
    
    // Apply validation to all confidence level inputs
    document.querySelectorAll('input[name="confidence_level"], #editConfidenceLevel').forEach(input => {
        // Validate on input (real-time as user types)
        input.addEventListener('input', function() {
            validateConfidenceLevel(this);
        });
        
        // Validate on blur (when user leaves the field)
        input.addEventListener('blur', function() {
            validateConfidenceLevel(this);
        });
        
        // Prevent manual entry of values outside range
        input.addEventListener('keypress', function(e) {
            // Allow: backspace, delete, tab, escape, enter
            if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.keyCode === 65 && e.ctrlKey === true) ||
                (e.keyCode === 67 && e.ctrlKey === true) ||
                (e.keyCode === 86 && e.ctrlKey === true) ||
                (e.keyCode === 88 && e.ctrlKey === true)) {
                return;
            }
            
            // Ensure the character being typed creates a valid number
            let newValue = this.value + e.key;
            let numValue = parseFloat(newValue);
            
            // Prevent if not a valid number or exceeds 100
            if (isNaN(numValue) || numValue > 100) {
                e.preventDefault();
            }
        });
    });
});

function validateContentSimilarity(input) {
    let value = parseFloat(input.value);
    
    // Check if value exceeds maximum
    if (value > 100) {
        input.value = 100;
        value = 100;
    }
    
    // Check if value is below minimum
    if (value < 0) {
        input.value = 0;
        value = 0;
    }
    
    // Check for decimal places (optional - limit to 1 decimal place)
    if (value !== Math.round(value * 10) / 10) {
        input.value = Math.round(value * 10) / 10;
    }
}


function toggleCategories(shipmentTypeId) {
    const categoriesDiv = document.getElementById(`categories${shipmentTypeId}`);
    if (categoriesDiv.style.display === 'none') {
        categoriesDiv.style.display = 'block';
    } else {
        categoriesDiv.style.display = 'none';
    }
}

function toggleDocuments(categoryId) {
    const documentsDiv = document.getElementById(`documents${categoryId}`);
    if (documentsDiv.style.display === 'none') {
        documentsDiv.style.display = 'block';
        loadDocuments(categoryId);
    } else {
        documentsDiv.style.display = 'none';
    }
}

function confirmDelete(id) {
    const deleteForm = document.getElementById('deleteForm');
    deleteForm.action = "{{ url_for('masters.delete_shipment_type', shipment_type_id=0) }}".replace('0', id);
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function loadDocuments(categoryId) {
    fetch(`/masters/ship-cat-document/${categoryId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const documentsList = document.getElementById(`documentsList${categoryId}`);
                documentsList.innerHTML = data.documents.map(doc => `
                <div class="card shadow-none border mb-2">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex align-items-center">
                            <div class="flex-grow-1">
                                <i class="ri-file-text-line me-2 text-muted"></i>
                                <span>${doc.description}</span>
                                ${doc.isMandatory ? '<span class="badge badge-soft-warning ms-2">Mandatory</span>' : ''}
                                ${doc.ai_validate ? '<span class="badge badge-soft-info ms-2">AI Validate</span>' : ''}
                                ${doc.multiple_document ? '<span class="badge badge-soft-primary ms-2">Multiple Docs</span>' : ''}
                                <span class="badge badge-soft-info ms-2">
                                    <i class="ri-accuracy-line me-1"></i>
                                    Conf: ${doc.confidence_level || 0}%
                                </span>
                                <span class="badge badge-soft-success ms-2">
                                    <i class="ri-percentage-line me-1"></i>
                                    Sim: ${doc.content_similarity || 0}%
                                </span>
                                ${doc.sample_file_url ? `<a href="${doc.sample_file_url}" class="ms-2 text-info" target="_blank"><i class="ri-download-line"></i> Sample</a>` : ''}
                                <button type="button" class="btn btn-sm btn-secondary ai-check-btn" 
                                        data-bs-toggle="tooltip" 
                                        data-bs-placement="top" 
                                        title="AI Check Fields"
                                        data-shipment-type-id="${doc.shipment_type_id}"
                                        data-category-id="${categoryId}"
                                        data-document-id="${doc.id}"
                                        data-document-description="${doc.description}">
                                        <i class="ri-settings-3-line"></i>
                                    </button>
                            </div>
                            <div class="hstack gap-2">
                                <button class="btn btn-sm btn-primary edit-document-btn" 
                                    data-document-id="${doc.id}" 
                                    data-category-id="${categoryId}"
                                    data-description="${doc.description}"
                                    data-is-mandatory="${doc.isMandatory ? 'true' : 'false'}"
                                    data-has-sample="${doc.sample_file_url ? 'true' : 'false'}"
                                    data-confidence-level="${doc.confidence_level || 0}"
                                    data-content-similarity="${doc.content_similarity || 0}"
                                    data-ai-validate="${doc.ai_validate ? 'true' : 'false'}"
                                    data-multiple-document="${doc.multiple_document ? 'true' : 'false'}">
                                    <i class="ri-pencil-line"></i>
                                </button>
                                <button class="btn btn-sm btn-danger delete-document-btn" 
                                    data-document-id="${doc.id}" 
                                    data-category-id="${categoryId}">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
                
                // Add event listeners to newly created delete document buttons
                document.querySelectorAll('.delete-document-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const docId = this.getAttribute('data-document-id');
                        const catId = this.getAttribute('data-category-id');
                        deleteDocument(docId, catId);
                    });
                });

                // Initialize tooltips
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl)
                });
            }
        });
}


function deleteDocument(documentId, categoryId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You want to delete this document?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'No, cancel!',
        confirmButtonColor: '#f06548',
        cancelButtonColor: '#0ab39c'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/masters/ship-cat-document/${documentId}/delete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadDocuments(categoryId);
                    Swal.fire(
                        'Deleted!',
                        'Document has been deleted.',
                        'success'
                    );
                }
            });
        }
    });
}

// Add event listeners for forms
document.addEventListener('DOMContentLoaded', function () {
    // Category form submission
    document.querySelectorAll('[id^=categoryForm]').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const shipmentTypeId = this.id.replace('categoryForm', '');
            const formData = new FormData(this);

            fetch(`/masters/ship-category/${shipmentTypeId}/add`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: 'Success!',
                        text: 'Category added successfully',
                        icon: 'success',
                        confirmButtonColor: '#0ab39c'
                    }).then(() => {
                        location.reload();
                    });
                }
            });
        });
    });

    // Document form submission
    document.querySelectorAll('.document-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const categoryId = this.dataset.categoryId;
            const shipmentTypeId = this.dataset.shipmentTypeId;
            
            // Create FormData object for file upload
            const formData = new FormData();
            formData.append('shipCatId', categoryId);
            formData.append('shipmentTypeId', shipmentTypeId);
            formData.append('description', this.querySelector('[name="description"]').value);
            formData.append('isMandatory', this.querySelector('[name="isMandatory"]').checked ? 1 : 0);
            formData.append('confidence_level', this.querySelector('[name="confidence_level"]').value);
            
            // Add new fields
            formData.append('content_similarity', this.querySelector('[name="content_similarity"]').value);
            formData.append('ai_validate', this.querySelector('[name="ai_validate"]').checked ? 1 : 0);
            formData.append('multiple_document', this.querySelector('[name="multiple_document"]').checked ? 1 : 0);

            // Get the file if it exists
            const fileInput = this.querySelector('[name="sampleFile"]');
            if (fileInput.files.length > 0) {
                formData.append('sampleFile', fileInput.files[0]);
            }

            fetch('/masters/ship-cat-document/add', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadDocuments(categoryId);
                    this.reset();
                    Swal.fire({
                        title: 'Success!',
                        text: 'Document added successfully',
                        icon: 'success',
                        confirmButtonColor: '#0ab39c'
                    });
                }
            });
        });
    });

    
    // Delete category - THIS IS THE FIX
    document.querySelectorAll('.btn-danger[data-category-id]').forEach(button => {
        button.addEventListener('click', function () {
            const categoryId = this.dataset.categoryId;
            
            Swal.fire({
                title: 'Are you sure?',
                text: "You want to delete this category?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'No, cancel!',
                confirmButtonColor: '#f06548',
                cancelButtonColor: '#0ab39c'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/masters/ship-category/${categoryId}/delete`, {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire(
                                'Deleted!',
                                'Category has been deleted.',
                                'success'
                            ).then(() => {
                                location.reload();
                            });
                        }
                    });
                }
            });
        });
    });

    
});

// AI Check Fields Functionality
document.addEventListener('DOMContentLoaded', function() {
    const aiCheckFieldsModal = new bootstrap.Modal(document.getElementById('aiCheckFieldsModal'));
    const aiCheckFieldsContainer = document.getElementById('aiCheckFieldsContainer');
    const addAICheckFieldBtn = document.getElementById('addAICheckFieldBtn');
    const saveAICheckFieldsBtn = document.getElementById('saveAICheckFieldsBtn');

    // Event delegation for AI Check Fields button
    document.addEventListener('click', function(e) {
        const aiCheckBtn = e.target.closest('.ai-check-btn');
        if (aiCheckBtn) {
            // Reset modal
            aiCheckFieldsContainer.innerHTML = `
                <div class="ai-check-field-row mb-3 row g-2 align-items-center">
                    <div class="col-md-5">
                        <input type="text" class="form-control field-name" placeholder="Field Name">
                    </div>
                    <div class="col-md-5">
                        <select class="form-select field-condition">
                            <option value="">Select Section</option>
                            <option value="header">Header</option>
                            <option value="body">Body</option>
                            <option value="footer">Footer</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-danger remove-ai-check-field d-none">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>
                </div>
            `;

            // Set hidden input values
            document.getElementById('aiCheckShipmentTypeId').value = aiCheckBtn.dataset.shipmentTypeId;
            document.getElementById('aiCheckCategoryId').value = aiCheckBtn.dataset.categoryId;
            document.getElementById('aiCheckDocumentId').value = aiCheckBtn.dataset.documentId;
            document.getElementById('aiCheckDocumentDescription').value = aiCheckBtn.dataset.documentDescription;

            // Check if there are existing AI check fields
            fetch(`/masters/ship-cat-document/${aiCheckBtn.dataset.documentId}/ai-checks`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.ai_checks && data.ai_checks.length > 0) {
                        // Clear initial row
                        aiCheckFieldsContainer.innerHTML = '';
                        
                        // Populate existing AI check fields
                        data.ai_checks.forEach(check => {
                            const newRow = addAICheckFieldRow(check.field_name, check.condition);
                            // Store the check ID for updates
                            if (check.id) {
                                newRow.dataset.checkId = check.id;
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading AI checks:', error);
                    Swal.fire({
                        title: 'Error!',
                        text: 'Failed to load existing AI check fields',
                        icon: 'error',
                        confirmButtonColor: '#f06548'
                    });
                });

            // Show modal
            aiCheckFieldsModal.show();
        }
    });

    // Function to add a new AI check field row
    function addAICheckFieldRow(fieldName = '', condition = '') {
        const newRow = document.createElement('div');
        newRow.classList.add('ai-check-field-row', 'mb-3', 'row', 'g-2', 'align-items-center');
        newRow.innerHTML = `
            <div class="col-md-5">
                <input type="text" class="form-control field-name" placeholder="Field Name" value="${fieldName}">
            </div>
            <div class="col-md-5">
                <select class="form-select field-condition">
                    <option value="">Select Section</option>
                    <option value="header" ${condition === 'header' ? 'selected' : ''}>Header</option>
                    <option value="body" ${condition === 'body' ? 'selected' : ''}>Body</option>
                    <option value="footer" ${condition === 'footer' ? 'selected' : ''}>Footer</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger remove-ai-check-field">
                    <i class="ri-delete-bin-line"></i>
                </button>
            </div>
        `;

        // Add event listener for remove button
        newRow.querySelector('.remove-ai-check-field').addEventListener('click', function() {
            newRow.remove();
        });

        aiCheckFieldsContainer.appendChild(newRow);
        return newRow;
    }

    // Add AI Check Field Button
    addAICheckFieldBtn.addEventListener('click', function() {
        addAICheckFieldRow();
    });

    // Save AI Check Fields
    saveAICheckFieldsBtn.addEventListener('click', function() {
        const documentId = document.getElementById('aiCheckDocumentId').value;
        
        if (!documentId) {
            Swal.fire({
                title: 'Error!',
                text: 'Document ID is missing',
                icon: 'error',
                confirmButtonColor: '#f06548'
            });
            return;
        }

        const aiCheckFields = [];
        let isValid = true;

        document.querySelectorAll('.ai-check-field-row').forEach(row => {
            const fieldName = row.querySelector('.field-name').value.trim();
            const condition = row.querySelector('.field-condition').value;
            const checkId = row.dataset.checkId;
            
            // Validate input
            if (!fieldName) {
                row.querySelector('.field-name').classList.add('is-invalid');
                isValid = false;
            } else {
                row.querySelector('.field-name').classList.remove('is-invalid');
            }
            
            if (!condition) {
                row.querySelector('.field-condition').classList.add('is-invalid');
                isValid = false;
            } else {
                row.querySelector('.field-condition').classList.remove('is-invalid');
            }
            
            if (fieldName && condition) {
                const fieldData = { 
                    field_name: fieldName, 
                    condition: condition 
                };
                
                // Include ID if it exists
                if (checkId) {
                    fieldData.id = parseInt(checkId);
                }
                
                aiCheckFields.push(fieldData);
            }
        });

        if (!isValid) {
            Swal.fire({
                title: 'Validation Error',
                text: 'Please fill in all required fields',
                icon: 'warning',
                confirmButtonColor: '#f7b84b'
            });
            return;
        }

        // Send data to backend
        fetch('/masters/ship-cat-document/ai-checks/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                document_id: documentId,
                ai_check_fields: aiCheckFields
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: 'Success!',
                    text: data.message || 'AI Check Fields saved successfully',
                    icon: 'success',
                    confirmButtonColor: '#0ab39c'
                });
                aiCheckFieldsModal.hide();
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: data.message || 'Failed to save AI Check Fields',
                    icon: 'error',
                    confirmButtonColor: '#f06548'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error!',
                text: 'An unexpected error occurred',
                icon: 'error',
                confirmButtonColor: '#f06548'
            });
        });
    });
});



</script>
{% endblock extra_js %}