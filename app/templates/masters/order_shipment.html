{% extends "partials/base.html" %}

{% block title %}{% if shipment %}Edit{% else %}New{% endif %} Shipment - {{entry.docserial}} {% endblock title %}

{% block content %}
<!-- Start right Content here -->
<div class="main-content">
    <div class="page-content">
        <div class="container-fluid">
            <!-- start page title -->
            <div class="row">
                <div class="col-12">
                    <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
                        <h4 class="mb-sm-0">{% if shipment %}Edit{% else %}New{% endif %} Shipment - {{entry.docserial}} </h4>

                        <div class="page-title-right">
                            <ol class="breadcrumb m-0">
                                <li class="breadcrumb-item"><a href="javascript: void(0);">Clearing</a></li>
                                <li class="breadcrumb-item"><a href="javascript:window.history.back();">Shipments</a></li>
                                <li class="breadcrumb-item active">{% if shipment %}Edit{% else %}Add{% endif %} Shipment</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end page title -->

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" id="flash-message">
                <i class="ri-check-double-line"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <div class="row">
                <div class="col-12">
                    <!-- Tab Navigation -->
                    <div class="card shadow-none border mb-0">
                        <div class="card-body p-0">
                            <ul class="nav nav-tabs nav-tabs-custom nav-justified" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#tab-details" role="tab" aria-selected="true">
                                        <span class="d-block d-sm-none"><i class="ri-file-list-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-file-list-line"></i> Details</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-actions" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-rocket-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-rocket-line"></i> Actions</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-attachments" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-attachment-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-attachment-line"></i> Attachments</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-containers" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-container-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-inbox-archive-line"></i> Containers</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-items" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-item-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-archive-line"></i> Items</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-demurrage" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-container-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-inbox-archive-line"></i> Demurrage</span>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-expenses" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-money-dollar-circle-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-money-dollar-circle-line"></i> Expenses</span>
                                    </a>
                                </li>
                                
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#tab-invoices" role="tab" aria-selected="false">
                                        <span class="d-block d-sm-none"><i class="ri-bill-line"></i></span>
                                        <span class="d-none d-sm-block"><i class="ri-file-paper-line"></i> Invoices</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Tab Content -->
                    <div class="tab-content pt-3">
                        <!-- Details Tab -->
                        <div class="tab-pane active" id="tab-details" role="tabpanel">
                            <form method="POST" action="{{ url_for('masters.order_shipment', entry_id=entry.id) }}">
                                {% if shipment %}
                                <input type="hidden" name="id" value="{{ shipment.id }}">
                                {% endif %}
                                {% if order %}
                                <input type="hidden" name="order_id" value="{{ order.id }}">
                                {% endif %}

                                <!-- Basic Information -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="branch_id" class="form-label">Branch</label>
                                                    <select class="form-select" id="branch_id" name="branch_id">
                                                        <option value="">Select Branch</option>
                                                        {% for branch in branches %}
                                                        <option value="{{ branch.id }}" {% if shipment and shipment.branch_id == branch.id %}selected{% endif %}>{{ branch.name }}</option>
                                                        {% endfor %}
                                                    </select>   
                                                </div>                                    
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="import_id" class="form-label">Import ID</label>
                                                    <input type="text" class="form-control" id="import_id" name="import_id" placeholder="Enter Import ID" value="{{ entry.docserial if entry else (shipment.import_id if shipment else '') }}" {% if entry %}readonly{% endif %}>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="shipment_deadline" class="form-label">Shipment Deadline</label>
                                                    <input type="date" class="form-control" id="shipment_deadline" name="shipment_deadline" value="{{ entry.dealineDate if entry else (shipment.shipment_deadline if shipment else '') }}" {% if entry %}readonly{% endif %}>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="bl_no" class="form-label">BL No</label>
                                                    <input type="text" class="form-control" id="bl_no" name="bl_no" placeholder="Enter BL number" value="{{ shipment.bl_no if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="license_number" class="form-label">License No</label>
                                                    <input type="text" class="form-control" id="license_number" name="license_number" placeholder="Enter license number" value="{{ shipment.license_number if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <div class="d-flex align-items-center">
                                                        <label for="primary_job" class="form-label me-2">Primary Job</label>
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" id="primary_job_yn" name="primary_job_yn" value="Y" {% if shipment and shipment.primary_job_yn == 'Y' %}checked{% endif %}>
                                                        </div>
                                                    </div>
                                                    <input type="text" class="form-control" id="primary_job" name="primary_job" placeholder="Enter primary job" value="{{ shipment.primary_job if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <!-- Shipment Type -->
                                                <select class="form-select" id="shipment_type_id" name="shipment_type_id">
                                                    <option value="">Select Shipment Type</option>
                                                    {% for st in os_shipment_types %}
                                                        <option value="{{ st.id }}" {% if shipment and shipment.shipment_type_id == st.id %}selected{% endif %}>{{ st.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            
                                            <div class="col-md-3">
                                                <!-- Sub Type -->
                                                <select class="form-select" id="sub_type" name="sub_type">
                                                    <option value="">Select Sub Type</option>
                                                    {% for sub in sub_types %}
                                                        <option value="{{ sub.id }}" {% if shipment and shipment.sub_type_id == sub.id %}selected{% endif %}>{{ sub.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <!-- Customer Category -->
                                                <select class="form-select" id="customer_category" name="customer_category">
                                                    <option value="">Select Customer Category</option>
                                                    {% for cat in customer_categories %}
                                                        <option value="{{ cat.id }}" {% if shipment and shipment.customer_category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <!-- Business Type -->
                                                <select class="form-select" id="business_type" name="business_type">
                                                    <option value="">Select Business Type</option>
                                                    {% for bt in business_types %}
                                                        <option value="{{ bt.id }}" {% if shipment and shipment.business_type_id == bt.id %}selected{% endif %}>{{ bt.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Customer Information -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- First card in left column -->
                                        <div class="card shadow-none border mb-3">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="customer_id" class="form-label">Customer</label>
                                                            <select class="form-select" id="customer_id" name="customer_id" {% if entry %}readonly{% endif %}>
                                                                <option value="">Select Customer</option>
                                                                {% for customer in customers %}
                                                                <option value="{{ customer.id }}" {% if entry and entry.customer_id == customer.id %}selected{% elif shipment and shipment.customer_id == customer.id %}selected{% endif %}>{{ customer.customer_name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="billing_party_id" class="form-label">Billing Party</label>
                                                            <select class="form-select" id="billing_party_id" name="billing_party_id">
                                                                <option value="">Select Billing Party</option>
                                                                {% for party in billing_parties %}
                                                                <option value="{{ party.id }}" {% if shipment and shipment.billing_party_id == party.id %}selected{% endif %}>{{ party.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Second card in left column -->
                                        <div class="card shadow-none border mb-3">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="clearing_agent" class="form-label">Clearing Agent</label>
                                                            <input type="text" class="form-control" id="clearing_agent" name="clearing_agent" placeholder="Enter clearing agent" value="{{ shipment.clearing_agent if shipment else '' }}">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="contact_person" class="form-label">Contact Person</label>
                                                            <input type="text" class="form-control" id="contact_person" name="contact_person" placeholder="Enter contact person" value="{{ shipment.contact_person if shipment else '' }}">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Right column with single card -->
                                    <div class="col-md-6">
                                        <!-- Team Assignment -->
                                        <div class="card shadow-none border mb-3">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="sales_person_id" class="form-label">Sales Person</label>
                                                            <select class="form-select" id="sales_person_id" name="sales_person_id">
                                                                <option value="">Select Sales Person</option>
                                                                {% for person in sales_people %}
                                                                <option value="{{ person.id }}" {% if shipment and shipment.sales_person_id == person.id %}selected{% endif %}>{{ person.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="cs_executive_id" class="form-label">CS Executive</label>
                                                            <select class="form-select" id="cs_executive_id" name="cs_executive_id">
                                                                <option value="">Select CS Executive</option>
                                                                {% for exec in cs_executives %}
                                                                <option value="{{ exec.id }}" {% if shipment and shipment.cs_executive_id == exec.id %}selected{% endif %}>{{ exec.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-12">
                                                        <div class="mb-3">
                                                            <label for="wharf_clerk_id" class="form-label">Wharf Clerk</label>
                                                            <select class="form-select" id="wharf_clerk_id" name="wharf_clerk_id">
                                                                <option value="">Select Wharf Clerk</option>
                                                                {% for wharf in wharf_clerks %}
                                                                <option value="{{ wharf.id }}" {% if shipment and shipment.wharf_clerk_id == wharf.id %}selected{% endif %}>{{ wharf.first_name }} {{wharf.last_name}}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Modified Import Container Section with Existing Container Loading -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="mb-0">Container Details</h5>
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <label class="form-label mb-0 me-2">20 ft:</label>
                                                    <input type="text" class="form-control form-control-sm d-inline-block" style="width: 60px;" id="importCount20ft" value="0" readonly>
                                                </div>
                                                <div class="me-3">
                                                    <label class="form-label mb-0 me-2">40 ft:</label>
                                                    <input type="text" class="form-control form-control-sm d-inline-block" style="width: 60px;" id="importCount40ft" value="0" readonly>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-primary" id="addImportContainerRow">
                                                    <i class="ri-add-line"></i> Add Container
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div id="importContainerRows">
                                            {% if import_containers and import_containers|length > 0 %}
                                                {% for container in import_containers %}
                                                <div class="row mb-3 container-row">
                                                    <div class="col-md-3">
                                                        <label class="form-label">Container #</label>
                                                        <input type="text" class="form-control container-number" name="import_container_numbers[]" placeholder="Enter container number" value="{{ container.container_number }}">
                                                    </div>
                                                    <input type="hidden" name="import_container_ids[]" value="{{ container.id }}">

                                                    <div class="col-md-3">
                                                        <label class="form-label">Size</label>
                                                        <select class="form-select container-size" name="import_container_sizes[]">
                                                            <option value="">Select Size</option>
                                                            {% for cs in container_sizes %}
                                                                <!-- UPDATED: Compare with container_size_id -->
                                                                <option value="{{ cs.id }}" {% if container.container_size_id == cs.id %}selected{% endif %}>{{ cs.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Type</label>
                                                        <select class="form-select container-type" name="import_container_types[]">
                                                            <option value="">Select Type</option>
                                                            {% for ct in container_types %}
                                                                <!-- UPDATED: Compare with container_type_id -->
                                                                <option value="{{ ct.id }}" {% if container.container_type_id == ct.id %}selected{% endif %}>{{ ct.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">Remarks</label>
                                                        <input type="text" class="form-control container-remarks" name="import_container_remarks[]" placeholder="Enter remarks" value="{{ container.remarks }}">
                                                    </div>
                                                    <div class="col-md-1">
                                                        <label class="form-label">&nbsp;</label>
                                                        <button type="button" class="btn btn-danger btn-sm d-block remove-container">
                                                            <i class="ri-delete-bin-line"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <!-- Default empty container row if no containers exist -->
                                                <div class="row mb-3 container-row">
                                                    <div class="col-md-3">
                                                        <label class="form-label">Container #</label>
                                                        <input type="text" class="form-control container-number" name="import_container_numbers[]" placeholder="Enter container number">
                                                    </div>

                                                    <div class="col-md-3">
                                                        <label class="form-label">Size</label>
                                                        <select class="form-select container-size" name="import_container_sizes[]">
                                                            <option value="">Select Size</option>
                                                            {% for cs in container_sizes %}
                                                                <option value="{{ cs.id }}">{{ cs.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label class="form-label">Type</label>
                                                        <select class="form-select container-type" name="import_container_types[]">
                                                            <option value="">Select Type</option>
                                                            {% for ct in container_types %}
                                                                <option value="{{ ct.id }}">{{ ct.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <label class="form-label">Remarks</label>
                                                        <input type="text" class="form-control container-remarks" name="import_container_remarks[]" placeholder="Enter remarks">
                                                    </div>
                                                    <div class="col-md-1">
                                                        <label class="form-label">&nbsp;</label>
                                                        <button type="button" class="btn btn-danger btn-sm d-block remove-container">
                                                            <i class="ri-delete-bin-line"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Reference Information -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="po_no" class="form-label">PO No</label>
                                                    <input type="text" class="form-control" id="po_no" name="po_no" placeholder="Enter PO number" value="{{ shipment.po_no if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="invoice_no" class="form-label">Invoice No</label>
                                                    <input type="text" class="form-control" id="invoice_no" name="invoice_no" placeholder="Enter invoice number" value="{{ shipment.invoice_no if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="customer_ref_no" class="form-label">Customer Ref No</label>
                                                    <input type="text" class="form-control" id="customer_ref_no" name="customer_ref_no" placeholder="Enter customer reference" value="{{ order.customer.customer_id if order else (shipment.customer_ref_no if shipment else '') }}" {% if order %}readonly{% endif %}>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="customs_dti_no" class="form-label">Customs DTI No</label>
                                                    <input type="text" class="form-control" id="customs_dti_no" name="customs_dti_no" placeholder="Enter customs DTI number" value="{{ shipment.customs_dti_no if shipment else '' }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Shipping Information -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="mbl_number" class="form-label">MBL Number</label>
                                                    <input type="text" class="form-control" id="mbl_number" name="mbl_number" placeholder="Enter MBL number" value="{{ shipment.mbl_number if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="vessel" class="form-label">Vessel</label>
                                                    <input type="text" class="form-control" id="vessel" name="vessel" placeholder="Enter vessel name" value="{{ shipment.vessel if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="voyage" class="form-label">Voyage</label>
                                                    <input type="text" class="form-control" id="voyage" name="voyage" placeholder="Enter voyage" value="{{ shipment.voyage if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="eta" class="form-label">ETA</label>
                                                    <input type="datetime-local" class="form-control" id="eta" name="eta" value="{{ shipment.eta.strftime('%Y-%m-%dT%H:%M') if shipment and shipment.eta else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="shipper" class="form-label">Shipper</label>
                                                    <input type="text" class="form-control" id="shipper" name="shipper" placeholder="Enter shipper" value="{{ shipment.shipper if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="port_of_loading" class="form-label">Port of Loading</label>
                                                    <input type="text" class="form-control" id="port_of_loading" name="port_of_loading" placeholder="Enter port of loading" value="{{ shipment.port_of_loading if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="port_of_discharge" class="form-label">Port of Discharge</label>
                                                    <input type="text" class="form-control" id="port_of_discharge" name="port_of_discharge" placeholder="Enter port of discharge" value="{{ shipment.port_of_discharge if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="job_type" class="form-label">Job Type</label>
                                                    <select class="form-select" id="job_type" name="job_type">
                                                        <option value="">Select Job Type</option>
                                                        {% for jt in job_types %}
                                                            <option value="{{ jt.id }}" {% if shipment and shipment.job_type == jt.id %}selected{% endif %}>{{ jt.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>                                 
                                            </div>
    
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="fcl_gate_out_date" class="form-label">FCL Gate Out Date</label>
                                                    <input type="date" class="form-control" id="fcl_gate_out_date" name="fcl_gate_out_date" value="{{ shipment.fcl_gate_out_date if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="pod_datetime" class="form-label">POD Date/Time</label>
                                                    <input type="datetime-local" class="form-control" id="pod_datetime" name="pod_datetime" value="{{ shipment.pod_datetime.strftime('%Y-%m-%dT%H:%M') if shipment and shipment.pod_datetime else '' }}">
                                                </div>
                                            </div>
                    
                                        </div>
                                    </div>
                                </div>

                                <!-- Cargo Details -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="no_of_packages" class="form-label">No of Packages</label>
                                                    <input type="number" class="form-control" id="no_of_packages" name="no_of_packages" placeholder="Enter number of packages" value="{{ shipment.no_of_packages if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="package_type" class="form-label">Package Type</label>
                                                    <input type="text" class="form-control" id="package_type" name="package_type" placeholder="Enter package type" value="{{ shipment.package_type if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="cbm" class="form-label">CBM</label>
                                                    <input type="number" step="0.01" class="form-control" id="cbm" name="cbm" placeholder="Enter CBM" value="{{ shipment.cbm if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="gross_weight" class="form-label">Gross Weight</label>
                                                    <input type="number" step="0.01" class="form-control" id="gross_weight" name="gross_weight" placeholder="Enter gross weight" value="{{ shipment.gross_weight if shipment else '' }}">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="cargo_description" class="form-label">Cargo Description</label>
                                                    <input class="form-control" id="cargo_description" name="cargo_description" rows="3" placeholder="Enter cargo description" value="{{ shipment.cargo_description if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="liner" class="form-label">Liner</label>
                                                    <input type="text" class="form-control" id="liner" name="liner" placeholder="Enter Liner" value="{{ shipment.liner if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="entrepot" class="form-label">Entrepot</label>
                                                    <input type="text" class="form-control" id="entrepot" name="entrepot" placeholder="Enter entrepot" value="{{ shipment.entrepot if shipment else '' }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Financial Information -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="mb-3">
                                                    <label for="job_currency" class="form-label">Job Currency</label>
                                                    <input type="text" class="form-control" id="job_currency" name="job_currency" placeholder="Enter currency code" value="{{ shipment.job_currency if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="mb-3">
                                                    <label for="ex_rating_buying" class="form-label">Exchange Rate (Buying)</label>
                                                    <input type="number" step="0.0001" class="form-control" id="ex_rating_buying" name="ex_rating_buying" placeholder="Enter buying rate" value="{{ shipment.ex_rating_buying if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="mb-3">
                                                    <label for="ex_rating_selling" class="form-label">Exchange Rate (Selling)</label>
                                                    <input type="number" step="0.0001" class="form-control" id="ex_rating_selling" name="ex_rating_selling" placeholder="Enter selling rate" value="{{ shipment.ex_rating_selling if shipment else '' }}">
                                                </div>
                                            </div>
                                            <div class="col-md-5">
                                                <div class="mb-3">
                                                    <label for="remarks" class="form-label">Remarks</label>
                                                    <input class="form-control" id="remarks" name="remarks" rows="3" placeholder="Enter remarks" value="{{ order.custComment if order else (shipment.remarks if shipment else '') }}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Job Status Information -->
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <div class="form-check form-switch mt-2">
                                                        <input class="form-check-input" type="checkbox" id="onhold_yn" name="onhold_yn" value="Y" {% if shipment and shipment.onhold_yn == 'Y' %}checked{% endif %}>
                                                        <label class="form-check-label" for="onhold_yn">On Hold</label>
                                                    </div>
                                                    <div id="onhold_reason_container" class="mt-3" style="display: none;">
                                                        <textarea class="form-control" id="onhold_reason" name="onhold_reason" rows="2" placeholder="Enter reason for on hold">{{ shipment.onhold_reason if shipment and shipment.onhold_yn == 'Y' else '' }}</textarea>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="cleared_date" class="form-label">Cleared Date</label>
                                                            <input type="date" class="form-control" id="cleared_date" name="cleared_date" value="{{ shipment.cleared_date if shipment else '' }}">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="estimated_job_closing_date" class="form-label">Estimated Job Closing Date</label>
                                                            <input type="date" class="form-control" id="estimated_job_closing_date" name="estimated_job_closing_date" value="{{ shipment.estimated_job_closing_date if shipment else '' }}">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                        
                                <div class="card shadow-none border mb-3">
                                    <div class="card-body">
                                        <div class="d-flex gap-2 float-end">
                                            <a href="{{ url_for('masters.orders') }}" class="btn btn-light">
                                                <i class="ri-close-line me-1"></i>Cancel
                                            </a>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="ri-save-line me-1"></i>Save Shipment
                                            </button>
                                        </div>
                                    </div>
                                </div>    
                            </form>
                        </div>

                        <!-- Actions Tab -->
                        <div class="tab-pane" id="tab-actions" role="tabpanel">
                            <div class="card shadow-none border">
                
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="card" id="tasksList">
                                                <div class="card-header border-0">
                                                    <div class="d-flex align-items-center">
                                                        <h5 class="card-title mb-0 flex-grow-1">All Tasks</h5>
                                                        <div class="flex-shrink-0">
                                                            <div class="d-flex flex-wrap gap-2">
                                                                <button class="btn btn-danger add-btn" data-bs-toggle="modal" data-bs-target="#showModal"><i class="ri-add-line align-bottom me-1"></i> Create Task</button>
                                                                <button class="btn btn-success" id="remove-actions" onClick="deleteMultiple()"><i class="ri-delete-bin-2-line"></i></button>
                                                           </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="card-body border border-dashed border-end-0 border-start-0">
                                                    <form>
                                                        <div class="row g-3">
                                                            <div class="col-xxl-4 col-sm-4">
                                                                <div class="search-box">
                                                                    <input type="text" class="form-control search bg-light border-light" placeholder="Search for tasks or something...">
                                                                    <i class="ri-search-line search-icon"></i>
                                                                </div>
                                                            </div>
                                                            <!--end col-->
                
                                                                <div class="col-xxl-3 col-sm-3">
                                                                    <div class="input-light">
                                                                        <input type="text" class="form-control bg-light border-light" id="demo-datepicker" 
                                                                               data-provider="flatpickr" data-date-format="d M, Y" data-range-date="true" 
                                                                               data-clear-button="true"
                                                                               placeholder="Select due date range">
                                                                    </div>
                                                                </div>
                                                            <!--end col-->
                
                                                            <div class="col-xxl-2 col-sm-2">
                                                                <div class="input-light">
                                                                    <select class="form-control" data-choices data-choices-search-false name="choices-single-default" id="idStatus">
                                                                        <option value="">Status</option>
                                                                        <option value="all" selected>All</option>
                                                                        <!-- Task statuses will be loaded dynamically -->
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            <!--end col-->
                
                                                            <div class="col-xxl-2 col-sm-2">
                                                                <div class="input-light">
                                                                    <select class="form-control" data-choices data-choices-search-false name="taskView" id="idTaskView">
                                                                        <option value="my_tasks" selected>My Tasks</option>
                                                                        <option value="connected_tasks">My Connected Tasks</option>
                                                                    </select>
                                                                </div>
                                                            </div>
                
                                                            <div class="col-xxl-1 col-sm-1">
                                                                <button type="button" class="btn btn-primary w-100" onclick="SearchData();"> <i class="ri-equalizer-fill me-1 align-bottom"></i>
                                                                    Filters
                                                                </button>
                                                            </div>
                                                            <!--end col-->
                                                        </div>
                                                        <!--end row-->
                                                    </form>
                                                </div>
                                                <!--end card-body-->
                                                <div class="card-body">
                                                    <div class="table-responsive table-card mb-4">
                                                        <table class="table align-middle table-nowrap mb-0" id="tasksTable">
                                                            <thead class="table-light text-muted">
                                                                <tr>
                                                                    <th scope="col" style="width: 40px;">
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" id="checkAll" value="option">
                                                                        </div>
                                                                    </th>
                                                                    <th class="sort" data-sort="id">Task Key</th>
                                                                    <th class="sort" data-sort="project_name">Project</th>
                                                                    <th class="sort" data-sort="tasks_name">Task</th>
                                                                    <th class="sort" data-sort="assignedto">Assigned To</th>
                                                                    <th class="sort" data-sort="due_date">Due Date</th>
                                                                    <th class="sort" data-sort="status">Status</th>
                                                                    <th class="sort" data-sort="priority">Priority</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="form-check-all">
                                                                {% for task in tasks %}
                                                                <tr class="task-row" 
                                                                    data-task-id="{{ task.id }}" 
                                                                    data-is-done="{{ task.is_done }}" 
                                                                    data-is-reviewed="{{ task.is_reviewed }}"
                                                                    data-assigned-to="{{ task.assigned_to }}"
                                                                    data-created-by="{{ task.created_by }}"
                                                                    data-has-visibility="{{ 'true' if task.id in visible_task_ids else 'false' }}"
                                                                 >
                                                                    
                                                                    <th scope="row">
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" name="chk_child" value="option{{ task.id }}">
                                                                        </div>
                                                                    </th>
                                                                    <td class="id"><a href="{{ url_for('tasks.task_detail', project_id=task.project_id, task_id=task.id) }}?taskView={{ request.args.get('taskView', 'my_tasks') }}" class="fw-medium link-primary">
                                                                        {{ task.task_key }}</a></td>
                                                                    <td class="project_name">
                                                                        {% if task.project %}
                                                                        <a href="{{ url_for('tasks.task_detail', project_id=task.project_id, task_id=task.id) }}?taskView={{ request.args.get('taskView', 'my_tasks') }}" class="fw-medium link-primary">
                                                                            {{ task.project.name }}</a>
                                                                        {% else %}
                                                                        -
                                                                        {% endif %}
                                                                    </td>
                                                                    <td>
                                                                        <div class="d-flex">
                                                                            <div class="flex-grow-1 tasks_name">{{ task.title }}</div>
                                                                            <div class="flex-shrink-0 ms-4">
                                                                                <ul class="list-inline tasks-list-menu mb-0">
                                                                                    <li class="list-inline-item">
                                                                                        <a href="{{ url_for('tasks.task_detail', project_id=task.project_id, task_id=task.id) }}?taskView={{ request.args.get('taskView', 'my_tasks') }}">
                                                                                            <i class="ri-eye-fill align-bottom me-2 text-muted"></i>
                                                                                        </a>
                                                                                    </li>
                                                                                    {% if current_user.role_id == 1 or current_user.id == task.creator_id %}
                                                                                    <li class="list-inline-item">
                                                                                            <a class="edit-item-btn" href="#showModal" data-bs-toggle="modal" onclick="editTask({{ task.id }})">
                                                                                                <i class="ri-pencil-fill align-bottom me-2 text-muted"></i>
                                                                                            </a>
                                                                                        </li>
                                                                                        <li class="list-inline-item">
                                                                                            <a class="remove-item-btn" onclick="deleteTask({{ task.id }})">
                                                                                                <i class="ri-delete-bin-fill align-bottom me-2 text-muted"></i>
                                                                                            </a>
                                                                                        </li>
                                                                                    {% endif %}
                
                                                                                </ul>
                                                                            </div>
                                                                        </div>
                                                                    </td>
                                                                    <td class="assignedto">
                                                                        {% if task.assignee %}
                                                                        <div class="avatar-group">
                                                                            <a href="javascript: void(0);" class="avatar-group-item" data-bs-toggle="tooltip" data-bs-trigger="hover" data-bs-placement="top" title="{{ task.assignee.name }}">
                                                                                {% if task.assignee.profile_picture %}
                                                                                <img src="data:image/jpeg;base64,{{ task.assignee.profile_picture_base64 }}" alt="" class="rounded-circle avatar-xxs">
                                                                                {% else %}
                                                                                <img src="{{ url_for('static', filename='images/users/user-dummy-img.jpg') }}" alt="" class="rounded-circle avatar-xxs">
                                                                                {% endif %}
                                                                            </a>
                                                                        </div>
                                                                        {% else %}
                                                                        -
                                                                        {% endif %}
                                                                    </td>
                                                                    <td class="due_date">{{ task.due_date.strftime('%d %b, %Y') if task.due_date else '-' }}</td>
                                                                    <td class="status">
                                                                        <span class="badge badge-soft-{{ task.status.color if task.status else 'secondary' }} text-uppercase">
                                                                            {{ task.status.name if task.status else 'Not Set' }}
                                                                        </span>
                                                                        <!-- Show review status badge only for project reviewers -->
                                                                     
                
                                                                    </td>
                                                                    <td class="priority">
                                                                        {% if task.priority %}
                                                                            {% set color_map = {
                                                                                'red': 'danger',
                                                                                'blue': 'primary',
                                                                                'green': 'success',
                                                                                'yellow': 'warning',
                                                                                'gray': 'secondary'
                                                                            } %}
                                                                            <span class="badge badge-soft-{{ color_map[task.priority.color] if task.priority.color in color_map else 'secondary' }} text-uppercase">
                                                                                {{ task.priority.name }}
                                                                            </span>
                                                                        {% else %}
                                                                            <span class="badge badge-soft-secondary text-uppercase">Not Set</span>
                                                                        {% endif %}
                                                                    </td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                        <!--end table-->
                                                        <div class="noresult" style="display: none">
                                                            <div class="text-center">
                                                                <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#121331,secondary:#08a88a" style="width:75px;height:75px"></lord-icon>
                                                                <h5 class="mt-2">Sorry! No Result Found</h5>
                                                                <p class="text-muted mb-0">We did not find any tasks for you search.</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex justify-content-end mt-2">
                                                        <div class="pagination-wrap hstack gap-2">
                                                            <a class="page-item pagination-prev disabled" href="#">
                                                                Previous
                                                            </a>
                                                            <ul class="pagination listjs-pagination mb-0"></ul>
                                                            <a class="page-item pagination-next" href="#">
                                                                Next
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--end card-body-->
                                            </div>
                                            <!--end card-->
                                        </div>
                                        <!--end col-->
                                    </div>
                                    <!--end row-->
                
                                    <div class="modal fade flip" id="deleteOrder" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content">
                                                <div class="modal-body p-5 text-center">
                                                    <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
                                                    <div class="mt-4 text-center">
                                                        <h4>You are about to delete a task ?</h4>
                                                        <p class="text-muted fs-14 mb-4">Deleting your task will remove all of
                                                            your information from our database.</p>
                                                        <div class="hstack gap-2 justify-content-center remove">
                                                            <button class="btn btn-link btn-ghost-success fw-medium text-decoration-none" id="deleteRecord-close" data-bs-dismiss="modal"><i class="ri-close-line me-1 align-middle"></i> Close</button>
                                                            <button class="btn btn-danger" id="delete-record">Yes, Delete It</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--end delete modal -->
                
                                    <div class="modal fade zoomIn" id="showModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered modal-lg">
                                            <div class="modal-content border-0">
                                                <div class="modal-header p-3 bg-soft-info">
                                                    <h5 class="modal-title" id="exampleModalLabel">Create Task</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="close-modal"></button>
                                                </div>
                                                    <!-- In the showModal div, update the form -->
                                                    <form id="createTaskForm" enctype="multipart/form-data" action="{{ url_for('tasks.create_project_task', project_id=0) }}" method="POST">
                                                        {% if shipment %}
                                                        <input type="hidden" name="id" value="{{ shipment.id }}">
                                                        {% endif %}
                                                        {% if order %}
                                                        <input type="hidden" name="order_id" id="order_id" value="{{ order.id }}">
                                                        {% endif %}
                                                        <div class="modal-body">
                                                            <!-- Tab Navigation -->
                                                            <ul class="nav nav-tabs nav-tabs-custom nav-justified" role="tablist">
                                                                <li class="nav-item">
                                                                    <a class="nav-link active" data-bs-toggle="tab" href="#task-details-tab" role="tab" aria-selected="true">
                                                                        <i class="ri-task-line me-1 align-bottom"></i> Task Details
                                                                    </a>
                                                                </li>
                                                                <li class="nav-item">
                                                                    <a class="nav-link" data-bs-toggle="tab" href="#task-attachments-tab" role="tab" aria-selected="false">
                                                                        <i class="ri-attachment-line me-1 align-bottom"></i> Attachments
                                                                    </a>
                                                                </li>
                                                            </ul>
                                                            
                                                            <!-- Tab Content -->
                                                            <div class="tab-content">
                                                                <!-- Task Details Tab -->
                                                                <div class="tab-pane active" id="task-details-tab" role="tabpanel">
                                                                    <div class="row mt-4">
                                                                        <div class="col-md-6">
                                                                            <div class="mb-3">
                                                                                <label for="projects" class="form-label">Project</label>
                                                                                <select class="form-select" id="projects" required>
                                                                                    {% for project in projects %}
                                                                                    <option value="{{ project.id }}">{{ project.name }}</option>
                                                                                    {% endfor %}
                                                                                </select>
                                                                            </div>
                                                                        </div>
                                
                                                                    </div>
                                                                    <div class="mt-2 mb-3">
                                                                        <label for="taskTitle" class="form-label">Title</label>
                                                                        <input type="text" class="form-control" id="taskTitle" required>
                                                                    </div>
                                                                    <div class="mb-3">
                                                                        <label for="taskDescription" class="form-label">Description</label>
                                                                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                                                                    </div>
                                                                    
                                                                    <div class="row">
                                                                        <div class="col-md-6">
                                                                            <div class="mb-3">
                                                                                <label for="taskCategory" class="form-label">Category</label>
                                                                                <select class="form-select" id="taskCategory" required>
                                                                                    {% for category in categories %}
                                                                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                                                                    {% endfor %}
                                                                                </select>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-6">
                                                                            <div class="mb-3">
                                                                                <label for="taskAssignee" class="form-label">Assignee</label>
                                                                                <select class="form-select" id="taskAssignee">
                                                                                    <option value="">Unassigned</option>
                                                                                    {% for member in project_members %}
                                                                                    <option value="{{ member.id }}">{{ member.name }}</option>
                                                                                    {% endfor %}
                                                                                </select>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="row">
                                                                        <div class="col-md-4">
                                                                            <div class="mb-3">
                                                                                <label for="taskStatus" class="form-label">Status</label>
                                                                                <select class="form-select" id="taskStatus" required>
                                                                                    {% for status in statuses %}
                                                                                    <option value="{{ status.id }}">{{ status.name }}</option>
                                                                                    {% endfor %}
                                                                                </select>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-4">
                                                                            <div class="mb-3">
                                                                                <label for="taskPriority" class="form-label">Priority</label>
                                                                                <select class="form-select" id="taskPriority" required>
                                                                                    {% for priority in priorities %}
                                                                                    <option value="{{ priority.id }}">{{ priority.name }}</option>
                                                                                    {% endfor %}
                                                                                </select>
                                                                            </div>
                                                                        </div>
                                                                        <div class="col-md-4">
                                                                            <div class="mb-3">
                                                                                <label for="taskDueDate" class="form-label">Due Date</label>
                                                                                <input type="date" class="form-control" id="taskDueDate" name="due_date">
                                                                                <small id="dueDateHelperText" class="text-muted">
                                                                                    <!-- This text will be updated dynamically based on project settings -->
                                                                                </small>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <!-- Attachments Tab -->
                                                                <div class="tab-pane" id="task-attachments-tab" role="tabpanel">
                                                                    <div class="mb-3 mt-3">
                                                                        <label for="taskAttachments" class="form-label">Attachments</label>
                                                                        <input type="file" class="form-control" id="taskAttachments" multiple>
                                                                        <div id="attachmentList" class="mt-3"></div>
                                                                    </div>
                                        
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                                                            <button type="submit" class="btn btn-success" id="createTaskBtn">Create Task</button>
                                                        </div>
                                                    </form>
                                            </div>
                                        </div>
                                    </div>
                                    <!--end modal-->

                            </div>
                        </div>

                        <!-- Attachments Tab -->
                        <div class="tab-pane" id="tab-attachments" role="tabpanel">
                            <div class="card shadow-none border">
                                <div class="card-body">
                                    <div class="d-flex align-items-center justify-content-between mb-4">
                                        <h5 class="card-title mb-0">Shipment Documents</h5>
                                        <div class="flex-shrink-0">
                                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#documentModal">
                                                <i class="ri-upload-2-line align-bottom me-1"></i> Upload Document
                                            </button>
                                            
                                        </div>
                                    </div>
                                    
                                    <!-- Documents Table -->
                                    <div class="table-responsive">
                                        <table class="table align-middle table-nowrap mb-0" id="documentsTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Document Name</th>
                                                    <th>Type</th>
                                                    <th>Description</th>
                                                    <th>Uploaded By</th>
                                                    <th>Upload Date</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if documents %}
                                                    {% for doc in documents %}
                                                        <tr>
                                                            <td>
                                                                <div class="d-flex align-items-center">
                                                                    <i class="ri-file-text-line fs-18 me-2 text-primary"></i>
                                                                    <div>{{ doc.document_name }}</div>
                                                                </div>
                                                            </td>
                                                            <td><span class="badge badge-soft-info">{{ doc.document_type }}</span></td>
                                                            <td>{{ doc.description }}</td>
                                                            <td>{{ doc.uploaded_by_user.name if doc.uploaded_by_user else 'Unknown' }}</td>
                                                            <td>{{ doc.created_at.strftime('%d %b, %Y') if doc.created_at else 'N/A' }}</td>
                                                            <td>
                                                                <div class="d-flex gap-2">
                                                                    <a href="{{ url_for('masters.view_ship_document', entry_id=entry.id, document_id=doc.id) }}" 
                                                                    class="btn btn-sm btn-soft-primary" target="_blank">
                                                                        <i class="ri-eye-line"></i>
                                                                    </a>
                                                                    <button class="btn btn-sm btn-soft-info edit-document" data-id="{{ doc.id }}">
                                                                        <i class="ri-pencil-line"></i>
                                                                    </button>
                                                                    <button class="btn btn-sm btn-soft-danger delete-document" data-id="{{ doc.id }}">
                                                                        <i class="ri-delete-bin-line"></i>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="6" class="text-center py-4">
                                                            <div class="text-muted">
                                                                    <i class="ri-folder-info-line fs-24 mb-2 d-block"></i>
                                                                    <p>No documents found. Upload documents using the button above.</p>                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Document Modal -->
                            <div class="modal fade zoomIn" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content border-0">
                                        <div class="modal-header p-3 bg-soft-info">
                                            <h5 class="modal-title" id="documentModalLabel">Upload Document</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeDocumentModal"></button>
                                        </div>
                                        <form id="documentForm" enctype="multipart/form-data" >
                                            <input type="hidden" id="documentId" name="document_id" value="">
                                            <input type="hidden" id="shipmentId" name="shipment_id" value="{{ entry.id }}">
                                            
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <label for="documentType" class="form-label">Document Type</label>
                                                    <select class="form-select" id="documentType" name="document_type" required>
                                                        <option value="">Select Document Type</option>
                                                        <option value="invoice">Invoice</option>
                                                        <option value="bill-of-lading">Bill of Lading</option>
                                                        <option value="packing-list">Packing List</option>
                                                        <option value="customs">Customs Documents</option>
                                                        <option value="certificate">Certificates</option>
                                                        <option value="other">Other</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="documentFile" class="form-label">Document File</label>
                                                    <input type="file" class="form-control" id="documentFile" name="document" required>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="documentDescription" class="form-label">Description</label>
                                                    <textarea class="form-control" id="documentDescription" name="description" rows="3" placeholder="Enter document description"></textarea>
                                                </div>
                                                
                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox" id="isConfidential" name="is_confidential">
                                                    <label class="form-check-label" for="isConfidential">Mark as Confidential</label>
                                                </div>
                                                
                                                <div class="edit-only-fields d-none">
                                                    <div class="mb-3">
                                                        <label class="form-label">Uploaded By</label>
                                                        <input type="text" class="form-control" id="uploadedBy" readonly>
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label class="form-label">Upload Date</label>
                                                        <input type="text" class="form-control" id="uploadDate" readonly>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="modal-footer">
                                                <div class="hstack gap-2 justify-content-end">
                                                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                                                    <button type="submit" class="btn btn-success" id="saveDocument">Upload Document</button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Delete Document Modal -->
                            <div class="modal fade flip" id="deleteDocumentModal" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-body p-5 text-center">
                                            <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
                                            <div class="mt-4 text-center">
                                                <h4>You are about to delete a document?</h4>
                                                <p class="text-muted fs-14 mb-4">Deleting your document will remove it permanently from the system.</p>
                                                <div class="hstack gap-2 justify-content-center remove">
                                                    <button class="btn btn-link btn-ghost-success fw-medium text-decoration-none" id="deleteDocumentCancel" data-bs-dismiss="modal">
                                                        <i class="ri-close-line me-1 align-middle"></i> Cancel
                                                    </button>
                                                    <button class="btn btn-danger" id="deleteDocument" data-document-id="">
                                                        Yes, Delete It
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Container -->
                        <div class="tab-pane" id="tab-containers" role="tabpanel">
                            <div class="card shadow-none border">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <h5 class="card-title mb-0">Container Document Management</h5>
                                        <!-- Debug info -->
                                        <div class="col-md-4 text-end">
                                            
                                            <small class="text-muted">{{ containers_with_workflows|length }} containers loaded</small>
                                            <button type="button" class="btn btn-primary btn-sm" onclick="refreshContainers()">
                                                <i class="ri-refresh-line me-1"></i> Refresh Progress
                                            </button>
                                        </div>
                                    </div>


                                    <!-- Add this section BEFORE the container details in your order_shipment.html -->

                                    <!-- Workflow Selection Section -->
                                    <div class="card shadow-none border mb-3">
                                        <div class="card-header bg-soft-success">
                                            <h6 class="card-title mb-0">
                                                <i class="ri-workflow-line me-1"></i>
                                                Container Deposit Workflow
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label for="selected_workflow_id" class="form-label">Select Workflow</label>
                                                        <select class="form-select" id="selected_workflow_id" name="selected_workflow_id" onchange="handleWorkflowSelection(this.value)">
                                                            <option value="">Select a Container Deposit Workflow</option>
                                                            {% for workflow in available_workflows %}
                                                            <option value="{{ workflow.id }}" 
                                                                    {% if entry and entry.selected_workflow_id == workflow.id %}selected{% endif %}>
                                                                {{ workflow.workflow_code }} - {{ workflow.workflow_name }}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                        <small class="form-text text-muted">
                                                            This workflow will be applied to all containers in this shipment
                                                        </small>
                                                    </div>
                                                </div>
                                       
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Loading state (optional) -->
                                    <div id="containersLoading" class="text-center py-3" style="display: none;">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                        <span class="ms-2">Loading containers...</span>
                                    </div>
                                    
                                    <!-- Containers List -->
                                    <div id="containersList">
                                        <!-- Containers will be loaded here -->
                                    </div>
                                    
                                    <!-- No Containers Message -->
                                    <div id="noContainersMessage" class="text-center py-4" style="display: none;">
                                        <i class="ri-container-line fs-1 text-muted mb-2"></i>
                                        <p class="text-muted mb-0">No containers found for this shipment</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                                <!-- Document Upload Form Template (Hidden) -->
                                <div id="documentUploadTemplate" style="display: none;">
                                    <div class="document-upload-form border rounded p-3 mb-3 bg-light">
                                        <form class="upload-form row g-3 align-items-end">
                                            <input type="hidden" name="entry_id" value="{{ entry.id }}">
                                            <input type="hidden" name="container_id" class="container-id-input">
                                            <input type="hidden" name="workflow_id" class="workflow-id-input">
                                            <input type="hidden" name="container_document_id" class="document-id-input">
                                            
                                            <div class="col-md-4">
                                                <label class="form-label">Select Document</label>
                                                <input type="file" class="form-control document-file-input" name="document_file" required>
                                                <small class="form-text text-muted">Max file size: 10MB</small>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <label class="form-label">Narration (Optional)</label>
                                                <input type="text" class="form-control narration-input" name="narration" placeholder="Enter description or notes">
                                            </div>
                                            
                                            <div class="col-md-2">
                                                <button type="submit" class="btn btn-success w-100">
                                                    <i class="ri-upload-line me-1"></i> Upload
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>

                        <!-- Items Tab -->
                        <div class="tab-pane" id="tab-items" role="tabpanel">
                            <div class="card shadow-none border">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <h5 class="card-title mb-0">
                                            <i class="ri-shopping-cart-line me-1"></i>
                                            Items
                                        </h5>
                                        <!-- <div>
                                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addManualItemModal">
                                                <i class="ri-add-line me-1"></i>
                                                Add Item
                                            </button>
                                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#pullFromPOModal">
                                                <i class="ri-download-line me-1"></i>
                                                Pull from PO
                                            </button>
                                        </div> -->
                                    </div>

                                    <!-- Items Summary Cards -->
                                    <div class="row mb-4">
                                        <div class="col-md-3">
                                            <div class="card card-animate card-hover shadow-sm bg-soft-primary">
                                                <div class="card-body p-3">
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0">
                                                            <i class="ri-shopping-bag-line fs-3 text-primary"></i>
                                                        </div>
                                                        <div class="flex-grow-1 overflow-hidden ms-3">
                                                            <h6 class="mb-0 text-muted">Total Items</h6>
                                                            <h4 class="mb-0">{{ shipment_items|length if shipment_items else 0 }}</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card card-animate card-hover shadow-sm bg-soft-success">
                                                <div class="card-body p-3">
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0">
                                                            <i class="ri-edit-line fs-3 text-success"></i>
                                                        </div>
                                                        <div class="flex-grow-1 overflow-hidden ms-3">
                                                            <h6 class="mb-0 text-muted">Manual Items</h6>
                                                            <h4 class="mb-0">{{ shipment_items|selectattr('source_type', 'equalto', 'manual')|list|length if shipment_items else 0 }}</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card card-animate card-hover shadow-sm bg-soft-info">
                                                <div class="card-body p-3">
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0">
                                                            <i class="ri-file-list-line fs-3 text-info"></i>
                                                        </div>
                                                        <div class="flex-grow-1 overflow-hidden ms-3">
                                                            <h6 class="mb-0 text-muted">PO Items</h6>
                                                            <h4 class="mb-0">{{ shipment_items|selectattr('source_type', 'equalto', 'po')|list|length if shipment_items else 0 }}</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="card card-animate card-hover shadow-sm bg-soft-warning">
                                                <div class="card-body p-3">
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0 ">
                                                            <i class="ri-money-dollar-circle-line fs-3 text-warning"></i>
                                                        </div>
                                                        <div class="flex-grow-1 overflow-hidden ms-3">
                                                            <h6 class="mb-0 text-muted">Total Value</h6>
                                                            <h4 class="mb-0">LKR {{ '{:,.2f}'.format(shipment_items|sum(attribute='line_total') if shipment_items else 0) }}</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Items Table - Updated with proper button states and actions -->
                                    <div class="table-responsive">
                                        {% if shipment_items and shipment_items|length > 0 %}
                                        <table class="table table-bordered table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th width="3%">#</th>
                                                    <th width="5%">Source</th>
                                                    <th width="8%">PO Number</th>
                                                    <th width="8%">Material Code</th>
                                                    <th width="30%">Material Name</th>
                                                    <th width="7%">Quantity</th>
                                                    <th width="3%">Unit</th>
                                                    <th width="6%">Price</th>
                                                    <th width="9%">Total</th>
                                                    <th width="9%">HS Code</th>
                                                    <th width="12%">Documents</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for item in shipment_items %}
                                                <tr>
                                                    <td>{{ loop.index }}</td>
                                                    <td>
                                                        {% if item.source_type == 'manual' %}
                                                            <span class="badge bg-success">Manual</span>
                                                        {% else %}
                                                            <span class="badge bg-info">PO</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if item.po_number %}
                                                            <small class="text-primary">{{ item.po_number }}</small>
                                                        {% else %}
                                                            <small class="text-muted">-</small>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <strong>{{ item.material_code }}</strong>
                                                    </td>
                                                    <td>
                                                        <div class="text-wrap">{{ item.material_name }}</div>
                                                        {% if item.supplier_name %}
                                                            <small class="text-muted">Supplier: {{ item.supplier_name }}</small>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-end">
                                                        {{ '%0.3f'|format(item.quantity) }}
                                                    </td>
                                                    <td>{{ item.order_unit }}</td>
                                                    <td class="text-end">
                                                        {% if item.net_price %}
                                                            {{ '{:,.2f}'.format(item.net_price) }}
                                                        {% else %}
                                                            <small class="text-muted">-</small>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-end">
                                                        {% if item.line_total %}
                                                            <strong>{{ item.po_currency }} {{ '{:,.2f}'.format(item.line_total) }}</strong>
                                                        {% else %}
                                                            <small class="text-muted">-</small>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if item.hs_code %}
                                                            <span class="badge badge-soft-success">{{ item.hs_code.code }}</span>
                                                        {% else %}
                                                            <span class="badge badge-soft-warning">Not Connected</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if item.hs_code %}
                                                            <div class="d-flex gap-1 flex-wrap">
                                                                <span class="badge badge-soft-warning" data-bs-toggle="tooltip" data-bs-placement="top" title="Required">
                                                                    <i class="ri-file-list-line me-1"></i>
                                                                    {{ item.required_docs_count }}
                                                                </span>
                                                                <span class="badge badge-soft-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Uploaded">
                                                                    <i class="ri-upload-line me-1"></i>
                                                                    {{ item.uploaded_docs_count }}
                                                                </span>
                                                                {% if item.po_material %}
                                                                <button class="btn btn-sm btn-outline-info" onclick="viewMaterialDocuments({{ item.po_material.id }})" data-bs-toggle="tooltip" data-bs-placement="top" title="View Documents">
                                                                    <i class="ri-eye-line"></i>
                                                                </button>
                                                                <span id="material-alert-{{ item.po_material.id }}" 
                                                                    class="material-alert-icon" 
                                                                    style="display: none;"
                                                                    data-bs-toggle="tooltip" 
                                                                    data-bs-placement="top" 
                                                                    title="Documents expiring before shipment date">
                                                                    <i class="ri-error-warning-line" style="color: #dc3545; font-size: 16px;"></i>
                                                                </span>
                                                                {% endif %}

                                                            </div>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                            <tfoot class="table-light">
                                                <tr>
                                                    <td colspan="8" class="text-end"><strong>Grand Total:</strong></td>
                                                    <td class="text-end">
                                                        <strong>LKR {{ '{:,.2f}'.format(shipment_items|sum(attribute='line_total') if shipment_items else 0) }}</strong>
                                                    </td>
                                                    <td colspan="3"></td>
                                                </tr> 
                                            </tfoot>
                                        </table>
                                        {% else %}
                                        <div class="text-center py-5">
                                            <i class="ri-shopping-cart-line fs-1 text-muted mb-3"></i>
                                            <h5 class="text-muted">No items added yet</h5>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>


                        
                                <!-- Add Manual Item Modal -->
                                <div class="modal fade" id="addManualItemModal" tabindex="-1" aria-labelledby="addManualItemModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <form id="manualItemForm" method="POST" action="{{ url_for('masters.add_manual_item', entry_id=entry.id) }}">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="addManualItemModalLabel">
                                                        <i class="ri-add-line me-1"></i>
                                                        Add Manual Item
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="material_code" class="form-label">Material Code <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="material_code" name="material_code" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="material_name" class="form-label">Material Name <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="material_name" name="material_name" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                                                                <input type="number" class="form-control" id="quantity" name="quantity" step="0.001" min="0" required onchange="calculateLineTotal()">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="order_unit" class="form-label">Unit <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="order_unit" name="order_unit" placeholder="e.g., PCS, KG, LTR" required>
                                                                <small class="form-text text-muted">Enter unit (PCS, KG, LTR, M, etc.)</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="net_price" class="form-label">Unit Price</label>
                                                                <input type="number" class="form-control" id="net_price" name="net_price" step="0.01" min="0" onchange="calculateLineTotal()">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="supplier_name" class="form-label">Supplier Name</label>
                                                                <input type="text" class="form-control" id="supplier_name" name="supplier_name">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="po_number" class="form-label">PO Number</label>
                                                                <input type="text" class="form-control" id="po_number" name="po_number" placeholder="Enter PO number (if applicable)">
                                                                <small class="form-text text-muted">Optional - Link to purchase order</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="delivery_date" class="form-label">Delivery Date</label>
                                                                <input type="date" class="form-control" id="delivery_date" name="delivery_date">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="line_total_display" class="form-label">Line Total</label>
                                                                <input type="text" class="form-control bg-light" id="line_total_display" readonly>
                                                                <input type="hidden" id="line_total" name="line_total">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="mb-3">
                                                                <label for="remarks" class="form-label">Remarks</label>
                                                                <textarea class="form-control" id="remarks" name="remarks" rows="2" placeholder="Enter any additional notes"></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" name="submit_action" value="add_another" class="btn btn-info">
                                                        <i class="ri-add-line me-1"></i>
                                                        Add Another
                                                    </button>
                                                    <button type="submit" name="submit_action" value="save_close" class="btn btn-primary">
                                                        <i class="ri-save-line me-1"></i>
                                                        Save & Close
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Pull from PO Modal -->
                                <div class="modal fade" id="pullFromPOModal" tabindex="-1" aria-labelledby="pullFromPOModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <form id="pullFromPOForm" method="POST" action="{{ url_for('masters.add_po_items', entry_id=entry.id) }}">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="pullFromPOModalLabel">
                                                        <i class="ri-download-line me-1"></i>
                                                        Pull Items from Purchase Orders
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <!-- Search and Filter Controls -->
                                                    <div class="row mb-3">
                                                        <div class="col-md-4">
                                                            <label for="po_search" class="form-label">Search PO Number</label>
                                                            <input type="text" class="form-control" id="po_search" placeholder="Enter PO number..." onkeyup="filterPOItems()">
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label for="material_search" class="form-label">Search Material</label>
                                                            <input type="text" class="form-control" id="material_search" placeholder="Material code or name..." onkeyup="filterPOItems()">
                                                        </div>
                                                        <div class="col-md-4">
                                                            <label for="supplier_filter" class="form-label">Filter by Supplier</label>
                                                            <select class="form-select" id="supplier_filter" onchange="filterPOItems()">
                                                                <option value="">All Suppliers</option>
                                                                {% for supplier in available_suppliers %}
                                                                <option value="{{ supplier }}">{{ supplier }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                    </div>

                                                    <!-- PO Items Table -->
                                                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                        {% if available_po_items and available_po_items|length > 0 %}
                                                        <table class="table table-sm table-bordered">
                                                            <thead class="table-light sticky-top">
                                                                <tr>
                                                                    <th width="5%">
                                                                        <div class="form-check">
                                                                            <input class="form-check-input" type="checkbox" id="selectAllPO" onchange="toggleAllPOItems()">
                                                                            <label class="form-check-label" for="selectAllPO">All</label>
                                                                        </div>
                                                                    </th>
                                                                    <th width="12%">PO Number</th>
                                                                    <th width="12%">Material Code</th>
                                                                    <th width="25%">Material Name</th>
                                                                    <th width="8%">Pending Qty</th>
                                                                    <th width="6%">Unit</th>
                                                                    <th width="10%">Price</th>
                                                                    <th width="10%">Total</th>
                                                                    <th width="12%">Supplier</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody id="poItemsTableBody">
                                                                {% for po_item in available_po_items %}
                                                                <tr class="po-item-row" 
                                                                    data-po-number="{{ po_item.po_number }}"
                                                                    data-material="{{ (po_item.material_code + ' ' + po_item.material_name)|lower }}"
                                                                    data-supplier="{{ po_item.supplier_name }}">
                                                                    <td>
                                                                        <div class="form-check">
                                                                            <input class="form-check-input po-item-checkbox" type="checkbox" 
                                                                                name="selected_po_items" value="{{ po_item.id }}"
                                                                                id="po_item_{{ po_item.id }}" onchange="updateSelection()">
                                                                        </div>
                                                                    </td>
                                                                    <td><small class="text-primary">{{ po_item.po_number }}</small></td>
                                                                    <td><strong>{{ po_item.material_code }}</strong></td>
                                                                    <td>
                                                                        <div class="text-wrap">{{ po_item.material_name }}</div>
                                                                    </td>
                                                                    <td class="text-end">{{ '%0.3f'|format(po_item.quantity_pending) }}</td>
                                                                    <td>{{ po_item.order_unit }}</td>
                                                                                                                                        <td class="text-end">{{ '%0.2f'|format(po_item.net_price) }}</td>
                                                                    <td class="text-end">
                                                                        <strong>LKR {{ '%0.2f'|format(po_item.quantity_pending * po_item.net_price) }}</strong>
                                                                    </td>
                                                                    <td><small>{{ po_item.supplier_name }}</small></td>
                                                                </tr>
                                                                {% endfor %}
                                                            </tbody>
                                                        </table>
                                                        {% else %}
                                                        <div class="text-center py-4">
                                                            <i class="ri-file-list-line fs-1 text-muted mb-3"></i>
                                                            <h5 class="text-muted">No PO items available</h5>
                                                            <p class="text-muted">No purchase order items found for your company.</p>
                                                        </div>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Selection Summary -->
                                                    <div class="mt-3">
                                                        <div class="alert alert-info" id="selectionSummary" style="display: none;">
                                                            <i class="ri-information-line me-1"></i>
                                                            <span id="selectedCount">0</span> item(s) selected
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn btn-success" id="addSelectedItemsBtn" disabled>
                                                        <i class="ri-download-line me-1"></i>
                                                        Add Selected Items (<span id="selectedCountBtn">0</span>)
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Edit Item Modal (reuse manual item form structure) -->
                                <div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <form id="editItemForm" method="POST">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editItemModalLabel">
                                                        <i class="ri-edit-line me-1"></i>
                                                        Edit Item
                                                    </h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <!-- Same form fields as manual item modal but with edit_ prefix -->
                                                    <input type="hidden" id="edit_item_id" name="item_id">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="edit_material_code" class="form-label">Material Code <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="edit_material_code" name="material_code" required>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="edit_material_name" class="form-label">Material Name <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="edit_material_name" name="material_name" required>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="edit_quantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                                                                <input type="number" class="form-control" id="edit_quantity" name="quantity" step="0.001" min="0" required onchange="calculateEditLineTotal()">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="edit_order_unit" class="form-label">Unit <span class="text-danger">*</span></label>
                                                                <input type="text" class="form-control" id="edit_order_unit" name="order_unit" placeholder="e.g., PCS, KG, LTR" required>
                                                                <small class="form-text text-muted">Enter unit (PCS, KG, LTR, M, etc.)</small>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="mb-3">
                                                                <label for="edit_net_price" class="form-label">Unit Price</label>
                                                                <input type="number" class="form-control" id="edit_net_price" name="net_price" step="0.01" min="0" onchange="calculateEditLineTotal()">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="edit_supplier_name" class="form-label">Supplier Name</label>
                                                                <input type="text" class="form-control" id="edit_supplier_name" name="supplier_name">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="edit_po_number" class="form-label">PO Number</label>
                                                                <input type="text" class="form-control" id="edit_po_number" name="po_number" placeholder="Enter PO number (if applicable)">
                                                                <small class="form-text text-muted">Optional - Link to purchase order</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="edit_delivery_date" class="form-label">Delivery Date</label>
                                                                <input type="date" class="form-control" id="edit_delivery_date" name="delivery_date">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label for="edit_line_total_display" class="form-label">Line Total</label>
                                                                <input type="text" class="form-control bg-light" id="edit_line_total_display" readonly>
                                                                <input type="hidden" id="edit_line_total" name="line_total">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="mb-3">
                                                                <label for="edit_remarks" class="form-label">Remarks</label>
                                                                <textarea class="form-control" id="edit_remarks" name="remarks" rows="2" placeholder="Enter any additional notes"></textarea>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="ri-save-line me-1"></i>
                                                        Update Item
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- HS Code Info Modal -->
                                <div class="modal fade" id="hsCodeInfoModal" tabindex="-1" aria-labelledby="hsCodeInfoModalLabel" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="hsCodeInfoModalLabel">
                                                    <i class="ri-barcode-line me-1"></i>
                                                    HS Code Information
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row">
                                                    <div class="col-12">
                                                        <div class="mb-3">
                                                            <label class="form-label fw-semibold">HS Code:</label>
                                                            <p class="text-primary fs-5 fw-bold" id="hsCodeDisplay"></p>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label fw-semibold">Description:</label>
                                                            <p class="text-muted" id="hsCodeDescription"></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Material Documents Modal -->
                                <div class="modal fade" id="materialDocumentsModal" tabindex="-1" aria-labelledby="materialDocumentsModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="materialDocumentsModalLabel">
                                                    <i class="ri-file-text-line me-2"></i>Material Documents
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div id="materialDocumentSection">
                                                    <!-- Document progress will be displayed here -->
                                                    <div id="materialDocumentProgress"></div>
                                                    
                                                    <div id="materialAlertSection" style="display: none;">
                                                        <div class="modal-alert-header">
                                                            <h6 class="text-danger mb-2">
                                                                <i class="ri-error-warning-line me-2"></i>
                                                                Document Expiry Alert
                                                            </h6>
                                                            <p class="mb-2 small" id="alertMessage">
                                                                Some documents expire before the shipment ETA/deadline date.
                                                            </p>
                                                        </div>
                                                    </div>


                                                    <!-- Material and HS Code info -->
                                                    <div class="row mb-3" id="materialHSInfo" style="display: none;">
                                                        <div class="col-12">
                                                            <div class="alert alert-info">
                                                                <h6 id="materialInfoTitle"></h6>
                                                                <p class="mb-0" id="materialInfoDetails"></p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Existing documents will be loaded here dynamically -->
                                                    <div class="card mb-3">
                                                        <div class="card-header">
                                                            <h6 class="card-title mb-0">Uploaded Documents</h6>
                                                        </div>
                                                        <div class="card-body" id="materialExistingDocuments">
                                                            <!-- Existing documents will be populated here -->
                                                        </div>
                                                    </div>

                                                    <!-- Required documents for view only -->
                                                    <div class="card">
                                                        <div class="card-header">
                                                            <h6 class="card-title mb-0">Required Documents</h6>
                                                        </div>
                                                        <div class="card-body" id="materialRequiredDocuments">
                                                            <!-- Required documents will be displayed here -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        

                        <!-- Demurrage Tab  -->
                        <div class="tab-pane" id="tab-demurrage" role="tabpanel">
                            <div class="card shadow-none border">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center mb-4">
                                                <h5 class="card-title mb-0">Demurrage Records</h5>
                                                <button type="button" class="btn btn-primary" id="addDemurrageBtn">
                                                    <i class="ri-add-line me-1"></i>Add Demurrage
                                                </button>
                                            </div>
                                            
                                            <!-- No Containers Message -->
                                            <div id="noContainersForDemurrage" class="alert alert-info text-center" style="display: none;">
                                                <i class="ri-container-line fs-2 mb-2"></i>
                                                <p class="mb-0">No containers found for this shipment. Please add containers first.</p>
                                            </div>
                                            
                                            <!-- Demurrage Table -->
                                            <div class="table-responsive" id="demurrageTableContainer">
                                                <table class="table table-bordered table-striped" id="demurrageTable">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Container #</th>
                                                            <th>Date</th>
                                                            <th>Reason</th>
                                    
                                                            <th>Currency</th>
                                                            <th class="text-end">Demurrage Amount</th>
                                                            <th>Bearer</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- Demurrage records will be loaded here -->
                                                    </tbody>
                                                    <tfoot>
                                                        <tr class="table-info">
                                                            <th colspan="4" class="text-end">Total:</th>
                                                            <th id="totalDemurrageAmount" class="text-end">0.00</th>
                                                            <th colspan="3"></th>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                                <!-- Demurrage Details Modal -->
    <div class="modal fade" id="demurrageDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="ri-file-text-line me-2"></i>
                        Demurrage Calculation Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="demurrageDetailsContent">
                    <!-- Content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-info" id="printDemurrageBtn">
                        <i class="ri-printer-line me-1"></i>Print
                    </button>
                    <button type="button" class="btn btn-success" id="downloadDemurrageBtn">
                        <i class="ri-download-line me-1"></i>Download PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

                        <!-- Expenses Tab -->
                        <div class="tab-pane" id="tab-expenses" role="tabpanel">
                            <div class="card shadow-none border">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center mb-4">
                                                <h5 class="card-title mb-0">Shipment Expenses</h5>
                                                <button type="button" class="btn btn-primary" id="addExpenseBtn1">
                                                    <i class="ri-add-line me-1"></i>Add Expense
                                                </button>
                                                
                                            </div>
                                            
                                            <!-- Filter Controls -->
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-3">
                                                    <div class="search-box">
                                                        <input type="text" class="form-control search" id="expenseSearch" placeholder="Search expenses...">
                                                        <i class="ri-search-line search-icon"></i>
                                                    </div>
                                                </div>
                                                <div class="col-md-2">
                                                    <select class="form-select" id="expenseTypeFilter">
                                                        <option value="all">All Expense Types</option>
                                                        {% for expense in income_expenses %}
                                                            {% if expense.type == 'expense' %}
                                                                <option value="{{ expense.id }}">{{ expense.description }}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <select class="form-select" id="expenseSettlementFilter">
                                                        <option value="all">All Settlement Status</option>
                                                        <option value="unsettled">Unsettled</option>
                                                        <option value="partially">Partially Settled</option>
                                                        <option value="fully">Fully Settled</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-2">
                                                    <input type="text" class="form-control" id="expenseDateFilter" 
                                                        placeholder="Select date range" data-provider="flatpickr" 
                                                        data-date-format="d M, Y" data-range-date="true">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-primary w-100" id="filterExpensesBtn">
                                                        <i class="ri-filter-line me-1"></i> Filter
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            
                                            <!-- Expenses List Table -->
                                            <div class="table-responsive">
                                                <table class="table table-bordered table-striped align-middle table-responsive" id="expensesTable">
                                                    <thead class="text-muted table-light">
                                                        <tr>
                                                            <th scope="col">Doc Date</th>
                                                            <th scope="col">Doc No</th>
                                                            <th scope="col">Expense Type</th>
                                                            <th scope="col">Supplier</th>
                                                            <th scope="col">Narration</th>
                                                            <th scope="col">Value</th>
                                                            <!-- <th scope="col">VAT Amount</th> -->
                                                            <th scope="col">NET Amount</th>
                                                            <th scope="col">Margin %</th>
                                                            <th scope="col">Margin Amount</th>
                                                            <th scope="col">Chargeable Amount</th>
                                                            <th scope="col">Charged Amount</th>
                                                            <th scope="col">Balance Amount</th>
                                                            <!-- <th scope="col">Settlement Status</th> -->
                                                            <th scope="col">Attachment</th>
                                                            <th scope="col">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% if expenses %}
                                                            {% for expense in expenses %}
                                                            <tr data-id="{{ expense.id }}"
                                                                data-type="{{ expense.expense_type_id }}"
                                                                data-date-from="{{ expense.doc_date }}"
                                                                data-charged-amount="{{ expense.charged_amount }}"
                                                                data-chargeable-amount="{{ expense.chargeable_amount }}"
                                                                data-balance-amount="{{ expense.balance_amount }}"
                                                                >
                                                                <td>
                                                                    {% if expense.doc_date %}
                                                                        {{ expense.doc_date.strftime('%d %b, %Y') }}
                                                                 
                                                                    {% else %}
                                                                        -
                                                                    {% endif %}
                                                                </td>
                                                                <td>{{ expense.document_number }}</td>
                                                                <td>
                                                                    <span class="fw-medium">{{ expense.expense_description }}</span>
                                                                    <small class="d-block text-muted">{{ expense.expense_type.gl_code }}</small>
                                                                </td>
                                                                <td>{{ expense.supplier_name }}</td>
                                                                <td>{{ expense.narration }}</td>
                                                                <td class="text-end">
                                                                    <span class="fw-medium">{{ expense.formatted_value_amount }}</span>
                                                                </td>
                                                                <!-- <td class="text-end">
                                                                    <span class="fw-medium">{{ expense.formatted_vat_amount }}</span>
                                                                </td> -->
                                                                <td class="text-end">
                                                                    <span class="fw-medium">{{ expense.formatted_amount }}</span>
                                                                </td>
                                                                <td class="text-center">{{ expense.margin|default(0) }}%</td>
                                                                <td class="text-end">
                                                                    <span class="fw-medium">{{ expense.formatted_margin_amount}}</span>
                                                                </td>
                                                                <td class="text-end">
                                                                    <span class="badge badge-soft-success fw-medium fs-6 py-1 px-2">{{ expense.formatted_chargeable_amount }}</span>
                                                                </td>
                                                                <td class="text-end">
                                                                    <span class="fw-medium">{{ expense.formatted_charged_amount }}</span>
                                                                </td>
                                                                <td class="text-end">
                                                                    <span class="fw-medium">{{ expense.formatted_balance_amount }}</span>
                                                                </td>
                                                                <!-- <td>
                                                                    {% if expense.charged_amount and expense.chargeable_amount %}
                                                                        {% set percentage = (expense.charged_amount / expense.chargeable_amount * 100) | round | int %}
                                                                        {% if percentage >= 100 %}
                                                                            <span class="badge badge-soft-success">Fully Settled</span>
                                                                        {% elif percentage > 0 %}
                                                                            <span class="badge badge-soft-warning">Partially Settled ({{ percentage }}%)</span>
                                                                        {% else %}
                                                                            <span class="badge badge-soft-danger">Unsettled</span>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        <span class="badge badge-soft-secondary">N/A</span>
                                                                    {% endif %}
                                                                    
                                                                    <button type="button" class="btn btn-sm btn-soft-info ms-1 view-settlements" 
                                                                            data-id="{{ expense.id }}" title="View Settlement History">
                                                                        <i class="ri-history-line"></i>
                                                                    </button>
                                                                </td> -->
                                                            
                                                                
                                                                <td>
                                                                    {% if expense.attachment_path %}
                                                                        <a href="{{ url_for('masters.view_expense_attachment', expense_id=expense.id) }}" target="_blank" class="btn btn-sm btn-soft-info">
                                                                            <i class="ri-file-text-line me-1"></i>View
                                                                        </a>
                                                                        {% if expense.visible_to_customer %}
                                                                            <span class="badge badge-soft-primary ms-2" title="Visible to customer">
                                                                                <i class="ri-eye-line"></i>
                                                                            </span>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        <span class="badge badge-soft-secondary">None</span>
                                                                    {% endif %}
                                                                </td>
                                                            
                                                                <td>
                                                                    <div class="d-flex gap-2">
                                                                        <!-- Edit button - keep this as a button now -->
                                                                        <button type="button" class="btn btn-sm btn-soft-primary edit-expense"
                                                                                data-id="{{ expense.id }}">
                                                                            <i class="ri-pencil-line"></i>
                                                                        </button>
                                                                        
                                                                        <!-- Delete button - convert to form with data attributes -->
                                                                        <form method="POST" 
                                                                            action="{{ url_for('masters.delete_shipment_expense', entry_id=entry.id, expense_id=expense.id) }}" 
                                                                            class="d-inline delete-expense-form"
                                                                            data-expense-id="{{ expense.id }}"
                                                                            data-charged-amount="{{ expense.charged_amount or 0 }}"
                                                                            data-entry-id="{{ entry.id }}">
                                                                            <button type="submit" class="btn btn-sm btn-soft-danger">
                                                                                <i class="ri-delete-bin-line"></i>
                                                                            </button>
                                                                        </form>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <tr>
                                                                <td colspan="14" class="text-center py-4">
                                                                    <div class="text-muted">
                                                                            <i class="ri-money-dollar-circle-line fs-24 mb-2 d-block"></i>
                                                                            <p>No expenses recorded yet. Add expenses using the button above.</p>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            <!-- "No Results" message (initially hidden) -->
                                            <div class="noresult" style="display: none">
                                                <div class="text-center py-4">
                                                    <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#121331,secondary:#08a88a" style="width:75px;height:75px"></lord-icon>
                                                    <h5 class="mt-2">Sorry! No Result Found</h5>
                                                    <p class="text-muted mb-0">We couldn't find any expenses matching your search criteria.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                                <!-- Expense Modal -->
                                <div class="modal fade zoomIn" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered modal-lg">
                                        <div class="modal-content border-0">
                                            <div class="modal-header p-3 bg-soft-info">
                                                <h5 class="modal-title" id="expenseModalLabel">Add Expense</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeExpenseModal"></button>
                                            </div>
                                            <form action="{{ url_for('masters.save_shipment_expense', entry_id=entry.id) }}" method="POST" enctype="multipart/form-data">
                                                <input type="hidden" id="expenseId" name="expense_id" value="">
                                                <input type="hidden" id="shipmentIdForExpense" name="ship_doc_entry_id" value="{{ entry.id }}">
                                                <input type="hidden" name="active_tab" value="expenses">

                                                <div class="modal-body">
                                                    <!-- Part 1: Basic Information - Each field in separate row -->
                                                    <div class="card shadow-none border mb-3">
                                                        <div class="card-header bg-soft-light">
                                                            <h6 class="card-title mb-0">Basic Information</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="row mb-3">
                                                                <div class="col-md-3">
                                                                    <label for="expenseDateFrom" class="form-label">Date</label>
                                                                </div>
                                                                <div class="col-md-9">
                                                                    <input type="date" class="form-control" id="expenseDateFrom" name="date_from">
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row mb-3">
                                                                <div class="col-md-3">
                                                                    <label for="documentNumber" class="form-label">Document Number</label>
                                                                </div>
                                                                <div class="col-md-9">
                                                                    <input type="text" class="form-control" id="documentNumber" name="document_number" readonly>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row mb-3">
                                                                <div class="col-md-3">
                                                                    <label for="supplierName" class="form-label">Supplier Name</label>
                                                                </div>
                                                                <div class="col-md-9">
                                                                    <input type="text" class="form-control" id="supplierName" name="supplier_name">
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row mb-3">
                                                                <div class="col-md-3">
                                                                    <label for="expenseReference" class="form-label">Other Reference</label>
                                                                </div>
                                                                <div class="col-md-9">
                                                                    <input type="text" class="form-control" id="expenseReference" name="reference" placeholder="Invoice/Receipt number">
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row mb-3">
                                                                <div class="col-md-3">
                                                                    <label for="expenseNarration" class="form-label">Narration</label>
                                                                </div>
                                                                <div class="col-md-9">
                                                                    <textarea class="form-control" id="expenseNarration" name="narration" rows="2" required></textarea>
                                                                </div>
                                                            </div>
                                                            <div class="row mb-3">
                                                                <div class="form-check form-switch mb-0">
                                                                    <div class="col-md-3">
                                                                        <input class="form-check-input" type="checkbox" id="expenseVisibleToCustomer" name="visible_to_customer" value="1" checked>
                                                                    </div>
                                                                    <div class="col-md-9">
                                                                        <label class="form-check-label ms-2" for="expenseVisibleToCustomer">
                                                                            <span>Visible to Customer</span>
                                                                            <small class="form-text text-muted d-block">If checked, this expense will be visible to the customer.</small>
                                                                        </label>
                                                                    </div>
                                                                    
                                                                </div>
                                                            </div>

                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Part 2: Expense Details -->
                                                    <div class="card shadow-none border mb-3">
                                                        <div class="card-header bg-soft-light">
                                                            <h6 class="card-title mb-0">Expense Details</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <!-- Expense Type and Currency in same row -->
                                                            <div class="row mb-3">
                                                                <div class="col-md-6">
                                                                    <label for="expenseType" class="form-label">Expense Type<span class="text-danger">*</span></label>
                                                                    <select class="form-select" id="expenseType" name="expense_type" required>
                                                                        <option value="">Select Expense Type</option>
                                                                        {% for expense in income_expenses %}
                                                                            <option value="{{ expense.id }}">{{ expense.description }}</option>
                                                                        {% endfor %}
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label for="expenseCurrency" class="form-label">Currency<span class="text-danger">*</span></label>
                                                                    <select class="form-select" id="expenseCurrency" name="currency_id" required>
                                                                        <option value="">Select Currency</option>
                                                                            {% for currency in currencies %}
                                                                                <option value="{{ currency.currencyID }}">{{ currency.CurrencyCode }} - {{ currency.CurrencyName }}</option>
                                                                            {% endfor %}
                                                                    </select>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Amount Details - Centralized and one field per row -->
                                                            <div class="row justify-content-center">
                                                                <div class="col-md-8">
                                                                    <div class="card shadow-none border">
                                                                        <div class="card-body">
                                                                            <div class="row mb-3">
                                                                                <div class="col-md-5">
                                                                                    <label for="expenseValue" class="form-label">Value Amount</label>
                                                                                </div>
                                                                                <div class="col-md-7">
                                                                                    <input type="number" step="0.01" class="form-control" id="expenseValue" name="value" required>
                                                                                </div>
                                                                            </div>
                                                                            
                                                                            <!-- Hide VAT Amount field - keeping the input for backend compatibility -->
                                                                            <div class="row mb-3 d-none">
                                                                                <div class="col-md-5">
                                                                                    <label for="expenseVAT" class="form-label">VAT Amount</label>
                                                                                </div>
                                                                                <div class="col-md-7">
                                                                                    <input type="number" step="0.01" class="form-control" id="expenseVAT" name="vat_amount" value="0">
                                                                                </div>
                                                                            </div>
                                                                            
                                                                            <div class="row mb-3">
                                                                                <div class="col-md-5">
                                                                                    <label for="expenseNetAmount" class="form-label">Net Amount</label>
                                                                                </div>
                                                                                <div class="col-md-7">
                                                                                    <input type="number" step="0.01" class="form-control bg-light" id="expenseNetAmount" name="net_amount" readonly>
                                                                                </div>
                                                                            </div>
                                                                            
                                                                            <div class="row mb-3">
                                                                                <div class="col-md-5">
                                                                                    <label for="expenseMargin" class="form-label">Margin %</label>
                                                                                </div>
                                                                                <div class="col-md-7">
                                                                                    <input type="number" step="0.01" class="form-control" id="expenseMargin" name="margin" value="0">
                                                                                </div>
                                                                            </div>
                                                                            
                                                                            <div class="row mb-3">
                                                                                <div class="col-md-5">
                                                                                    <label for="expenseMarginAmount" class="form-label">Margin Amount</label>
                                                                                </div>
                                                                                <div class="col-md-7">
                                                                                    <input type="number" step="0.01" class="form-control" id="expenseMarginAmount" name="margin_amount" value="0">
                                                                                </div>
                                                                            </div>
                                                                            
                                                                            <div class="row mb-3">
                                                                                <div class="col-md-5">
                                                                                    <label for="expenseChargeableAmount" class="form-label">Chargeable Amount</label>
                                                                                </div>
                                                                                <div class="col-md-7">
                                                                                    <input type="number" step="0.01" class="form-control bg-light" id="expenseChargeableAmount" name="chargeable_amount" readonly>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Attachment Section -->
                                                            <!-- Updated Attachment Section without Duplicate Visibility Toggle -->
                                                            <div class="row mt-4">
                                                                <div class="col-md-12">
                                                                    <label for="expenseAttachment" class="form-label">Attachment</label>
                                                                    <input type="file" class="form-control" id="expenseAttachment" name="attachment">
                                                                    <div id="attachmentPreview" class="mt-2 d-none">
                                                                        <div class="d-flex align-items-center p-2 border rounded">
                                                                            <i id="attachmentIcon" class="ri-file-text-line fs-24 me-2"></i>
                                                                            <div class="flex-grow-1">
                                                                                <div id="attachmentName" class="fw-medium"></div>
                                                                                <div id="attachmentSize" class="text-muted small"></div>
                                                                            </div>
                                                                            <button type="button" class="btn btn-sm btn-ghost-danger" id="removeAttachment">
                                                                                <i class="ri-delete-bin-line"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <div id="currentAttachment" class="mt-2 d-none">
                                                                        <div class="d-flex align-items-center p-2 border rounded">
                                                                            <i class="ri-file-text-line fs-24 me-2"></i>
                                                                            <div class="flex-grow-1">
                                                                                <div id="currentAttachmentName" class="fw-medium"></div>
                                                                                <small class="text-muted">Current attachment</small>
                                                                            </div>
                                                                            <a id="viewAttachmentLink" href="#" target="_blank" class="btn btn-sm btn-ghost-primary me-1">
                                                                                <i class="ri-eye-line"></i>
                                                                            </a>
                                                                            <button type="button" class="btn btn-sm btn-ghost-danger" id="removeCurrentAttachment">
                                                                                <i class="ri-delete-bin-line"></i>
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <small class="form-text text-muted d-block mt-2">
                                                                        Max file size: 10MB. Supported formats: PDF, DOC, XLS, JPG, PNG
                                                                    </small>
                                                                </div>
                                                            </div>
                                                                                                                
                                                            <div class="form-check form-switch mb-3">
                                                                <input class="form-check-input" type="checkbox" id="attachmentVisibleToCustomer" name="attachment_visible_to_customer" value="1">
                                                                <label class="form-check-label" for="attachmentVisibleToCustomer">Attachment Visible to Customer</label>
                                                                <small class="form-text text-muted d-block">If checked, the attached file will be visible to the customer.</small>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Add new Settlement Information section -->
                                                    <div class="card shadow-none border mb-3">
                                                        <div class="card-header bg-soft-light">
                                                            <h6 class="card-title mb-0">Settlement Information</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="row mb-3">
                                                                <div class="col-md-5">
                                                                    <label for="expenseChargedAmount" class="form-label">Charged Amount</label>
                                                                </div>
                                                                <div class="col-md-7">
                                                                    <input type="number" step="0.01" class="form-control bg-light" id="expenseChargedAmount" name="charged_amount" readonly>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row mb-3">
                                                                <div class="col-md-5">
                                                                    <label for="expenseBalanceAmount" class="form-label">Balance Amount</label>
                                                                </div>
                                                                <div class="col-md-7">
                                                                    <input type="number" step="0.01" class="form-control bg-light" id="expenseBalanceAmount" name="balance_amount" readonly>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row mb-3">
                                                                <div class="col-md-5">
                                                                    <label class="form-label">Settlement Status</label>
                                                                </div>
                                                                <div class="col-md-7">
                                                                    <div id="expenseSettlementStatus">
                                                                        <span class="badge badge-soft-secondary">Not Available</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row">
                                                                <div class="col-12">
                                                                    <button type="button" class="btn btn-sm btn-soft-info" id="viewSettlementHistory">
                                                                        <i class="ri-history-line me-1"></i> View Settlement History
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Edit-only fields (hidden by default) -->
                                                    <div class="edit-only-fields d-none">
                                                        <div class="row mb-3">
                                                            <div class="col-md-6">
                                                                <label class="form-label">Created By</label>
                                                                <input type="text" class="form-control" id="expenseCreatedBy" readonly>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Created Date</label>
                                                                <input type="text" class="form-control" id="expenseCreatedDate" readonly>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="modal-footer">
                                                    <div class="hstack gap-2 justify-content-end">
                                                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-success" id="saveExpense">Save Expense</button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Delete Expense Confirmation Modal -->
                                <div class="modal fade flip" id="deleteExpenseModal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-body p-5 text-center">
                                                <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
                                                <div class="mt-4 text-center">
                                                    <h4>Delete Expense</h4>
                                                    <p class="text-muted fs-14 mb-4">Are you sure you want to delete this expense?</p>
                                                    <div class="hstack gap-2 justify-content-center remove">
                                                        <button class="btn btn-link btn-ghost-success fw-medium text-decoration-none" id="deleteExpenseCancel" data-bs-dismiss="modal">
                                                            <i class="ri-close-line me-1 align-middle"></i> Cancel
                                                        </button>
                                                        <button class="btn btn-danger" id="deleteExpense" data-expense-id="">
                                                            Yes, Delete It
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                        <!-- Invoices Tab -->
                        <div class="tab-pane" id="tab-invoices" role="tabpanel">
                            <div class="card shadow-none border">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-between align-items-center mb-4">
                                                <h5 class="card-title mb-0">Shipment Invoices</h5>
                                                <button type="button" class="btn btn-primary" id="createInvoiceBtn">
                                                    <i class="ri-add-line me-1"></i>Create Invoice
                                                </button>
                                                
                                            </div>
                                            
                                            <!-- Filter Controls -->
                                            <div class="row g-3 mb-3">
                                                <div class="col-md-4">
                                                    <div class="search-box">
                                                        <input type="text" class="form-control search" id="invoiceSearch" placeholder="Search invoices...">
                                                        <i class="ri-search-line search-icon"></i>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <select class="form-select" id="invoiceStatusFilter">
                                                        <option value="all">All Statuses</option>
                                                        <option value="0">Pending</option>
                                                        <option value="1">Partially Paid</option>
                                                        <option value="2">Paid</option>
                                                        <option value="3">Cancelled</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-3">
                                                    <input type="text" class="form-control" id="invoiceDateFilter" 
                                                        placeholder="Select date range" data-provider="flatpickr" 
                                                        data-date-format="d M, Y" data-range-date="true">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-primary w-100" id="filterInvoicesBtn">
                                                        <i class="ri-filter-line me-1"></i> Filter
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Invoices List Table -->
                                            <div class="table-responsive">
                                                <table class="table table-bordered table-striped align-middle" id="invoicesTable">
                                                    <thead class="text-muted table-light">
                                                        <tr>
                                                            <th scope="col">Invoice #</th>
                                                            <th scope="col">Date</th>
                                                            <th scope="col">Customer</th>
                                                            <th scope="col">Amount</th>
                                                            <th scope="col">Status</th>
                                                            <th scope="col">Created By</th>
                                                            <th scope="col">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% if invoices and invoices|length > 0 %}
                                                            {% for invoice in invoices %}
                                                            <tr data-id="{{ invoice.id }}"
                                                                data-status="{{ invoice.payment_status }}"
                                                                data-date="{{ invoice.invoice_date }}">
                                                                <td>
                                                                    <span class="fw-medium">{{ invoice.invoice_number }}</span>
                                                                </td>
                                                                <td>{{ invoice.invoice_date }}</td>
                                                                <td>{{ invoice.customer_name }}</td>
                                                                <td class="text-end">
                                                                    <span class="fw-medium">{{ invoice.formatted_total }}</span>
                                                                </td>
                                                                <td>
                                                                    {% if invoice.payment_status == 0 %}
                                                                        <span class="badge badge-soft-warning">Pending</span>
                                                                    {% elif invoice.payment_status == 1 %}
                                                                        <span class="badge badge-soft-info">Partially Paid</span>
                                                                    {% elif invoice.payment_status == 2 %}
                                                                        <span class="badge badge-soft-success">Paid</span>
                                                                    {% elif invoice.payment_status == 3 %}
                                                                        <span class="badge badge-soft-danger">Cancelled</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    <div class="d-flex align-items-center">
                                                                        <!-- <div class="avatar-xs me-2">
                                                                            <div class="avatar-title bg-soft-primary text-primary rounded-circle">
                                                                                {{ invoice.created_by }}
                                                                            </div>
                                                                        </div> -->
                                                                        <div>
                                                                            <span class="d-block">{{ invoice.created_by }}</span>
                                                                            <small class="text-muted">{{ invoice.created_at }}</small>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div class="d-flex gap-2">
                                                                        <button type="button" class="btn btn-sm btn-soft-primary view-invoice" 
                                                                                data-id="{{ invoice.id }}" title="View">
                                                                            <i class="ri-eye-line"></i>
                                                                        </button>
                                                                        {% if invoice.payment_status != 2 and invoice.payment_status != 3 and not invoice.submitted %}
                                                                        <button type="button" class="btn btn-sm btn-soft-info edit-invoice" 
                                                                                data-id="{{ invoice.id }}" title="Edit">
                                                                            <i class="ri-pencil-line"></i>
                                                                        </button>
                                                                        {% endif %}
                                                                        <!-- Payment status button - show for all invoices except cancelled -->
                                                                        {% if invoice.payment_status != 3 %}
                                                                        <button type="button" class="btn btn-sm btn-soft-success update-status" 
                                                                                data-id="{{ invoice.id }}" data-status="{{ invoice.payment_status }}" title="Update Status">
                                                                            <i class="ri-money-dollar-circle-line"></i>
                                                                        </button>
                                                                        {% endif %}
                                                                        {% if invoice.payment_status == 0 and not invoice.submitted %}
                                                                        <button type="button" class="btn btn-sm btn-soft-danger delete-invoice" 
                                                                                data-id="{{ invoice.id }}" title="Delete">
                                                                            <i class="ri-delete-bin-line"></i>
                                                                        </button>
                                                                        {% endif %}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            {% endfor %}
                                                        {% else %}
                                                            <tr>
                                                                <td colspan="7" class="text-center py-4">
                                                                    <div class="text-muted">
                                                                            <i class="ri-bill-line fs-24 mb-2 d-block"></i>
                                                                            <p>No invoices created yet. Create an invoice using the button above.</p>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            
                                            <!-- "No Results" message (initially hidden) -->
                                            <div class="noresult" style="display: none">
                                                <div class="text-center py-4">
                                                    <lord-icon src="https://cdn.lordicon.com/msoeawqm.json" trigger="loop" colors="primary:#121331,secondary:#08a88a" style="width:75px;height:75px"></lord-icon>
                                                    <h5 class="mt-2">Sorry! No Result Found</h5>
                                                    <p class="text-muted mb-0">We couldn't find any invoices matching your search criteria.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                                <!-- Invoice Modal -->
                                <div class="modal fade zoomIn" id="invoiceModal" tabindex="-1" aria-labelledby="invoiceModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered modal-xl">
                                        <div class="modal-content border-0">
                                            <div class="modal-header p-3 bg-soft-info">
                                                <h5 class="modal-title" id="invoiceModalLabel">Create Invoice</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeInvoiceModal"></button>
                                            </div>
                                            <form id="invoiceForm">
                                                <input type="hidden" id="invoiceId" name="invoice_id" value="">
                                                <input type="hidden" id="shipmentIdForInvoice" name="shipment_id" value="{{ entry.id }}">
                                                <input type="hidden" id="shipDocEntryId" name="ship_doc_entry_id" value="{{ entry.id }}">

                                                <div class="modal-body">
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <label for="invoiceNumber" class="form-label">Invoice Number<span class="text-danger">*</span></label>
                                                            <input type="text" class="form-control" id="invoiceNumber" name="invoice_number" readonly>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label for="invoiceDate" class="form-label">Invoice Date<span class="text-danger">*</span></label>
                                                            <input type="date" class="form-control" id="invoiceDate" name="invoice_date" required>
                                                        </div>
                                                    
                                                    </div>
                                                    
                                                    <div class="mb-3">
                                                        <label for="invoiceNarration" class="form-label">Narration</label>
                                                        <textarea class="form-control" id="invoiceNarration" name="narration" rows="2"></textarea>
                                                    </div>
                                                    
                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                        <h5 class="mb-0">Items</h5>
                                                        <div>
                                                            <button type="button" class="btn btn-sm btn-primary mx-1" id="addExpenseBtn">
                                                                <i class="ri-add-line me-1"></i>Add Expense
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-info mx-1" id="addRateCardBtn">
                                                                <i class="ri-price-tag-3-line me-1"></i>Add Rate Card
                                                            </button>
                                                            <button type="button" class="btn btn-sm btn-success mx-1" id="addIncomeBtn">
                                                                <i class="ri-add-line me-1"></i>Add Income
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Invoice Items Table -->
                                                    <div class="table-responsive mb-3">
                                                        <table class="table table-bordered table-sm" id="invoiceItemsTable">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Expense Type</th>
                                                                    <th>Description</th>
                                                                    <th>Expense</th>
                                                                    <th>Margin</th>
                                                                    <th>Chargeable</th>
                                                                    <th>Available Balance</th>
                                                                    <th>Charged Amount</th>
                                                                    <th>Actions</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr id="noItemsRow">
                                                                    <td colspan="7" class="text-center">No items added yet</td>
                                                                </tr>
                                                            </tbody>
                                                            <tfoot>
                                                                <tr>
                                                                    <td colspan="6" class="text-end fw-bold">Total:</td>
                                                                    <td id="invoiceTotal" class="fw-bold text-end">LKR 0.00</td>
                                                                    <td></td>
                                                                </tr>
                                                            </tfoot>
                                                        </table>
                                                    </div>
                                                    
                                                    <!-- Edit Only Fields -->
                                                    <div class="edit-only-fields d-none">
                                                        <div class="row mb-3">
                                                            <div class="col-md-6">
                                                                <label class="form-label">Created By</label>
                                                                <input type="text" class="form-control" id="invoiceCreatedBy" readonly>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Created Date</label>
                                                                <input type="text" class="form-control" id="invoiceCreatedDate" readonly>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="modal-footer">
                                                    <div class="hstack gap-2 justify-content-end">
                                                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-success" id="saveInvoice">Create Invoice</button>
                                                        <!-- UPDATED: Submit button for edit mode with conditional state -->
                                                        <button type="button" 
                                                                class="btn {% if invoice and invoice.submitted %}btn-secondary{% else %}btn-primary{% endif %}" 
                                                                id="submitInvoiceEditBtn" 
                                                                data-invoice-id="" 
                                                                style="display: none;"
                                                                {% if invoice and invoice.submitted %}disabled{% endif %}>
                                                            {% if invoice and invoice.submitted %}
                                                                <i class="ri-check-double-line me-1"></i> Submitted
                                                            {% else %}
                                                                <i class="ri-check-line me-1"></i> Submit Invoice
                                                            {% endif %}
                                                        </button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <!-- Enhanced Expense Selection Modal with VAT -->
                                <div class="modal fade" id="expenseSelectionModal" tabindex="-1" aria-labelledby="expenseSelectionModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="expenseSelectionModalLabel">Select Expense</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <select class="form-select" id="expenseSelector">
                                                        <option value="">Select an expense</option>
                                                        <!-- Options will be loaded via JavaScript -->
                                                    </select>
                                                </div>
                                                
                                                <div id="expenseDetails" class="d-none">
                                                    <div class="card border">
                                                        <div class="card-body">
                                                            <div class="row mb-2">
                                                                <div class="col-md-6">
                                                                    <strong>Expense Type:</strong>
                                                                    <span id="expenseTypeDisplay"></span>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <strong>Original Amount:</strong>
                                                                    <span id="expenseAmountDisplay"></span>
                                                                </div>
                                                            </div>
                                                            <div class="row mb-2">
                                                                <div class="col-md-6">
                                                                    <strong>Margin:</strong>
                                                                    <span id="expenseMarginDisplay"></span>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <strong>Chargeable Amount:</strong>
                                                                    <span id="expenseChargeableDisplay"></span>
                                                                </div>
                                                            </div>
                                                            <div class="row mb-3">
                                                                <div class="col-md-6">
                                                                    <strong>Already Charged:</strong>
                                                                    <span id="expenseChargedDisplay">LKR 0.00</span>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <strong>Available Balance:</strong>
                                                                    <span id="expenseBalanceDisplay" class="fw-bold text-success">LKR 0.00</span>
                                                                </div>
                                                            </div>
                                                            <div class="mb-3">
                                                                <strong>Description:</strong>
                                                                <p id="expenseNarrationDisplay" class="mb-0"></p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Enhanced VAT Calculation Section -->
                                                    <div class="card border mt-3">
                                                        <div class="card-body">
                                                            <h6 class="card-title mb-3">Invoice Amount Calculation</h6>
                                                            
                                                            <div class="row mb-3">
                                                                <div class="col-md-12">
                                                                    <label class="form-label">Amount to Charge <small class="text-muted">(Max: <span id="maxAvailableAmount">LKR 0.00</span>)</small></label>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">LKR</span>
                                                                        <input type="number" class="form-control charged-amount-input" id="finalAmount" step="0.01" max="0" placeholder="0.00">
                                                                    </div>
                                                                    <div class="invalid-feedback">Amount exceeds available balance</div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row mb-3">
                                                                <div class="col-md-6">
                                                                    <label class="form-label">VAT Percentage</label>
                                                                    <div class="input-group">
                                                                        <input type="number" class="form-control vat-percentage-input" step="0.01" min="0" max="100" placeholder="0.00" value="0">
                                                                        <span class="input-group-text">%</span>
                                                                    </div>
                                                                </div>
                                                                <div class="col-md-6">
                                                                    <label class="form-label">VAT Amount</label>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">LKR</span>
                                                                        <input type="number" class="form-control vat-amount-input" step="0.01" min="0" placeholder="0.00" value="0">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="row">
                                                                <div class="col-md-12">
                                                                    <label class="form-label"><strong>Final Invoice Amount</strong></label>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">LKR</span>
                                                                        <input type="number" class="form-control final-amount-with-vat" step="0.01" readonly style="background-color: #e9ecef; font-weight: bold;" value="0.00">
                                                                    </div>
                                                                    <small class="text-muted">Amount to Charge + VAT = Final Invoice Amount</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="button" class="btn btn-primary" id="addSelectedExpense">Add to Invoice</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <!-- Rate Card Selection Modal - Minimal Version -->
                                <div class="modal fade" id="rateCardSelectionModal" tabindex="-1" aria-labelledby="rateCardSelectionModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="rateCardSelectionModalLabel">Select Rate Card Item</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <!-- Rate Card Selector -->
                                        <div class="mb-3">
                                        <select class="form-select" id="rateCardSelector">
                                            <option value="">Select a rate card item</option>
                                        </select>
                                        </div>
                                        
                                        <!-- Rate Card Details (Hidden by Default) -->
                                        <div id="rateCardDetails" class="d-none">
                                        <div class="card">
                                            <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                <label class="form-label fw-medium">Item</label>
                                                <div id="rateCardTypeDisplay" class="fs-6"></div>
                                                </div>
                                                <div class="col-md-6">
                                                <label class="form-label fw-medium">Rate Amount</label>
                                                <div id="rateCardAmountDisplay" class="fs-6"></div>
                                                </div>
                                            </div>
                                            <div>
                                                <label for="rateCardDescription" class="form-label">Description (Optional)</label>
                                                <input type="text" class="form-control" id="rateCardDescription" placeholder="Enter description">
                                            </div>
                                            </div>
                                        </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <button type="button" class="btn btn-primary" id="addSelectedRateCard">Add to Invoice</button>
                                    </div>
                                    </div>
                                </div>
                                </div>


                                <!-- Income Modal -->
                                <div class="modal fade" id="incomeModal" tabindex="-1" aria-labelledby="incomeModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="incomeModalLabel">Add Income Item</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="mb-3">
                                                    <label for="incomeDescription" class="form-label">Description</label>
                                                    <input type="text" class="form-control" id="incomeDescription" placeholder="Enter income description">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="incomeAmount" class="form-label">Amount</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">LKR</span>
                                                        <input type="number" class="form-control" id="incomeAmount" min="0.01" step="0.01" placeholder="Enter amount">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="button" class="btn btn-primary" id="addIncomeBtn">Add to Invoice</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Invoice Status Modal -->
                                <div class="modal fade" id="invoiceStatusModal" tabindex="-1" aria-labelledby="invoiceStatusModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered modal-sm">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="invoiceStatusModalLabel">Update Invoice Status</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <input type="hidden" id="statusInvoiceId">
                                                <div class="mb-3">
                                                    <label for="invoicePaymentStatus" class="form-label">Payment Status</label>
                                                    <select class="form-select" id="invoicePaymentStatus">
                                                        <option value="0">Pending</option>
                                                        <option value="1">Partially Paid</option>
                                                        <option value="2">Paid</option>
                                                        <option value="3">Cancelled</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                <button type="button" class="btn btn-success" id="updateInvoiceStatus">Update Status</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Delete Invoice Confirmation Modal -->
                                <div class="modal fade flip" id="deleteInvoiceModal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-body p-5 text-center">
                                                <lord-icon src="https://cdn.lordicon.com/gsqxdxog.json" trigger="loop" colors="primary:#405189,secondary:#f06548" style="width:90px;height:90px"></lord-icon>
                                                <div class="mt-4 text-center">
                                                    <h4>Delete Invoice</h4>
                                                    <p class="text-muted fs-14 mb-4">Are you sure you want to delete this invoice?</p>
                                                    <div class="hstack gap-2 justify-content-center remove">
                                                        <button class="btn btn-link btn-ghost-success fw-medium text-decoration-none" id="deleteInvoiceCancel" data-bs-dismiss="modal">
                                                            <i class="ri-close-line me-1 align-middle"></i> Cancel
                                                        </button>
                                                        <button class="btn btn-danger" id="deleteInvoice" data-invoice-id="">
                                                            Yes, Delete It
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- View Invoice Modal -->
                                <div class="modal fade" id="viewInvoiceModal" tabindex="-1" aria-labelledby="viewInvoiceModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-xl modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="viewInvoiceModalLabel">Invoice Details</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row mb-4">
                                                    <div class="col-md-6">
                                                        <div class="card bg-light">
                                                            <div class="card-body">
                                                                <h6 class="card-title">Invoice Information</h6>
                                                                <table class="table table-sm table-borderless mb-0">
                                                                    <tbody>
                                                                        <tr>
                                                                            <td class="fw-medium">Invoice Number:</td>
                                                                            <td id="viewInvoiceNumber"></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td class="fw-medium">Date:</td>
                                                                            <td id="viewInvoiceDate"></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td class="fw-medium">Status:</td>
                                                                            <td id="viewInvoiceStatus"></td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="card bg-light">
                                                            <div class="card-body">
                                                                <h6 class="card-title">Customer Information</h6>
                                                                <table class="table table-sm table-borderless mb-0">
                                                                    <tbody>
                                                                        <tr>
                                                                            <td class="fw-medium">Customer:</td>
                                                                            <td id="viewInvoiceCustomer"></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td class="fw-medium">Narration:</td>
                                                                            <td id="viewInvoiceNarration"></td>
                                                                        </tr>
                                                                        <tr>
                                                                            <td class="fw-medium">Created By:</td>
                                                                            <td id="viewInvoiceCreatedBy"></td>
                                                                        </tr>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="table-responsive">
                                                    <table class="table table-bordered" id="viewInvoiceItems">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>Expense Type</th>
                                                                <th>Description</th>
                                                                <th>Original Amount</th>
                                                                <th>Margin</th>
                                                                <th>Chargeable</th>
                                                                <th>Invoice Amount</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <!-- Items will be loaded via JavaScript -->
                                                        </tbody>
                                                        <tfoot>
                                                            <tr>
                                                                <td colspan="5" class="text-end fw-bold">Total:</td>
                                                                <td id="viewInvoiceTotal" class="fw-bold text-end"></td>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                <button type="button" class="btn btn-primary" id="printInvoiceBtn">
                                                    <i class="ri-printer-line me-1"></i> Print
                                                </button>
                                                <!-- Submit button - only show if not submitted -->
                                                <button type="button" 
                                                        class="btn btn-success" 
                                                        id="submitInvoiceBtn" 
                                                        data-invoice-id=""
                                                        style="display: none;">
                                                    <i class="ri-check-line me-1"></i> Submit Invoice
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- container-fluid -->
    </div>


    <div class="modal fade" id="settlementHistoryModal" tabindex="-1" aria-labelledby="settlementHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settlementHistoryModalLabel">Settlement History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Settlement Summary -->
                    <div class="card shadow-none border mb-3">
                        <div class="card-body">
                            <h6 class="card-title mb-3">Settlement Progress</h6>
                            
                            <div class="progress mb-4" style="height: 24px;">
                                <div id="settlementProgressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label fw-medium">Total Chargeable</label>
                                        <div id="totalChargeable" class="fs-5">LKR 0.00</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label fw-medium">Total Charged</label>
                                        <div id="totalCharged" class="fs-5">LKR 0.00</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label fw-medium">Balance Remaining</label>
                                        <div id="balanceRemaining" class="fs-5">LKR 0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Settlement History Table -->
                    <h6 class="mb-3">Settlement Records</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped" id="settlementHistoryTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Date</th>
                                    <th class="text-end">Amount Charged</th>
                                    <th>Created By</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Settlement records will be loaded dynamically -->
                                <tr>
                                    <td colspan="4" class="text-center">Loading settlement records...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>




    <!-- End Page-content -->

    {% block footer %}
    {% include "partials/footer.html" %}
    {% endblock footer %}
</div>

    <!-- Demurrage Modal -->
    <div class="modal fade" id="demurrageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="demurrageModalTitle">Add Demurrage</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="demurrageForm">
                    <div class="modal-body">
                        <input type="hidden" id="demurrageId" name="demurrage_id">
                        <input type="hidden" id="shipmentId" name="shipment_id" value="{{ entry.id }}">
                        
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs nav-tabs-custom" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#demurrage-details" role="tab" aria-selected="true">
                                    <i class="ri-file-list-line me-1"></i>Details
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#demurrage-attachments" role="tab" aria-selected="false">
                                    <i class="ri-attachment-line me-1"></i>Attachments
                                </a>
                            </li>
                        </ul>
                        
                        <!-- Tab Content -->
                        <div class="tab-content pt-3">
                            <!-- Details Tab -->
                            <div class="tab-pane active show" id="demurrage-details" role="tabpanel">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label for="containerId" class="form-label">Container <span class="text-danger">*</span></label>
                                            <select class="form-select" id="containerId" name="container_id" required>
                                                <option value="">Select Container</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="demurrageDate" class="form-label">Date <span class="text-danger">*</span></label>
                                            <input type="date" class="form-control" id="demurrageDate" name="demurrage_date" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="reasonId" class="form-label">Reason <span class="text-danger">*</span></label>
                                            <select class="form-select" id="reasonId" name="reason_id" required>
                                                <option value="">Select Reason</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Replace the existing amount field in demurrage modal -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="currencyId" class="form-label">Currency <span class="text-danger">*</span></label>
                                            <select class="form-select" id="currencyId" name="currency_id" required>
                                                <option value="">Select Currency</option>
                                                {% for currency in currencies %}
                                                <option value="{{ currency.currencyID }}">{{ currency.CurrencyCode }} - {{ currency.CurrencyName }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="demurrageAmount" class="form-label">
                                                Demurrage Amount <span class="text-danger">*</span>
                                                <button type="button" class="btn btn-sm btn-outline-info ms-2" id="calculateRateBtn">
                                                    <i class="ri-calculator-line"></i> Calculate
                                                </button>
                                            </label>
                                            <input type="number" class="form-control" id="demurrageAmount" name="amount" 
                                                step="0.01" min="0" required>
                                            
                                            <!-- Calculation Details Panel -->
                                            <div id="calculationDetails" class="mt-2" style="display: none;">
                                                <div class="card border-info">
                                                    <div class="card-body p-2">
                                                        <h6 class="card-title text-info mb-2">
                                                            <i class="ri-information-line"></i> Calculation Details
                                                        </h6>
                                                        <div id="calculationBreakdown"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="form-check mt-2">
                                                <input class="form-check-input" type="checkbox" id="manualOverride">
                                                <label class="form-check-label" for="manualOverride">
                                                    Manual override (disable auto-calculation)
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Bearing Percentage</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" min="0" max="100" class="form-control" 
                                                id="bearingPercentage" name="bearing_percentage" 
                                                placeholder="Enter percentage">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Bearer</label>
                                        <div class="input-group">
                                            <select class="form-select" id="bearerId" name="bearer_id">
                                                <option value="">Select Bearer</option>
                                                <!-- Options will be populated dynamically -->
                                            </select>
                                          
                                        </div>
                                    </div>
                                </div>


                            </div>
                            
                            <!-- Attachments Tab -->
                            <div class="tab-pane" id="demurrage-attachments" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">Attachments</h6>
                                            <button type="button" class="btn btn-sm btn-primary" id="addAttachmentBtn">
                                                <i class="ri-add-line me-1"></i>Add Attachment
                                            </button>
                                        </div>
                                        
                                        <!-- Attachment Form -->
                                        <div class="card border" id="attachmentForm" style="display: none;">
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="attachmentFile" class="form-label">File <span class="text-danger">*</span></label>
                                                            <input type="file" class="form-control" id="attachmentFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xls,.xlsx">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mb-3">
                                                            <label for="attachmentDate" class="form-label">Date</label>
                                                            <input type="date" class="form-control" id="attachmentDate">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-12">
                                                        <div class="mb-3">
                                                            <label for="attachmentComment" class="form-label">Comment</label>
                                                            <textarea class="form-control" id="attachmentComment" rows="3" placeholder="Enter comment..."></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-end gap-2">
                                                    <button type="button" class="btn btn-secondary btn-sm" id="cancelAttachmentBtn">Cancel</button>
                                                    <button type="button" class="btn btn-primary btn-sm" id="saveAttachmentBtn">Save Attachment</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Attachments List -->
                                        <div id="attachmentsList">
                                            <div class="table-responsive">
                                                <table class="table table-sm table-bordered" id="attachmentsTable">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>File Name</th>
                                                            <th>Date</th>
                                                            <th>Comment</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <!-- Attachments will be loaded here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveDemurrageBtn">
                            <i class="ri-save-line me-1"></i>Save Demurrage
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


{% endblock content %}

{% block extra_js %}
<script>
    // Make server-side data available to JavaScript
    window.containersWithWorkflows = {{ containers_with_workflows | tojson | safe }};
    window.currentEntryId = {{ entry.id }};
    
    // Debug: Log the data to console
    console.log('Containers with workflows data:', window.containersWithWorkflows);
    console.log('Current entry ID:', window.currentEntryId);
</script>


<script>
    window.currentEntryId = "{{ entry.id }}";
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-hide flash messages after 5 seconds
        const flashMessage = document.getElementById('flash-message');
        if (flashMessage) {
            setTimeout(() => {
                const closeBtn = flashMessage.querySelector('.btn-close');
                if (closeBtn) closeBtn.click();
            }, 5000);
        }
        
        // Toggle onhold_reason field based on onhold_yn checkbox
        const onholdCheckbox = document.getElementById('onhold_yn');
        const onholdReasonContainer = document.getElementById('onhold_reason_container');
        const onholdReasonField = document.getElementById('onhold_reason');
        
        function updateOnholdReason() {
            if (onholdCheckbox.checked) {
                onholdReasonContainer.style.display = 'block';
                onholdReasonField.setAttribute('required', 'required');
            } else {
                onholdReasonContainer.style.display = 'none';
                onholdReasonField.removeAttribute('required');
                onholdReasonField.value = ''; // Reset text area when unchecked
            }
        }
        
        if (onholdCheckbox && onholdReasonContainer) {
            updateOnholdReason(); // Initial state
            onholdCheckbox.addEventListener('change', updateOnholdReason);
        }
        
        // Make prefilled fields from order appear as read-only
        const customerSelect = document.getElementById('customer_id');
        if (customerSelect && customerSelect.hasAttribute('readonly')) {
            customerSelect.classList.add('bg-light');
            customerSelect.addEventListener('mousedown', function(event) {
                event.preventDefault();
                return false;
            });
        }
        
        // Additional read-only handling for other pre-filled fields
        const readOnlyFields = document.querySelectorAll('input[readonly], select[readonly]');
        readOnlyFields.forEach(field => {
            field.classList.add('bg-light');
            if (field.tagName === 'SELECT') {
                field.addEventListener('mousedown', function(event) {
                    event.preventDefault();
                    return false;
                });
            }
        });


        (function ensureActiveTab() {
            // Get all tab links and content panes
            const tabLinks = document.querySelectorAll('.nav-tabs .nav-link');
            const tabPanes = document.querySelectorAll('.tab-content .tab-pane');
            
            // Check if any tab is active
            const hasActiveTab = Array.from(tabLinks).some(link => link.classList.contains('active'));
            
            // If no tab is active, make the first tab active
            if (!hasActiveTab && tabLinks.length > 0 && tabPanes.length > 0) {
            // First clear any active classes that might exist
            tabLinks.forEach(link => link.classList.remove('active'));
            tabPanes.forEach(pane => pane.classList.remove('active'));
            
            // Now set the first tab and its content as active
            tabLinks[0].classList.add('active');
            tabLinks[0].setAttribute('aria-selected', 'true');
            tabPanes[0].classList.add('active');
            
            // Also save this to localStorage if you're using it
            localStorage.setItem('activeShipmentTab', tabLinks[0].getAttribute('href'));
            }
        })();

        // Handle tab navigation
        const tabLinks = document.querySelectorAll('.nav-tabs .nav-link');
        const tabContents = document.querySelectorAll('.tab-pane');
        
        // Save active tab to localStorage
        function saveActiveTab(tabId) {
            localStorage.setItem('activeShipmentTab', tabId);
        }
        
        // Restore active tab from localStorage
        const activeTab = localStorage.getItem('activeShipmentTab');
        let tabActivated = false;

        if (activeTab) {
            const tabToActivate = document.querySelector(`[href="${activeTab}"]`);
            if (tabToActivate) {
                // Remove active class from all tabs and content
                tabLinks.forEach(link => {
                    link.classList.remove('active');
                    link.setAttribute('aria-selected', 'false');
                });
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Add active class to selected tab and content
                tabToActivate.classList.add('active');
                tabToActivate.setAttribute('aria-selected', 'true');
                document.querySelector(activeTab).classList.add('active');
                tabActivated = true;
            }
        }

        if (!tabActivated && tabLinks.length > 0 && tabContents.length > 0) {
            tabLinks[0].classList.add('active');
            tabLinks[0].setAttribute('aria-selected', 'true');
            tabContents[0].classList.add('active');
            saveActiveTab(tabLinks[0].getAttribute('href'));
        }
        
        // Add click event listeners to tabs
        tabLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                // Set aria-selected for all tabs
                tabLinks.forEach(l => l.setAttribute('aria-selected', 'false'));
                this.setAttribute('aria-selected', 'true');
                
                saveActiveTab(this.getAttribute('href'));
            });
        });
    });
</script>

<!-- Sea Import Container Script -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
    // ===== IMPORT CONTAINER HANDLING =====
    
    // Function to update container counts for Import
    function updateImportContainerCounts() {
        const sizeSelects = document.querySelectorAll('#importContainerRows .container-size');
        let count20ft = 0;
        let count40ft = 0;
        
        sizeSelects.forEach(select => {
            if (select.value === '1') {
                count20ft += 1;
            } else if (select.value === '2') {
                count40ft += 1;
            }
        });
        
        // Update the count displays
        const importCount20ft = document.getElementById('importCount20ft');
        const importCount40ft = document.getElementById('importCount40ft');
        
        if (importCount20ft) importCount20ft.value = count20ft;
        if (importCount40ft) importCount40ft.value = count40ft;
    }
    
    // Add new container row for Import
    const addImportContainerRowBtn = document.getElementById('addImportContainerRow');
    if (addImportContainerRowBtn) {
        addImportContainerRowBtn.addEventListener('click', function() {
            const containerRows = document.getElementById('importContainerRows');
            const newRow = containerRows.querySelector('.container-row').cloneNode(true);
            
            // Clear input values
            newRow.querySelectorAll('input').forEach(input => {
                input.value = '';
            });
            
            // Reset selects
            newRow.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Add event listeners to the new row
            addContainerRowEventListeners(newRow);
            
            // Append the new row
            containerRows.appendChild(newRow);
        });
    }
    
    // Add event listeners to container row
    function addContainerRowEventListeners(row) {
        // Add remove button event listener
        const removeBtn = row.querySelector('.remove-container');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                row.remove();
                // Update counts after removal
                updateImportContainerCounts();
            });
        }
        
        // Add container size change event listener
        const sizeSelect = row.querySelector('.container-size');
        if (sizeSelect) {
            sizeSelect.addEventListener('change', function() {
                // Update counts when size changes
                updateImportContainerCounts();
            });
        }
    }
    
    // Initialize event listeners for existing rows
    document.querySelectorAll('#importContainerRows .container-row').forEach(row => {
        addContainerRowEventListeners(row);
    });
    
    // Initial count update
    updateImportContainerCounts();
});
</script>

<!-- Actions Tab -->

<!-- list.js min js -->
<script src="{{url_for('static' ,filename='libs/list.js/dist/list.min.js')}}"></script>

<!--list pagination js-->
<script src="{{url_for('static' ,filename='libs/list.pagination.js/dist/list.pagination.min.js')}}"></script>

<!-- Sweet Alerts js -->
<script src="{{url_for('static' ,filename='libs/sweetalert2/dist/sweetalert2.min.js')}}"></script>

<!-- titcket init js -->
<script src="{{url_for('static' ,filename='js/pages/tasks-list.init.js')}}"></script>

<script>
    // This script enhances the edit task functionality in the tasks list view
// while preserving all other existing functionality

document.addEventListener('DOMContentLoaded', function() {
    const createTaskForm = document.getElementById('createTaskForm');
    const projectSelect = document.getElementById('projects');
    
    if (createTaskForm) {
        createTaskForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            console.log("Form submission started");
            
            try {
                // Validate each element exists before trying to access its value
                const elements = {
                    'projects': document.getElementById('projects'),
                    'taskTitle': document.getElementById('taskTitle'),
                    'taskDescription': document.getElementById('taskDescription'),
                    'taskCategory': document.getElementById('taskCategory'),
                    'taskAssignee': document.getElementById('taskAssignee'),
                    'taskStatus': document.getElementById('taskStatus'),
                    'taskPriority': document.getElementById('taskPriority'),
                    'taskDueDate': document.getElementById('taskDueDate'),
                    'taskAttachments': document.getElementById('taskAttachments')
                };
                
                // Check which elements are null
                const missingElements = [];
                for (const [key, element] of Object.entries(elements)) {
                    if (element === null) {
                        missingElements.push(key);
                        console.error(`Missing element: ${key}`);
                    }
                }
                
                if (missingElements.length > 0) {
                    console.error(`The following elements are missing: ${missingElements.join(', ')}`);
                    alert(`Cannot submit the form. Missing elements: ${missingElements.join(', ')}`);
                    return;
                }
                
                // Get the selected project ID
                const projectId = elements.projects.value;
                if (!projectId) {
                    alert('Please select a project');
                    return;
                }
                
                console.log("Creating FormData with project ID:", projectId);
                
                // Create FormData
                const formData = new FormData();
                
                // Add form fields
                formData.append('title', elements.taskTitle.value);
                formData.append('description', elements.taskDescription.value);
                formData.append('category_id', elements.taskCategory.value);
                formData.append('assignee_id', elements.taskAssignee.value);
                formData.append('status_id', elements.taskStatus.value);
                formData.append('priority_id', elements.taskPriority.value);
                formData.append('due_date', elements.taskDueDate.value);
                
                // Get the order_id if it exists and has value
                if (window.currentEntryId) {
                    console.log("Using entry ID:", window.currentEntryId);
                    formData.append('order_id', window.currentEntryId);
                } else {
                    console.warn("No entry ID found in global scope");
                    // Try to find a hidden input as a fallback
                    const orderIdInput = document.querySelector('input[name="order_id"]');
                    if (orderIdInput && orderIdInput.value) {
                        console.log("Using order_id from hidden input:", orderIdInput.value);
                        formData.append('order_id', orderIdInput.value);
                    }
                }
                
                // Add file attachments
                const attachments = elements.taskAttachments.files;
                for (let i = 0; i < attachments.length; i++) {
                    formData.append('attachments', attachments[i]);
                }
                
                // Show loading state on button
                const submitButton = document.getElementById('createTaskBtn');
                const originalButtonText = submitButton ? submitButton.textContent : 'Create Task';
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';
                }
                
                console.log("Submitting form to:", `/tasks/api/projects/${projectId}/create-task`);
                
                // Submit to the correct URL with the selected project ID
                const response = await fetch(`/tasks/api/projects/${projectId}/create-task`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                console.log("Server response:", result);
                
                if (result.success) {
                    // Show success message and close modal
                    Swal.fire({
                        title: 'Success',
                        text: 'Task created successfully',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.reload();
                    });
                } else {
                    throw new Error(result.error || 'Failed to create task');
                }
            } catch (error) {
                console.error('Error creating task:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to create task',
                    icon: 'error'
                });
                
                // Reset button state
                const submitButton = document.getElementById('createTaskBtn');
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Create Task';
                }
            }
        });
    } else {
        console.error('Form with ID "createTaskForm" not found!');
    }

    // Add event listener for project selection
    if (projectSelect) {
        projectSelect.addEventListener('change', function() {
            const selectedProjectId = this.value;
            if (selectedProjectId) {
                updateProjectFormData(selectedProjectId);
                
                // Load project settings if in edit mode
                const form = document.getElementById('createTaskForm');
                if (form && form.dataset.mode === 'edit') {
                    loadProjectSettings(selectedProjectId);
                }
            }
        });
    }

    // Trigger data loading when a project is selected
    if (projectSelect) {
        projectSelect.addEventListener('change', function() {
            const selectedProjectId = this.value;
            if (selectedProjectId) {
                // This function needs to fetch the project data and populate the dropdowns
                updateProjectFormData(selectedProjectId);
            }
        });
        
        // Also load data for the first project when the modal opens
        document.querySelector('.add-btn')?.addEventListener('click', function() {
            const initialProjectId = projectSelect.value;
            if (initialProjectId) {
                setTimeout(() => updateProjectFormData(initialProjectId), 300);
            }
        });
    }

    // Add event listener for category selection
    const categorySelect = document.getElementById('taskCategory');
    if (categorySelect) {
        categorySelect.addEventListener('change', function() {
            const selectedCategoryId = this.value;
            if (selectedCategoryId) {
                handleCategorySelection(selectedCategoryId);
            }
        });
    }

    // Reset form when modal is closed
    const closeButtons = document.querySelectorAll('[data-bs-dismiss="modal"]');
    closeButtons.forEach(button => {
        button.addEventListener('click', resetTaskForm);
    });

    // Also reset when modal is hidden
    const modal = document.getElementById('showModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', resetTaskForm);
    }

    // Initialize attachment handling
    const taskAttachments = document.getElementById('taskAttachments');
    if (taskAttachments) {
        taskAttachments.addEventListener('change', handleFileSelect);
    }

    // Format tasks for review
    formatTasksListForReview();
});



function formatTasksListForReview() {
    // Find all tasks in the list
    const taskRows = document.querySelectorAll('.task-row');
    
    taskRows.forEach(row => {
        const isDone = row.getAttribute('data-is-done') === '1';
        const isReviewed = row.getAttribute('data-is-reviewed') === '1';
        
        if (isDone && !isReviewed) {
            // Highlight tasks that need review
            row.classList.add('needs-review');
            
            // Add a badge
            const statusCell = row.querySelector('.task-status');
            if (statusCell) {
                const reviewBadge = document.createElement('span');
                reviewBadge.className = 'badge bg-warning ms-2';
                reviewBadge.textContent = 'Needs Review';
                statusCell.appendChild(reviewBadge);
            }
        } else if (isDone && isReviewed) {
            // Add reviewed badge
            const statusCell = row.querySelector('.task-status');
            if (statusCell) {
                const reviewedBadge = document.createElement('span');
                reviewedBadge.className = 'badge bg-success ms-2';
                reviewedBadge.textContent = 'Reviewed';
                statusCell.appendChild(reviewedBadge);
            }
        }
    });
}


// Enhanced helper functions for status and priority colors
function getStatusColor(status) {
    const colors = {
        'New': 'info',
        'In Progress': 'warning',
        'Completed': 'success',
        'Pending': 'danger'
    };
    return colors[status] || 'secondary';
}

function getPriorityColor(priority) {
    const colors = {
        'High': 'danger',
        'Medium': 'warning',
        'Low': 'success'
    };
    return colors[priority] || 'secondary';
}

// Function to create new task
function createTask(event) {
    event.preventDefault();
    const form = document.getElementById('createTaskForm');
    const formData = new FormData(form);
    
    const data = {
        title: formData.get('tasksTitle-field'),
        description: formData.get('description'),
        priority: formData.get('priority-field'),
        status: formData.get('ticket-status'),
        due_date: formData.get('duedate-field'),
        assigned_to: formData.get('assignedTo[]')
    };

    fetch('/tasks/api/tasks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if(data.task_id) {
            // Close modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('showModal'));
            modal.hide();
            
            // Reload tasks
            loadTasks();
            
            // Show success message
            Swal.fire({
                title: 'Success!',
                text: 'Task created successfully',
                icon: 'success',
                confirmButtonClass: 'btn btn-primary w-xs mt-2',
                buttonsStyling: false
            });
        }
    })
    .catch(error => console.error('Error:', error));
}

// Function to delete task
function deleteTask(taskId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonClass: 'btn btn-primary w-xs me-2 mt-2',
        cancelButtonClass: 'btn btn-danger w-xs mt-2',
        confirmButtonText: 'Yes, delete it!',
        buttonsStyling: false,
        showCloseButton: true
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/tasks/api/tasks/${taskId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    // If server returns an error, throw it to be caught
                    return response.json().then(data => {
                        throw new Error(data.error || 'Unknown error occurred');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Instead of calling loadTasks(), reload the page
                Swal.fire({
                    title: 'Deleted!',
                    text: 'Task has been deleted.',
                    icon: 'success',
                    confirmButtonClass: 'btn btn-primary w-xs mt-2',
                    buttonsStyling: false
                }).then(() => {
                    // Reload page after confirmation
                    window.location.reload();
                });
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: `Failed to delete task: ${error.message}`,
                    icon: 'error',
                    confirmButtonClass: 'btn btn-primary w-xs mt-2',
                    buttonsStyling: false
                });
            });
        }
    });
}

// Enhanced edit task function
window.editTask = async function(taskId) {
    try {
        // Show loading state
        const modalTitle = document.querySelector('#showModal .modal-title');
        const submitButton = document.getElementById('createTaskBtn');
        
        if (modalTitle) modalTitle.textContent = 'Loading Task...';
        if (submitButton) {
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';
        }
        
        // Set the form in edit mode
        const form = document.getElementById('createTaskForm');
        form.dataset.mode = 'edit';
        form.dataset.taskId = taskId;
        
        // Show the modal first
        const modal = new bootstrap.Modal(document.getElementById('showModal'));
        modal.show();
        
        // Fetch task data
        const response = await fetch(`/tasks/api/tasks/${taskId}`);
        if (!response.ok) {
            throw new Error(`Failed to fetch task: ${response.status}`);
        }
        
        const task = await response.json();
        console.log("Task data for editing:", task);
        
        // Update modal UI
        if (modalTitle) modalTitle.textContent = 'Edit Task';
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Update Task';
        }
        
        // Get project ID and load project data first
        if (task.project && task.project.id) {
            const projectSelect = document.getElementById('projects');
            if (projectSelect) {
                projectSelect.value = task.project.id;
                
                // Now load project data
                try {
                    await updateProjectFormData(task.project.id);
                    // Also load project settings
                    await loadProjectSettings(task.project.id);
                    
                    // After project data is loaded, populate all form fields
                    populateFormFields(task);
                } catch (error) {
                    console.error("Error updating project data:", error);
                    // Continue with populating basic fields even if project data loading fails
                    populateFormFields(task);
                }
            } else {
                // If no project select, just populate the fields directly
                populateFormFields(task);
            }
        } else {
            // No project data, populate what we can
            populateFormFields(task);
        }
    } catch (error) {
        console.error('Error in editTask:', error);
        Swal.fire({
            title: 'Error',
            text: 'Failed to load task data: ' + error.message,
            icon: 'error'
        });
        
        // Reset form and close modal on error
        resetTaskForm();
        const modal = bootstrap.Modal.getInstance(document.getElementById('showModal'));
        if (modal) {
            modal.hide();
            // After modal is hidden, ensure backdrop is removed
            document.querySelector('.modal-backdrop')?.remove();
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
        }
    }
};

// Function to populate form fields
function populateFormFields(task) {
    console.log("Populating form fields with:", task);
    
    // Basic fields that don't depend on drop-downs
    const titleField = document.getElementById('taskTitle');
    const descriptionField = document.getElementById('taskDescription');
    
    if (titleField) titleField.value = task.title || '';
    if (descriptionField) descriptionField.value = task.description || '';
    
    // Fields that depend on drop-downs being populated
    const categorySelect = document.getElementById('taskCategory');
    const statusSelect = document.getElementById('taskStatus');
    const prioritySelect = document.getElementById('taskPriority');
    const assigneeSelect = document.getElementById('taskAssignee');
    const dueDateField = document.getElementById('taskDueDate');
    
    if (categorySelect && task.category_id) {
        categorySelect.value = task.category_id;
    }
    
    if (statusSelect && task.status_id) {
        statusSelect.value = task.status_id;
    }
    
    if (prioritySelect && task.priority_id) {
        prioritySelect.value = task.priority_id;
    }
    
    if (assigneeSelect && task.assignee_id) {
        assigneeSelect.value = task.assignee_id;
    }
    
    // Handle due date
    if (dueDateField && task.due_date) {
        try {
            const dueDateObj = new Date(task.due_date);
            const formattedDate = dueDateObj.toISOString().split('T')[0]; // Format as YYYY-MM-DD
            dueDateField.value = formattedDate;
        } catch (error) {
            console.error("Error formatting due date:", error);
        }
    }
    
    // Setup due date field based on project settings
    setupTaskDueDateField(task);
    
    // Handle attachments if any
    const attachmentList = document.getElementById('attachmentList');
    if (attachmentList) {
        attachmentList.innerHTML = '';
        
        if (task.attachments && task.attachments.length > 0) {
            task.attachments.forEach(attachment => {
                const fileIcon = getFileIcon(attachment.file_name);
                
                attachmentList.innerHTML += `
                    <div class="d-flex align-items-center mt-2 border rounded p-2">
                        <i class="${fileIcon} fs-20 me-2"></i>
                        <div class="flex-grow-1">
                            <div class="fw-medium">${attachment.file_name}</div>
                            <small class="text-muted">Uploaded by ${attachment.uploaded_by || 'Unknown'}</small>
                        </div>
                        <a href="/tasks/download_attachment/${attachment.id}" class="btn btn-ghost-primary btn-icon btn-sm me-1">
                            <i class="ri-download-line"></i>
                        </a>
                        <button type="button" class="btn btn-ghost-danger btn-icon btn-sm" onclick="deleteAttachment(${attachment.id})">
                            <i class="ri-delete-bin-line"></i>
                        </button>
                    </div>
                `;
            });
        }
    }
}

// Make sure this function properly loads and fills the dropdowns
async function updateProjectFormData(projectId) {
    try {
        // Fetch project form data from the API
        const response = await fetch(`/tasks/api/projects/${projectId}/form-data`);
        if (!response.ok) {
            throw new Error('Failed to load project data');
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to load project data');
        }
        
        // Update categories dropdown
        const categorySelect = document.getElementById('taskCategory');
        if (categorySelect) {
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            result.data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }
        
        // Update statuses dropdown
        // Update statuses dropdown
        const statusSelect = document.getElementById('taskStatus');
        if (statusSelect) {
            statusSelect.innerHTML = '<option value="">Select Status</option>';
            result.data.statuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status.id;
                option.textContent = status.name;
                if (status.task_status_id == 1) {  // Note: use == not === for type flexibility
                    option.selected = true;
                }
                statusSelect.appendChild(option);
            });
        }
        
        // Update priorities dropdown
        const prioritySelect = document.getElementById('taskPriority');
        if (prioritySelect) {
            prioritySelect.innerHTML = '<option value="">Select Priority</option>';
            result.data.priorities.forEach(priority => {
                const option = document.createElement('option');
                option.value = priority.id;
                option.textContent = priority.name;
                prioritySelect.appendChild(option);
            });
        }
        
        // Update assignee dropdown
        const assigneeSelect = document.getElementById('taskAssignee');
        if (assigneeSelect) {
            assigneeSelect.innerHTML = '<option value="">Unassigned</option>';
            result.data.team_members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;
                assigneeSelect.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Error loading project form data:', error);
        // Show error to user
        alert('Failed to load project data: ' + error.message);
    }
}


// Function to load project settings (for due date handling)
async function loadProjectSettings(projectId) {
    try {
        const response = await fetch(`/tasks/api/projects/${projectId}`);
        const projectData = await response.json();
        
        window.projectSettings = {
            allowDueDateAssignment: projectData.allow_due_date_assignment,
            projectType: projectData.project_type
        };
        
        console.log("Loaded project settings:", window.projectSettings);
        return window.projectSettings;
    } catch (error) {
        console.error('Error loading project settings:', error);
        
        // Default settings
        window.projectSettings = {
            allowDueDateAssignment: true,
            projectType: 'general'
        };
        
        return window.projectSettings;
    }
}

// Function to setup due date field based on project settings
function setupTaskDueDateField(task) {
    const dueDateField = document.getElementById('taskDueDate');
    if (!dueDateField) return;
    
    const dueDateContainer = dueDateField.closest('.mb-3');
    if (!dueDateContainer) return;
    
    const dueDateHelperText = document.getElementById('dueDateHelperText');
    
    // Check if we have project settings
    if (!window.projectSettings) {
        console.log("No project settings, assuming manual due date allowed");
        return; // No special handling needed
    }
    
    if (window.projectSettings.allowDueDateAssignment) {
        // Enable manual due date editing
        dueDateField.removeAttribute('disabled');
        dueDateField.style.display = 'block';
        
        // Remove any read-only display
        const readOnlyDisplay = dueDateContainer.querySelector('.due-date-readonly');
        if (readOnlyDisplay) {
            readOnlyDisplay.style.display = 'none';
        }
        
        // Update helper text
        if (dueDateHelperText) {
            dueDateHelperText.textContent = 'You can modify the due date';
        }
    } else {
        // For automatic due date, show it as read-only
        dueDateField.style.display = 'none';
        dueDateField.setAttribute('disabled', 'disabled');
        
        // Create or update read-only display
        let readOnlyDisplay = dueDateContainer.querySelector('.due-date-readonly');
        if (!readOnlyDisplay) {
            readOnlyDisplay = document.createElement('div');
            readOnlyDisplay.className = 'due-date-readonly form-control-plaintext';
            readOnlyDisplay.style.marginTop = '8px';
            dueDateField.after(readOnlyDisplay);
        }
        
        // Show original due date
        if (task.due_date) {
            const dueDate = new Date(task.due_date);
            const displayDate = dueDate.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            });
            
            readOnlyDisplay.innerHTML = `<strong>${displayDate}</strong>`;
            
            // Update helper text
            if (dueDateHelperText) {
                dueDateHelperText.textContent = 'Due date calculated based on category SLA';
            }
        } else {
            readOnlyDisplay.textContent = 'No due date set';
            
            // Update helper text
            if (dueDateHelperText) {
                dueDateHelperText.textContent = 'Due date will be calculated when task is updated';
            }
        }
    }
}

// Handle category selection - update assignee and due date
function handleCategorySelection(categoryId) {
    if (!window.currentProjectData) return;
    
    // Find the selected category in our data
    const category = window.currentProjectData.categories.find(c => c.id == categoryId);
    if (!category) return;
    
    console.log("Selected category:", category);
    
    // Auto-assign to category lead if exists
    const assigneeSelect = document.getElementById('taskAssignee');
    if (category.category_lead && assigneeSelect) {
        assigneeSelect.value = category.category_lead.id;
        console.log(`Auto-assigned to category lead: ${category.category_lead.name}`);
    }
    
    // If manual due date assignment is disabled, calculate based on SLA
    if (window.projectSettings && !window.projectSettings.allowDueDateAssignment) {
        const dueDateField = document.getElementById('taskDueDate');
        if (!dueDateField) return;
        
        const slaHours = category.sla_hours || 24; // Default to 24 hours
        
        // Calculate due date
        const now = new Date();
        const dueDate = new Date(now.getTime() + (slaHours * 60 * 60 * 1000));
        
        // Format for storage (YYYY-MM-DD)
        const formattedDate = dueDate.toISOString().slice(0, 10);
        dueDateField.value = formattedDate;
        
        // Update display for read-only mode
        const dueDateContainer = dueDateField.closest('.mb-3');
        if (dueDateContainer) {
            let readOnlyDisplay = dueDateContainer.querySelector('.due-date-readonly');
            if (!readOnlyDisplay) {
                readOnlyDisplay = document.createElement('div');
                readOnlyDisplay.className = 'due-date-readonly form-control-plaintext';
                readOnlyDisplay.style.marginTop = '8px';
                dueDateField.after(readOnlyDisplay);
            }
            
            // Format for display
            const displayDate = dueDate.toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            });
            
            readOnlyDisplay.innerHTML = `<strong>${displayDate}</strong>`;
            
            // Update helper text
            const dueDateHelperText = document.getElementById('dueDateHelperText');
            if (dueDateHelperText) {
                dueDateHelperText.innerHTML = `Due date calculated as <strong>${slaHours} hours</strong> from now (per category SLA)`;
            }
        }
    }
}

// Reset form function
function resetTaskForm() {
    const form = document.getElementById('createTaskForm');
    if (!form) return;
    
    form.reset();
    delete form.dataset.mode;
    delete form.dataset.taskId;
    
    // Reset modal title and button
    const modalTitle = document.querySelector('#showModal .modal-title');
    const submitButton = document.getElementById('createTaskBtn');
    
    if (modalTitle) modalTitle.textContent = 'Create Task';
    if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = 'Create Task';
    }
    
    // Clear attachment list
    const attachmentList = document.getElementById('attachmentList');
    if (attachmentList) {
        attachmentList.innerHTML = '';
    }
    
    // Reset due date field
    const dueDateField = document.getElementById('taskDueDate');
    if (dueDateField) {
        dueDateField.removeAttribute('disabled');
        dueDateField.style.display = 'block';
        
        // Remove read-only display if exists
        const dueDateContainer = dueDateField.closest('.mb-3');
        if (dueDateContainer) {
            const readOnlyDisplay = dueDateContainer.querySelector('.due-date-readonly');
            if (readOnlyDisplay) {
                readOnlyDisplay.remove();
            }
        }
    }
    
    // Clear helper text
    const dueDateHelperText = document.getElementById('dueDateHelperText');
    if (dueDateHelperText) {
        dueDateHelperText.textContent = '';
    }

    setTimeout(() => {
        if (!document.querySelector('.modal.show') && document.querySelector('.modal-backdrop')) {
            document.querySelector('.modal-backdrop').remove();
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
        }
    }, 200);
}

// Delete attachment function
function deleteAttachment(attachmentId) {
    const taskId = document.getElementById('createTaskForm').dataset.taskId;
    if (!taskId) return;
    
    Swal.fire({
        title: 'Delete Attachment',
        text: 'Are you sure you want to delete this attachment?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/tasks/api/tasks/${taskId}/attachments/${attachmentId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove attachment from list
                    const attachmentElement = document.querySelector(`button[onclick="deleteAttachment(${attachmentId})"]`).closest('.d-flex');
                    attachmentElement.remove();
                    
                    Swal.fire({
                        title: 'Deleted!',
                        text: 'Attachment has been deleted.',
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } else {
                    throw new Error(data.error || 'Failed to delete attachment');
                }
            })
            .catch(error => {
                console.error('Error deleting attachment:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to delete attachment',
                    icon: 'error'
                });
            });
        }
    });
}

// Handle file selection for attachments
function handleFileSelect(event) {
    const files = event.target.files;
    const attachmentList = document.getElementById('attachmentList');
    
    if (!attachmentList) return;
    
    // Clear list if we're not in edit mode
    const form = document.getElementById('createTaskForm');
    if (!form || !form.dataset.mode) {
        attachmentList.innerHTML = '';
    }
    
    Array.from(files).forEach(file => {
        const fileSize = (file.size / 1024).toFixed(2);
        const fileExtension = file.name.split('.').pop().toLowerCase();
        let iconClass = getFileIcon(file.name);
        
        attachmentList.innerHTML += `
            <div class="d-flex align-items-center mt-2 border rounded p-2">
                <i class="${iconClass} fs-20 me-2"></i>
                <div class="flex-grow-1">
                    <div class="fw-medium">${file.name}</div>
                    <small class="text-muted">${fileSize} KB</small>
                </div>
                <button type="button" class="btn btn-ghost-danger btn-icon btn-sm" onclick="removeAttachment(this)">
                    <i class="ri-delete-bin-line"></i>
                </button>
            </div>
        `;
    });
}

// Remove attachment from form
function removeAttachment(button) {
    const attachmentDiv = button.closest('.d-flex');
    attachmentDiv.remove();
    
    // Clear the file input if all attachments are removed
    if (document.getElementById('attachmentList').children.length === 0) {
        document.getElementById('taskAttachments').value = '';
    }
}

// Get file icon based on extension
function getFileIcon(fileName) {
    if (!fileName) return 'ri-file-text-line';
    
    const ext = fileName.split('.').pop().toLowerCase();
    
    if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(ext)) {
        return 'ri-image-line';
    } else if (ext === 'pdf') {
        return 'ri-file-pdf-line';
    } else if (['doc', 'docx'].includes(ext)) {
        return 'ri-file-word-line';
    } else if (['xls', 'xlsx'].includes(ext)) {
        return 'ri-file-excel-line';
    } else if (['ppt', 'pptx'].includes(ext)) {
        return 'ri-file-ppt-line';
    } else if (['zip', 'rar', 'tar', 'gz'].includes(ext)) {
        return 'ri-file-zip-line';
    } else {
        return 'ri-file-text-line';
    }
}


</script>

<!-- filter -->
<script>
    /**
 * Comprehensive Task Filtering System
 * This script properly handles all filters including:
 * 1. "My Tasks" vs "My Connected Tasks" separation
 * 2. Text search
 * 3. Date range filter
 * 4. Status filter with dynamic status loading
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log("Starting comprehensive filter system setup...");
    
    // Get filter elements
    const viewFilter = document.getElementById('idTaskView');
    const searchInput = document.querySelector('.search');
    const dateRangePicker = document.getElementById('demo-datepicker');
    const statusFilter = document.getElementById('idStatus');
    
    if (!viewFilter) {
        console.error("View filter element not found");
        return;
    }
    
    // Store the current user ID for comparison
    const currentUserId = '{{ current_user.id }}';
    console.log(`Current user ID: ${currentUserId}`);

    // First, load status options into the status dropdown
    loadTaskStatuses();
    
    /**
     * Main filtering function that coordinates all filters
     * This completely replaces the existing SearchData function
     */
    window.SearchData = function() {
        console.log("Comprehensive filter function called");
        
        // Step 1: Make all rows visible first
        const allRows = resetRowVisibility();
        console.log(`Reset visibility for ${allRows.length} rows`);
        
        // Step 2: Apply combined filtering
        applyAllFilters(allRows);
    };
    
    /**
     * Reset all rows to visible state
     * This is critical to ensure filters work correctly
     */
    function resetRowVisibility() {
        const allRows = document.querySelectorAll('#tasksTable tbody tr');
        allRows.forEach(row => {
            row.style.display = '';
        });
        return allRows;
    }
    
    /**
     * Load task statuses from the table into the status dropdown
     */
    function loadTaskStatuses() {
        // Keep only first two options (blank and "All")
        while (statusFilter && statusFilter.options.length > 2) {
            statusFilter.remove(2);
        }
        
        // Extract unique statuses from the table
        const statusSet = new Set();
        document.querySelectorAll('#tasksTable .status .badge').forEach(badge => {
            // Extract the status text (ignoring any badges for connected tasks)
            const statusText = badge.textContent.trim();
            if (statusText && statusText !== 'Not Set' && !badge.classList.contains('bg-info')) {
                statusSet.add(statusText);
            }
        });
        
        // Add unique statuses to dropdown
        if (statusFilter) {
            statusSet.forEach(status => {
                const option = document.createElement('option');
                option.value = status.toLowerCase();
                option.textContent = status;
                statusFilter.appendChild(option);
            });
            
            console.log(`Added ${statusSet.size} statuses to dropdown`);
        }
    }
    
    /**
     * Apply all filters in the correct sequence
     */
    function applyAllFilters(rows) {
        // Get filter values
        const viewMode = viewFilter.value;
        const searchText = searchInput ? searchInput.value.toLowerCase().trim() : '';
        const dateRange = dateRangePicker ? dateRangePicker.value : '';
        const statusValue = statusFilter ? statusFilter.value.toLowerCase() : '';
        
        console.log(`Applying filters - View: ${viewMode}, Search: "${searchText}", Date Range: ${dateRange}, Status: ${statusValue}`);
        
        // Parse date range if provided
        let startDate = null;
        let endDate = null;
        
        if (dateRange) {
            const dateValues = parseDateRange(dateRange);
            startDate = dateValues.startDate;
            endDate = dateValues.endDate;
        }
        
        // Track statistics
        let hiddenCount = 0;
        let visibleCount = 0;
        let myTasksCount = 0;
        let connectedTasksCount = 0;
        
        // Apply all filters to each row
        rows.forEach(row => {
            // Extract row data
            const taskId = row.getAttribute('data-task-id');
            const assignedTo = row.getAttribute('data-assigned-to');
            const hasVisibility = row.getAttribute('data-has-visibility') === 'true';
            const isDone = row.getAttribute('data-is-done') === '1';
            const isReviewed = row.getAttribute('data-is-reviewed') === '1';
            const isCreator = row.getAttribute('data-created-by') === currentUserId;

            // Check if user is a reviewer for this task
            const isReviewer = row.hasAttribute('data-is-reviewer') && 
                            row.getAttribute('data-is-reviewer') === 'true';

            // View filter - My Tasks vs My Connected Tasks
            const isMyTask = assignedTo === currentUserId;
            const isConnectedTask = hasVisibility && assignedTo !== currentUserId; // Only count connected if NOT assigned
            let passesViewFilter = false;
            
            // Change needed around line 731-742 where the view filter is applied
            if (viewMode === 'my_tasks') {
                // Previously only checking if assigned to user
                // Need to modify to include tasks pending review for reviewers
                passesViewFilter = isMyTask || isCreator || (isReviewer && isDone && !isReviewed);
                if (isMyTask) myTasksCount++;
                if (isReviewer && isDone && !isReviewed) myTasksCount++;
            } else if (viewMode === 'connected_tasks') {
                // For reviewers: only show tasks that have been reviewed in connected tasks
                // For non-reviewers: show all connected tasks
                if (isReviewer) {
                    passesViewFilter = (isConnectedTask && !(isDone && !isReviewed)) || 
                                    (isDone && isReviewed);
                } else {
                    passesViewFilter = isConnectedTask;
                }
                
                if (passesViewFilter) connectedTasksCount++;
            }
            
            // Text search filter
            let passesSearchFilter = true;
            if (searchText) {
                const rowText = row.textContent.toLowerCase();
                passesSearchFilter = rowText.includes(searchText);
            }
            
            // Status filter
            let passesStatusFilter = true;
            if (statusValue && statusValue !== 'all') {
                const statusCell = row.querySelector('.status');
                const statusBadge = statusCell ? statusCell.querySelector('.badge:not(.bg-info)') : null;
                let statusText = '';
                
                if (statusBadge) {
                    statusText = statusBadge.textContent.trim().toLowerCase();
                } else if (statusCell) {
                    statusText = statusCell.textContent.trim().toLowerCase();
                }
                
                passesStatusFilter = statusText.includes(statusValue);
            }
            
            // Date filter
            let passesDateFilter = true;
            if (startDate && endDate) {
                const dueDateCell = row.querySelector('.due_date');
                if (dueDateCell) {
                    const dueDateText = dueDateCell.textContent.trim();
                    if (dueDateText && dueDateText !== '-') {
                        const dueDate = parseDate(dueDateText);
                        passesDateFilter = dueDate && dueDate >= startDate && dueDate <= endDate;
                    } else {
                        // No due date, doesn't pass date filter
                        passesDateFilter = false;
                    }
                }
            }
            
            // Combine all filters (AND logic)
            const isVisible = passesViewFilter && passesSearchFilter && 
                              passesStatusFilter && passesDateFilter;
            
            // Apply visibility
            row.style.display = isVisible ? '' : 'none';
            
            // Count for statistics
            if (isVisible) {
                visibleCount++;
            } else {
                hiddenCount++;
            }
        });
        
        console.log(`Filter results: ${visibleCount} shown, ${hiddenCount} hidden`);
        console.log(`My tasks: ${myTasksCount}, Connected tasks: ${connectedTasksCount}`);
        
        // Update stats and handle no results
        updateTaskCounters(rows);
        toggleNoResultsMessage(visibleCount === 0);
    }
    
    /**
     * Helper function to update task counters in UI
     */
    function updateTaskCounters(allRows) {
        const visibleRows = Array.from(allRows).filter(row => row.style.display !== 'none');
        
        // Count total, pending and completed
        const totalCount = visibleRows.length;
        const pendingCount = visibleRows.filter(row => row.getAttribute('data-is-done') !== '1').length;
        const completedCount = visibleRows.filter(row => row.getAttribute('data-is-done') === '1').length;
        
        // Update counter elements
        const counterElements = document.querySelectorAll('.counter-value');
        if (counterElements.length >= 3) {
            counterElements[0].setAttribute('data-target', totalCount);
            counterElements[0].textContent = totalCount;
            
            counterElements[1].setAttribute('data-target', pendingCount);
            counterElements[1].textContent = pendingCount;
            
            counterElements[2].setAttribute('data-target', completedCount);
            counterElements[2].textContent = completedCount;
        }
    }
    
    /**
     * Helper function to toggle no results message
     */
    function toggleNoResultsMessage(show) {
        const noResultDiv = document.querySelector('.noresult');
        if (noResultDiv) {
            noResultDiv.style.display = show ? 'block' : 'none';
        }
    }
    
    /**
     * Helper function to parse date strings from the table
     */
    function parseDate(dateStr) {
        if (!dateStr || dateStr === '-') return null;
        
        try {
            // Format: "15 Feb, 2023"
            const formatRegex = /(\d+)\s+([A-Za-z]+),?\s+(\d{4})/;
            const match = dateStr.match(formatRegex);
            
            if (match) {
                const day = match[1].padStart(2, '0');
                const month = getMonthNumber(match[2]);
                const year = match[3];
                return new Date(`${year}-${month}-${day}`);
            }
            
            // Try direct parsing as fallback
            const directDate = new Date(dateStr);
            if (!isNaN(directDate.getTime())) {
                return directDate;
            }
        } catch (error) {
            console.error(`Error parsing date: ${dateStr}`, error);
        }
        
        return null;
    }
    
    /**
     * Helper function to parse a date range string
     */
    function parseDateRange(dateRange) {
        let startDate = null;
        let endDate = null;
        
        if (dateRange.includes('to')) {
            // Format: "15 Feb, 2023 to 20 Feb, 2023"
            const dates = dateRange.split('to').map(d => d.trim());
            if (dates.length === 2) {
                startDate = parseDate(dates[0]);
                endDate = parseDate(dates[1]);
                
                // Set end date to end of day for inclusive comparison
                if (endDate) {
                    endDate = new Date(endDate);
                    endDate.setHours(23, 59, 59, 999);
                }
            }
        } else {
            // Single date
            startDate = parseDate(dateRange);
            endDate = parseDate(dateRange);
            
            // Set end date to end of day for inclusive comparison
            if (endDate) {
                endDate = new Date(endDate);
                endDate.setHours(23, 59, 59, 999);
            }
        }
        
        return { startDate, endDate };
    }
    
    /**
     * Helper function to convert month name to number
     */
    function getMonthNumber(monthName) {
        const months = {
            'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04', 
            'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
            'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
        };
        return months[monthName.substring(0, 3)] || '01';
    }
    
    // Set up event listeners for all filter controls
    // Update URL when view filter changes
    if (viewFilter) {
        viewFilter.addEventListener('change', function() {
            console.log(`View filter changed to: ${this.value}`);
            
            // Update URL with the new filter value without reloading the page
            const url = new URL(window.location.href);
            url.searchParams.set('taskView', this.value);
            
            // Replace current history state without reloading
            window.history.replaceState({}, '', url.toString());
            console.log(`Updated URL to: ${url.toString()}`);
            
            // Then apply filters
            window.SearchData();
        });
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            window.SearchData();
        });
    }
    
    if (dateRangePicker) {
        // Initialize the flatpickr date picker if it isn't already
        if (typeof flatpickr === 'function' && !dateRangePicker._flatpickr) {
            flatpickr(dateRangePicker, {
                mode: "range",
                dateFormat: "d M, Y",
                clear: true,
                onChange: function() {
                    window.SearchData();
                }
            });
        }

        dateRangePicker.addEventListener('change', function() {
            window.SearchData();
        });
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', function() {
            window.SearchData();
        });
    }
    
    // Apply initial filtering after a short delay to ensure the page is fully loaded
    setTimeout(window.SearchData, 500);
});

// Simple filter parameter handler
document.addEventListener('DOMContentLoaded', function() {
  // Check URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const taskViewParam = urlParams.get('taskView');
  
  if (taskViewParam) {
    // If there's a taskView parameter in the URL, update the filter dropdown
    const taskViewSelect = document.getElementById('idTaskView');
    if (taskViewSelect && (taskViewParam === 'my_tasks' || taskViewParam === 'connected_tasks')) {
      taskViewSelect.value = taskViewParam;
      
      // Apply filter (using the existing SearchData function)
      if (typeof SearchData === 'function') {
        SearchData();
      }
    }
  }
});

</script>
    
<!-- 4. Add a small CSS to highlight connected tasks (optional) -->
<style>
/* Connected task styling */
tr[data-has-visibility="true"]:not([data-assigned-to="{{ current_user.id }}"]) {
    background-color: rgba(0, 149, 255, 0.01); /* Light blue background */
}

/* Badge for connected tasks */
.connected-badge {
    font-size: 10px;
    padding: 2px 5px;
    margin-left: 5px;
    background-color: #0d6efd;
    color: white;
}
</style>



<script src="{{ url_for('static', filename='js/o_s_expense_tab.js') }}"></script>
<script src="{{ url_for('static', filename='js/o_s_attachment_tab.js') }}"></script>
<script src="{{ url_for('static', filename='js/o_s_invoice_tab.js') }}"></script>
<script src="{{ url_for('static', filename='js/o_s_container_tab.js') }}"></script>
<script src="{{ url_for('static', filename='js/o_s_item_tab.js') }}"></script>
<script src="{{ url_for('static', filename='js/o_s_demurrage_tab.js') }}"></script>

<script>
  // Debug code for rate card items
  document.addEventListener('DOMContentLoaded', function() {
    // Log when rate card modal is opened
    document.getElementById('addRateCardBtn')?.addEventListener('click', function() {
      console.log('Rate card modal opened');
    });
    
    // Log invoice form submission data
    const invoiceForm = document.getElementById('invoiceForm');
    if (invoiceForm) {
      invoiceForm._oldSubmit = invoiceForm.onsubmit;
      invoiceForm.onsubmit = function(e) {
        e.preventDefault();
        
        console.log('FORM SUBMISSION - Checking for rate card items:');
        const rateCardRows = document.querySelectorAll('#invoiceItemsTable tbody tr[data-rate-card-id]');
        console.log(`Found ${rateCardRows.length} rate card rows`, rateCardRows);
        
        if (invoiceForm._oldSubmit) {
          return invoiceForm._oldSubmit.call(this, e);
        } else {
          handleInvoiceSubmit();
        }
      };
    }
  });
</script>

<!-- tab management -->

<script>
    document.addEventListener('DOMContentLoaded', function() {
    // ====== IMPROVED TAB MANAGEMENT ======
    
    // Initialize modal tabs when "Create Task" button is clicked
    document.querySelectorAll('.add-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            setTimeout(function() {
                // Force activate the first tab in the modal
                const firstTab = document.querySelector('#task-details-tab');
                const firstTabLink = document.querySelector('a[href="#task-details-tab"]');
                
                if (firstTab && firstTabLink) {
                    // Remove active class from all tabs in the modal
                    document.querySelectorAll('.modal .tab-pane').forEach(tab => {
                        tab.classList.remove('active', 'show');
                    });
                    document.querySelectorAll('.modal .nav-link').forEach(link => {
                        link.classList.remove('active');
                        link.setAttribute('aria-selected', 'false');
                    });
                    
                    // Activate first tab
                    firstTab.classList.add('active', 'show');
                    firstTabLink.classList.add('active');
                    firstTabLink.setAttribute('aria-selected', 'true');
                }
            }, 200);
        });
    });
    
    // Improved main page tab persistence
    function initializeMainTabs() {
        // Get all tab links and content panes
        const tabLinks = document.querySelectorAll('.nav-tabs:not(.modal .nav-tabs) .nav-link');
        const tabPanes = document.querySelectorAll('.tab-content > .tab-pane');
        
        // Check URL parameters - this takes highest priority
        const urlParams = new URLSearchParams(window.location.search);
        const targetTab = urlParams.get('tab');
        let tabActivated = false;
        
        // URL parameter takes precedence over everything else
        if (targetTab) {
            const tabToActivate = document.querySelector(`a[href="#tab-${targetTab}"]`);
            if (tabToActivate) {
                activateTab(tabToActivate);
                tabActivated = true;
            }
        } 
        // Fall back to stored tab
        else {
            const storedTabId = localStorage.getItem('activeShipmentTab');
            if (storedTabId) {
                const tabToActivate = document.querySelector(`a[href="${storedTabId}"]`);
                if (tabToActivate) {
                    activateTab(tabToActivate);
                    tabActivated = true;
                }
            }
        }
        
        // If no tab was activated, ensure the first tab is active
        if (!tabActivated && tabLinks.length > 0 && tabPanes.length > 0) {
            activateTab(tabLinks[0]);
        }
        
        // Add click event listeners to all main tabs
        tabLinks.forEach(link => {
            link.addEventListener('click', function() {
                activateTab(this);
            });
        });
    }
    
    // Helper function to activate a tab
    function activateTab(tabLink) {
        if (!tabLink) return;
        
        const tabId = tabLink.getAttribute('href');
        const targetPane = document.querySelector(tabId);
        
        // Deactivate all tabs
        document.querySelectorAll('.nav-tabs:not(.modal .nav-tabs) .nav-link').forEach(link => {
            link.classList.remove('active');
            link.setAttribute('aria-selected', 'false');
        });
        document.querySelectorAll('.tab-content > .tab-pane').forEach(pane => {
            pane.classList.remove('active');
        });
        
        // Activate desired tab
        tabLink.classList.add('active');
        tabLink.setAttribute('aria-selected', 'true');
        
        if (targetPane) {
            targetPane.classList.add('active');
        }
        
        // Store active tab in localStorage
        localStorage.setItem('activeShipmentTab', tabId);
    }
    
    // Initialize tabs
    initializeMainTabs();
    
    // Create task form submission - ensure redirect to Actions tab
    // const createTaskForm = document.getElementById('createTaskForm');
    // if (createTaskForm) {
    //     createTaskForm.addEventListener('submit', function() {
    //         // Store a flag to redirect to Actions tab after reload
    //         localStorage.setItem('redirectToActionsTab', 'true');
    //     });
    // }
});
</script>

<script>
    // Add this at the end of your order_shipment.html file or in a separate common.js file

// Global helper functions for expense settlement tracking

// Format currency with optional currency code
function formatCurrency(amount, currencyCode) {
    if (amount === undefined || amount === null) return 'LKR 0.00';
    
    const numValue = parseFloat(amount);
    if (isNaN(numValue)) return 'LKR 0.00';
    
    const currency = currencyCode || 'LKR';
    return `${currency} ${numValue.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
}

// Validate amount against maximum available balance
function validateAmount(input) {
    const value = parseFloat(input.value) || 0;
    const max = parseFloat(input.max) || 0;
    
    if (value > max) {
        input.value = max;
        input.classList.add('is-invalid');
    } else {
        input.classList.remove('is-invalid');
    }
}

// Generate settlement status badge HTML
function getSettlementStatusBadge(expense) {
    if (!expense.chargeable_amount) return '<span class="badge badge-soft-secondary">N/A</span>';
    
    const chargedAmount = parseFloat(expense.charged_amount) || 0;
    const chargeableAmount = parseFloat(expense.chargeable_amount) || 0;
    
    if (chargedAmount <= 0) {
        return '<span class="badge badge-soft-danger">Unsettled</span>';
    } else if (chargedAmount >= chargeableAmount) {
        return '<span class="badge badge-soft-success">Fully Settled</span>';
    } else {
        const percentage = Math.round((chargedAmount / chargeableAmount) * 100);
        return `<span class="badge badge-soft-warning">Partially Settled (${percentage}%)</span>`;
    }
}
</script>


<!-- ATTACHMENT -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle URL tab parameter for redirects (like after deletion)
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');
    
    if (tabParam) {
        console.log(`Activating tab from URL parameter: ${tabParam}`);
        
        // Activate the specified tab
        const targetTabId = `#tab-${tabParam}`;
        const targetTabLink = document.querySelector(`a[href="${targetTabId}"]`);
        const targetTabPane = document.querySelector(targetTabId);
        
        if (targetTabLink && targetTabPane) {
            // Deactivate all tabs first
            document.querySelectorAll('.nav-tabs .nav-link').forEach(link => {
                link.classList.remove('active');
                link.setAttribute('aria-selected', 'false');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Activate the target tab
            targetTabLink.classList.add('active');
            targetTabLink.setAttribute('aria-selected', 'true');
            targetTabPane.classList.add('active');
            
            // Update localStorage
            localStorage.setItem('activeShipmentTab', targetTabId);
            
            console.log(`Successfully activated tab: ${tabParam}`);
        } else {
            console.warn(`Tab not found: ${tabParam}`);
        }
        
        // Clean up URL by removing the tab parameter ONLY ONCE
        if (!sessionStorage.getItem('tab_cleaned')) {
            sessionStorage.setItem('tab_cleaned', 'true');
            const url = new URL(window.location);
            url.searchParams.delete('tab');
            window.history.replaceState({}, document.title, url);
        }
    }
    
    // Clear the tab_cleaned flag when navigating away
    window.addEventListener('beforeunload', function() {
        sessionStorage.removeItem('tab_cleaned');
    });
});
</script>

<script>
// Function to check alerts for PO items when modal is opened
function checkPOItemAlerts() {
    const poAlertElements = document.querySelectorAll('[id^="po-material-alert-"]');
    
    poAlertElements.forEach(element => {
        const materialId = element.id.replace('po-material-alert-', '');
        checkMaterialDocumentAlerts(materialId);
    });
}

// Add event listener for when PO modal is shown
document.addEventListener('DOMContentLoaded', function() {
    const pullFromPOModal = document.getElementById('pullFromPOModal');
    if (pullFromPOModal) {
        pullFromPOModal.addEventListener('shown.bs.modal', function() {
            setTimeout(checkPOItemAlerts, 500);
        });
    }
});
</script>

{% endblock extra_js %}