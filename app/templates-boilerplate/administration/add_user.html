{% extends "partials/base.html" %}
{% block title %}Add User{% endblock title %}
{% block extra_css %}
{% endblock extra_css %}
{% block content %}
    <!-- Start right Content here -->
    <div class="main-content">
        <div class="page-content">
            <div class="container-fluid">
                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent">
                            <h4 class="mb-sm-0">Add User</h4>
                            <div class="page-title-right">
                                <ol class="breadcrumb m-0">
                                    <li class="breadcrumb-item"><a href="{{ url_for('administration.user_configuration') }}">User Configuration</a></li>
                                    <li class="breadcrumb-item active">Add User</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- end page title -->

                <!-- Flash Messages -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                                <i class="ri-alert-line me-2"></i>
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title mb-0"><i class="ri-user-add-line me-2"></i>Add New User</h4>
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-tabs" id="userTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">User Details</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="menu-access-tab" data-bs-toggle="tab" data-bs-target="#menu-access" type="button" role="tab" aria-controls="menu-access" aria-selected="false">Menu Access</button>
                                    </li>
                                </ul>
                                <form action="{{ url_for('administration.add_user') }}" method="POST" class="needs-validation" enctype="multipart/form-data">
                                    {{ form.csrf_token }}
                                    <div class="tab-content" id="userTabsContent">
                                        <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">

                                            <!-- Basic Information Card -->
                                            <div class="card mb-4">
                                                <div class="card-header">
                                                    <h5 class="card-title mb-0">Basic Information</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Full Name <span class="text-danger">*</span></label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text"><i class="ri-user-line"></i></span>
                                                                    {{ form.name(class="form-control", placeholder="Enter full name") }}
                                                                </div>
                                                                {% if form.name.errors %}
                                                                    <div class="text-danger small mt-1">
                                                                        {% for error in form.name.errors %}
                                                                            {{ error }}
                                                                        {% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>

                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Username <span class="text-danger">*</span></label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text"><i class="ri-user-follow-line"></i></span>
                                                                    {{ form.username(class="form-control", placeholder="Enter username") }}
                                                                </div>
                                                                {% if form.username.errors %}
                                                                    <div class="text-danger small mt-1">
                                                                        {% for error in form.username.errors %}
                                                                            {{ error }}
                                                                        {% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Account Information Card -->
                                            <div class="card mb-4">
                                                <div class="card-header">
                                                    <h5 class="card-title mb-0">Account Information</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Email Address <span class="text-danger">*</span></label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text"><i class="ri-mail-line"></i></span>
                                                                    {{ form.email(class="form-control", placeholder="Enter email address") }}
                                                                </div>
                                                                {% if form.email.errors %}
                                                                    <div class="text-danger small mt-1">
                                                                        {% for error in form.email.errors %}
                                                                            {{ error }}
                                                                        {% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>

                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Profile Picture</label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text"><i class="ri-image-line"></i></span>
                                                                    {{ form.profile_picture(class="form-control", accept="image/*") }}
                                                                </div>
                                                                {% if form.profile_picture.errors %}
                                                                    <div class="text-danger small mt-1">
                                                                        {% for error in form.profile_picture.errors %}
                                                                            {{ error }}
                                                                        {% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        

                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Password <span class="text-danger">*</span></label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text"><i class="ri-lock-password-line"></i></span>
                                                                    {{ form.password(class="form-control", placeholder="Enter password") }}
                                                                </div>
                                                                {% if form.password.errors %}
                                                                    <div class="text-danger small mt-1">
                                                                        {% for error in form.password.errors %}
                                                                            {{ error }}
                                                                        {% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>

                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Confirm Password <span class="text-danger">*</span></label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text"><i class="ri-lock-password-line"></i></span>
                                                                    {{ form.confirm_password(class="form-control", placeholder="Confirm password") }}
                                                                </div>
                                                                {% if form.confirm_password.errors %}
                                                                    <div class="text-danger small mt-1">
                                                                        {% for error in form.confirm_password.errors %}
                                                                            {{ error }}
                                                                        {% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Assignment Information Card -->
                                            <div class="card mb-4">
                                                <div class="card-header">
                                                    <h5 class="card-title mb-0">Assignment Information</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Company <span class="text-danger">*</span></label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text"><i class="ri-building-line"></i></span>
                                                                    {{ form.company_id(class="form-select", multiple="multiple") }} 
                                                                </div>
                                                                {% if form.company_id.errors %}
                                                                    <div class="text-danger small mt-1">
                                                                        {% for error in form.company_id.errors %}
                                                                            {{ error }}
                                                                        {% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        

                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Role <span class="text-danger">*</span></label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text"><i class="ri-shield-user-line"></i></span>
                                                                    {{ form.role_id(class="form-select", id="role_id", onchange="updateMenuPermissions()") }}
                                                                </div>
                                                                {% if form.role_id.errors %}
                                                                    <div class="text-danger small mt-1">
                                                                        {% for error in form.role_id.errors %}
                                                                            {{ error }}
                                                                        {% endfor %}
                                                                    </div>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Status Information Card -->
                                            <div class="card mb-4">
                                                <div class="card-header">
                                                    <h5 class="card-title mb-0">Status Information</h5>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-12">
                                                            <div class="mb-3">
                                                                <div class="form-check form-switch form-switch-success">
                                                                    {{ form.isactiveYN(class="form-check-input") }}
                                                                    <label class="form-check-label" for="isactiveYN">Active Status</label>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-12">
                                                            <div class="mb-3">
                                                                <label class="form-label">Deactivation Reason</label>
                                                                <div class="input-group">
                                                                    <span class="input-group-text"><i class="ri-information-line"></i></span>
                                                                    {{ form.deactivation_reason(class="form-control", rows="3") }}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="tab-pane fade" id="menu-access" role="tabpanel" aria-labelledby="menu-access-tab">
                                            <!-- Menu Access Form Fields -->
                                            <div id="menu-list" class="mt-3">
                                                <!-- JavaScript will populate this -->
                                            </div>
                                        </div>
                                      
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="d-flex justify-content-end gap-2">
                                                <button type="button" class="btn btn-light" onclick="window.location.href='{{ url_for('administration.user_configuration') }}'">
                                                    <i class="ri-close-line align-bottom me-1"></i> Cancel
                                                </button>
                                                <button type="submit" class="btn btn-success">
                                                    <i class="ri-save-line align-bottom me-1"></i> Save User
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <script>
            function updateMenuPermissions() {
                const roleId = document.getElementById("role_id").value;
                const menuList = document.getElementById("menu-list");
                menuList.innerHTML = ""; // Clear the current menu list

                if (!roleId) {
                    return; // If no role is selected, do nothing
                }

                Promise.all([
                    fetch(`/Administration/get_menus_by_role/${roleId}`),
                    document.getElementById("user_id")?.value 
                        ? fetch(`/dashboard/get_user_permissions/${document.getElementById("user_id").value}`)
                        : Promise.resolve({ json: () => ({ success: true, permissions: [] }) })
                ])
                .then(([roleResponse, userResponse]) => Promise.all([roleResponse.json(), userResponse.json()]))
                .then(([roleData, userData]) => {
                    if (roleData.success) {
                        const menus = roleData.menus;
                        const rolePermissions = roleData.permissions || {};
                        const userPermissions = userData.success ? userData.permissions || {} : {};
                        renderMenus(menus, menuList, 0, rolePermissions, userPermissions);
                    } else {
                        document.getElementById("menuMessage").innerHTML = "No menus found for the selected role.";
                    }
                })
                .catch(error => {
                    console.error("Error fetching permissions:", error);
                });
            }
        
            function renderMenus(menus, container, level, rolePermissions, userPermissions) {
                menus.forEach(menu => {
                    const menuItem = document.createElement("div");
                    menuItem.classList.add("menu-item");
                    menuItem.style.marginLeft = `${level * 20}px`;
        
                    const menuName = document.createElement("div");
                    menuName.textContent = menu.name;
                    menuName.classList.add("menu-name");
        
                    menuItem.appendChild(menuName);
                    container.appendChild(menuItem);
        
                    if (!menu.submenus || menu.submenus.length === 0) {
                        const optionsContainer = document.createElement("div");
                        optionsContainer.classList.add("options-container");
        
                        const options = ["All", "Create", "Edit", "Delete", "Print"];
                        const checkboxes = {};
        
                        options.forEach(option => {
                            const optionLabel = document.createElement("label");
                            optionLabel.textContent = option;
                            const optionCheckbox = document.createElement("input");
                            optionCheckbox.type = "checkbox";
                            optionCheckbox.name = `permissions[${menu.id}][${option.toLowerCase()}]`;
        
                            if (option === "All") {
                                optionCheckbox.disabled = false;
                            } else {
                                const isPermittedForRole = rolePermissions[menu.id]?.[option.toLowerCase()];
        
                                if (!isPermittedForRole) {
                                    optionCheckbox.disabled = true;
                                    optionLabel.classList.add("disabled");
                                }
        
                                const userPermission = userPermissions[menu.id]?.[option.toLowerCase()];
                                if (userPermission !== undefined) {
                                    optionCheckbox.checked = userPermission;
                                } else if (isPermittedForRole) {
                                    optionCheckbox.checked = true;
                                }
                            }
        
                            checkboxes[option] = optionCheckbox;
                            optionsContainer.appendChild(optionCheckbox);
                            optionsContainer.appendChild(optionLabel);
                        });
        
                        const updateAllCheckboxState = () => {
                            const allEnabledChecked = ["Create", "Edit", "Delete", "Print"].every(
                                key => checkboxes[key] && checkboxes[key].checked && !checkboxes[key].disabled
                            );
                            checkboxes["All"].checked = allEnabledChecked;
                        };
        
                        checkboxes["All"].addEventListener("change", () => {
                            const isChecked = checkboxes["All"].checked;
                            ["Create", "Edit", "Delete", "Print"].forEach(key => {
                                if (checkboxes[key] && !checkboxes[key].disabled) {
                                    checkboxes[key].checked = isChecked;
                                }
                            });
                        });
        
                        ["Create", "Edit", "Delete", "Print"].forEach(option => {
                            if (checkboxes[option] && !checkboxes[option].disabled) {
                                checkboxes[option].addEventListener("change", updateAllCheckboxState);
                            }
                        });
        
                        updateAllCheckboxState();
                        menuItem.appendChild(optionsContainer);
                    }
        
                    if (menu.submenus && menu.submenus.length > 0) {
                        renderMenus(menu.submenus, container, level + 1, rolePermissions, userPermissions);
                    }
                });
            }
        
            const style = document.createElement("style");
            style.textContent = `
                .disabled {
                    color: #999;
                    cursor: not-allowed;
                }
                .options-container {
                    display: inline-flex;
                    gap: 10px;
                    margin-left: 20px;
                }
                .menu-item {
                    margin: 8px 0;
                }
            `;
            document.head.appendChild(style);
        </script>
                
        <style>
            .menu-item {
                font-family: Arial, sans-serif;
                font-size: 14px;
                margin-top: 5px;
            }
        
            .menu-name {
                font-weight: bold;
            }
        
            .options-container {
                margin-top: 5px;
                margin-left: 20px;
                display: flex;
                gap: 10px;
                align-items: center;
            }
        
            .options-container input {
                margin-right: 5px;
            }
        </style>

        <!-- <script>
            document.addEventListener("DOMContentLoaded", function() {
                let selectElement = document.querySelector("select[name='company_id']");
                if (selectElement) {
                    selectElement.setAttribute("multiple", "multiple");
                }
            });
        </script> -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const companySelect = document.getElementById('company_id');
                
                if (companySelect) {
                    // Initialize Choices.js on the company select
                    const companyChoices = new Choices(companySelect, {
                        removeItemButton: true,
                        classNames: {
                            containerOuter: 'choices select-choices company-select-choices',
                            containerInner: 'choices__inner',
                            input: 'choices__input',
                            inputCloned: 'choices__input--cloned',
                            list: 'choices__list',
                            listItems: 'choices__list--multiple',
                            listSingle: 'choices__list--single',
                            listDropdown: 'choices__list--dropdown',
                            item: 'choices__item',
                            itemSelectable: 'choices__item--selectable',
                            itemSelected: 'choices__item--selected',
                            placeholder: 'choices__placeholder',
                            group: 'choices__group',
                            groupHeading: 'choices__group-heading',
                            button: 'choices__button',
                            activeState: 'is-active',
                            focusState: 'is-focused',
                            openState: 'is-open',
                            disabledState: 'is-disabled',
                            highlightedState: 'is-highlighted',
                            selectedState: 'is-selected',
                            flippedState: 'is-flipped',
                            loadingState: 'is-loading',
                            noResults: 'has-no-results',
                            noChoices: 'has-no-choices'
                        },
                        placeholder: true,
                        placeholderValue: 'Select Companies',
                        searchPlaceholderValue: 'Search companies...',
                        shouldSort: false
                    });
                }
            });
        </script>
        <style>
           /* Multiselect Choices.js Customization */
            .company-select-choices {
                width: 90%;
            }

            .company-select-choices .choices__inner {
                background-color: #fff;
                border: 1px solid #ced4da;
                border-radius: 0.25rem;
                min-height: 38px;
                padding: 0.375rem 0.75rem;
                width: 100%;
            }

            .company-select-choices .choices__list--multiple .choices__item {
                background-color: #f1f3f9;
                border: 1px solid #f1f3f9;
                color: #495057;
                font-size: 0.8125rem;
                margin-bottom: 0;
                margin-right: 0.25rem;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
            }

            .company-select-choices .choices__list--multiple .choices__item.choices__item--selectable {
                display: inline-flex;
                align-items: center;
            }

            .company-select-choices .choices__list--multiple .choices__item .choices__button {
                border-left: 1px solid rgba(0,0,0,0.1);
                padding-left: 0.5rem;
                margin-left: 0.5rem;
                line-height: 1;
            }

            .company-select-choices .choices__list--dropdown {
                z-index: 10;
                border: 1px solid #ced4da;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                width: 100%;
            }

            .company-select-choices .choices__list--dropdown .choices__item {
                padding: 0.5rem 0.75rem;
            }

            .company-select-choices .choices__list--dropdown .choices__item--selectable {
                transition: background-color 0.2s ease;
            }

            .company-select-choices .choices__list--dropdown .choices__item--selectable:hover {
                background-color: #f1f3f9;
            }

            /* Ensure input group takes full width */
            .company-select-choices .input-group {
                width: 100%;
            }

            /* Adjust input group text icon positioning */
            .company-select-choices .input-group-text {
                height: 38px;
            }
        </style>
                

        {% block footer %}
        {% include "partials/footer.html" %}
        {% endblock footer %}
    </div>


{% endblock content %}